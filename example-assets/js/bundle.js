/**
 * Modules in this bundle
 * @license
 * 
 * patroljs:
 *   license: MIT
 *   author: Nick Janssen
 *   maintainers: nickjanssen <info@nickjanssen.com>
 *   version: 0.1.0
 * 
 * hyper3d:
 *   license: MIT
 *   author: yvt <i@yvt.jp>
 *   version: 0.0.1
 * 
 * three:
 *   license: MIT
 *   author: three.js contributors
 *   maintainers: bhouston <ben@exocortex.com>, cabbibo <isaaclandoncohen@gmail.com>, rtsao <rtsao@scu.edu>, rickytomatoes <eriksalgstrom@gmail.com>, hughsk <hughskennedy@gmail.com>, xoryouyou <xoryouyou@googlemail.com>
 *   homepage: http://threejs.org/
 *   version: 0.73.0
 * 
 * threejs-geometry-hittest:
 *   license: MIT
 *   author: yvt <i@yvt.jp>
 *   maintainers: yvt <i@yvt.jp>
 *   homepage: https://github.com/yvt/threejs-geometry-hittest#readme
 *   version: 0.0.3
 * 
 * underscore:
 *   license: MIT
 *   author: Jeremy Ashkenas <jeremy@documentcloud.org>
 *   maintainers: jashkenas <jashkenas@gmail.com>
 *   homepage: http://underscorejs.org
 *   version: 1.8.3
 * 
 * This header is generated by licensify (https://github.com/twada/licensify)
 */
require=function e(t,r,n){function i(a,s){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var c=r[a]={exports:{}};t[a][0].call(c.exports,function(e){var r=t[a][1][e];return i(r?r:e)},c,c.exports,e,t,r,n)}return r[a].exports}for(var o="function"==typeof require&&require,a=0;a<n.length;a++)i(n[a]);return i}({1:[function(e,t,r){
//     (c) 2009-2015 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function(){function e(e){function t(t,r,n,i,o,a){for(;o>=0&&a>o;o+=e){var s=i?i[o]:o;n=r(n,t[s],s,t)}return n}return function(r,n,i,o){n=b(n,o,4);var a=!R(r)&&_.keys(r),s=(a||r).length,u=e>0?0:s-1;return arguments.length<3&&(i=r[a?a[u]:u],u+=e),t(r,n,i,a,u,s)}}function n(e){return function(t,r,n){r=w(r,n);for(var i=C(t),o=e>0?0:i-1;o>=0&&i>o;o+=e)if(r(t[o],o,t))return o;return-1}}function i(e,t,r){return function(n,i,o){var a=0,s=C(n);if("number"==typeof o)e>0?a=o>=0?o:Math.max(o+s,a):s=o>=0?Math.min(o+1,s):o+s+1;else if(r&&o&&s)return o=r(n,i),n[o]===i?o:-1;if(i!==i)return o=t(p.call(n,a,s),_.isNaN),o>=0?o+a:-1;for(o=e>0?a:s-1;o>=0&&s>o;o+=e)if(n[o]===i)return o;return-1}}function o(e,t){var r=B.length,n=e.constructor,i=_.isFunction(n)&&n.prototype||h,o="constructor";for(_.has(e,o)&&!_.contains(t,o)&&t.push(o);r--;)o=B[r],o in e&&e[o]!==i[o]&&!_.contains(t,o)&&t.push(o)}var a=this,s=a._,u=Array.prototype,h=Object.prototype,c=Function.prototype,l=u.push,p=u.slice,f=h.toString,d=h.hasOwnProperty,m=Array.isArray,g=Object.keys,v=c.bind,x=Object.create,y=function(){},_=function(e){return e instanceof _?e:this instanceof _?void(this._wrapped=e):new _(e)};"undefined"!=typeof r?("undefined"!=typeof t&&t.exports&&(r=t.exports=_),r._=_):a._=_,_.VERSION="1.8.3";var b=function(e,t,r){if(void 0===t)return e;switch(null==r?3:r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)};case 4:return function(r,n,i,o){return e.call(t,r,n,i,o)}}return function(){return e.apply(t,arguments)}},w=function(e,t,r){return null==e?_.identity:_.isFunction(e)?b(e,t,r):_.isObject(e)?_.matcher(e):_.property(e)};_.iteratee=function(e,t){return w(e,t,1/0)};var T=function(e,t){return function(r){var n=arguments.length;if(2>n||null==r)return r;for(var i=1;n>i;i++)for(var o=arguments[i],a=e(o),s=a.length,u=0;s>u;u++){var h=a[u];t&&void 0!==r[h]||(r[h]=o[h])}return r}},M=function(e){if(!_.isObject(e))return{};if(x)return x(e);y.prototype=e;var t=new y;return y.prototype=null,t},S=function(e){return function(t){return null==t?void 0:t[e]}},E=Math.pow(2,53)-1,C=S("length"),R=function(e){var t=C(e);return"number"==typeof t&&t>=0&&E>=t};_.each=_.forEach=function(e,t,r){t=b(t,r);var n,i;if(R(e))for(n=0,i=e.length;i>n;n++)t(e[n],n,e);else{var o=_.keys(e);for(n=0,i=o.length;i>n;n++)t(e[o[n]],o[n],e)}return e},_.map=_.collect=function(e,t,r){t=w(t,r);for(var n=!R(e)&&_.keys(e),i=(n||e).length,o=Array(i),a=0;i>a;a++){var s=n?n[a]:a;o[a]=t(e[s],s,e)}return o},_.reduce=_.foldl=_.inject=e(1),_.reduceRight=_.foldr=e(-1),_.find=_.detect=function(e,t,r){var n;return n=R(e)?_.findIndex(e,t,r):_.findKey(e,t,r),void 0!==n&&-1!==n?e[n]:void 0},_.filter=_.select=function(e,t,r){var n=[];return t=w(t,r),_.each(e,function(e,r,i){t(e,r,i)&&n.push(e)}),n},_.reject=function(e,t,r){return _.filter(e,_.negate(w(t)),r)},_.every=_.all=function(e,t,r){t=w(t,r);for(var n=!R(e)&&_.keys(e),i=(n||e).length,o=0;i>o;o++){var a=n?n[o]:o;if(!t(e[a],a,e))return!1}return!0},_.some=_.any=function(e,t,r){t=w(t,r);for(var n=!R(e)&&_.keys(e),i=(n||e).length,o=0;i>o;o++){var a=n?n[o]:o;if(t(e[a],a,e))return!0}return!1},_.contains=_.includes=_.include=function(e,t,r,n){return R(e)||(e=_.values(e)),("number"!=typeof r||n)&&(r=0),_.indexOf(e,t,r)>=0},_.invoke=function(e,t){var r=p.call(arguments,2),n=_.isFunction(t);return _.map(e,function(e){var i=n?t:e[t];return null==i?i:i.apply(e,r)})},_.pluck=function(e,t){return _.map(e,_.property(t))},_.where=function(e,t){return _.filter(e,_.matcher(t))},_.findWhere=function(e,t){return _.find(e,_.matcher(t))},_.max=function(e,t,r){var n,i,o=-(1/0),a=-(1/0);if(null==t&&null!=e){e=R(e)?e:_.values(e);for(var s=0,u=e.length;u>s;s++)n=e[s],n>o&&(o=n)}else t=w(t,r),_.each(e,function(e,r,n){i=t(e,r,n),(i>a||i===-(1/0)&&o===-(1/0))&&(o=e,a=i)});return o},_.min=function(e,t,r){var n,i,o=1/0,a=1/0;if(null==t&&null!=e){e=R(e)?e:_.values(e);for(var s=0,u=e.length;u>s;s++)n=e[s],o>n&&(o=n)}else t=w(t,r),_.each(e,function(e,r,n){i=t(e,r,n),(a>i||i===1/0&&o===1/0)&&(o=e,a=i)});return o},_.shuffle=function(e){for(var t,r=R(e)?e:_.values(e),n=r.length,i=Array(n),o=0;n>o;o++)t=_.random(0,o),t!==o&&(i[o]=i[t]),i[t]=r[o];return i},_.sample=function(e,t,r){return null==t||r?(R(e)||(e=_.values(e)),e[_.random(e.length-1)]):_.shuffle(e).slice(0,Math.max(0,t))},_.sortBy=function(e,t,r){return t=w(t,r),_.pluck(_.map(e,function(e,r,n){return{value:e,index:r,criteria:t(e,r,n)}}).sort(function(e,t){var r=e.criteria,n=t.criteria;if(r!==n){if(r>n||void 0===r)return 1;if(n>r||void 0===n)return-1}return e.index-t.index}),"value")};var D=function(e){return function(t,r,n){var i={};return r=w(r,n),_.each(t,function(n,o){var a=r(n,o,t);e(i,n,a)}),i}};_.groupBy=D(function(e,t,r){_.has(e,r)?e[r].push(t):e[r]=[t]}),_.indexBy=D(function(e,t,r){e[r]=t}),_.countBy=D(function(e,t,r){_.has(e,r)?e[r]++:e[r]=1}),_.toArray=function(e){return e?_.isArray(e)?p.call(e):R(e)?_.map(e,_.identity):_.values(e):[]},_.size=function(e){return null==e?0:R(e)?e.length:_.keys(e).length},_.partition=function(e,t,r){t=w(t,r);var n=[],i=[];return _.each(e,function(e,r,o){(t(e,r,o)?n:i).push(e)}),[n,i]},_.first=_.head=_.take=function(e,t,r){return null!=e?null==t||r?e[0]:_.initial(e,e.length-t):void 0},_.initial=function(e,t,r){return p.call(e,0,Math.max(0,e.length-(null==t||r?1:t)))},_.last=function(e,t,r){return null!=e?null==t||r?e[e.length-1]:_.rest(e,Math.max(0,e.length-t)):void 0},_.rest=_.tail=_.drop=function(e,t,r){return p.call(e,null==t||r?1:t)},_.compact=function(e){return _.filter(e,_.identity)};var A=function(e,t,r,n){for(var i=[],o=0,a=n||0,s=C(e);s>a;a++){var u=e[a];if(R(u)&&(_.isArray(u)||_.isArguments(u))){t||(u=A(u,t,r));var h=0,c=u.length;for(i.length+=c;c>h;)i[o++]=u[h++]}else r||(i[o++]=u)}return i};_.flatten=function(e,t){return A(e,t,!1)},_.without=function(e){return _.difference(e,p.call(arguments,1))},_.uniq=_.unique=function(e,t,r,n){_.isBoolean(t)||(n=r,r=t,t=!1),null!=r&&(r=w(r,n));for(var i=[],o=[],a=0,s=C(e);s>a;a++){var u=e[a],h=r?r(u,a,e):u;t?(a&&o===h||i.push(u),o=h):r?_.contains(o,h)||(o.push(h),i.push(u)):_.contains(i,u)||i.push(u)}return i},_.union=function(){return _.uniq(A(arguments,!0,!0))},_.intersection=function(e){for(var t=[],r=arguments.length,n=0,i=C(e);i>n;n++){var o=e[n];if(!_.contains(t,o)){for(var a=1;r>a&&_.contains(arguments[a],o);a++);a===r&&t.push(o)}}return t},_.difference=function(e){var t=A(arguments,!0,!0,1);return _.filter(e,function(e){return!_.contains(t,e)})},_.zip=function(){return _.unzip(arguments)},_.unzip=function(e){for(var t=e&&_.max(e,C).length||0,r=Array(t),n=0;t>n;n++)r[n]=_.pluck(e,n);return r},_.object=function(e,t){for(var r={},n=0,i=C(e);i>n;n++)t?r[e[n]]=t[n]:r[e[n][0]]=e[n][1];return r},_.findIndex=n(1),_.findLastIndex=n(-1),_.sortedIndex=function(e,t,r,n){r=w(r,n,1);for(var i=r(t),o=0,a=C(e);a>o;){var s=Math.floor((o+a)/2);r(e[s])<i?o=s+1:a=s}return o},_.indexOf=i(1,_.findIndex,_.sortedIndex),_.lastIndexOf=i(-1,_.findLastIndex),_.range=function(e,t,r){null==t&&(t=e||0,e=0),r=r||1;for(var n=Math.max(Math.ceil((t-e)/r),0),i=Array(n),o=0;n>o;o++,e+=r)i[o]=e;return i};var P=function(e,t,r,n,i){if(!(n instanceof t))return e.apply(r,i);var o=M(e.prototype),a=e.apply(o,i);return _.isObject(a)?a:o};_.bind=function(e,t){if(v&&e.bind===v)return v.apply(e,p.call(arguments,1));if(!_.isFunction(e))throw new TypeError("Bind must be called on a function");var r=p.call(arguments,2),n=function(){return P(e,n,t,this,r.concat(p.call(arguments)))};return n},_.partial=function(e){var t=p.call(arguments,1),r=function(){for(var n=0,i=t.length,o=Array(i),a=0;i>a;a++)o[a]=t[a]===_?arguments[n++]:t[a];for(;n<arguments.length;)o.push(arguments[n++]);return P(e,r,this,this,o)};return r},_.bindAll=function(e){var t,r,n=arguments.length;if(1>=n)throw new Error("bindAll must be passed function names");for(t=1;n>t;t++)r=arguments[t],e[r]=_.bind(e[r],e);return e},_.memoize=function(e,t){var r=function(n){var i=r.cache,o=""+(t?t.apply(this,arguments):n);return _.has(i,o)||(i[o]=e.apply(this,arguments)),i[o]};return r.cache={},r},_.delay=function(e,t){var r=p.call(arguments,2);return setTimeout(function(){return e.apply(null,r)},t)},_.defer=_.partial(_.delay,_,1),_.throttle=function(e,t,r){var n,i,o,a=null,s=0;r||(r={});var u=function(){s=r.leading===!1?0:_.now(),a=null,o=e.apply(n,i),a||(n=i=null)};return function(){var h=_.now();s||r.leading!==!1||(s=h);var c=t-(h-s);return n=this,i=arguments,0>=c||c>t?(a&&(clearTimeout(a),a=null),s=h,o=e.apply(n,i),a||(n=i=null)):a||r.trailing===!1||(a=setTimeout(u,c)),o}},_.debounce=function(e,t,r){var n,i,o,a,s,u=function(){var h=_.now()-a;t>h&&h>=0?n=setTimeout(u,t-h):(n=null,r||(s=e.apply(o,i),n||(o=i=null)))};return function(){o=this,i=arguments,a=_.now();var h=r&&!n;return n||(n=setTimeout(u,t)),h&&(s=e.apply(o,i),o=i=null),s}},_.wrap=function(e,t){return _.partial(t,e)},_.negate=function(e){return function(){return!e.apply(this,arguments)}},_.compose=function(){var e=arguments,t=e.length-1;return function(){for(var r=t,n=e[t].apply(this,arguments);r--;)n=e[r].call(this,n);return n}},_.after=function(e,t){return function(){return--e<1?t.apply(this,arguments):void 0}},_.before=function(e,t){var r;return function(){return--e>0&&(r=t.apply(this,arguments)),1>=e&&(t=null),r}},_.once=_.partial(_.before,2);var L=!{toString:null}.propertyIsEnumerable("toString"),B=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];_.keys=function(e){if(!_.isObject(e))return[];if(g)return g(e);var t=[];for(var r in e)_.has(e,r)&&t.push(r);return L&&o(e,t),t},_.allKeys=function(e){if(!_.isObject(e))return[];var t=[];for(var r in e)t.push(r);return L&&o(e,t),t},_.values=function(e){for(var t=_.keys(e),r=t.length,n=Array(r),i=0;r>i;i++)n[i]=e[t[i]];return n},_.mapObject=function(e,t,r){t=w(t,r);for(var n,i=_.keys(e),o=i.length,a={},s=0;o>s;s++)n=i[s],a[n]=t(e[n],n,e);return a},_.pairs=function(e){for(var t=_.keys(e),r=t.length,n=Array(r),i=0;r>i;i++)n[i]=[t[i],e[t[i]]];return n},_.invert=function(e){for(var t={},r=_.keys(e),n=0,i=r.length;i>n;n++)t[e[r[n]]]=r[n];return t},_.functions=_.methods=function(e){var t=[];for(var r in e)_.isFunction(e[r])&&t.push(r);return t.sort()},_.extend=T(_.allKeys),_.extendOwn=_.assign=T(_.keys),_.findKey=function(e,t,r){t=w(t,r);for(var n,i=_.keys(e),o=0,a=i.length;a>o;o++)if(n=i[o],t(e[n],n,e))return n},_.pick=function(e,t,r){var n,i,o={},a=e;if(null==a)return o;_.isFunction(t)?(i=_.allKeys(a),n=b(t,r)):(i=A(arguments,!1,!1,1),n=function(e,t,r){return t in r},a=Object(a));for(var s=0,u=i.length;u>s;s++){var h=i[s],c=a[h];n(c,h,a)&&(o[h]=c)}return o},_.omit=function(e,t,r){if(_.isFunction(t))t=_.negate(t);else{var n=_.map(A(arguments,!1,!1,1),String);t=function(e,t){return!_.contains(n,t)}}return _.pick(e,t,r)},_.defaults=T(_.allKeys,!0),_.create=function(e,t){var r=M(e);return t&&_.extendOwn(r,t),r},_.clone=function(e){return _.isObject(e)?_.isArray(e)?e.slice():_.extend({},e):e},_.tap=function(e,t){return t(e),e},_.isMatch=function(e,t){var r=_.keys(t),n=r.length;if(null==e)return!n;for(var i=Object(e),o=0;n>o;o++){var a=r[o];if(t[a]!==i[a]||!(a in i))return!1}return!0};var F=function(e,t,r,n){if(e===t)return 0!==e||1/e===1/t;if(null==e||null==t)return e===t;e instanceof _&&(e=e._wrapped),t instanceof _&&(t=t._wrapped);var i=f.call(e);if(i!==f.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!==+e?+t!==+t:0===+e?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}var o="[object Array]"===i;if(!o){if("object"!=typeof e||"object"!=typeof t)return!1;var a=e.constructor,s=t.constructor;if(a!==s&&!(_.isFunction(a)&&a instanceof a&&_.isFunction(s)&&s instanceof s)&&"constructor"in e&&"constructor"in t)return!1}r=r||[],n=n||[];for(var u=r.length;u--;)if(r[u]===e)return n[u]===t;if(r.push(e),n.push(t),o){if(u=e.length,u!==t.length)return!1;for(;u--;)if(!F(e[u],t[u],r,n))return!1}else{var h,c=_.keys(e);if(u=c.length,_.keys(t).length!==u)return!1;for(;u--;)if(h=c[u],!_.has(t,h)||!F(e[h],t[h],r,n))return!1}return r.pop(),n.pop(),!0};_.isEqual=function(e,t){return F(e,t)},_.isEmpty=function(e){return null==e?!0:R(e)&&(_.isArray(e)||_.isString(e)||_.isArguments(e))?0===e.length:0===_.keys(e).length},_.isElement=function(e){return!(!e||1!==e.nodeType)},_.isArray=m||function(e){return"[object Array]"===f.call(e)},_.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},_.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(e){_["is"+e]=function(t){return f.call(t)==="[object "+e+"]"}}),_.isArguments(arguments)||(_.isArguments=function(e){return _.has(e,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(_.isFunction=function(e){return"function"==typeof e||!1}),_.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},_.isNaN=function(e){return _.isNumber(e)&&e!==+e},_.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"===f.call(e)},_.isNull=function(e){return null===e},_.isUndefined=function(e){return void 0===e},_.has=function(e,t){return null!=e&&d.call(e,t)},_.noConflict=function(){return a._=s,this},_.identity=function(e){return e},_.constant=function(e){return function(){return e}},_.noop=function(){},_.property=S,_.propertyOf=function(e){return null==e?function(){}:function(t){return e[t]}},_.matcher=_.matches=function(e){return e=_.extendOwn({},e),function(t){return _.isMatch(t,e)}},_.times=function(e,t,r){var n=Array(Math.max(0,e));t=b(t,r,1);for(var i=0;e>i;i++)n[i]=t(i);return n},_.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},_.now=Date.now||function(){return(new Date).getTime()};var G={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},U=_.invert(G),k=function(e){var t=function(t){return e[t]},r="(?:"+_.keys(e).join("|")+")",n=RegExp(r),i=RegExp(r,"g");return function(e){return e=null==e?"":""+e,n.test(e)?e.replace(i,t):e}};_.escape=k(G),_.unescape=k(U),_.result=function(e,t,r){var n=null==e?void 0:e[t];return void 0===n&&(n=r),_.isFunction(n)?n.call(e):n};var V=0;_.uniqueId=function(e){var t=++V+"";return e?e+t:t},_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,O={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},z=/\\|'|\r|\n|\u2028|\u2029/g,N=function(e){return"\\"+O[e]};_.template=function(e,t,r){!t&&r&&(t=r),t=_.defaults({},t,_.templateSettings);var n=RegExp([(t.escape||I).source,(t.interpolate||I).source,(t.evaluate||I).source].join("|")+"|$","g"),i=0,o="__p+='";e.replace(n,function(t,r,n,a,s){return o+=e.slice(i,s).replace(z,N),i=s+t.length,r?o+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":n?o+="'+\n((__t=("+n+"))==null?'':__t)+\n'":a&&(o+="';\n"+a+"\n__p+='"),t}),o+="';\n",t.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{var a=new Function(t.variable||"obj","_",o)}catch(s){throw s.source=o,s}var u=function(e){return a.call(this,e,_)},h=t.variable||"obj";return u.source="function("+h+"){\n"+o+"}",u},_.chain=function(e){var t=_(e);return t._chain=!0,t};var j=function(e,t){return e._chain?_(t).chain():t};_.mixin=function(e){_.each(_.functions(e),function(t){var r=_[t]=e[t];_.prototype[t]=function(){var e=[this._wrapped];return l.apply(e,arguments),j(this,r.apply(_,e))}})},_.mixin(_),_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=u[e];_.prototype[e]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!==e&&"splice"!==e||0!==r.length||delete r[0],j(this,r)}}),_.each(["concat","join","slice"],function(e){var t=u[e];_.prototype[e]=function(){return j(this,t.apply(this._wrapped,arguments))}}),_.prototype.value=function(){return this._wrapped},_.prototype.valueOf=_.prototype.toJSON=_.prototype.value,_.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return _})}).call(this)},{}],2:[function(e,t,r){t.exports=function(){return{tick:function(){}}}},{}],3:[function(e,t,r){var n=function(){function e(e,t){this.gl=e,this.handle=t}return e.createFramebuffer=function(t,r,n){null==n&&(n=t.TEXTURE_2D);var i=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,i),null!=r.depth&&(r.depth instanceof WebGLTexture?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,r.depth,0):r.depth instanceof WebGLRenderbuffer&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,r.depth));for(var o=r.colors,a=0;a<o.length;++a)t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+a,n,o[a],0);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);if(s!=t.FRAMEBUFFER_COMPLETE)throw t.deleteFramebuffer(i),new Error("incomplete framebuffer: "+s);return new e(t,i)},e.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.handle)},e.prototype.dispose=function(){this.gl.deleteFramebuffer(this.handle)},e}();r.GLFramebuffer=n},{}],4:[function(require,module,exports){var GLProgram=function(){function GLProgram(e,t){this.core=e,this.program=t,this.logger=e.log.getLogger("shader"),this.attrLocs={},this.nextAttrLoc=0,this.gl=e.gl,this.linked=!1,this.globalUniformSubscriber=e.shaderManager.subscribeGlobalUniforms(this)}return GLProgram.prototype.dispose=function(){this.gl.deleteProgram(this.program)},GLProgram.prototype.use=function(){this.linked||this.link(),this.gl.useProgram(this.program),this.globalUniformSubscriber.updateGlobalUniforms()},GLProgram.prototype.link=function(){if(this.linked)throw new Error;var e=this.gl;if(e.linkProgram(this.program),this.logger.isEnabled){var t=e.getProgramInfoLog(this.program);t.length>0&&this.logger.log("Program link log was generated:\n"+t)}if(!e.getProgramParameter(this.program,e.LINK_STATUS))throw new Error("program compilation failed.");this.linked=!0},GLProgram.prototype.initializeAttributes=function(e){if(this.linked)throw new Error("already linked");for(var t=0;t<e.length;t++){var r=e[t],n=this.attrLocs[r];null==n&&(n=this.nextAttrLoc,this.gl.bindAttribLocation(this.program,n,r),this.attrLocs[r]=n,this.nextAttrLoc=n+1)}},GLProgram.prototype.getAttributes=function(e){for(var t={},r=0;r<e.length;r++){var n=e[r];t[n]=this.attrLocs[n]}return t},GLProgram.prototype.getUniforms=function(e){if(!this.linked)throw new Error("not linked");for(var t={},r=0;r<e.length;r++){var n=e[r];t[n]=this.gl.getUniformLocation(this.program,n)}return t},GLProgram.prototype.createUniformSetter=function(setters){var ret={},gl=this.gl;for(var name_4 in setters){var loc=this.gl.getUniformLocation(this.program,name_4);loc?ret[name_4]=eval("(function(gl, fn, loc) {\n                    return function (a1, a2, a3, a4) {\n                        fn.call(gl, loc, a1, a2, a3, a4);\n                    };\n                })")(gl,setters[name_4],loc):ret[name_4]=function(){}}return ret},GLProgram.link=function(e,t,r){var n=e.gl,i=new GLProgram(e,n.createProgram());try{for(var o=0;o<t.length;o++){var a=t[o];n.attachShader(i.program,a.shader)}var s=i;return s.initializeAttributes(r),s.link(),i=null,s}finally{null!=i&&i.dispose()}},GLProgram}();exports.GLProgram=GLProgram},{}],5:[function(e,t,r){var n=e("./shaders"),i=function(){function e(e,t){this.gl=e,this.shader=t}return e.prototype.dispose=function(){this.gl.deleteShader(this.shader)},e.getAllAttributesReferencedByChunk=function(e){function t(e){if(e.requires)for(var a=0,s=e.requires;a<s.length;a++){var u=s[a];if(!o[u]){if(o[u]=!0,!n.shaderChunks[u])throw new Error("shader chunk "+u+" not found.");t(n.shaderChunks[u])}}if(e.attributes)for(var h=0,c=e.attributes;h<c.length;h++){var l=c[h];i[l]||(i[l]=!0,r.push(l))}}var r=[],i={},o={};return e.forEach(t),r},e.preprocess=function(e,t,r,i){function o(e,t){if(e.requires)for(var r=0,i=e.requires;r<i.length;r++){var c=i[r];if(!s[c]){if(s[c]=!0,!n.shaderChunks[c])throw new Error("shader chunk "+c+" not found.");o(n.shaderChunks[c],c)}}if(e.parameters)for(var l=0,p=e.parameters;l<p.length;l++){var f=p[l];u[f]=null}t&&a.push("/* ---- "+t+" ---- */"),a.push(e.source),e.source.indexOf("// --- precision highp ---")>=0&&(h=!0)}var a=[],s={},u={};r=r||{};var h=!1,c=e.gl;switch(t.forEach(function(e){return o(e)}),i){case c.VERTEX_SHADER:break;case c.FRAGMENT_SHADER:a.unshift("precision "+(h?"highp":"mediump")+" float;");break;default:throw new Error}var l=e.shaderManager.globalParameters;for(var p in u){var f=r[p];if(null==f&&(f=l[p]),null==f)throw new Error("value for parameter "+p+" is missing");if(f===!0)a.unshift("#define c_"+p+" 1");else if(f===!1)a.unshift("#define c_"+p+" 0");else{if("number"!=typeof f)throw new Error("bad parameter type");a.unshift("#define c_"+p+" "+f)}}return a.join("\n")},e.compile=function(t,r,n){var i=t.gl,o=t.log.getLogger("shader"),a=new e(i,i.createShader(r));try{if(i.shaderSource(a.shader,n),i.compileShader(a.shader),o.isEnabled){var s=i.getShaderInfoLog(a.shader);s.length>0&&o.log("Shader compilation log generated for the following shader:\n"+n+"\nFollowing is the log message:\n"+s)}if(!i.getShaderParameter(a.shader,i.COMPILE_STATUS))throw new Error("shader compilation failed.");var u=a;return a=null,u}finally{null!=a&&a.dispose()}},e}();r.GLShader=i},{"./shaders":17}],6:[function(e,t,r){function n(e){var t=1&e;return e>>=1,t=t<<1|1&e,e>>=1,t=t<<1|1&e,e>>=1,t=t<<1|1&e,e>>=1,t=t<<1|1&e,e>>=1,t<<=3}function i(e,t,r,i){var o=n(i);return 1&r&&(e+=4),2&r&&(t+=4),e&=7,t&=7,(s[e|t<<3]<<2&208)+o&255}var o=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},a=function(){function e(e,t){this.gl=e,this.size=64,this.textures=[],this.index=0;for(var r=new Uint8Array(this.size*this.size*4),n=0;32>n;++n){var i=e.createTexture();this.generate(r,n,t),e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.size,this.size,0,e.RGBA,e.UNSIGNED_BYTE,r),this.textures.push(i)}this.texture=this.textures[0]}return e.prototype.dispose=function(){for(var e=this.gl,t=0,r=this.textures;t<r.length;t++){var n=r[t];e.deleteTexture(n)}},e.prototype.generate=function(e,t,r){for(var n=e.byteLength,i=0;n>i;i++)e[i]=r(i>>2&63,i>>8,3&i,t)},e.prototype.update=function(){this.texture=this.textures[this.index],this.index++,this.index==this.textures.length&&(this.index=0)},e}();r.JitterTexture=a;var s=[0,48,12,60,3,51,15,63,32,16,44,28,35,19,47,31,8,56,4,52,11,59,7,55,40,24,36,20,43,27,39,23,2,50,14,62,1,49,13,61,34,18,46,30,33,17,45,29,10,58,6,54,9,57,5,53,42,26,38,22,41,25,37,21],u=function(e){function t(t){e.call(this,t,i)}return o(t,e),t}(a);r.DitherJitterTexture=u;var h=function(e){function t(t){e.call(this,t,function(e,t,r,n){var o=(i(e,t,r,n)-128)*(1/128),a=o*o,s=a*a,u=s*s,h=u*o,c=.4736*o+.5263*h;return 160*c+128})}return o(t,e),t}(a);r.GaussianDitherJitterTexture=h;var c=function(e){function t(t){e.call(this,t,function(){return 256*Math.random()})}return o(t,e),t}(a);r.UniformJitterTexture=c;var l=function(e){function t(t){e.call(this,t,function(){var e,t;do e=Math.random(),t=Math.random();while(0==e);var r=Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*t);return 128+32*r})}return o(t,e),t}(a);r.GaussianJitterTexture=l},{}],7:[function(e,t,r){var n=e("../utils/Utils"),i=function(){function e(e,t){this.core=e,this.logger=t,this.ext=e.ext.get("EXT_disjoint_timer_query"),this.queries=[],this.nextIndex=0,this.activePhases=[],this.state=0,this.callback=null,this.queryRunning=!1}return e.prototype.begin=function(e){if(1==this.state){var t=this.markTime(!1),r=this.activePhases[this.activePhases.length-1],n={begin:t,end:0,name:e,subphases:[]};r&&r.subphases.push(n),this.activePhases.push(n)}},e.prototype.end=function(){if(1==this.state){var e=this.markTime(!0),t=this.activePhases.pop();if(!t)throw new Error("Unmatched Profiler.begin/end. Too many ends.");t.end=e}},e.prototype.dispose=function(){for(var e=0,t=this.queries;e<t.length;e++){var r=t[e];this.ext.deleteQueryEXT(r)}this.queries=[]},e.prototype.startProfiling=function(e){if(0==this.state){if(!this.ext)return void this.logger.error("Cannot start profiling because EXT_disjoint_timer_query is not available.");this.state=1}this.callback=e},e.prototype.stopProfiling=function(){this.state=0,this.callback=null,this.dispose()},e.prototype.checkMeasurementReady=function(){function e(t,r,n){for(var i="",o=0;r>o;++o)i+=o==r-1?n?"└ ":"├ ":"│";i+=t.name,u.push({name:i,time:a[t.end]-a[t.begin]});for(var s=0,h=t.subphases;s<h.length;s++){var c=h[s];e(c,r+1,c==t.subphases[t.subphases.length-1])}}if(2==this.state){for(var t=this.queries,r=this.nextIndex,i=0;r>i;++i)if(!this.ext.getQueryObjectEXT(t[i],this.ext.QUERY_RESULT_AVAILABLE_EXT))return;this.state=1;var o=this.activePhases.pop();if(!o)throw new Error;for(var a=[0],s=0,i=0;r>i;++i)s+=this.ext.getQueryObjectEXT(t[i],this.ext.QUERY_RESULT_EXT),a.push(s);var u=[];e(o,0,!0);var h={phases:u},c=[40,10,20];this.logger.warn("Profiling done. \n"+("| "+n.fillWith("Phase",c[0]," ")+" | "+n.fillWithRightAligned("Time",c[1]," ")+" | "+n.stringRepeat(" ",c[2])+" |\n")+("| "+n.stringRepeat("-",c[0])+" | "+n.stringRepeat("-",c[1])+" | "+n.stringRepeat("-",c[2])+" |\n")+u.map(function(e){var t=e.name,r=""+Math.floor(e.time),i=Math.min(Math.ceil(e.time/15e5*c[2]),c[2]);return"| "+n.fillWith(t,c[0]," ")+" | "+n.fillWithRightAligned(r,c[1]," ")+" | "+(n.fillWith(n.stringRepeat("▓",i),c[2],"░")+" |")}).join("\n")),this.callback&&this.callback(h)}},e.prototype.beginFrame=function(){this.checkMeasurementReady(),1==this.state&&(this.nextIndex=0,this.queryRunning=!1,this.activePhases=[],this.begin("Frame"))},e.prototype.finalizeFrame=function(){if(1!=this.state)return void this.checkMeasurementReady();if(this.activePhases.length>1)throw new Error("Unmatched Profiler.begin/end. Too many begins.");var e=this.activePhases[0];this.end(),this.activePhases.push(e),this.state=2,this.checkMeasurementReady()},e.prototype.markTime=function(e){return this.queryRunning&&(this.ext.endQueryEXT(this.ext.TIME_ELAPSED_EXT),this.queryRunning=!1,this.nextIndex++),e||(this.nextIndex>=this.queries.length&&this.queries.push(this.ext.createQueryEXT()),this.ext.beginQueryEXT(this.ext.TIME_ELAPSED_EXT,this.queries[this.nextIndex]),this.queryRunning=!0),this.nextIndex},e}();r.Profiler=i},{"../utils/Utils":57}],8:[function(e,t,r){var n=function(){function e(e){this.renderer=e;var t=e.gl;this.buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.buffer);var r=new Uint8Array([-1,-1,1,-1,-1,1,1,1]);t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW)}return e.prototype.dispose=function(){var e=this.renderer.gl;e.deleteBuffer(this.buffer)},e.prototype.render=function(e){var t=this.renderer.gl;this.renderer.vertexAttribs.toggleAllWithTrueIndex(e),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.vertexAttribPointer(e,2,t.BYTE,!1,2,0),t.drawArrays(t.TRIANGLE_STRIP,0,4)},e}();r.QuadRenderer=n},{}],9:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("./RenderPipeline"),o=function(e){function t(t,r,n,i){switch(e.call(this,t),this.width=r,this.height=n,this.format=i,this.format){case s.R8:case s.R8G8:this.format=s.RGBA8}switch(this.hash=this.width^this.height<<16^this.format<<24^114514,this.cost=this.width*this.height,this.format){case s.RGBA8:this.cost*=4;break;case s.RGBAF16:this.cost*=8;break;case s.Depth:this.cost*=2}}return n(t,e),t.prototype.canMergeWith=function(e){return e instanceof t?this.width==e.width&&this.height==e.height&&this.format==e.format:!1},t.prototype.create=function(e){return new u(e,this.width,this.height,this.format)},Object.defineProperty(t.prototype,"isDepthBuffer",{get:function(){switch(this.format){case s.Depth:return!0;default:return!1}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"physicalFormatDescription",{get:function(){var e=""+this.format;switch(this.format){case s.RGBA8:e="RGBA8";break;case s.SRGBA8:e="sRGBA8";break;case s.RGBAF16:e="RGBAF16";break;case s.Depth:e="Depth"}return"Texture "+this.width+"x"+this.height+" "+e},enumerable:!0,configurable:!0}),t}(i.RenderBufferInfo);r.TextureRenderBufferInfo=o;var a=function(e){function t(t){e.call(this,t),this.cost=0}return n(t,e),t.prototype.create=function(e){return new h},Object.defineProperty(t.prototype,"physicalFormatDescription",{get:function(){return"None"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"Untyped"},enumerable:!0,configurable:!0}),t}(i.RenderBufferInfo);r.DummyRenderBufferInfo=a,function(e){e[e.Depth=0]="Depth",e[e.RGBA8=1]="RGBA8",e[e.SRGBA8=2]="SRGBA8",e[e.RGBAF16=3]="RGBAF16",e[e.R8=4]="R8",e[e.R8G8=5]="R8G8"}(r.TextureRenderBufferFormat||(r.TextureRenderBufferFormat={}));var s=r.TextureRenderBufferFormat,u=function(){function e(e,t,r,n){this.manager=e,this.width=t,this.height=r,this.format=n;var i=e.core.gl;this.texture=null,this.renderbuffer=null;var o;switch(this.format){case s.SRGBA8:if(o=e.core.ext.get("EXT_sRGB"),!o)throw new Error("sRGB not supported");this.texture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.texture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,o.SRGB_ALPHA_EXT,t,r,0,o.SRGB_ALPHA_EXT,i.UNSIGNED_BYTE,null);break;case s.RGBA8:this.texture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.texture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,r,0,i.RGBA,i.UNSIGNED_BYTE,null);break;case s.RGBAF16:if(o=e.core.ext.get("OES_texture_half_float"),!o)throw new Error("RGBAF16 buffer not supported");this.texture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.texture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,r,0,i.RGBA,o.HALF_FLOAT_OES,null);break;case s.Depth:if(o=e.core.ext.get("WEBGL_depth_texture"),!o)throw new Error("Depth texture not supported");this.texture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.texture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.DEPTH_STENCIL,t,r,0,i.DEPTH_STENCIL,o.UNSIGNED_INT_24_8_WEBGL,null)}this.renderbuffer=i.createRenderbuffer()}return e.prototype.dispose=function(){var e=this.manager.core.gl;null!=this.texture&&(e.deleteTexture(this.texture),this.texture=null),null!=this.renderbuffer&&(e.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null)},e.prototype.invalidate=function(){},e}(),h=function(){function e(){}return e.prototype.dispose=function(){},e}()},{"./RenderPipeline":10}],10:[function(e,t,r){function n(e){return e.map(function(e){var t=[],r=[];for(var n in e.inputs)null!=e.inputs[n]&&t.push(n);for(var n in e.outputs)null!=e.outputs[n]&&r.push(n);
var i=[];if(e.bindings)for(var o=0;o<e.bindings.length;o+=2)i.push(t.indexOf(e.bindings[o])),i.push(r.indexOf(e.bindings[o+1]));return{name:e.name,factory:function(n){for(var i={inputs:{},outputs:{}},o=0;o<t.length;++o)i.inputs[t[o]]=n.inputs[o];for(var o=0;o<r.length;++o)i.outputs[r[o]]=n.outputs[o];return e.factory?e.factory(i):null},inputs:t.map(function(t){return e.inputs[t]}),outputs:r.map(function(t){return e.outputs[t]}),bindings:i,optionalOutputs:e.optionalOutputs?e.optionalOutputs.map(function(e){return r.indexOf(e)}):[]}})}function i(e){function t(e){return e.id||(e.id=p++),"n-"+e.id}function r(e){l.push('"'+t(e)+'" [ label="'+e.toString().replace(/ : /g,"\n")+'", shape=none ];\n')}for(var n=[],i=[],o=0,a=0;a<e.length;a++){var s=e[a];for(var u in s.inputs)s.inputs[u]&&(s.inputs[u].num=o++);for(var u in s.outputs)s.outputs[u]&&(s.outputs[u].num=o++)}for(var h=0;h<e.length;h++){var s=e[h];for(var u in s.inputs)if(s.inputs[u]){var c=s.inputs[u].num;n[c]||(n[c]=!0,i.push(s.inputs[u]))}for(var u in s.outputs)if(s.outputs[u]){var c=s.outputs[u].num;n[c]||(n[c]=!0,i.push(s.outputs[u]))}}var l=[];l.push("digraph G {"),l.push('rankdir="LR";\n'),l.push("node [shape=none];\n");for(var p=1,f=0;f<i.length;f++){var u=i[f];t(u),r(u)}for(var d=0;d<e.length;d++){var s=e[d],m=t(s);l.push('"'+m+'" [ label=<<table border="1" cellborder="0" cellpadding="3" bgcolor="white">');var g=[],v=[];for(var x in s.inputs)g.push(x);for(var x in s.outputs)v.push(x);var y=Math.max(g.length,v.length);l.push('<TR><TD bgcolor="black" align="center" colspan="2"><font color="white">'),l.push(s.name+"</font></TD></TR>");for(var _=0;y>_;++_)l.push("<tr>"),_<g.length?l.push('<td align="left" port="in-'+g[_]+'">'+g[_]+"</td>"):l.push('<td align="left"></td>'),_<v.length?l.push('<td align="right" port="out-'+v[_]+'">'+v[_]+"</td>"):l.push('<td align="right"></td>'),l.push("</tr>");l.push("</table>>];\n");for(var b=0;b<g.length;b++){var x=g[b],w=s.inputs[x];w&&l.push('"'+t(w)+'" -> "'+m+'":"in-'+x+'";\n')}for(var T=0;T<v.length;T++){var x=v[T],w=s.outputs[x];w&&l.push('"'+m+'":"out-'+x+'" -> "'+t(w)+'";\n')}}return l.push("}"),l.join("")}var o=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},a=e("../utils/Map");r.preprocessRenderOperations=n;var s=function(){function e(e){this.name=e,this.num=0,this.hash=0,this.cost=0}return e.prototype.canMergeWith=function(e){return this==e},e.prototype.create=function(e){throw new Error("not implemented")},e.prototype.toString=function(){return this.name+" : "+this.logicalFormatDescription+" : "+this.physicalFormatDescription},Object.defineProperty(e.prototype,"physicalFormatDescription",{get:function(){throw new Error("not implemented")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"logicalFormatDescription",{get:function(){return"Untyped"},enumerable:!0,configurable:!0}),e}();r.RenderBufferInfo=s;var u=function(e){function t(){e.apply(this,arguments)}return o(t,e),t.prototype.computeHash=function(e){return e.hash},t.prototype.equals=function(e,t){return e.canMergeWith(t)},t}(a.Map),h=function(){function e(){this.maxNumAllocated=0,this.numAllocated=0}return e.prototype.get=function(){this.numAllocated+=1,this.maxNumAllocated=Math.max(this.maxNumAllocated,this.numAllocated)},e.prototype.release=function(){this.numAllocated-=1},e}(),c=function(){function e(e){this.info=e,this.maxNumAllocated=0,this.numAllocated=0,this.firstFree=null}return e.prototype.get=function(){if(this.numAllocated+=1,null==this.firstFree){var e=this.maxNumAllocated++;return{info:this.info,index:e,next:null}}var t=this.firstFree;return this.firstFree=t.next,t},e.prototype.release=function(e){if(e.next=this.firstFree,this.firstFree=e,this.numAllocated-=1,this.numAllocated<0)throw new Error},e}(),l=function(e){function t(){e.apply(this,arguments)}return o(t,e),t.prototype.getOrCreate=function(e){var t=this.get(e);return null==t&&(t=new h,this.set(e,t)),t},t}(u),p=function(e){function t(){e.apply(this,arguments)}return o(t,e),t.prototype.getOrCreate=function(e){var t=this.get(e);return null==t&&(t=new c(e),this.set(e,t)),t},t}(u);r.dumpRenderOperationAsDot=i;var f=function(){function e(e){this.core=e,this.logger=e.log.getLogger("pipeline"),this.renderBuffers=new u,this.phases=[],this.operators=[],this.outputBuffers=[],this.allRenderBuffers=[]}return e.prototype.dispose=function(){this.clearPipeline(),this.releaseAll()},e.prototype.setup=function(e,t){var r=this,i=n(e);this.clearPipeline();for(var o=0,a=0;a<i.length;a++){for(var s=i[a],h=0,c=s.inputs;h<c.length;h++){var f=c[h];f.num=o++}for(var d=0,m=s.outputs;d<m.length;d++){var f=m[d];f.num=o++}}for(var g=[],v=[],x=[],y=0;y<t.length;y++){var f=t[y];v.push(f),x[f.num]=f}for(;v.length>0;){for(var _=[],b=!1,w=0;w<v.length;w++){var f=v[w];_[f.num]=f}for(var T=0;T<i.length;++T){for(var s=i[T],M=!1,S=0,E=s.outputs;S<E.length;S++){var C=E[S];x[C.num]&&(M=!0)}if(M){g.indexOf(s)<0&&g.push(s);for(var R=0,D=s.outputs;R<D.length;R++){var C=D[R];_[C.num]=null}for(var A=0,P=s.inputs;A<P.length;A++){var L=P[A];_[L.num]||(_[L.num]=L)}b=!0}}if(!b)throw new Error('no driver for one of "'+v.map(function(e){return e.name}).join(", ")+'"');x=_;var B=[];for(var F in _)_[F]&&B.push(_[F]);v=B}for(var G=new p,U=new l,k=[],V=[],I=[],O=g.slice(0),z=[],N=0;N<g.length;N++)for(var s=g[N],j=0,H=s.inputs;j<H.length;j++){var f=H[j];z[f.num]=(z[f.num]||0)+1}for(var X=0;X<t.length;X++){var f=t[X],W={info:f,allocated:G.getOrCreate(f).get()};k.push({binding:W,useCount:1}),I.push(W),z[f.num]=(z[f.num]||0)+1}for(var q=1e3;k.length>0;){if(0==--q)throw new Error("bad");for(var Y=-1,K=-1,T=0;T<O.length;++T){for(var s=O[T],Z=!1,Q=0,J=s.outputs;Q<J.length;Q++){var $=J[Q];if(z[$.num]){for(var ee=!1,te=0;te<k.length;te++){var re=k[te];if(z[re.binding.info.num]==re.useCount&&re.binding.info===$){ee=!0;break}}if(!ee){Z=!0;break}}}if(!Z){for(var ne=0,ie=5,oe=1,ae=[],se=0;se<s.inputs.length;++se){var f=s.inputs[se],ue=G.getOrCreate(f),he=U.getOrCreate(f);he.numAllocated=ue.numAllocated,he.maxNumAllocated=ue.maxNumAllocated}for(var se=0;se<s.inputs.length;++se){for(var ce=s.inputs[se],le=-1,pe=0;pe<s.bindings.length;pe+=2)if(s.bindings[pe]==se){if(-1!=le)throw new Error('operation "%s" has invalid bindings');le=s.bindings[pe+1]}if(le>=0)for(var fe=0;fe<k.length;fe++){var de=k[fe];if(de.binding.info==ce){le=-1;break}}if(0>le){for(var me=!1,ge=0;ge<k.length;ge++){var ve=k[ge];ve.binding.info==ce&&(me=!0)}if(!me&&!ae[ce.num]){var he=U.getOrCreate(ce),xe=he.maxNumAllocated;he.get(),ne+=ce.cost*(he.maxNumAllocated-xe)*ie,ne+=ce.cost*oe,ae[ce.num]=!0}}}for(var se=0;se<s.outputs.length;++se){for(var ye=s.outputs[se],le=-1,pe=0;pe<s.bindings.length;pe+=2)if(s.bindings[pe+1]==se){if(-1!=le)throw new Error('operation "%s" has invalid bindings');le=s.bindings[pe]}if(le>=0)for(var _e=0;_e<k.length;_e++){var de=k[_e];if(de.binding.info==s.inputs[le]){le=-1;break}}if(0>le){var he=U.getOrCreate(ye),xe=he.maxNumAllocated;he.release(),ne+=ye.cost*(he.maxNumAllocated-xe)*ie,ne-=oe}}(-1==Y||K>ne)&&(Y=T,K=ne)}}if(-1==Y)throw new Error("unrealizable dependency graph; remaining needed variables = "+k.map(function(e){return e.binding.info.name}).join(", "));var s=O[Y];O.splice(Y,1);for(var be={operation:s,inputs:[],outputs:[]},pe=0;pe<s.outputs.length;++pe){var we=s.outputs[pe];if(z[we.num]){for(var Te=!1,se=k.length-1;se>=0;--se)if(k[se].binding.info==we){if(k[se].useCount!=z[we.num])throw new Error;be.outputs.push(k[se].binding.allocated),k.splice(se,1),Te=!0;break}if(!Te)throw new Error}else if(s.optionalOutputs.indexOf(pe)>=0)be.outputs.push(null);else{var W=G.getOrCreate(we).get();be.outputs.push(W)}}for(var pe=0;pe<s.inputs.length;++pe){for(var ce=s.inputs[pe],le=-1,se=0;se<s.bindings.length;se+=2)if(s.bindings[se]==pe){if(-1!=le)throw new Error('operation "%s" has invalid bindings');le=s.bindings[se+1]}if(le>=0){for(var Me=0;Me<k.length;Me++){var de=k[Me];if(de.binding.info==ce){le=-1;break}}if(le>=0){be.inputs.push(be.outputs[le]),k.push({binding:{info:ce,allocated:be.outputs[le]},useCount:1});continue}}for(var me=!1,Se=0;Se<k.length;Se++){var de=k[Se];if(de.binding.info==ce){de.useCount+=1,be.inputs.push(de.binding.allocated),me=!0;break}}if(!me){var W=G.getOrCreate(ce).get();be.inputs.push(W),k.push({binding:{info:ce,allocated:W},useCount:1})}}if(be.inputs.length!=s.inputs.length||be.outputs.length!=s.outputs.length)throw new Error;for(var se=0;se<s.outputs.length;++se){for(var le=-1,pe=0;pe<s.bindings.length;pe+=2)if(s.bindings[pe+1]==se){if(-1!=le)throw new Error('operation "'+s.name+'" has invalid bindings');le=s.bindings[pe]}le>=0&&be.inputs[le]!=be.outputs[se]&&(le=-1),0>le&&be.outputs[se]&&G.getOrCreate(be.outputs[se].info).release(be.outputs[se])}V.unshift(be)}if(this.phases=V,this.logger.isEnabled){this.logger.log("--- Pipeline Compilation Done ----");for(var Ee=0;Ee<V.length;Ee++){var be=V[Ee];this.logger.log(be.outputs.map(function(e){return e?e.info.physicalFormatDescription+"["+e.index+"]":"_"}).join(", ")+" := "+be.operation.name+"("+be.inputs.map(function(e){return e.info.physicalFormatDescription+"["+e.index+"]"}).join(", ")+")")}var Ce=0;G.forEach(function(e,t){r.logger.log(t.info.physicalFormatDescription+" (cost="+t.info.cost+") x "+t.maxNumAllocated+" = "+t.maxNumAllocated*t.info.cost),Ce+=t.maxNumAllocated*t.info.cost}),this.logger.log("Total Cost = "+Ce)}this.renderBuffers.forEach(function(e,t){for(var r=G.get(e),n=r?r.maxNumAllocated:0,i=t.renderBuffers;i.length>n;){var o=i.pop();o.dispose()}}),this.allRenderBuffers=[];var Re=new u;G.forEach(function(e,t){for(var n=r.renderBuffers.get(e),i=n?n.renderBuffers:[],o=t.maxNumAllocated;i.length<o;)i.push(e.create(r));Re.set(e,{renderBuffers:i});for(var a=0;a<i.length;a++){var s=i[a];r.allRenderBuffers.push(s)}}),this.operators=V.map(function(e){return e.operation.factory({inputs:e.inputs.map(function(e){return Re.get(e.info).renderBuffers[e.index]}),outputs:e.outputs.map(function(e){return e?Re.get(e.info).renderBuffers[e.index]:null})})}),this.outputBuffers=I.map(function(e){return Re.get(e.info).renderBuffers[e.allocated.index]}),this.renderBuffers=Re},e.prototype.render=function(){this.renderPartial(this.numPhases)},Object.defineProperty(e.prototype,"numPhases",{get:function(){return this.operators.length},enumerable:!0,configurable:!0}),e.prototype.getPhaseName=function(e){return this.phases[e].operation.name},e.prototype.renderPartial=function(e){var t=this.core.profiler;t.begin("Before Render");for(var r=0;e>r;++r)this.operators[r].beforeRender();t.end(),t.begin("Render");for(var r=0;e>r;++r)t.begin(this.getPhaseName(r)),this.operators[r].perform(),t.end();t.end(),t.begin("After Render");for(var r=0;e>r;++r)this.operators[r].afterRender();t.end()},e.prototype.clearPipeline=function(){for(var e=0,t=this.operators;e<t.length;e++){var r=t[e];r.dispose()}this.operators=[],this.outputBuffers=[],this.allRenderBuffers=[]},e.prototype.releaseAll=function(){this.renderBuffers.forEach(function(e,t){for(var r=0,n=t.renderBuffers;r<n.length;r++){var i=n[r];i.dispose()}}),this.renderBuffers=new u},e}();r.RenderPipeline=f},{"../utils/Map":53}],11:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("three"),o=e("../render/TextureManager"),a=e("../render/TextureProvider"),s=e("../render/ReflectionTextureProvider"),u=e("../utils/BitArray"),h=e("../render/GeometryRenderer"),c=e("../render/ShadowMapRenderer"),l=e("../render/GeometryManager"),p=e("../render/LightRenderer"),f=e("../render/ReflectionRenderer"),d=e("../render/HdrDemosaicFilter"),m=e("./JitterTexture"),g=e("./QuadRenderer"),v=e("./ShaderManager"),x=e("./Visualizer"),y=e("../postfx/ToneMappingFilter"),_=e("../postfx/MotionBlurFilter"),b=e("../postfx/ResampleFilter"),w=e("../postfx/SSAORenderer"),T=e("../postfx/TemporalAAFilter"),M=e("../postfx/BloomFilter"),S=e("../postfx/HdrCompressFilter"),E=e("./RendererParameters"),C=e("./RenderPipeline"),R=e("./TypedRenderBuffers"),D=e("../utils/Geometry"),A=e("../validator/SRGBValidator"),P=e("../validator/FPColorBufferValidator"),L=e("../utils/Logger"),B=e("./Profiler");!function(e){e[e.NativeHdr=0]="NativeHdr",e[e.MobileHdr=1]="MobileHdr"}(r.HdrMode||(r.HdrMode={}));var F=r.HdrMode,G=function(){function e(e,t){if(this.gl=e,this.params=t,null==t&&(this.params=t={}),this.log=new L.LogManager,"object"==typeof t.log){var r=t.log;for(var n in r)r[n]&&this.log.enableTopic(n)}else"boolean"==typeof t.log&&t.log&&this.log.enableAllTopics();if(this.parameters=new E.RendererCoreParameters(this),this.useFullResolutionGBuffer=null==t.useFullResolutionGBuffer?!1:t.useFullResolutionGBuffer,this.ext=new i.WebGLExtensions(this.gl),this.ext.get("OES_texture_float"),this.ext.get("OES_texture_float_linear"),this.ext.get("OES_texture_half_float"),this.ext.get("OES_texture_half_float_linear"),this.ext.get("OES_standard_derivatives"),this.ext.get("EXT_frag_depth"),!this.ext.get("WEBGL_depth_texture"))throw new Error("required WebGL extension WEBGL_depth_texture is not supported.");if(!this.ext.get("EXT_shader_texture_lod"))throw new Error("required WebGL extension EXT_shader_texture_lod is not supported.");this.supportsSRGB=!!this.ext.get("EXT_sRGB"),this.supportsHdrTexture=!(!this.ext.get("OES_texture_half_float")||!this.ext.get("OES_texture_half_float_linear")),this.supportsHdrRenderingBuffer=!1,this.hdrMode=F.MobileHdr,this.renderWidth=this.width=e.drawingBufferWidth,this.renderHeight=this.height=e.drawingBufferHeight,this.deferGC=!1,this.depthFar=1e3,this.shadowCasterBounds=null,this.sceneBounds=null,this.setup()}return Object.defineProperty(e.prototype,"useWiderTemporalAA",{get:function(){return!this.useFullResolutionGBuffer},enumerable:!0,configurable:!0}),e.prototype.setup=function(){this.shaderManager=v.createShaderManager(this),this.vertexAttribs=new U(this.gl),this.state=new k(this.gl),this.profiler=new B.Profiler(this,this.log.getLogger("profiler")),this.quadRenderer=new g.QuadRenderer(this),this.supportsSRGB&&(A.validateSRGBCompliance(this)||(console.warn("WebGLHyperRenderer: defective EXT_sRGB detected; disabling sRGB support."),this.supportsSRGB=!1)),P.validateHalfFloatColorBuffer(this)&&(this.supportsHdrRenderingBuffer=!0),this.hdrMode=this.supportsHdrRenderingBuffer&&this.params.useFPBuffer?F.NativeHdr:F.MobileHdr,this.shaderManager.setGlobalParameter("globalUseFullResolutionGBuffer",this.useFullResolutionGBuffer),this.shaderManager.setGlobalParameter("globalSupportsSRGB",this.supportsSRGB),this.updateGlobalUniforms(),this.textures=new o.TextureManager(this,new a.Texture2DProvider),this.textureCubes=new o.TextureManager(this,new a.TextureCubeProvider),this.reflectionTextures=new o.TextureManager(this,new s.ReflectionTextureCubeProvider(this)),this.geometryManager=new l.GeometryManager(this),this.renderBuffers=new C.RenderPipeline(this),this.uniformJitter=new m.UniformJitterTexture(this.gl),this.gaussianJitter=new m.GaussianJitterTexture(this.gl),this.uniformDitherJitter=new m.DitherJitterTexture(this.gl),this.gaussianDitherJitter=new m.GaussianDitherJitterTexture(this.gl),this.geometryRenderer=new h.GeometryRenderer(this),this.shadowRenderer=new c.ShadowMapRenderer(this),this.passthroughRenderer=new V(this),this.bufferVisualizer=new x.BufferVisualizer(this),this.lightRenderer=new p.LightRenderer(this),this.reflectionRenderer=new f.ReflectionRenderer(this),this.hdrDemosaic=new d.HdrDemosaicFilterRenderer(this),this.ssaoRenderer=new w.SSAORenderer(this),this.resampler=new b.ResampleFilterRenderer(this),this.toneMapFilter=new y.ToneMappingFilterRenderer(this),this.temporalAA=new T.TemporalAAFilterRenderer(this,{useWiderFilter:this.useWiderTemporalAA}),this.bloom=new M.BloomFilterRenderer(this),this.motionBlur=new _.MotionBlurFilterRenderer(this),this.hdrCompress=new S.HdrCompressFilter(this),this.compilePipeline()},e.prototype.updateGlobalUniforms=function(){this.shaderManager.setGlobalUniform("globalRenderSize",!0,this.renderWidth,this.renderHeight),this.shaderManager.setGlobalUniform("globalQuadRenderSize",!0,4*this.renderWidth,4*this.renderHeight),this.shaderManager.setGlobalUniform("globalDoubleRenderSize",!0,2*this.renderWidth,2*this.renderHeight),this.shaderManager.setGlobalUniform("globalHalfRenderSize",!0,.5*this.renderWidth,.5*this.renderHeight),this.shaderManager.setGlobalUniform("globalQuadInvRenderSize",!0,4/this.renderWidth,4/this.renderHeight),this.shaderManager.setGlobalUniform("globalDoubleInvRenderSize",!0,2/this.renderWidth,2/this.renderHeight),this.shaderManager.setGlobalUniform("globalInvRenderSize",!0,1/this.renderWidth,1/this.renderHeight),this.shaderManager.setGlobalUniform("globalHalfInvRenderSize",!0,.5/this.renderWidth,.5/this.renderHeight),this.shaderManager.setGlobalUniform("globalQuarterInvRenderSize",!0,.25/this.renderWidth,.25/this.renderHeight),this.shaderManager.setGlobalUniform("globalDepthFar",!0,this.depthFar),this.shaderManager.setGlobalUniform("globalInvDepthFar",!0,1/this.depthFar)},e.prototype.dispose=function(){this.motionBlur.dispose(),this.bloom.dispose(),this.temporalAA.dispose(),this.toneMapFilter.dispose(),this.resampler.dispose(),this.ssaoRenderer.dispose(),this.hdrDemosaic.dispose(),this.reflectionRenderer.dispose(),this.lightRenderer.dispose(),this.bufferVisualizer.dispose(),this.passthroughRenderer.dispose(),this.geometryRenderer.dispose(),this.shadowRenderer.dispose(),this.textures.dispose(),this.quadRenderer.dispose(),this.geometryManager.dispose(),this.renderBuffers.dispose(),this.uniformDitherJitter.dispose(),this.gaussianDitherJitter.dispose(),this.uniformJitter.dispose(),this.gaussianJitter.dispose(),this.shaderManager.dispose(),this.hdrCompress.dispose(),this.profiler.dispose()},e.prototype.compilePipeline=function(){var e=[],t=this.geometryRenderer.setupGeometryPass(this.width,this.height,e),r=this.resampler.setupNearestResampler(t.linearDepth,{outWidth:t.linearDepth.width+1>>1,outHeight:t.linearDepth.height+1>>1},e),n=this.shadowRenderer.setupShadowPass(e),i=this.ssaoRenderer.setupFilter({g2:t.g2,linearDepth:t.linearDepth,linearDepthHalf:r},e),o=this.hdrMode==F.MobileHdr?this.lightRenderer.setupMobileHdrLightPass({g0:t.g0,g1:t.g1,g2:t.g2,g3:t.g3,linearDepth:t.linearDepth,depth:t.depth,shadowMaps:n.shadowMaps,ssao:i.output},e):this.lightRenderer.setupNativeHdrLightPass({g0:t.g0,g1:t.g1,g2:t.g2,g3:t.g3,linearDepth:t.linearDepth,depth:t.depth,shadowMaps:n.shadowMaps,ssao:i.output},e),a=this.reflectionRenderer.setupReflectionPass({g0:t.g0,g1:t.g1,g2:t.g2,g3:t.g3,linearDepth:t.linearDepth,depth:t.depth,ssao:i.output,lit:o},e),s=a instanceof R.HdrMosaicTextureRenderBufferInfo?this.hdrDemosaic.setupFilter(a,{halfSized:!1},e):a;this.hdrMode==F.NativeHdr&&(s=this.hdrCompress.setupFilter(s,0,1,1,e),s=this.temporalAA.setupFilter({color:s,linearDepth:t.linearDepth,g0:t.g0,g1:t.g1},e),s=this.hdrCompress.setupFilter(s,0,0,1,e)),s=this.motionBlur.setupFilter({color:s,g0:t.g0,g1:t.g1,linearDepth:t.linearDepth},{maxBlur:Math.max(this.renderWidth,this.renderHeight)/40},e),s=this.bloom.setupFilter(s,e);var u=this.toneMapFilter.setupFilter(s,e);this.hdrMode==F.MobileHdr&&(u=this.temporalAA.setupFilter({color:u,linearDepth:t.linearDepth,g0:t.g0,g1:t.g1},e));var h=u,c=this.bufferVisualizer.setupColorVisualizer(h,e),l=this.log.getLogger("pipeline");l.isEnabled&&l.log(C.dumpRenderOperationAsDot(e)),this.renderBuffers.setup(e,[c])},e.prototype.startProfiling=function(e){this.profiler.startProfiling(e)},e.prototype.stopProfiling=function(){this.profiler.stopProfiling()},e.prototype.invalidateFramebuffer=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];for(var r=0,n=this.gl,i=0;i<e.length;++i)switch(e[i]){case n.COLOR_ATTACHMENT0:r|=n.COLOR_BUFFER_BIT;break;case n.DEPTH_ATTACHMENT:r|=n.DEPTH_BUFFER_BIT;break;case n.STENCIL_ATTACHMENT:r|=n.STENCIL_BUFFER_BIT;break;case n.DEPTH_STENCIL_ATTACHMENT:r|=n.DEPTH_BUFFER_BIT,r|=n.STENCIL_BUFFER_BIT}0==e.length&&(r=n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT),n.clear(r)},e.prototype.render=function(e,t){this.currentScene=e,this.currentCamera=t,this.uniformJitter.update(),this.gaussianJitter.update(),this.uniformDitherJitter.update(),this.gaussianDitherJitter.update(),this.sceneBounds=(new D.ObjectBoundingBoxCalculator).computeBoundingBox(e,this.sceneBounds),this.shadowCasterBounds=(new D.ShadowCastingObjectBoundingBoxCalculator).computeBoundingBox(e,this.shadowCasterBounds);var r=t.projectionMatrix,n=D.computeFarDepthFromProjectionMatrix(r);n!=this.depthFar&&(this.depthFar=n,this.updateGlobalUniforms()),e.autoUpdate&&e.updateMatrixWorld(!1),t.parent||t.updateMatrixWorld(!1),e.traverse(function(e){e instanceof i.SkinnedMesh&&e.skeleton.update()}),t.matrixWorldInverse.getInverse(t.matrixWorld),this.profiler.beginFrame(),this.renderBuffers.render(),this.profiler.finalizeFrame()},e.prototype.setSize=function(e,t){if(1&e)throw new Error("width cannot be odd");if(1&t)throw new Error("height cannot be odd");e=Math.max(0|e,2),t=Math.max(0|t,2),this.renderWidth=this.width=e,this.renderHeight=this.height=t,this.updateGlobalUniforms(),this.compilePipeline()},e}();r.RendererCore=G;var U=function(e){function t(t){e.call(this),this.gl=t}return n(t,e),t.prototype.onToggledTrue=function(e){this.gl.enableVertexAttribArray(e)},t.prototype.onToggledFalse=function(e){this.gl.disableVertexAttribArray(e)},t}(u.BitArray),k=function(){function e(e){this.gl=e,e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.disable(e.BLEND),e.depthMask(!0),e.colorMask(!0,!0,!0,!0),e.enable(e.CULL_FACE),e.frontFace(e.CCW),this.flags_=0}return Object.defineProperty(e.prototype,"flags",{get:function(){return this.flags_},set:function(e){var t=e^this.flags_;if(t){var r=this.gl;1&t&&(1&e?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST)),2&t&&(2&e?r.depthMask(!1):r.depthMask(!0)),240&t&&r.colorMask(!(16&e),!(32&e),!(64&e),!(128&e)),4&t&&(4&e?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST)),8&t&&(8&e?r.enable(r.BLEND):r.disable(r.BLEND)),256&t&&(256&e?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE)),512&t&&(512&e?r.frontFace(r.CW):r.frontFace(r.CCW)),this.flags_=e}},enumerable:!0,configurable:!0}),e}(),V=function(){function e(e){this.core=e;var t=e.shaderManager.get("VS_Passthrough","FS_Passthrough",["a_position"]);this.normal={program:t,uniforms:t.getUniforms(["u_uvScale","u_texture"]),attrs:t.getAttributes(["a_position"])};var t=e.shaderManager.get("VS_Passthrough","FS_PassthroughModulated",["a_position"]);this.modulated={program:t,uniforms:t.getUniforms(["u_uvScale","u_texture","u_modulation"]),attrs:t.getAttributes(["a_position"])}}return e.prototype.dispose=function(){},e.prototype.render=function(){var e=this.core.gl,t=this.normal;t.program.use(),e.uniform4f(t.uniforms.u_uvScale,.5,.5,.5,.5),e.uniform1i(t.uniforms.u_texture,0),this.core.quadRenderer.render(t.attrs.a_position)},e.prototype.renderModulated=function(e,t,r,n){var i=this.core.gl,o=this.modulated;o.program.use(),i.uniform4f(o.uniforms.u_uvScale,.5,.5,.5,.5),i.uniform1i(o.uniforms.u_texture,0),i.uniform4f(o.uniforms.u_modulation,e,t,r,n),this.core.quadRenderer.render(o.attrs.a_position)},e}()},{"../postfx/BloomFilter":19,"../postfx/HdrCompressFilter":21,"../postfx/MotionBlurFilter":22,"../postfx/ResampleFilter":23,"../postfx/SSAORenderer":24,"../postfx/TemporalAAFilter":26,"../postfx/ToneMappingFilter":27,"../render/GeometryManager":35,"../render/GeometryRenderer":36,"../render/HdrDemosaicFilter":37,"../render/LightRenderer":38,"../render/ReflectionRenderer":40,"../render/ReflectionTextureProvider":41,"../render/ShadowMapRenderer":43,"../render/TextureManager":45,"../render/TextureProvider":46,"../utils/BitArray":48,"../utils/Geometry":49,"../utils/Logger":52,"../validator/FPColorBufferValidator":58,"../validator/SRGBValidator":59,"./JitterTexture":6,"./Profiler":7,"./QuadRenderer":8,"./RenderPipeline":10,"./RendererParameters":12,"./ShaderManager":13,"./TypedRenderBuffers":15,"./Visualizer":16,three:"three"}],12:[function(e,t,r){var n=function(){function e(e){this.core=e}return Object.defineProperty(e.prototype,"bloomAmount",{get:function(){return this.core.bloom.params.amount},set:function(e){this.core.bloom.params.amount=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bloomSaturation",{get:function(){return this.core.bloom.params.saturation},set:function(e){this.core.bloom.params.saturation=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bloomTexture",{get:function(){return this.core.bloom.params.texture},set:function(e){this.core.bloom.params.texture=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"motionBlurAmount",{get:function(){return this.core.motionBlur.amount},set:function(e){this.core.motionBlur.amount=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"exposureBias",{get:function(){return this.core.toneMapFilter.params.exposureBias},set:function(e){this.core.toneMapFilter.params.exposureBias=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vignette",{get:function(){return this.core.toneMapFilter.params.vignette},set:function(e){this.core.toneMapFilter.params.vignette=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"autoExposureEnabled",{get:function(){return this.core.toneMapFilter.params.autoExposureEnabled},set:function(e){this.core.toneMapFilter.params.autoExposureEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this.core.toneMapFilter.params.color},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"highlightCrush",{get:function(){return this.core.toneMapFilter.params.highlightCrush},set:function(e){this.core.toneMapFilter.params.highlightCrush=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contrast",{get:function(){return this.core.toneMapFilter.params.contrast},set:function(e){this.core.toneMapFilter.params.contrast=e},enumerable:!0,configurable:!0}),e}();r.RendererCoreParameters=n},{}],13:[function(e,t,r){function n(e){return new s(e)}var i=e("../core/GLProgram"),o=e("../core/GLShader"),a=function(){function e(e,t){this.program=e,this.manager=t,this.lastGlobalUniformStructureVersion=null,this.lastGlobalUniformVersion=null,this.globalUniforms=null}return e.prototype.updateGlobalUniforms=function(){var e=this.manager;if(e.globalUniformVersion!==this.lastGlobalUniformVersion){if(this.lastGlobalUniformVersion=e.globalUniformVersion,e.globalUniformStructureVersion!=this.lastGlobalUniformStructureVersion){this.lastGlobalUniformStructureVersion=e.globalUniformStructureVersion;for(var t=this.program.getUniforms(e.globalUniforms.map(function(e){return"u_"+e.name})),r=[],n=0,i=e.globalUniforms;n<i.length;n++){var o=i[n],a=t["u_"+o.name];null!=a&&r.push({index:a,unif:o})}this.globalUniforms=r}for(var s=this.manager.core.gl,u=0,h=this.globalUniforms;u<h.length;u++){var r=h[u],c=r.unif.value;if(r.unif.isIntegral)switch(c.length){case 1:s.uniform1i(r.index,c[0]);break;case 2:s.uniform2i(r.index,c[0],c[1]);break;case 3:s.uniform3i(r.index,c[0],c[1],c[2]);break;case 4:s.uniform4i(r.index,c[0],c[1],c[2],c[3]);break;default:throw new Error}else switch(c.length){case 1:s.uniform1f(r.index,c[0]);break;case 2:s.uniform2f(r.index,c[0],c[1]);break;case 3:s.uniform3f(r.index,c[0],c[1],c[2]);break;case 4:s.uniform4f(r.index,c[0],c[1],c[2],c[3]);break;default:throw new Error}}}},e}();r.createShaderManager=n;var s=function(){function e(e){this.core=e,this.programs={},this.frags={},this.verts={},this.globalParameters={},this.globalUniforms=[],this.globalUniformStructureVersion={},this.globalUniformVersion={},this.globalUniformMap=[]}return e.prototype.dispose=function(){},e.prototype.subscribeGlobalUniforms=function(e){return new a(e,this)},e.prototype.setGlobalParameter=function(e,t){this.globalParameters[e]=t},e.prototype.setGlobalUniform=function(e,t,r,n,i,o){var a,s=this.globalUniformMap[e];null==s&&(s=this.globalUniforms.length,this.globalUniformMap[e]=s,this.globalUniforms.push(a={name:e,value:[0],isIntegral:!t}),this.globalUniformStructureVersion={});var u=this.globalUniforms[s].value;u[0]=r,null!=n?(u[1]=n,null!=i?(u[2]=i,null!=o?u[3]=o:u.length>3&&(u.length=3)):u.length>2&&(u.length=2)):u.length>1&&(u.length=1),this.globalUniformVersion={}},e.prototype.getShader=function(e,t,r,n){var i=[r];for(var a in n)i.push(a),i.push(String(n[a]));var s=i.join("_"),u=e[s];if(!u){var h=o.GLShader.preprocess(this.core,[{requires:[r],source:""}],n,t);u=o.GLShader.compile(this.core,t,h),e[s]=u}return u},e.prototype.get=function(e,t,r,n){var o=[e,"-",t];for(var a in n)o.push(a),o.push(String(n[a]));var s=o.join("_"),u=this.core.gl,h=this.programs[s];return h||(h=i.GLProgram.link(this.core,[this.getShader(this.verts,u.VERTEX_SHADER,e,n),this.getShader(this.verts,u.FRAGMENT_SHADER,t,n)],r),this.programs[s]=h),h},e}()},{"../core/GLProgram":4,"../core/GLShader":5}],14:[function(e,t,r){var n=e("../shaders/ShaderChunk");r.shaderChunks=n.shaderChunks},{"../shaders/ShaderChunk":47}],15:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("./RenderBuffers"),o=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"LogRGB"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.LogRGBTextureRenderBufferInfo=o;var a=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"Linear RGB"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.LinearRGBTextureRenderBufferInfo=a;var s=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"HDR Mosaic"},enumerable:!0,configurable:!0}),t}(i.TextureRenderBufferInfo);r.HdrMosaicTextureRenderBufferInfo=s;var u=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"Mosaiced G-Buffer"},enumerable:!0,configurable:!0}),t}(i.TextureRenderBufferInfo);r.GBufferMosaicTextureRenderBufferInfo=u;var h=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"Depth"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.DepthTextureRenderBufferInfo=h;var c=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"Linearized Depth"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.LinearDepthTextureRenderBufferInfo=c;var l=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"G0"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.GBuffer0TextureRenderBufferInfo=l;var p=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"G1"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.GBuffer1TextureRenderBufferInfo=p;
var f=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"G2"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.GBuffer2TextureRenderBufferInfo=f;var d=function(e){function t(){e.apply(this,arguments)}return n(t,e),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"G3"},enumerable:!0,configurable:!0}),t.prototype.cloneWithDimension=function(e,r,n){return new t(e,r,n,this.format)},t}(i.TextureRenderBufferInfo);r.GBuffer3TextureRenderBufferInfo=d},{"./RenderBuffers":9}],16:[function(e,t,r){var n=e("./RenderBuffers"),i=function(){function e(e){this.core=e}return e.prototype.dispose=function(){},e.prototype.setupColorVisualizer=function(e,t){var r=this,i=new n.DummyRenderBufferInfo("Visualized Output");return t.push({inputs:{input:e},outputs:{output:i},optionalOutputs:["output"],name:"Visualize Color Buffer",factory:function(e){return new o(r.core,e.inputs.input,"FS_VisualizeColor")}}),i},e.prototype.setupLinearDepthVisualizer=function(e,t){var r=this,i=new n.DummyRenderBufferInfo("Visualized Output");return t.push({inputs:{input:e},outputs:{output:i},optionalOutputs:["output"],name:"Visualize Linear Depth Buffer",factory:function(e){return new o(r.core,e.inputs.input,"FS_VisualizeLinearDepth")}}),i},e.prototype.setupGBufferVisualizer=function(e,t,r){var i=this,o=new n.DummyRenderBufferInfo("Visualized Output"),s=""+t;switch(t){case 0:s="Albedo";break;case 1:s="Normal";break;case 2:s="Velocity";break;case 3:s="Roughness";break;case 4:s="Metallic";break;case 5:s="Specular";break;case 6:s="Preshaded";break;case 7:s="MaterialId"}return r.push({inputs:{g0:e.g0,g1:e.g1,g2:e.g2,g3:e.g3},outputs:{output:o},optionalOutputs:["output"],name:"Visualize "+t,factory:function(e){return new a(i.core,e.inputs.g0,e.inputs.g1,e.inputs.g2,e.inputs.g3,t)}}),o},e}();r.BufferVisualizer=i;var o=function(){function e(e,t,r){this.core=e,this.input=t,this.shader=r,this.program=e.shaderManager.get("VS_Passthrough",r,["a_position"]),this.attributes=this.program.getAttributes(["a_position"]),this.uniforms=this.program.getUniforms(["u_texture","u_uvScale"])}return e.prototype.dispose=function(){},e.prototype.beforeRender=function(){},e.prototype.perform=function(){var e=this.core.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture),this.program.use(),e.uniform1i(this.uniforms.u_texture,0),e.uniform4f(this.uniforms.u_uvScale,.5,.5,.5,.5),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT),this.core.state.flags=0;var t=this.core.quadRenderer;t.render(this.attributes.a_position)},e.prototype.afterRender=function(){},e}(),a=function(){function e(e,t,r,n,i,o){this.core=e,this.inG0=t,this.inG1=r,this.inG2=n,this.inG3=i,this.type=o,this.program=e.shaderManager.get("VS_Passthrough","FS_VisualizeGBuffer",["a_position"],{visualizedAttribute:o}),this.attributes=this.program.getAttributes(["a_position"]),this.uniforms=this.program.getUniforms(["u_g0","u_g1","u_g2","u_g3","u_uvScale"])}return e.prototype.dispose=function(){},e.prototype.beforeRender=function(){},e.prototype.perform=function(){var e=this.core.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inG0.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inG1.texture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.inG2.texture),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,this.inG3.texture),this.program.use(),e.uniform1i(this.uniforms.u_g0,0),e.uniform1i(this.uniforms.u_g1,1),e.uniform1i(this.uniforms.u_g2,2),e.uniform1i(this.uniforms.u_g3,3),e.uniform4f(this.uniforms.u_uvScale,.5,.5,.5,.5),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT),this.core.state.flags=0;var t=this.core.quadRenderer;t.render(this.attributes.a_position)},e.prototype.afterRender=function(){},e}()},{"./RenderBuffers":9}],17:[function(e,t,r){arguments[4][14][0].apply(r,arguments)},{"../shaders/ShaderChunk":47,dup:14}],18:[function(e,t,r){var n=e("../core/RenderBuffers"),i=e("../core/GLFramebuffer"),o=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t,r){var i=this,o=t.outWidth,s=t.outHeight,u=t.dir,h={output:new n.TextureRenderBufferInfo(0==u?"H Bilateral Result":"V Bilateral Result",o,s,n.TextureRenderBufferFormat.R8)};return r.push({inputs:{input:e.input,linearDepth:e.linearDepth},outputs:{output:h.output},bindings:[],optionalOutputs:[],name:0==u?"H Bilateral Filter":"V Bilateral Filter",factory:function(e){return new a(i,e.inputs.input,e.inputs.linearDepth,e.outputs.output,t)}}),h},e}();r.BilateralFilterRenderer=o;var a=function(){function e(e,t,r,n,o){this.parent=e,this.input=t,this.inLinearDepth=r,this.out=n,this.params=o,this.fb=i.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[n.texture]});var a=e.renderer.shaderManager.get("VS_BilateralFilter","FS_BilateralFilter",["a_position"]);this.program={program:a,uniforms:a.getUniforms(["u_input","u_linearDepth","u_texCoordOffset"]),attributes:a.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_input,0),e.uniform1i(t.uniforms.u_linearDepth,1);var r=this.params.kernelScale/this.out.width,n=this.params.kernelScale/this.out.height;switch(this.params.dir){case 0:n=0;break;case 1:r=0}e.uniform2f(t.uniforms.u_texCoordOffset,r,n);var i=this.parent.renderer.quadRenderer;i.render(t.attributes.a_position),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}();r.BilateralFilterRendererInstance=a},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9}],19:[function(e,t,r){var n=e("three"),i=e("../core/TypedRenderBuffers"),o=e("../core/GLFramebuffer"),a=e("./BlurFilter"),s=e("./SimpleOps"),u=e("./ResampleFilter"),h=function(){function e(e){this.renderer=e,this.params={amount:.5,saturation:1,texture:null,textureZoom:1},this.resampler=new u.ResampleFilterRenderer(e),this.blurFlt=new a.GaussianBlurFilterRenderer(e),this.adder=new s.BufferAdder(e)}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t){var r,o=this,a=1/128;this.renderer.supportsSRGB||(a=1/16),e instanceof i.LinearRGBTextureRenderBufferInfo&&(a=1),e instanceof i.LogRGBTextureRenderBufferInfo?(r=new i.LinearRGBTextureRenderBufferInfo("Bloom 1/2",e.width+1>>1,e.height+1>>1,e.format),t.push({inputs:{input:e},outputs:{output:r},bindings:[],optionalOutputs:[],name:"Resample and Convert To Linear RGB",factory:function(e){return new c(o,e.inputs.input,e.outputs.output,a)}})):(r=this.resampler.setupLinearResampler(e,{outWidth:e.width+1>>1,outHeight:e.height+1>>1},t),r.name="Bloom 1/2");for(var s=[],u=r,h=0;6>h;++h){var p=4<<h;if(e.width<4*p||e.height<4*p)break;var f=this.resampler.setupLinearResampler(u,{outWidth:e.width+p-1>>h+2,outHeight:e.height+p-1>>h+2},t);if(f.name="Bloom 1/"+p,1>h)u=f;else{var d=this.blurFlt.setupFilter(f,2,t);d.name="Bloom 1/"+p+" LPFed",s.push(d),u=d}}for(var h=s.length-2;h>=0;--h){var m=1.5;u=this.adder.setupFilter(s[h],u,new n.Vector4(m,m,m,m),t)}var g=e instanceof i.LinearRGBTextureRenderBufferInfo?new i.LinearRGBTextureRenderBufferInfo("Bloom Added",e.width,e.height,e.format):new i.LogRGBTextureRenderBufferInfo("Bloom Added",e.width,e.height,e.format);return t.push({inputs:{input:e,bloom:u},outputs:{output:g},bindings:[],optionalOutputs:[],name:"Combine Bloom",factory:function(t){return new l(o,t.inputs.input,t.inputs.bloom,t.outputs.output,e instanceof i.LogRGBTextureRenderBufferInfo,1/32/a)}}),g},e}();r.BloomFilterRenderer=h;var c=function(){function e(e,t,r,n){this.parent=e,this.input=t,this.out=r,this.gain=n,this.fb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var i=e.renderer.shaderManager.get("VS_BloomDownsample","FS_BloomDownsample",["a_position"]);this.program={program:i,uniforms:i.getUniforms(["u_input","u_gain","u_texCoordOffset"]),attributes:i.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_input,0),e.uniform1f(t.uniforms.u_gain,.25*this.gain),e.uniform2f(t.uniforms.u_texCoordOffset,.5/this.input.width,.5/this.input.height);var r=this.parent.renderer.quadRenderer;r.render(t.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}(),l=function(){function e(e,t,r,n,i,a){this.parent=e,this.input=t,this.bloom=r,this.out=n,this.gain=a,this.fb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[n.texture]}),this.program=[];for(var s=0;2>s;++s){var u=e.renderer.shaderManager.get("VS_Bloom","FS_Bloom",["a_position"],{useLogRGB:i,hasTexture:0!=(1&s)});this.program.push({program:u,uniforms:u.getUniforms(["u_input","u_bloom","u_texture","u_strength","u_saturation","u_dustScale"]),attributes:u.getAttributes(["a_position"])})}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.bloom.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);var t=this.parent.renderer.textures.get(this.parent.params.texture);t&&(e.activeTexture(e.TEXTURE2),t.bind());var r=0;t&&(r|=1);var n=this.program[r];n.program.use(),e.uniform1i(n.uniforms.u_input,0),e.uniform1i(n.uniforms.u_bloom,1),e.uniform1i(n.uniforms.u_texture,2);var i=this.parent.params;e.uniform1f(n.uniforms.u_strength,i.amount*this.gain),e.uniform1f(n.uniforms.u_saturation,i.saturation),e.uniform2f(n.uniforms.u_texCoordOffset,.5/this.input.width,.5/this.input.height),e.uniform2f(n.uniforms.u_dustScale,.5*this.input.width/(Math.max(this.input.width,this.input.height)*i.textureZoom),.5*this.input.height/(Math.max(this.input.width,this.input.height)*i.textureZoom));var o=this.parent.renderer.quadRenderer;o.render(n.attributes.a_position),e.activeTexture(e.TEXTURE1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/TypedRenderBuffers":15,"./BlurFilter":20,"./ResampleFilter":23,"./SimpleOps":25,three:"three"}],20:[function(e,t,r){var n=e("../core/TypedRenderBuffers"),i=e("../core/GLFramebuffer"),o=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t,r){var i=this,o=new n.LinearRGBTextureRenderBufferInfo("H & V Blurred",e.width,e.height,e.format),u=new n.LinearRGBTextureRenderBufferInfo("H Blurred",e.width,e.height,e.format);return r.push({inputs:{input:e},outputs:{output:u},bindings:[],optionalOutputs:[],name:"H Gaussian Blur (sigma="+t+")",factory:function(e){return new s(i,e.inputs.input,e.outputs.output,t,a.Horitonzal)}}),r.push({inputs:{input:u},outputs:{output:o},bindings:[],optionalOutputs:[],name:"V Gaussian Blur (sigma="+t+")",factory:function(e){return new s(i,e.inputs.input,e.outputs.output,t,a.Vertical)}}),o},e}();r.GaussianBlurFilterRenderer=o;var a;!function(e){e[e.Horitonzal=0]="Horitonzal",e[e.Vertical=1]="Vertical"}(a||(a={}));var s=function(){function e(e,t,r,n,o){this.parent=e,this.input=t,this.out=r,this.sigma=n,this.dir=o,this.kernelRadius=Math.floor(2*n),this.kernelSize=1+2*this.kernelRadius;var a=0;this.weights=[];for(var s=0;s<this.kernelSize;++s){var u=(s-this.kernelRadius)/n,h=Math.exp(-u*u);this.weights.push(h),a+=h}for(var c=1/a,s=0;s<this.kernelSize;++s)this.weights[s]*=c;this.fb=i.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var l=e.renderer.shaderManager.get("VS_GaussianBlur","FS_GaussianBlur",["a_position"],{kernelSize:this.kernelSize});this.program={program:l,uniforms:l.getUniforms(["u_input","u_linearDepth","u_texCoordOffset","u_texCoordIncr","u_weight1","u_weight2","u_weight3","u_weight4","u_weight5","u_weight6","u_weight7","u_weight8","u_weight9","u_weight10","u_weight11"]),attributes:l.getAttributes(["a_position"])},this.weightUniforms=[];for(var s=1;s<=this.kernelSize;++s)this.weightUniforms.push(this.program.uniforms["u_weight"+s])}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_input,0),e.uniform1i(t.uniforms.u_linearDepth,1);for(var r=this.weightUniforms,n=this.weights,i=0;i<n.length;++i)e.uniform1f(r[i],n[i]);var o=1/this.out.width,s=1/this.out.height;switch(this.dir){case a.Horitonzal:s=0;break;case a.Vertical:o=0}e.uniform2f(t.uniforms.u_texCoordIncr,o,s),e.uniform2f(t.uniforms.u_texCoordOffset,-o*this.kernelRadius,-s*this.kernelRadius);var u=this.parent.renderer.quadRenderer;u.render(t.attributes.a_position),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/TypedRenderBuffers":15}],21:[function(e,t,r){var n=e("../core/TypedRenderBuffers"),i=e("../core/GLFramebuffer"),o=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t,r,i,o){var s=this,u=e.width,h=e.height,c=new n.LinearRGBTextureRenderBufferInfo(1==r?"Compressed":"Decompressed",u,h,e.format);return o.push({inputs:{input:e},outputs:{output:c},bindings:[],optionalOutputs:[],name:(1==r?"Compress":"Decompress")+" HDR",factory:function(e){return new a(s,e.inputs.input,e.outputs.output,t,r,i)}}),c},e}();r.HdrCompressFilter=o;var a=function(){function e(e,t,r,n,o,a){this.parent=e,this.input=t,this.out=r,this.scale=a,this.fb=i.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var s=e.renderer.shaderManager.get("VS_HdrCompress","FS_HdrCompress",["a_position"],{operatorType:n,direction:o});this.program={program:s,uniforms:s.getUniforms(["u_input","u_gain","u_jitter","u_jitterScale"]),attributes:s.getAttributes(["a_position"])},0==o&&(this.scale=1/this.scale)}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.state.flags=2,this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture);var t=this.parent.renderer.uniformJitter;e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,t.texture);var r=this.program;r.program.use(),e.uniform1i(r.uniforms.u_input,0),e.uniform1f(r.uniforms.u_gain,this.scale),e.uniform1i(r.uniforms.u_jitter,1),e.uniform2f(r.uniforms.u_jitterScale,this.out.width/t.size,this.out.height/t.size),this.parent.renderer.quadRenderer.render(r.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/TypedRenderBuffers":15}],22:[function(e,t,r){var n=e("../core/RenderBuffers"),i=e("../core/TypedRenderBuffers"),o=e("../core/GLFramebuffer"),a=function(){function e(e){this.renderer=e,this.amount=1}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t,r){var o=this,a=e.color.width,c=e.color.height,l=e.color instanceof i.LinearRGBTextureRenderBufferInfo?new i.LinearRGBTextureRenderBufferInfo("Motion Blur Result",a,c,e.color.format):new i.LogRGBTextureRenderBufferInfo("Motion Blur Result",a,c,e.color.format),p=Math.ceil(e.color.width/t.maxBlur),f=Math.ceil(e.color.height/t.maxBlur),d=new n.TextureRenderBufferInfo("TileMax Velocity Map",p,f,n.TextureRenderBufferFormat.R8G8),m=new n.TextureRenderBufferInfo("NeighboxMax Velocity Map 1",p,f,n.TextureRenderBufferFormat.R8G8),g=new n.TextureRenderBufferInfo("NeighboxMax Velocity Map 2",p,f,n.TextureRenderBufferFormat.R8G8);return r.push({inputs:{g0:e.g0,g1:e.g1},outputs:{output:d},bindings:[],optionalOutputs:[],name:"Motion Blur: TileMax",factory:function(e){return new s(o,e.inputs.g0,e.inputs.g1,e.outputs.output,t.maxBlur)}}),r.push({inputs:{input:d},outputs:{output:m},bindings:[],optionalOutputs:[],name:"Motion Blur: NeighborMax",factory:function(e){return new u(o,e.inputs.input,e.outputs.output)}}),r.push({inputs:{input:m},outputs:{output:g},bindings:[],optionalOutputs:[],name:"Motion Blur: NeighborMax",factory:function(e){return new u(o,e.inputs.input,e.outputs.output)}}),r.push({inputs:{g0:e.g0,g1:e.g1,neighborVel:g,color:e.color,linearDepth:e.linearDepth},outputs:{output:l},bindings:[],optionalOutputs:[],name:"Motion Blur: Final Pass",factory:function(r){return new h(o,r.inputs.color,r.inputs.g0,r.inputs.g1,r.inputs.neighborVel,r.inputs.linearDepth,r.outputs.output,t.maxBlur,e.color instanceof i.LogRGBTextureRenderBufferInfo)}}),l},e}();r.MotionBlurFilterRenderer=a;var s=function(){function e(e,t,r,n,i){this.parent=e,this.inG0=t,this.inG1=r,this.out=n,this.maxVelocity=i;var a=t.width/n.width;this.fb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[n.texture]});var s=e.renderer.shaderManager.get("VS_MotionBlurDownsample","FS_MotionBlurDownsample",["a_position"],{scale:Math.ceil(a)});this.program={program:s,uniforms:s.getUniforms(["u_g0","u_g1","u_texCoordIncr","u_texCoordOffset","u_velocityScale","u_amount"]),attributes:s.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inG0.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inG1.texture);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_g0,0),e.uniform1i(t.uniforms.u_g1,1),e.uniform1f(t.uniforms.u_amount,this.parent.amount),e.uniform2f(t.uniforms.u_velocityScale,this.inG0.width/this.maxVelocity*.25,this.inG0.height/this.maxVelocity*.25),e.uniform2f(t.uniforms.u_texCoordIncr,1/this.inG0.width,1/this.inG0.height),e.uniform2f(t.uniforms.u_texCoordOffset,this.out.width/this.inG0.width*-.5,this.out.height/this.inG0.height*-.5);var r=this.parent.renderer.quadRenderer;r.render(t.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}(),u=function(){function e(e,t,r){this.parent=e,this.input=t,this.out=r,this.fb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var n=e.renderer.shaderManager.get("VS_MotionBlurNeighborMax","FS_MotionBlurNeighborMax",["a_position"]);this.program={program:n,uniforms:n.getUniforms(["u_input","u_texCoordOffset"]),attributes:n.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_input,0),e.uniform2f(t.uniforms.u_texCoordOffset,1/this.input.width,1/this.input.height);var r=this.parent.renderer.quadRenderer;r.render(t.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}(),h=function(){function e(e,t,r,n,i,a,s,u,h){this.parent=e,this.inColor=t,this.inG0=r,this.inG1=n,this.inVelTile=i,this.inLinearDepth=a,this.out=s,this.maxVelocity=u,this.fb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[s.texture]});var c=e.renderer.shaderManager.get("VS_MotionBlur","FS_MotionBlur",["a_position"],{numSamples:8,useLogRGB:h});this.program={program:c,uniforms:c.getUniforms(["u_g0","u_g1","u_velTile","u_color","u_linearDepth","u_velocityScale","u_velocityInvScale","u_minimumVelocity","u_minimumVelocitySquared","u_amount","u_jitter","u_jitterScale"]),attributes:c.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2;var t=this.parent.renderer.uniformDitherJitter;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inG0.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inG1.texture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.inVelTile.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,this.inColor.texture),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture),e.activeTexture(e.TEXTURE5),e.bindTexture(e.TEXTURE_2D,t.texture);var r=this.program;r.program.use(),e.uniform1i(r.uniforms.u_g0,0),e.uniform1i(r.uniforms.u_g1,1),e.uniform1i(r.uniforms.u_velTile,2),e.uniform1i(r.uniforms.u_color,3),e.uniform1i(r.uniforms.u_linearDepth,4),e.uniform1i(r.uniforms.u_jitter,5),e.uniform2f(r.uniforms.u_velocityScale,this.inG0.width/this.maxVelocity*.25,this.inG0.height/this.maxVelocity*.25),e.uniform2f(r.uniforms.u_velocityInvScale,this.maxVelocity/this.inG0.width*2,this.maxVelocity/this.inG0.height*2),e.uniform1f(r.uniforms.u_minimumVelocitySquared,Math.pow(.5/this.maxVelocity,2)),e.uniform1f(r.uniforms.u_minimumVelocity,.5/this.maxVelocity),e.uniform2f(r.uniforms.u_jitterScale,this.inG0.width/t.size,this.inG0.height/t.size),e.uniform1f(r.uniforms.u_amount,this.parent.amount);var n=this.parent.renderer.quadRenderer;n.render(r.attributes.a_position),e.activeTexture(e.TEXTURE2),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9,"../core/TypedRenderBuffers":15}],23:[function(e,t,r){var n=e("../core/TypedRenderBuffers"),i=e("../core/GLFramebuffer"),o=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupNearestResampler=function(e,t,r){var n=this,i=t.outWidth,o=t.outHeight,s=e.cloneWithDimension(e.name+" Resampled",i,o);return r.push({inputs:{input:e},outputs:{output:s},bindings:[],optionalOutputs:[],name:"Resample (Nearest)",factory:function(e){return new a(n,e.inputs.input,e.outputs.output,0)}}),s},e.prototype.setupLinearResampler=function(e,t,r){var i=this,o=t.outWidth,s=t.outHeight,u=new n.LinearRGBTextureRenderBufferInfo(e.name+" Resampled",o,s,e.format);return r.push({inputs:{input:e},outputs:{output:u},bindings:[],optionalOutputs:[],name:"Resample (Linear)",factory:function(e){return new a(i,e.inputs.input,e.outputs.output,1)}}),u},e}();r.ResampleFilterRenderer=o;var a=function(){function e(e,t,r,n){this.parent=e,this.input=t,this.out=r,this.type=n,this.fb=i.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var o=e.renderer.shaderManager.get("VS_Passthrough","FS_Passthrough",["a_position"]);this.program={program:o,uniforms:o.getUniforms(["u_texture","u_uvScale"]),attributes:o.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture),1==this.type&&(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR));var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_texture,0),e.uniform4f(t.uniforms.u_uvScale,.5,.5,.5,.5);var r=this.parent.renderer.quadRenderer;r.render(t.attributes.a_position),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}();r.ResampleFilterRendererInstance=a},{"../core/GLFramebuffer":3,"../core/TypedRenderBuffers":15}],24:[function(e,t,r){var n=e("three"),i=e("../core/RenderBuffers"),o=e("../core/GLFramebuffer"),a=e("./BilateralFilter"),s=e("../utils/Geometry"),u=function(){function e(e){this.renderer=e,this.bilateral=new a.BilateralFilterRenderer(e)}return e.prototype.dispose=function(){this.bilateral.dispose()},e.prototype.setupFilter=function(e,t){var r=this,n=e.linearDepth.width,o=e.linearDepth.height,a=new i.TextureRenderBufferInfo("SSAO Raw Result",n+1>>1,o+1>>1,i.TextureRenderBufferFormat.R8);t.push({inputs:{g2:e.g2,linearDepth:e.linearDepthHalf},outputs:{output:a},bindings:[],optionalOutputs:[],name:"SSAO",factory:function(e){return new h(r,e.inputs.g2,e.inputs.linearDepth,e.outputs.output)}});var s=this.bilateral.setupFilter({input:a,linearDepth:e.linearDepth},{dir:0,outWidth:n,outHeight:o,kernelScale:2},t),u=this.bilateral.setupFilter({input:s.output,linearDepth:e.linearDepth},{dir:1,outWidth:n,outHeight:o,kernelScale:2},t),c={output:u.output};return c},e}();r.SSAORenderer=u;var h=function(){function e(e,t,r,i){this.parent=e,this.inG2=t,this.inLinearDepth=r,this.out=i,this.fb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[i.texture]}),this.tmpMat=new n.Matrix4,this.projectionViewMat=new n.Matrix4,this.viewMat=null,this.viewVec=null;var a=e.renderer.shaderManager.get("VS_SSAO","FS_SSAO",["a_position"]);this.program={program:a,uniforms:a.getUniforms(["u_linearDepth","u_g2","u_viewDirCoefX","u_viewDirCoefY","u_viewDirOffset","u_sampleOffsetScale"]),attributes:a.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){this.viewMat=this.parent.renderer.currentCamera.matrixWorldInverse,this.projectionViewMat.multiplyMatrices(this.parent.renderer.currentCamera.projectionMatrix,this.parent.renderer.currentCamera.matrixWorldInverse),this.viewVec=s.computeViewVectorCoefFromProjectionMatrix(this.parent.renderer.currentCamera.projectionMatrix,this.viewVec)},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inG2.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture);var t=.002*Math.min(this.out.width,this.out.height),r=this.program;r.program.use(),e.uniform1i(r.uniforms.u_g2,0),e.uniform1i(r.uniforms.u_linearDepth,1),e.uniform2f(r.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),e.uniform2f(r.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),e.uniform2f(r.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y),e.uniform2f(r.uniforms.u_sampleOffsetScale,t/this.out.width,t/this.out.height);var n=this.parent.renderer.quadRenderer;n.render(r.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}();r.SSAORendererInstance=h},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9,"../utils/Geometry":49,"./BilateralFilter":18,three:"three"}],25:[function(e,t,r){var n=e("../core/TypedRenderBuffers"),i=e("../core/GLFramebuffer"),o=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t,r,i){var o=this,s=e.width,u=e.height,h=new n.LinearRGBTextureRenderBufferInfo("Sum",s,u,e.format);return i.push({inputs:{input1:e,input2:t},outputs:{output:h},bindings:["input1","output"],optionalOutputs:[],name:"Add",factory:function(e){return new a(o,e.inputs.input1,e.inputs.input2,e.outputs.output,r?r.clone():null)}}),h},e}();r.BufferAdder=o;var a=function(){function e(e,t,r,n,o){this.parent=e,this.input1=t,this.input2=r,this.out=n,this.modulation=o,this.fb=i.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[n.texture]})}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),this.input1!=this.out&&(this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),e.bindTexture(e.TEXTURE_2D,this.input1.texture),this.parent.renderer.passthroughRenderer.render()),this.parent.renderer.state.flags=10,e.blendFunc(e.ONE,e.ONE),e.bindTexture(e.TEXTURE_2D,this.input2.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this.modulation?this.parent.renderer.passthroughRenderer.renderModulated(this.modulation.x,this.modulation.y,this.modulation.z,this.modulation.w):this.parent.renderer.passthroughRenderer.render(),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/TypedRenderBuffers":15}],26:[function(e,t,r){var n=e("../core/RenderBuffers"),i=e("../core/TypedRenderBuffers"),o=e("../core/GLFramebuffer"),a=function(){function e(e,t){this.renderer=e,this.params=t}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t){var r=this,n=e.color.width,o=e.color.height,a=e.color instanceof i.LinearRGBTextureRenderBufferInfo?new i.LinearRGBTextureRenderBufferInfo("Antialiased",n,o,e.color.format):new i.LogRGBTextureRenderBufferInfo("Antialiased",n,o,e.color.format);return t.push({inputs:{g0:e.g0,g1:e.g1,input:e.color,linearDepth:e.linearDepth},outputs:{output:a},bindings:[],optionalOutputs:[],name:"Temporal AA",factory:function(e){return new s(r,e.inputs.input,e.inputs.g0,e.inputs.g1,e.inputs.linearDepth,e.outputs.output)}}),a},e}();r.TemporalAAFilterRenderer=a;var s=function(){function e(e,t,r,i,a,s){this.parent=e,this.input=t,this.inG0=r,this.inG1=i,this.inLinearDepth=a,this.out=s,this.fb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[s.texture]});var u=e.renderer.gl;this.accumTex=u.createTexture(),u.bindTexture(u.TEXTURE_2D,this.accumTex),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE);
var h=t.format==n.TextureRenderBufferFormat.SRGBA8?e.renderer.ext.get("EXT_sRGB").SRGB_ALPHA_EXT:u.RGBA,c=t.format==n.TextureRenderBufferFormat.RGBAF16?e.renderer.ext.get("OES_texture_half_float").HALF_FLOAT_OES:u.UNSIGNED_BYTE;u.texImage2D(u.TEXTURE_2D,0,h,t.width,t.height,0,h,c,null),this.savedDepthTex=u.createTexture(),u.bindTexture(u.TEXTURE_2D,this.savedDepthTex),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,t.width,t.height,0,u.RGBA,c,null),this.accumFb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[this.accumTex]}),this.savedDepthFb=o.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[this.savedDepthTex]}),this.firstTime=!0;var l=e.renderer.shaderManager.get("VS_TemporalAA","FS_TemporalAA",["a_position"],{useWiderFilter:e.params.useWiderFilter});this.program={program:l,uniforms:l.getUniforms(["u_input","u_linearDepth","u_oldAccum","u_oldDepth","u_g0","u_g1"]),attributes:l.getAttributes(["a_position"])};var l=e.renderer.shaderManager.get("VS_TemporalAA","FS_TemporalAAPrepass",["a_position"]);this.pre={program:l,uniforms:l.getUniforms(["u_input","u_linearDepth","u_oldAccum","u_oldDepth","u_g0","u_g1"]),attributes:l.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){var e=this.parent.renderer.gl,t=this.parent.renderer.profiler;t.begin("Pass 1"),e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.inG0.texture),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,this.inG1.texture),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.accumTex),e.activeTexture(e.TEXTURE5),e.bindTexture(e.TEXTURE_2D,this.savedDepthTex);var r=this.parent.renderer.quadRenderer;this.fb.bind(),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0);var n=this.pre;n.program.use(),e.uniform1i(n.uniforms.u_input,0),e.uniform1i(n.uniforms.u_linearDepth,1),e.uniform1i(n.uniforms.u_g0,2),e.uniform1i(n.uniforms.u_g1,3),e.uniform1i(n.uniforms.u_oldAccum,4),e.uniform1i(n.uniforms.u_oldDepth,5),r.render(n.attributes.a_position),t.end(),t.begin("Pass 2"),this.accumFb.bind(),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.out.texture);var n=this.program;n.program.use(),e.uniform1i(n.uniforms.u_input,0),e.uniform1i(n.uniforms.u_linearDepth,1),e.uniform1i(n.uniforms.u_g0,2),e.uniform1i(n.uniforms.u_g1,3),e.uniform1i(n.uniforms.u_oldAccum,4),e.uniform1i(n.uniforms.u_oldDepth,5),r.render(n.attributes.a_position),t.end(),t.begin("Pass 3"),this.fb.bind(),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.accumTex),this.parent.renderer.passthroughRenderer.render(),t.end(),t.begin("Pass 4"),this.savedDepthFb.bind(),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture),this.parent.renderer.passthroughRenderer.render(),t.end()},e.prototype.afterRender=function(){},e.prototype.dispose=function(){var e=this.parent.renderer.gl;this.fb.dispose(),this.accumFb.dispose(),this.savedDepthFb.dispose(),e.deleteTexture(this.accumTex),e.deleteTexture(this.savedDepthTex)},e}()},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9,"../core/TypedRenderBuffers":15}],27:[function(e,t,r){var n=e("three"),i=e("../core/RenderBuffers"),o=e("../core/TypedRenderBuffers"),a=e("../core/GLFramebuffer"),s=e("../utils/Geometry"),u=function(){function e(e){this.renderer=e,this.params={vignette:1,autoExposureEnabled:!0,exposureBias:0,color:new n.Vector3(1,1,1),highlightCrush:.2,contrast:.5}}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t){var r=this,n=e.width,a=e.height,s=new o.LinearRGBTextureRenderBufferInfo("Tone Mapped",n,a,this.renderer.supportsSRGB?i.TextureRenderBufferFormat.SRGBA8:i.TextureRenderBufferFormat.RGBA8);return t.push({inputs:{input:e},outputs:{output:s},bindings:[],optionalOutputs:[],name:"Tone Mapping",factory:function(t){return new h(r,t.inputs.input,t.outputs.output,e instanceof o.LogRGBTextureRenderBufferInfo)}}),s},e}();r.ToneMappingFilterRenderer=u;var h=function(){function e(e,t,r,n){this.parent=e,this.input=t,this.out=r,this.fb=a.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]}),this.viewVecs=null;var i=e.renderer.shaderManager.get("VS_ToneMapping","FS_ToneMapping",["a_position"],{inputIsLogRGB:n});this.program={program:i,uniforms:i.getUniforms(["u_input","u_vignetteAmount","u_vignetteScale","u_gain","u_color","u_highlightCrush","u_contrast"]),attributes:i.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_input,0);var r=this.parent.params;this.viewVecs=s.computeViewVectorCoefFromProjectionMatrix(this.parent.renderer.currentCamera.projectionMatrix,this.viewVecs),e.uniform1f(t.uniforms.u_vignetteAmount,r.vignette),e.uniform2f(t.uniforms.u_vignetteScale,this.viewVecs.coefX.length(),this.viewVecs.coefY.length()),e.uniform1f(t.uniforms.u_gain,Math.pow(2,r.exposureBias)),e.uniform3f(t.uniforms.u_color,r.color.x,r.color.y,r.color.z),e.uniform1f(t.uniforms.u_highlightCrush,r.highlightCrush),e.uniform1f(t.uniforms.u_contrast,r.contrast);var n=this.parent.renderer.quadRenderer;n.render(t.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9,"../core/TypedRenderBuffers":15,"../utils/Geometry":49,three:"three"}],28:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("three"),o=function(e){function t(t,r,n){e.call(this,t,r,n),this.radius=0,this.length=0,this.shadowCameraNear=0!=this.distance?.01*this.distance:.1}return n(t,e),t}(i.PointLight);r.PointLight=o},{three:"three"}],29:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("three");!function(e){e[e.Unlit=0]="Unlit",e[e.Opaque=1]="Opaque",e[e.ClearCoat=2]="ClearCoat",e[e.Transparent=3]="Transparent"}(r.MaterialShadingModel||(r.MaterialShadingModel={}));r.MaterialShadingModel;!function(e){e[e.Float=0]="Float",e[e.Float2=1]="Float2",e[e.Float3=2]="Float3",e[e.Float4=3]="Float4",e[e.Texture2D=4]="Texture2D",e[e.TextureCube=5]="TextureCube"}(r.MaterialParameterType||(r.MaterialParameterType={}));var o=(r.MaterialParameterType,0),a=function(){function e(e){this.id=o++,this.shadingModel=e.shadingModel,this.parameters=e.parameters,this.requiredVertexAttributes=(e.requiredVertexAttributes||[]).slice(0),this.shader=e.shader}return e}();r.Material=a;var s=function(e){function t(t,r){e.call(this),this.material=t,this.parameters={};for(var n in t.parameters)this.parameters[n]=t.parameters[n]["default"],r&&null!=r[n]&&(this.parameters[n]=r[n])}return n(t,e),t}(i.Material);r.MaterialInstance=s},{three:"three"}],30:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("three"),o=function(e){function t(){e.call(this),this.distance=1/0,this.decayDistance=5}return n(t,e),t}(i.Object3D);r.ReflectionProbe=o},{three:"three"}],31:[function(e,t,r){r.REVISION="0.0.1"},{}],32:[function(e,t,r){var n=e("../core/RendererCore"),i=e("./Version"),o=function(){function e(e){var t=this;console.log(this.rendererInfo),e=e||{},this.canvas=e.canvas?e.canvas:document.createElement("canvas");var r={alpha:!1,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1};if(this.gl=this.canvas.getContext("webgl",r)||this.canvas.getContext("experimental-webgl",r),!this.gl)throw new Error("could not create WebGL context.");this.canvas.addEventListener("webglcontextlost",function(){t.setup()}),this.canvas.addEventListener("webglcontextrestored",function(){}),this.core=new n.RendererCore(this.gl,e)}return e.prototype.setup=function(){},e.prototype.startProfiling=function(e){this.core.startProfiling(e)},e.prototype.stopProfiling=function(){this.core.stopProfiling()},Object.defineProperty(e.prototype,"rendererName",{get:function(){return"Hyper.WebGLHyperRenderer"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rendererVersion",{get:function(){return i.REVISION},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rendererInfo",{get:function(){return this.rendererName+" "+this.rendererVersion},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this.core.gl},enumerable:!0,configurable:!0}),e.prototype.render=function(e,t){this.core.render(e,t)},e.prototype.setSize=function(e,t,r){this.canvas.width=e,this.canvas.height=t,this.core.setSize(e,t)},Object.defineProperty(e.prototype,"domElement",{get:function(){return this.canvas},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parameters",{get:function(){return this.core.parameters},enumerable:!0,configurable:!0}),e}();r.WebGLHyperRenderer=o},{"../core/RendererCore":11,"./Version":31}],33:[function(e,t,r){function n(e){return e==h.MaterialShadingModel.Opaque||e==h.MaterialShadingModel.ClearCoat||e==h.MaterialShadingModel.Unlit}var i=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},o=e("three"),a=e("./MaterialManager"),s=e("./SkinningShader"),u=e("../utils/IntegerMap"),h=e("../public/Materials"),c=e("../core/GLProgram"),l=e("../core/GLShader"),p=e("../utils/ObjectPool"),f=e("../core/Shaders");r.isMaterialShadingModelDeferred=n;var d=function(){function e(e,t,r){this.core=e,this.materialManager=t,this.needsLastWorldPosition=r,this.tmpMat=new o.Matrix4,this.state={projectionViewMat:new o.Matrix4,viewMat:new o.Matrix4,frustum:new o.Frustum,lastViewProjMat:new o.Matrix4,nextToken:!1},this.objs=new u.IntegerMap}return e.prototype.renderGeometry=function(e,t){var r=this,n=this.state;n.viewMat.copy(e),n.projectionViewMat.multiplyMatrices(t,e),n.frustum.setFromMatrix(n.projectionViewMat);var i=this.core.currentScene;this.renderTree(i),this.objs.forEach(function(e,t){t.token!=n.nextToken&&r.objs.remove(e)}),n.nextToken=!n.nextToken,n.lastViewProjMat.copy(n.projectionViewMat)},e.prototype.cullObject=function(e){return e.frustumCulled&&!this.state.frustum.intersectsObject(e)},e.prototype.renderTree=function(e){var t=e.geometry;null==t||this.cullObject(e)||e instanceof o.Mesh&&!this.skipsMesh(e)&&this.renderMesh(e,t);for(var r=0,n=e.children;r<n.length;r++){var i=n[r];this.renderTree(i)}},e.prototype.renderMesh=function(e,t){var r=this.objs.get(e.id);r||(r=new m(e,this),this.objs.set(e.id,r)),r.render(this.state)},e.prototype.skipsMesh=function(e){return!1},e.prototype.skipsMaterial=function(e){return!n(e.material.shadingModel)},e.prototype.setupAdditionalUniforms=function(e,t){},e.prototype.dispose=function(){},e}();r.BaseGeometryPassRenderer=d;var m=function(){function e(e,t){this.obj=e,this.renderer=t,this.token=!1,this.lastModelMatrix=null,this.shaderInst=null,this.shader=null,this.skinning=null,this.lastModelMatrix=e.matrixWorld.clone();var r=e instanceof o.SkinnedMesh,n=0;r&&(n|=1);var i=a.importThreeJsMaterial(e.material);t.skipsMaterial(i)||(this.shaderInst=t.materialManager.get(i,n),this.shader=this.shaderInst.shader,this.shader.skinningShader&&(this.skinning=this.shader.skinningShader.createInstance(e)))}return e.prototype.render=function(e){if(this.shader){var t=this.renderer.core.gl,r=this.obj,n=this.obj.geometry,i=this.renderer,o=i.core.geometryManager.get(n),a=this.shaderInst,s=this.shader,u=s.getGeometryBinding(o);s.glProgram.use(),a.updateParameterUniforms(),u.setupVertexAttribs(),t.uniformMatrix4fv(s.uniforms.u_viewProjectionMatrix,!1,e.projectionViewMat.elements),t.uniformMatrix4fv(s.uniforms.u_lastViewProjectionMatrix,!1,e.lastViewProjMat.elements);var h=p.Matrix4Pool.alloc();h.multiplyMatrices(e.viewMat,r.matrixWorld),t.uniformMatrix4fv(s.uniforms.u_viewModelMatrix,!1,h.elements),p.Matrix4Pool.free(h),t.uniformMatrix4fv(s.uniforms.u_viewMatrix,!1,e.viewMat.elements),t.uniformMatrix4fv(s.uniforms.u_modelMatrix,!1,r.matrixWorld.elements),t.uniformMatrix4fv(s.uniforms.u_lastModelMatrix,!1,this.lastModelMatrix.elements),this.skinning&&this.skinning.update(),i.setupAdditionalUniforms(r,s);var c=o.indexAttribute;null!=c?c.drawElements():t.drawArrays(t.TRIANGLES,0,3*o.numFaces)}this.save(e.nextToken)},e.prototype.save=function(e){this.shader&&this.lastModelMatrix.copy(this.obj.matrixWorld),this.token=e},e}(),g=function(e){function t(t,r,n){e.call(this,t),this.vsName=r,this.fsName=n}return i(t,e),t.prototype.createShader=function(e,t){return new v(this,e,t)},t}(a.MaterialManager);r.BaseGeometryPassMaterialManager=g;var v=function(e){function t(t,r,n){e.call(this,t,r),this.manager=t,this.source=r,this.flags=n;for(var i=this.getVertexAttributesUsedInShader(l.GLShader.getAllAttributesReferencedByChunk([f.shaderChunks[t.vsName]]),!1),o=this.getVertexAttributesUsedInShader(l.GLShader.getAllAttributesReferencedByChunk([f.shaderChunks[t.vsName]]),!0),u=[],p=[],d=0;d<i.length;d++){var m=i[d],g=m.substr(2);u.push("attribute vec4 a_"+g+";"),u.push("varying vec4 v_"+g+";"),p.push("varying vec4 v_"+g+";")}p.push(a.getUniformDeclarationsForMaterial(r)),u.push("void computeExtraValues() {");for(var v=0;v<i.length;v++){var m=i[v],g=m.substr(2);u.push("v_"+g+" = a_"+g+";")}u.push("}");var x={requires:[t.vsName],source:u.join("\n")};switch(p.push("void evaluateShader() {"),r.shadingModel){case h.MaterialShadingModel.Unlit:p.push("m_materialId = MaterialIdUnlit;");break;case h.MaterialShadingModel.Opaque:p.push("m_materialId = MaterialIdDefault;");break;case h.MaterialShadingModel.ClearCoat:p.push("m_materialId = MaterialIdClearCoat;")}p.push(this.source.shader),p.push("}");var y,_={requires:[t.fsName,"Materials"],source:p.join("\n")};y=1&n?t.core.ext.get("OES_texture_float")?3:2:0;var b={useNormalMap:!0,skinningMode:y},w=null,T=null;try{var M=t.core.gl,S=l.GLShader.preprocess(t.core,[x],b,M.VERTEX_SHADER),E=l.GLShader.preprocess(t.core,[_],b,M.FRAGMENT_SHADER);w=l.GLShader.compile(t.core,M.VERTEX_SHADER,S),T=l.GLShader.compile(t.core,M.FRAGMENT_SHADER,E),this.program=c.GLProgram.link(t.core,[w,T],o)}finally{w&&w.dispose(),T&&T.dispose()}this.uniforms=this.program.getUniforms(["u_viewProjectionMatrix","u_lastViewProjectionMatrix","u_modelMatrix","u_lastModelMatrix","u_viewMatrix","u_viewModelMatrix"]),0!=y?(this.skinningShader=new s.SkinningShader(this.manager.core,this.program,0!=(2&n),y),this.skinningShader.textureStageIndex=this.numTextureStages,this.numTextureStages+=this.skinningShader.numTextureStagesNeeded):this.skinningShader=null}return i(t,e),Object.defineProperty(t.prototype,"glProgram",{get:function(){return this.program},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this.program.dispose(),a.Shader.prototype.dispose.call(this)},t}(a.Shader);r.BaseGeometryPassShader=v},{"../core/GLProgram":4,"../core/GLShader":5,"../core/Shaders":14,"../public/Materials":29,"../utils/IntegerMap":51,"../utils/ObjectPool":54,"./MaterialManager":39,"./SkinningShader":44,three:"three"}],34:[function(e,t,r){var n=e("three"),i=e("../utils/ObjectPool"),o=e("../core/GLFramebuffer"),a=e("../utils/Geometry"),s=e("./ShadowMapRenderer"),u=function(){function e(e,t,r,n,i){this.core=e,this.lightBuffer=t,this.inDepth=r,this.inLinearDepth=n,this.shadowMapService=i,this.width=t.width,this.height=t.height,this.infoMap=new Map,this.fb=o.GLFramebuffer.createFramebuffer(e.gl,{colors:[this.lightBuffer.texture],depth:r?r.texture:null}),this.program=[];for(var a=0;4>a;++a){var s=e.shaderManager.get("VS_DirectionalLightShadow","FS_DirectionalLightShadow",["a_position"],{clipByFarPlane:0!=(1&a),clipByNearPlane:0!=(2&a)});this.program.push({program:s,uniforms:s.getUniforms(["u_linearDepth","u_viewDirCoefX","u_viewDirCoefY","u_viewDirOffset","u_shadowMap","u_shadowMapMatrix","u_depthValue","u_farPlane","u_nearPlane","u_shadowMapZScale"]),attributes:s.getAttributes(["a_position"])})}}return e.prototype.dispose=function(){this.fb.dispose()},e.prototype.reset=function(){var e=this;if(this.infoMap.forEach(function(t,r){t.used?t.used=!1:e.infoMap["delete"](r)}),!(this.core.currentCamera instanceof n.PerspectiveCamera))throw new Error("Non-perspective camera is not supported by DirectionalLightShadowRenderer.");this.viewVec=a.computeViewVectorCoefFromProjectionMatrix(this.core.currentCamera.projectionMatrix)},e.prototype.prepare=function(e){var t=this.infoMap.get(e);null==t&&(t={used:!0,splits:[],dir:new n.Vector3},this.infoMap.set(e,t)),t.dir.copy(e.position),t.dir.normalize();for(var r=e.shadowCascadeCount||2,o=t.splits;o.length<r+1;)o.push(0);for(var a=this.core.currentCamera,u=o[0]=a.near,h=o[o.length-1]=a.far,c=(h-u)/r,l=Math.log(u),p=Math.log(h),f=(p-l)/r,d=1;d<o.length-1;++d){var m=u+c*d,g=Math.exp(l+f*d);o[d]=.5*(m+g)}var v=e.shadowCamera;for(null!=v&&v instanceof Array||(e.shadowCamera=v=[]);v.length<r;)v.push(new n.OrthographicCamera(0,0,0,0));v.length=r;for(var x=[],y=a.matrixWorld,d=0;8>d;++d){var _=i.Vector3Pool.alloc();x.push(_)}var b=i.Vector3Pool.alloc();b.set(0,0,-1),b.applyMatrix4(y);Math.abs(t.dir.dot(b));i.Vector3Pool.free(b);for(var d=0;r>d;++d){for(var w=v[d],T=o[d],M=o[d+1],S=0;8>S;++S){var _=x[S];_.set(this.viewVec.offset.x,this.viewVec.offset.y,-1),1&S?(_.x+=this.viewVec.coefX.x,_.y+=this.viewVec.coefX.y):(_.x-=this.viewVec.coefX.x,_.y-=this.viewVec.coefX.y),2&S?(_.x+=this.viewVec.coefY.x,_.y+=this.viewVec.coefY.y):(_.x-=this.viewVec.coefY.x,_.y-=this.viewVec.coefY.y),_.multiplyScalar(4&S?M:T),_.applyMatrix4(y)}this.setupShadowMapCamera(w,t,x),this.shadowMapService.prepareShadowMap(w,s.ShadowMapType.Normal)}for(var E=0;E<x.length;E++){var C=x[E];i.Vector3Pool.free(C)}},e.prototype.render=function(e){var t=this.infoMap.get(e),r=e.shadowCamera,n=this.core.gl,o=this.core.profiler;o.begin("Light Buffer Generation");for(var a=this.core.currentCamera,u=a.projectionMatrix,h=e.shadowCascadeCount||2,c=h;c>0;){--c;var l=r[c];this.shadowMapService.renderShadowMap(l,s.ShadowMapType.Normal);var p=0;h-1>c&&(p|=1),this.fb.bind(),0==c?this.core.state.flags=2:null==this.inDepth?(p|=2,this.core.state.flags=2):this.core.state.flags=3,n.viewport(0,0,this.width,this.height),c==h-1&&this.core.invalidateFramebuffer(n.COLOR_ATTACHMENT0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.inLinearDepth.texture),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this.shadowMapService.currentShadowMapDepth);var f=this.program[p];f.program.use(),n.uniform1i(f.uniforms.u_linearDepth,0),n.uniform1i(f.uniforms.u_shadowMap,1),n.uniform2f(f.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),n.uniform2f(f.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),n.uniform2f(f.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y);var d=i.Matrix4Pool.alloc(),m=i.Matrix4Pool.alloc(),g=i.Matrix4Pool.alloc();m.multiplyMatrices(l.projectionMatrix,l.matrixWorldInverse),d.multiplyMatrices(m,a.matrixWorld),m.makeScale(.5,.5,.5).multiply(d),g.makeTranslation(.5,.5,.5).multiply(m),n.uniformMatrix4fv(f.uniforms.u_shadowMapMatrix,!1,g.elements);var v=i.Vector4Pool.alloc();v.set(e.position.x,e.position.y,e.position.z,0),v.normalize(),v.applyMatrix4(g),n.uniform1f(f.uniforms.u_shadowMapZScale,1/v.length()),i.Vector4Pool.free(v),i.Matrix4Pool.free(d),i.Matrix4Pool.free(m),i.Matrix4Pool.free(g);var x=-t.splits[c],y=(x*u.elements[10]+u.elements[14])/(x*u.elements[11]+u.elements[15]);n.uniform1f(f.uniforms.u_depthValue,y),n.uniform1f(f.uniforms.u_farPlane,t.splits[c+1]),n.uniform1f(f.uniforms.u_nearPlane,t.splits[c]),this.core.quadRenderer.render(f.attributes.a_position)}o.end()},e.prototype.computeMinZByShadowCasterBounds=function(e){var t,r=this.core.shadowCasterBounds;return t=(e.x>0?r.max.x:r.min.x)*e.x,t+=(e.y>0?r.max.y:r.min.y)*e.y,t+=(e.z>0?r.max.z:r.min.z)*e.z},e.prototype.setupShadowMapCamera=function(e,t,r){var n=i.Vector3Pool.alloc(),o=i.Vector3Pool.alloc(),a=i.Vector3Pool.alloc(),s=this.core.currentCamera,u=n,h=o,c=t.dir;u.set(0,1,0),u.applyMatrix4(s.matrixWorld),u.cross(c),u.normalize(),h.crossVectors(u,c);for(var l=1/0,p=-(1/0),f=1/0,d=-(1/0),m=1/0,g=-(1/0),v=0;v<r.length;v++){var x=r[v],y=x.dot(u),_=x.dot(h),b=x.dot(c);l=Math.min(l,y),p=Math.max(p,y),f=Math.min(f,_),d=Math.max(d,_),m=Math.min(m,b),g=Math.max(g,b)}g=Math.max(g,this.computeMinZByShadowCasterBounds(c));var w=.5*(l+p),T=.5*(f+d),M=.5*(m+g);u.multiplyScalar(-2/(p-l)),h.multiplyScalar(2/(d-f));var S=a.copy(c);S.multiplyScalar(-2/(g-m));var E=e.matrixWorldInverse;E.set(u.x,u.y,u.z,2*w/(p-l),h.x,h.y,h.z,2*-T/(d-f),S.x,S.y,S.z,2*M/(g-m),0,0,0,1),e.matrixWorld.getInverse(E),e.projectionMatrix.identity(),i.Vector3Pool.free(n),i.Vector3Pool.free(o),i.Vector3Pool.free(a)},e.prototype.setupLiSPSMCamera=function(e,t,r,n,i){},e}();Object.defineProperty(r,"__esModule",{value:!0}),r["default"]=u},{"../core/GLFramebuffer":3,"../utils/Geometry":49,"../utils/ObjectPool":54,"./ShadowMapRenderer":43,three:"three"}],35:[function(e,t,r){function n(e){var t=new o.BufferGeometry;e.addEventListener("disposed",function(){t.dispose()}),t.fromGeometry(e);var r=e.faces;if(e.skinWeights&&!t.getAttribute("skinWeights")&&e.skinWeights.length>0){for(var n=e.skinWeights,i=new Float32Array(12*r.length),a=0;a<r.length;++a){var s=r[a],u=s.a;i[12*a]=n[u].x,i[12*a+1]=n[u].y,i[12*a+2]=n[u].z,i[12*a+3]=n[u].w,u=s.b,i[12*a+4]=n[u].x,i[12*a+5]=n[u].y,i[12*a+6]=n[u].z,i[12*a+7]=n[u].w,u=s.c,i[12*a+8]=n[u].x,i[12*a+9]=n[u].y,i[12*a+10]=n[u].z,i[12*a+11]=n[u].w}var h=new o.BufferAttribute(i,4);t.addAttribute("skinWeights",h)}if(e.skinIndices&&!t.getAttribute("skinIndices")&&e.skinIndices.length>0){for(var n=e.skinIndices,i=new Float32Array(12*r.length),a=0;a<r.length;++a){var s=r[a],u=s.a;i[12*a]=n[u].x,i[12*a+1]=n[u].y,i[12*a+2]=n[u].z,i[12*a+3]=n[u].w,u=s.b,i[12*a+4]=n[u].x,i[12*a+5]=n[u].y,i[12*a+6]=n[u].z,i[12*a+7]=n[u].w,u=s.c,i[12*a+8]=n[u].x,i[12*a+9]=n[u].y,i[12*a+10]=n[u].z,i[12*a+11]=n[u].w}var h=new o.BufferAttribute(i,4);t.addAttribute("skinIndices",h)}return t}var i=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},o=e("three"),a=e("../utils/Utils"),s=function(){function e(e){this.renderer=e,this.table={}}return e.prototype.dispose=function(){},e.prototype.get=function(e){if(e instanceof o.BufferGeometry){var t=this.table[e.id];return t||(t=new u(this,e),this.table[e.id]=t),t}if(e instanceof o.Geometry){var t=this.table[e.id];if(!t){var r=n(e);t=this.get(r),this.table[e.id]=t}return t}throw new Error("please use BufferGeometry")},e.prototype.flush=function(e){var t=this.table[e.id];t&&(delete this.table[e.id],t.dispose())},e}();r.GeometryManager=s;var u=function(e){function t(t,r){var n=this;e.call(this),this.manager=t,this.source=r,r.addEventListener("dispose",this.disposeHandler=function(){return n.onDispose()});var i=r.attributes,o=r.attributesKeys||a.getKeysOfObject(i);this.attributes=[],this.indexAttribute=null,this.numFaces=0;for(var s=0;s<o.length;s++){var u=o[s],c=i[u],l=new h(t.renderer,c,u);this.attributes.push(l),l.isIndex&&(this.indexAttribute=l,this.numFaces=c.length/3|0)}null==this.indexAttribute&&(this.numFaces=this.attributes[0].numElements/this.attributes[0].itemSize/3|0),this.update()}return i(t,e),Object.defineProperty(t.prototype,"id",{get:function(){return this.source.id},enumerable:!0,configurable:!0}),t.prototype.update=function(){for(var e=0,t=this.attributes;e<t.length;e++){var r=t[e];r.update()}},t.prototype.onDispose=function(){this.manager.flush(this.source)},t.prototype.dispose=function(){for(var e=0,t=this.attributes;e<t.length;e++){var r=t[e];r.dispose()}this.attributes=null,this.dispatchEvent({type:"disposed",target:this})},t}(o.EventDispatcher);r.Geometry=u;var h=function(){function e(e,t,r){this.renderer=e,this.source=t,this.name=r,this.buffer=null,this.isIndex="index"==r,this.isDynamic=t instanceof o.DynamicBufferAttribute,this.typedArray=null,t.array instanceof Array?(this.typedArray=new Float32Array(t.array.length),this.typedArrayValid=!1):(this.typedArray=t.array,this.typedArrayValid=!0)}return e.prototype.updateTypedArray=function(){var e=this.source.array,t=this.typedArray;if(this.source.needsUpdate||!this.typedArrayValid){if(e!=t)for(var r=0;r<e.length;++r)t[r]=e[r];this.typedArrayValid=!0}},e.prototype.update=function(){var e=this.renderer.gl,t=this.isIndex?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER;this.updateTypedArray(),this.buffer?this.source.needsUpdate&&(e.bindBuffer(t,this.buffer),e.bufferSubData(t,0,this.typedArray),this.source.needsUpdate=!1):(this.buffer=e.createBuffer(),e.bindBuffer(t,this.buffer),e.bufferData(t,this.typedArray,this.isDynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW))},e.prototype.drawElements=function(){var e=this.renderer.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.drawElements(e.TRIANGLES,this.source.array.length,e.UNSIGNED_SHORT,0)},e.prototype.setupVertexAttrib=function(e){if(this.isIndex)throw new Error;var t=this.renderer.gl,r=this.source;t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.vertexAttribPointer(e,r.itemSize,t.FLOAT,!1,0,0)},Object.defineProperty(e.prototype,"itemSize",{get:function(){return this.source.itemSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numElements",{get:function(){return this.source.array.length},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.buffer&&(this.renderer.gl.deleteBuffer(this.buffer),this.buffer=null)},e}();r.GeometryAttribute=h},{"../utils/Utils":57,three:"three"}],36:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("../core/TypedRenderBuffers"),o=e("../core/RenderBuffers"),a=e("./BaseGeometryPassRenderer"),s=e("../core/GLFramebuffer"),u=e("../utils/ObjectPool"),h=e("../utils/PoissonDiskSampler"),c=function(){function e(e){this.renderer=e,this.gpMaterials=new p(e)}return e.prototype.dispose=function(){this.gpMaterials.dispose()},e.prototype.setupShadowPass=function(e){},e.prototype.setupGeometryPass=function(e,t,r){var n=this,a=this.renderer.useFullResolutionGBuffer,s=new i.GBufferMosaicTextureRenderBufferInfo("Mosaicked G-Buffer",a?2*e:e,a?2*t:t,o.TextureRenderBufferFormat.RGBA8),u=new i.DepthTextureRenderBufferInfo("Raw Depth",a?2*e:e,a?2*t:t,o.TextureRenderBufferFormat.Depth),h={g0:new i.GBuffer0TextureRenderBufferInfo("G0",e,t,this.renderer.supportsSRGB?o.TextureRenderBufferFormat.SRGBA8:o.TextureRenderBufferFormat.RGBA8),g1:new i.GBuffer1TextureRenderBufferInfo("G1",e,t,o.TextureRenderBufferFormat.RGBA8),g2:new i.GBuffer2TextureRenderBufferInfo("G2",e,t,o.TextureRenderBufferFormat.RGBA8),g3:new i.GBuffer3TextureRenderBufferInfo("G3",e,t,this.renderer.supportsSRGB?o.TextureRenderBufferFormat.SRGBA8:o.TextureRenderBufferFormat.RGBA8),linearDepth:new i.LinearDepthTextureRenderBufferInfo("Depth",e,t,o.TextureRenderBufferFormat.RGBA8),depth:u};return r.push({inputs:{},outputs:{mosaic:s,depth:u},bindings:[],optionalOutputs:["shadowMapsDepth","shadowMapsColor"],name:"Geometry Pass",factory:function(e){return new f(n,e.outputs.mosaic,e.outputs.depth)}}),r.push({inputs:{mosaic:s,depth:u},outputs:{g0:h.g0,g1:h.g1,g2:h.g2,g3:h.g3,depth:h.linearDepth},bindings:[],optionalOutputs:["g0","g1","g2","g3","depth"],name:"Demosaick G-Buffer",factory:function(e){return new d(n,e.inputs.mosaic,e.inputs.depth,[e.outputs.g0,e.outputs.g1,e.outputs.g2,e.outputs.g3,e.outputs.depth])}}),h},e}();r.GeometryRenderer=c;var l=function(e){function t(t,r,n){e.call(this,t,r,n),this.manager=t,this.source=r,this.geoUniforms=this.glProgram.getUniforms(["u_screenVelOffset"])}return n(t,e),t}(a.BaseGeometryPassShader),p=function(e){function t(t){e.call(this,t,"VS_Geometry","FS_Geometry")}return n(t,e),t.prototype.createShader=function(e,t){return new l(this,e,2|t)},t}(a.BaseGeometryPassMaterialManager),f=function(e){function t(t,r,n){e.call(this,t.renderer,t.gpMaterials,!0),this.parent=t,this.outMosaic=r,this.outDepth=n,this.fb=s.GLFramebuffer.createFramebuffer(t.renderer.gl,{depth:n.texture,colors:[r.texture]}),this.lastJitX=this.lastJitY=0,this.screenVelOffX=this.screenVelOffY=0,this.jitGen=new h.CenteredNoise}return n(t,e),t.prototype.setupAdditionalUniforms=function(e,t){var r=t,n=this.parent.renderer.gl;n.uniform2f(r.geoUniforms.u_screenVelOffset,this.screenVelOffX,this.screenVelOffY)},t.prototype.beforeRender=function(){},t.prototype.perform=function(){this.fb.bind();var e=u.Matrix4Pool.alloc();e.copy(this.parent.renderer.currentCamera.projectionMatrix);for(var t=1.5*(this.parent.renderer.useWiderTemporalAA?2:1),r=this.jitGen.sample(),n=r.x/this.parent.renderer.renderWidth*t,i=r.y/this.parent.renderer.renderHeight*t,o=0;4>o;++o)e.elements[o<<2]+=e.elements[(o<<2)+3]*n,e.elements[(o<<2)+1]+=e.elements[(o<<2)+3]*i;this.screenVelOffX=this.lastJitX-n,this.screenVelOffY=this.lastJitY-i,this.lastJitX=n,this.lastJitY=i;var a=this.parent.renderer.gl;a.viewport(0,0,this.outMosaic.width,this.outMosaic.height),a.clearColor(.5,.5,.5,.5),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),this.parent.renderer.state.flags=1,this.renderGeometry(this.parent.renderer.currentCamera.matrixWorldInverse,e),u.Matrix4Pool.free(e)},t.prototype.afterRender=function(){},t.prototype.dispose=function(){this.fb.dispose(),a.BaseGeometryPassRenderer.prototype.dispose.call(this)},t}(a.BaseGeometryPassRenderer),d=function(){function e(e,t,r,n){this.parent=e,this.inMosaic=t,this.inDepth=r,this.outG=n,this.programs=[],this.fbs=[],this.uniforms=[],this.attributes=[],this.outWidth=1,this.outHeight=1;for(var i=0;i<n.length;++i){var o=n[i];o&&(this.programs.push(this.parent.renderer.shaderManager.get("VS_GBufferDemosaic","FS_GBufferDemosaic",["a_position"],{gBufferIndex:i})),this.fbs.push(s.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[o.texture]})),this.outWidth=o.width,this.outHeight=o.height)}for(var a=0,u=this.programs;a<u.length;a++){var h=u[a];this.uniforms.push(h.getUniforms(["u_uvScale","u_mosaic","u_depth","u_depthLinearizeCoef"])),this.attributes.push(h.getAttributes(["a_position"]))}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){var e=this.programs,t=this.uniforms,r=this.attributes,n=this.fbs,i=this.parent.renderer.quadRenderer,o=this.parent.renderer.gl;this.parent.renderer.state.flags=0,o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,this.inMosaic.texture),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,this.inDepth.texture),o.viewport(0,0,this.outWidth,this.outHeight);for(var a=this.parent.renderer.currentCamera.projectionMatrix,s=0;s<n.length;++s){var u=t[s];n[s].bind(),e[s].use(),this.parent.renderer.invalidateFramebuffer(o.COLOR_ATTACHMENT0,o.DEPTH_ATTACHMENT),
o.uniform1i(u.u_mosaic,0),o.uniform1i(u.u_depth,1),o.uniform4f(u.u_uvScale,.5,.5,.5,.5),o.uniform4f(u.u_depthLinearizeCoef,a.elements[15],-a.elements[14],a.elements[11],-a.elements[10]),i.render(r[s].a_position)}},e.prototype.afterRender=function(){},e.prototype.dispose=function(){for(var e=0,t=this.fbs;e<t.length;e++){var r=t[e];r.dispose()}},e}()},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9,"../core/TypedRenderBuffers":15,"../utils/ObjectPool":54,"../utils/PoissonDiskSampler":56,"./BaseGeometryPassRenderer":33}],37:[function(e,t,r){var n=e("../core/TypedRenderBuffers"),i=e("../core/GLFramebuffer"),o=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupFilter=function(e,t,r){var i=this,o=e.width,u=e.height;t.halfSized&&(o>>=1,u>>=1);var h=new n.LogRGBTextureRenderBufferInfo("LogRGB",o,u,e.format),c=new n.LogRGBTextureRenderBufferInfo("LogRGB",o,u,e.format);return r.push({inputs:{input:e},outputs:{output:h},bindings:[],optionalOutputs:[],name:"HDR Demosaic",factory:function(e){return new a(i,e.inputs.input,e.outputs.output,t)}}),r.push({inputs:{input:h},outputs:{output:c},bindings:[],optionalOutputs:[],name:"Smoothen Demosaic Result",factory:function(e){return new s(i,e.inputs.input,e.outputs.output)}}),c},e}();r.HdrDemosaicFilterRenderer=o;var a=function(){function e(e,t,r,n){this.parent=e,this.input=t,this.out=r,this.params=n,this.fb=i.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var o=e.renderer.shaderManager.get("VS_HdrDemosaic","FS_HdrDemosaic",["a_position"]);this.program={program:o,uniforms:o.getUniforms(["u_mosaic"]),attributes:o.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_mosaic,0);var r=this.parent.renderer.quadRenderer;r.render(t.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}(),s=function(){function e(e,t,r){this.parent=e,this.input=t,this.out=r,this.fb=i.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var n=e.renderer.shaderManager.get("VS_Blur","FS_Blur",["a_position"]);this.program={program:n,uniforms:n.getUniforms(["u_texture"]),attributes:n.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_texture,0);var r=this.parent.renderer.quadRenderer;r.render(t.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/TypedRenderBuffers":15}],38:[function(e,t,r){var n=e("three"),i=e("../core/TypedRenderBuffers"),o=e("../core/RenderBuffers"),a=e("../core/RendererCore"),s=e("../core/GLFramebuffer"),u=e("../utils/Geometry"),h=e("../utils/ObjectPool"),c=e("../public/Lights"),l=e("./ShadowMapRenderer"),p=e("./DirectionalLightShadowRenderer"),f=e("./ScreenSpaceSoftShadowFilter"),d=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupNativeHdrLightPass=function(e,t){var r=this,n=e.g0.width,s=e.g0.height,u=new i.HdrMosaicTextureRenderBufferInfo("Emissive Color Mosaicked",n,s,o.TextureRenderBufferFormat.RGBAF16),h=new i.LinearRGBTextureRenderBufferInfo("Lit Color",n,s,o.TextureRenderBufferFormat.RGBAF16),c=new i.HdrMosaicTextureRenderBufferInfo("Light Buffer",n,s,o.TextureRenderBufferFormat.R8),l=new i.HdrMosaicTextureRenderBufferInfo("Light Temporary Buffer",n,s,o.TextureRenderBufferFormat.R8),p=e.depth.width==n&&e.depth.height==s&&e.depth.isDepthBuffer;return t.push({inputs:{g3:e.g3},outputs:{lit:u},bindings:[],optionalOutputs:[],name:"Emissive Term",factory:function(e){return new m(r,e.inputs.g3,e.outputs.lit,a.HdrMode.NativeHdr)}}),t.push({inputs:{g0:e.g0,g1:e.g1,g2:e.g2,g3:e.g3,linearDepth:e.linearDepth,depth:p?e.depth:null,shadowMaps:e.shadowMaps,ssao:e.ssao,lit:u},outputs:{lit:h,light:c,light2:l},bindings:[],optionalOutputs:[],name:"Light Pass",factory:function(e){return new g(r,e.inputs.g0,e.inputs.g1,e.inputs.g2,e.inputs.g3,e.inputs.linearDepth,e.inputs.depth,e.inputs.ssao,e.inputs.shadowMaps.service,e.inputs.lit,e.outputs.lit,e.outputs.light,e.outputs.light2,a.HdrMode.NativeHdr)}}),h},e.prototype.setupMobileHdrLightPass=function(e,t){var r=this,n=e.g0.width,s=e.g0.height,u=new i.HdrMosaicTextureRenderBufferInfo("Emissive Color Mosaicked",n,s,this.renderer.supportsSRGB?o.TextureRenderBufferFormat.SRGBA8:o.TextureRenderBufferFormat.RGBA8),h=new i.HdrMosaicTextureRenderBufferInfo("Lit Color Mosaicked",n,s,this.renderer.supportsSRGB?o.TextureRenderBufferFormat.SRGBA8:o.TextureRenderBufferFormat.RGBA8),c=new i.HdrMosaicTextureRenderBufferInfo("Light Buffer",n,s,o.TextureRenderBufferFormat.R8),l=new i.HdrMosaicTextureRenderBufferInfo("Light Temporary Buffer",n,s,o.TextureRenderBufferFormat.R8),p=e.depth.width==n&&e.depth.height==s&&e.depth.isDepthBuffer;return t.push({inputs:{g3:e.g3},outputs:{lit:u},bindings:[],optionalOutputs:[],name:"Emissive Term",factory:function(e){return new m(r,e.inputs.g3,e.outputs.lit,a.HdrMode.MobileHdr)}}),t.push({inputs:{g0:e.g0,g1:e.g1,g2:e.g2,g3:e.g3,linearDepth:e.linearDepth,depth:p?e.depth:null,shadowMaps:e.shadowMaps,ssao:e.ssao,lit:u},outputs:{lit:h,light:c,light2:l},bindings:[],optionalOutputs:[],name:"Light Pass",factory:function(e){return new g(r,e.inputs.g0,e.inputs.g1,e.inputs.g2,e.inputs.g3,e.inputs.linearDepth,e.inputs.depth,e.inputs.ssao,e.inputs.shadowMaps.service,e.inputs.lit,e.outputs.lit,e.outputs.light,e.outputs.light2,a.HdrMode.MobileHdr)}}),h},e}();r.LightRenderer=d;var m=function(){function e(e,t,r,n){this.parent=e,this.inG3=t,this.outLit=r,this.hdrMode=n,this.fb=s.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[r.texture]});var i=e.renderer.shaderManager.get("VS_DeferredUnlit","FS_DeferredUnlit",["a_position"],{useHdrMosaic:n==a.HdrMode.MobileHdr});this.program={program:i,uniforms:i.getUniforms(["u_g3","u_ssao","u_dither","u_ditherScale"]),attributes:i.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){var e=this.parent.renderer.gl;this.fb.bind(),this.parent.renderer.state.flags=2,e.viewport(0,0,this.outLit.width,this.outLit.height),this.parent.renderer.invalidateFramebuffer(e.COLOR_ATTACHMENT0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inG3.texture);var t=this.parent.renderer.uniformJitter;e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,t.texture);var r=this.program;r.program.use(),e.uniform1i(r.uniforms.u_g3,0),e.uniform1i(r.uniforms.u_dither,1),e.uniform2f(r.uniforms.u_ditherScale,this.outLit.width/t.size/4,this.outLit.height/t.size/4);var n=this.parent.renderer.quadRenderer;n.render(r.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}(),g=function(){function e(e,t,r,i,o,u,h,c,l,d,m,g,v,x){this.parent=e,this.inG0=t,this.inG1=r,this.inG2=i,this.inG3=o,this.inLinearDepth=u,this.inDepth=h,this.inSSAO=c,this.inShadowMaps=l,this.inLit=d,this.outLit=m,this.tmpLight=g,this.tmpLight2=v,this.hdrMode=x,this.fb=s.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:h?h.texture:null,colors:[m.texture]}),this.tmpMat=new n.Matrix4,this.projectionViewMat=new n.Matrix4,this.viewMat=null,this.viewVec=null,this.totalAmbient={r:0,g:0,b:0},this.directionalLightProgram=[],this.pointLightProgram=[],this.frustumCorners=[];for(var y=0;5>y;++y)this.frustumCorners.push(new n.Vector3);this.directionalLightShadowRenderer=new p["default"](e.renderer,g,h,u,l),this.ssssRenderer1=new f.ScreenSpaceSoftShadowRendererInstance(e.renderer,g,u,v,0),this.ssssRenderer2=new f.ScreenSpaceSoftShadowRendererInstance(e.renderer,v,u,g,1);for(var y=0;4>y;++y){var _=e.renderer.shaderManager.get("VS_DeferredPointLight","FS_DeferredPointLight",["a_position"],{hasShadowMap:0!=(1&y),isFullScreen:0!=(2&y),useHdrMosaic:x==a.HdrMode.MobileHdr});this.pointLightProgram.push({program:_,uniforms:_.getUniforms(["u_g0","u_g1","u_g2","u_linearDepth","u_lightColor","u_lightStrength","u_viewDirCoefX","u_viewDirCoefY","u_viewDirOffset","u_shadowMap","u_shadowMapMatrix","u_jitter","u_jitterScale","u_jitterAmount","u_dither","u_ditherScale","u_lightPos","u_lightInfluenceRadius","u_lightInvInfluenceRadiusSquared","u_minimumDistance","u_invDistanceToJitter","u_lightRadius","u_lightLength","u_lightDir"]),attributes:_.getAttributes(["a_position"])})}for(var y=0;2>y;++y){var _=e.renderer.shaderManager.get("VS_DeferredDirectionalLight","FS_DeferredDirectionalLight",["a_position"],{hasShadow:0!=(1&y),useHdrMosaic:x==a.HdrMode.MobileHdr});this.directionalLightProgram.push({program:_,uniforms:_.getUniforms(["u_g0","u_g1","u_g2","u_linearDepth","u_lightDir","u_lightColor","u_lightStrength","u_viewDirCoefX","u_viewDirCoefY","u_viewDirOffset","u_shadow","u_dither","u_ditherScale"]),attributes:_.getAttributes(["a_position"])})}var _=e.renderer.shaderManager.get("VS_DeferredAmbientLight","FS_DeferredAmbientLight",["a_position"],{useHdrMosaic:x==a.HdrMode.MobileHdr});this.ambientLightProgram={program:_,uniforms:_.getUniforms(["u_g0","u_g1","u_g2","u_linearDepth","u_ssao","u_lightColor","u_viewDirCoefX","u_viewDirCoefY","u_viewDirOffset","u_dither","u_ditherScale"]),attributes:_.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){var e=this.parent.renderer.currentScene,t=this.parent.renderer.currentCamera;this.viewMat=t.matrixWorldInverse,this.projectionViewMat.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this.viewVec=u.computeViewVectorCoefFromProjectionMatrix(t.projectionMatrix,this.viewVec),this.totalAmbient.r=0,this.totalAmbient.g=0,this.totalAmbient.b=0;var r=t.matrixWorld,n=u.computeFarDepthFromProjectionMatrix(t.projectionMatrix);t.getWorldPosition(this.frustumCorners[4]);for(var i=0;4>i;++i){var o=this.frustumCorners[i];o.set(this.viewVec.offset.x,this.viewVec.offset.y,-1),1&i?(o.x+=this.viewVec.coefX.x,o.y+=this.viewVec.coefX.y):(o.x-=this.viewVec.coefX.x,o.y-=this.viewVec.coefX.y),2&i?(o.x+=this.viewVec.coefY.x,o.y+=this.viewVec.coefY.y):(o.x-=this.viewVec.coefY.x,o.y-=this.viewVec.coefY.y),o.multiplyScalar(n),o.applyMatrix4(r)}this.directionalLightShadowRenderer.reset(),this.prepareTree(e),this.ssssRenderer1.beforeRender(),this.ssssRenderer2.beforeRender()},e.prototype.setState=function(){var e=this.parent.renderer.gl;this.fb.bind(),this.parent.renderer.state.flags=11,e.blendFunc(e.ONE,e.ONE),e.viewport(0,0,this.outLit.width,this.outLit.height),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inG0.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inG1.texture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.inG2.texture),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,this.parent.renderer.uniformJitter.texture),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture)},e.prototype.perform=function(){var e=this.parent.renderer.currentScene,t=this.parent.renderer.gl,r=this.parent.renderer.profiler;this.fb.bind(),t.viewport(0,0,this.outLit.width,this.outLit.height),this.outLit!=this.inLit&&(this.parent.renderer.invalidateFramebuffer(t.COLOR_ATTACHMENT0),this.parent.renderer.state.flags=2,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.inLit.texture),this.parent.renderer.passthroughRenderer.render()),this.setState();for(var n=this.parent.renderer.gaussianJitter,i=this.projectionViewMat,o=this.parent.renderer.hdrMode==a.HdrMode.MobileHdr?.25:.5,s=0,u=this.pointLightProgram;s<u.length;s++){var h=u[s];h.program.use(),t.uniform1i(h.uniforms.u_g0,0),t.uniform1i(h.uniforms.u_g1,1),t.uniform1i(h.uniforms.u_g2,2),t.uniform1i(h.uniforms.u_dither,3),t.uniform2f(h.uniforms.u_ditherScale,this.outLit.width/n.size*o,this.outLit.height/n.size*o),t.uniform1i(h.uniforms.u_linearDepth,4),t.uniform1i(h.uniforms.u_jitter,5),t.uniform1i(h.uniforms.u_shadowMap,6),t.uniform2f(h.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),t.uniform2f(h.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),t.uniform2f(h.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y),t.uniformMatrix4fv(h.uniforms.u_viewProjectionMatrix,!1,i.elements)}for(var c=0,l=this.directionalLightProgram;c<l.length;c++){var h=l[c];h.program.use(),t.uniform1i(h.uniforms.u_g0,0),t.uniform1i(h.uniforms.u_g1,1),t.uniform1i(h.uniforms.u_g2,2),t.uniform1i(h.uniforms.u_dither,3),t.uniform2f(h.uniforms.u_ditherScale,this.outLit.width/n.size*o,this.outLit.height/n.size*o),t.uniform1i(h.uniforms.u_linearDepth,4),t.uniform1i(h.uniforms.u_shadow,6),t.uniform2f(h.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),t.uniform2f(h.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),t.uniform2f(h.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y)}var h=this.ambientLightProgram;h.program.use(),t.uniform1i(h.uniforms.u_g0,0),t.uniform1i(h.uniforms.u_g1,1),t.uniform1i(h.uniforms.u_g2,2),t.uniform1i(h.uniforms.u_dither,3),t.uniform2f(h.uniforms.u_ditherScale,this.outLit.width/n.size*o,this.outLit.height/n.size*o),t.uniform1i(h.uniforms.u_linearDepth,4),t.uniform1i(h.uniforms.u_ssao,5),t.uniform2f(h.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),t.uniform2f(h.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),t.uniform2f(h.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y),this.renderTree(e);var p=this.totalAmbient;if(p.r>0||p.g>0||p.b>0){r.begin("Ambient");var h=this.ambientLightProgram;h.program.use(),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,this.inSSAO.texture),t.uniform3f(h.uniforms.u_lightColor,p.r,p.g,p.b);var f=this.parent.renderer.quadRenderer;t.depthFunc(t.GREATER),f.render(h.attributes.a_position),t.depthFunc(t.LESS),r.end()}},e.prototype.prepareTree=function(e){e instanceof n.Light&&this.prepareLight(e);for(var t=0,r=e.children;t<r.length;t++){var i=r[t];this.prepareTree(i)}},e.prototype.prepareLight=function(e){var t=h.Vector3Pool.alloc(),r=h.Vector3Pool.alloc(),i=h.Vector3Pool.alloc();if(e instanceof n.DirectionalLight&&e.castShadow&&this.directionalLightShadowRenderer.prepare(e),e instanceof n.PointLight&&e.castShadow){var o=.1;e instanceof c.PointLight&&(o=e.shadowCameraNear);var a=e.shadowCamera=e.shadowCamera||new n.CubeCamera(o,e.distance,1024);a.position.copy(e.getWorldPosition(t)),a.updateMatrixWorld(!0);var s=this.inShadowMaps;s.prepareShadowMap(e.shadowCamera,l.ShadowMapType.Normal)}h.Vector3Pool.free(t),h.Vector3Pool.free(r),h.Vector3Pool.free(i)},e.prototype.renderTree=function(e){e instanceof n.Light&&this.renderLight(e);for(var t=0,r=e.children;t<r.length;t++){var i=r[t];this.renderTree(i)}},e.prototype.renderLight=function(e){var t=this.parent.renderer.gl,r=this.parent.renderer.profiler,i=e.color.r,o=e.color.g,a=e.color.b,s=h.Vector3Pool.alloc(),u=h.Vector3Pool.alloc(),p=h.Vector3Pool.alloc();if(e instanceof n.DirectionalLight){r.begin("Directional");var f=e.castShadow;if(f){var d=this.directionalLightShadowRenderer;d.render(e),this.ssssRenderer1.light=e,this.ssssRenderer2.light=e,r.begin("Screen-space Soft Shadow"),this.ssssRenderer1.perform(),r.end(),r.begin("Screen-space Soft Shadow"),this.ssssRenderer2.perform(),r.end(),this.setState(),t.activeTexture(t.TEXTURE6),t.bindTexture(t.TEXTURE_2D,d.lightBuffer.texture)}var m=0;f&&(m|=1);var g=this.directionalLightProgram[m];g.program.use();var v=e.position,x=h.Vector4Pool.alloc().set(v.x,v.y,v.z,0);x.set(v.x,v.y,v.z,0),x.applyMatrix4(this.parent.renderer.currentCamera.matrixWorldInverse),x.normalize(),t.uniform3f(g.uniforms.u_lightDir,x.x,x.y,x.z),h.Vector4Pool.free(x),t.uniform3f(g.uniforms.u_lightColor,i,o,a),t.uniform1f(g.uniforms.u_lightStrength,e.intensity);var y=this.parent.renderer.quadRenderer;t.depthFunc(t.GREATER),y.render(g.attributes.a_position),t.depthFunc(t.LESS),r.end()}if(e instanceof n.PointLight){r.begin("Point");var _=e.distance;0==_&&(_=1/0);var b=!0,w=e.castShadow,T=e.shadowCamera;if(w&&T){var d=this.inShadowMaps;d.renderShadowMap(T,l.ShadowMapType.Normal),this.setState(),t.activeTexture(t.TEXTURE6),t.bindTexture(t.TEXTURE_CUBE_MAP,d.currentCubeShadowDistanceMap)}else w=!1;var M=e.getWorldPosition(u);M.applyMatrix4(this.viewMat);var m=0;b&&(m|=2),w&&(m|=1);var g=this.pointLightProgram[m];if(g.program.use(),e instanceof c.PointLight?(t.uniform1f(g.uniforms.u_lightRadius,e.radius),t.uniform1f(g.uniforms.u_lightLength,.5*e.length),t.uniform1f(g.uniforms.u_invDistanceToJitter,1/e.radius),e.length>0?(s.set(0,0,1).transformDirection(e.matrixWorld).normalize(),t.uniform3f(g.uniforms.u_lightDir,s.x,s.y,s.z),s.multiplyScalar(.5*e.length),M.sub(s)):t.uniform3f(g.uniforms.u_lightDir,0,0,0)):(t.uniform1f(g.uniforms.u_lightRadius,0),t.uniform1f(g.uniforms.u_lightLength,0),t.uniform3f(g.uniforms.u_lightDir,0,0,0),t.uniform1f(g.uniforms.u_invDistanceToJitter,0)),t.uniform3f(g.uniforms.u_lightPos,M.x,M.y,M.z),t.uniform1f(g.uniforms.u_lightInfluenceRadius,_),t.uniform1f(g.uniforms.u_lightInvInfluenceRadiusSquared,1/(_*_)),t.uniform1f(g.uniforms.u_minimumDistance,.01*e.intensity),t.uniform3f(g.uniforms.u_lightColor,i,o,a),t.uniform1f(g.uniforms.u_lightStrength,e.intensity),w){var d=this.inShadowMaps,S=1/e.distance,E=h.Matrix4Pool.alloc(),C=h.Matrix4Pool.alloc(),R=h.Matrix4Pool.alloc();C.getInverse(T.matrixWorld),E.multiplyMatrices(C,this.parent.renderer.currentCamera.matrixWorld),R.makeScale(S,S,S).multiply(E),t.uniformMatrix4fv(g.uniforms.u_shadowMapMatrix,!1,R.elements),h.Matrix4Pool.free(E),h.Matrix4Pool.free(C),h.Matrix4Pool.free(R),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,this.parent.renderer.gaussianJitter.texture),t.uniform2f(g.uniforms.u_jitterAmount,16/d.cubeShadowDistanceMapSize,16/d.cubeShadowDistanceMapSize)}if(t.depthFunc(t.GREATER),b){var y=this.parent.renderer.quadRenderer;y.render(g.attributes.a_position)}t.depthFunc(t.LESS),r.end()}if(e instanceof n.SpotLight,e instanceof n.AmbientLight){var D=this.totalAmbient;D.r+=i,D.g+=o,D.b+=a}h.Vector3Pool.free(s),h.Vector3Pool.free(u),h.Vector3Pool.free(p)},e.prototype.afterRender=function(){this.ssssRenderer1.afterRender(),this.ssssRenderer2.afterRender()},e.prototype.dispose=function(){this.fb.dispose(),this.ssssRenderer1.dispose(),this.ssssRenderer2.dispose(),this.directionalLightShadowRenderer.dispose()},e}()},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9,"../core/RendererCore":11,"../core/TypedRenderBuffers":15,"../public/Lights":28,"../utils/Geometry":49,"../utils/ObjectPool":54,"./DirectionalLightShadowRenderer":34,"./ScreenSpaceSoftShadowFilter":42,"./ShadowMapRenderer":43,three:"three"}],39:[function(require,module,exports){function getStandardMaterial(e){var t=0;e.hasMap&&(t|=1),e.hasNormalMap&&(t|=2),e.hasSpecularMap&&(t|=4),e.hasAlphaMap&&(t|=8),e.lit&&(t|=16);var r=standardMaterials[t];if(!r){var n=[],i=[],o={color:{type:Materials_1.MaterialParameterType.Float3,"default":[1,1,1]},emissive:{type:Materials_1.MaterialParameterType.Float3,"default":[1,1,1]},specular:{type:Materials_1.MaterialParameterType.Float,"default":[1]},metal:{type:Materials_1.MaterialParameterType.Float,"default":[0]},roughness:{type:Materials_1.MaterialParameterType.Float,"default":[.5]}};e.hasAlphaMap&&(o.alphaMap={type:Materials_1.MaterialParameterType.Texture2D},n.push("float alphaMap = texture2D(p_alphaMap, v_uv.xy).y;"),n.push("if (alphaMap < 0.5) discard;")),n.push("m_albedo = p_color;"),n.push("m_roughness = p_roughness;"),n.push("m_metallic = p_metal;"),n.push("m_specular = p_specular;"),n.push("m_emissive = p_emissive;"),e.hasMap&&(o.map={type:Materials_1.MaterialParameterType.Texture2D},n.push((e.lit?"m_albedo":"m_emissive")+" *= texture2D(p_map, v_uv.xy).xyz;")),e.hasNormalMap&&(o.normalMap={type:Materials_1.MaterialParameterType.Texture2D},n.push("m_normal = texture2D(p_normalMap, v_uv.xy).xyz;")),e.hasSpecularMap&&(o.specularMap={type:Materials_1.MaterialParameterType.Texture2D},n.push("float specularMap = texture2D(p_specularMap, v_uv.xy).y;"),n.push("m_roughness = mix(1., m_roughness, specularMap);")),(e.hasAlphaMap||e.hasMap||e.hasNormalMap||e.hasSpecularMap)&&i.push("uv"),r=new Materials_1.Material({shadingModel:e.lit?Materials_1.MaterialShadingModel.Opaque:Materials_1.MaterialShadingModel.Unlit,shader:n.join("\n"),parameters:o,requiredVertexAttributes:i}),standardMaterials[t]=r}return r}function getUniformDeclarationsForMaterial(e){var t=[];for(var r in e.parameters){var n=e.parameters[r];switch(n.type){case Materials_1.MaterialParameterType.Float:t.push("uniform float p_"+r+";");break;case Materials_1.MaterialParameterType.Float2:t.push("uniform vec2 p_"+r+";");break;case Materials_1.MaterialParameterType.Float3:t.push("uniform vec3 p_"+r+";");break;case Materials_1.MaterialParameterType.Float4:t.push("uniform vec4 p_"+r+";");break;case Materials_1.MaterialParameterType.Texture2D:t.push("uniform sampler2D p_"+r+";");break;case Materials_1.MaterialParameterType.TextureCube:t.push("uniform samplerCube p_"+r+";");break;default:throw new Error("unknown param type: "+n.type)}}return t.join("\n")}function importThreeJsMaterial(e){function t(e){return[e.r*e.r,e.g*e.g,e.b*e.b]}var r=importedMaterialsCache.get(e);if(r)return r;if(e instanceof three.MeshPhongMaterial){var n=getStandardMaterial({hasMap:null!=e.map,hasAlphaMap:null!=e.alphaMap,hasNormalMap:null!=e.normalMap,hasSpecularMap:null!=e.specularMap,lit:!0});return r=new ImportedMaterialInstance(n,e),r.parameters.color=t(e.color),r.parameters.emissive=t(e.emissive),r.parameters.specular=Math.max(e.specular.r,e.specular.g,e.specular.b),r.parameters.metal=e.metal?1:0,r.parameters.roughness=Math.pow(2/(e.shininess+2),.25),e.map&&(r.parameters.map=e.map),e.alphaMap&&(r.parameters.alphaMap=e.alphaMap),e.normalMap&&(r.parameters.normalMap=e.normalMap),e.specularMap&&(r.parameters.specularMap=e.specularMap),importedMaterialsCache.set(e,r),r}if(e instanceof three.MeshBasicMaterial){var n=getStandardMaterial({hasMap:null!=e.map,hasAlphaMap:null!=e.alphaMap,hasNormalMap:!1,hasSpecularMap:!1,lit:!1});return r=new ImportedMaterialInstance(n,e),r.parameters.emissive=t(e.color),e.map&&(r.parameters.map=e.map),e.alphaMap&&(r.parameters.alphaMap=e.alphaMap),importedMaterialsCache.set(e,r),r}if(e instanceof Materials_1.MaterialInstance)return e;throw new Error("\n＿人人人人人人人人人人人人人人人人人人人人人人人人＿\n＞splatted by an unknown type of material!＜\n￣Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^Y^￣\n\n　　⊂⊃\n　　⏜\n　／　＼\n) X X (\nധധധ\n　 　㇎\n　　　㇉\n")}var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},three=require("three"),IntegerMap_1=require("../utils/IntegerMap"),IdWeakMap_1=require("../utils/IdWeakMap"),BitArray_1=require("../utils/BitArray"),Materials_1=require("../public/Materials"),MaterialManager=function(){function e(e){this.core=e,this.shaderTable=new IntegerMap_1.IntegerMap}return e.prototype.createShader=function(e,t){return new Shader(this,e)},e.prototype.get=function(e,t){var r=this;null==t&&(t=0);var n,i=this.shaderTable.get(e.material.id);if(i||(i=new ShaderGroup(this,e.material),i.addEventListener("disposed",function(){r.shaderTable.remove(e.material.id)}),this.shaderTable.set(e.material.id,i)),n=i.get(t),n.source!=e.material)throw new Error;return n.getInstance(e)},e.prototype.dispose=function(){this.shaderTable.forEach(function(e,t){t.dispose()})},e}();exports.MaterialManager=MaterialManager;var ShaderGroup=function(e){function t(t,r){e.call(this),this.manager=t,this.source=r,this.shaders=new IntegerMap_1.IntegerMap}return __extends(t,e),t.prototype.dispose=function(){var e=this;return this.shaders.isEmpty?void this.dispatchEvent({type:"disposed",target:void 0}):void this.shaders.forEach(function(t,r){e.deleteShader(t)})},t.prototype.deleteShader=function(e){this.shaders.remove(e),this.shaders.isEmpty&&this.dispose()},t.prototype.get=function(e){var t=this,r=this.shaders.get(e);return null==r&&(r=this.manager.createShader(this.source,e),r.addEventListener("disposed",function(){t.deleteShader(e)}),this.shaders.set(e,r)),r},t}(three.EventDispatcher),Shader=function(_super){function Shader(e,t){_super.call(this),this.manager=e,this.source=t,this.insts=new IntegerMap_1.IntegerMap,this.parameterUniformSetter_=null,this.parameterTextureStages=[];var r=t.parameters;for(var n in r){var i=r[n];(i.type==Materials_1.MaterialParameterType.Texture2D||i.type==Materials_1.MaterialParameterType.TextureCube)&&this.parameterTextureStages.push(n)}this.numTextureStages=this.parameterTextureStages.length,this.geometryBindings=new IdWeakMap_1.IdWeakMapWithDisposable}return __extends(Shader,_super),Shader.prototype.dispose=function(){var e=this;return this.insts.isEmpty?void this.dispatchEvent({type:"disposed",target:void 0}):void this.insts.forEach(function(t,r){e.deleteInstance(t)})},Object.defineProperty(Shader.prototype,"glProgram",{get:function(){throw new Error("must be overriden")},enumerable:!0,configurable:!0}),Shader.prototype.getGeometryBinding=function(e){var t=this.geometryBindings.get(e);return null==t&&(t=new ShaderGeometryBindings(this,e),this.geometryBindings.set(e,t)),t},Shader.prototype.getVertexAttributesUsedInShader=function(e,t){for(var r=[],n={},i=0;i<e.length;i++){var o=e[i],a="a_"+o;n[a]||(t&&r.push(a),n[a]=!0)}for(var s=0,u=this.source.requiredVertexAttributes;s<u.length;s++){var o=u[s],a="a_"+o;n[a]||(r.push(a),n[a]=!0)}return r},Object.defineProperty(Shader.prototype,"parameterUniformSetter",{get:function(){if(!this.parameterUniformSetter_){var unifNames=[],gl=this.manager.core.gl,params=this.source.parameters;for(var name_2 in params)unifNames.push("p_"+name_2);var texStages=this.parameterTextureStages,unifMap=this.glProgram.getUniforms(unifNames),parts=[];parts.push("(function (s, gl, tm, tcm) { return function (matInst) {"),parts.push("var params = matInst.parameters;");var i=0;for(var name_3 in params){var param=params[name_3],unifName="p_"+name_3,v="value"+ ++i;switch(parts.push("var "+v+' = params["'+name_3+'"];'),param.type){case Materials_1.MaterialParameterType.Float:parts.push("gl.uniform1f(s."+unifName+", "+v+");");break;case Materials_1.MaterialParameterType.Float2:parts.push("gl.uniform2f(s."+unifName+", "+v+"[0], "+v+"[1]);");break;case Materials_1.MaterialParameterType.Float3:parts.push("gl.uniform3f(s."+unifName+", "+v+"[0], "+v+"[1], "+v+"[2]);");break;case Materials_1.MaterialParameterType.Float4:parts.push("gl.uniform4f(s."+unifName+", "+v+"[0], "+v+"[1], "+v+"[2], "+v+"[3]);");break;case Materials_1.MaterialParameterType.Texture2D:var texStage=texStages.indexOf(name_3);parts.push("gl.uniform1i(s."+unifName+", "+texStage+");"),parts.push("gl.activeTexture(gl.TEXTURE0 + "+texStage+");"),parts.push("tm.get("+v+").bind();");break;case Materials_1.MaterialParameterType.TextureCube:var texStage=texStages.indexOf(name_3);parts.push("gl.uniform1i(s."+unifName+", "+texStage+");"),parts.push("gl.activeTexture(gl.TEXTURE0 + "+texStage+");"),parts.push("tcm.get("+v+").bind();");break;default:throw new Error}}return parts.push("}; })"),this.parameterUniformSetter_=eval(parts.join("\n"))(unifMap,gl,this.manager.core.textures,this.manager.core.textureCubes)}return this.parameterUniformSetter_},enumerable:!0,configurable:!0}),Shader.prototype.getInstance=function(e){var t=this.insts.get(e.id);return t?t:this.insts.set(e.id,new ShaderInstance(this,e))},Shader.prototype.deleteInstance=function(e){var t=this.insts.get(e);t&&(t.dispose(),this.insts.remove(e)),this.insts.isEmpty&&this.dispose()},Shader}(three.EventDispatcher);exports.Shader=Shader;var ShaderInstance=function(){function e(e,t){this.shader=e,this.source=t,t.addEventListener("disposed",this.disposeHandler=function(){e.deleteInstance(t.id)})}return e.prototype.updateParameterUniforms=function(){this.shader.parameterUniformSetter(this.source)},e.prototype.dispose=function(){},e}();exports.ShaderInstance=ShaderInstance;var ShaderGeometryBindings=function(){function e(e,t){this.shader=e;var r=t.attributes,n=e.glProgram.getAttributes(r.map(function(e){return"a_"+e.name}));this.bindings=[],this.vertexAttribMap=new BitArray_1.BitArray;for(var i=0;i<r.length;++i){var o=r[i];null!=n["a_"+o.name]&&(this.bindings.push({index:n["a_"+o.name],attr:o}),this.vertexAttribMap.toggleOne(n["a_"+o.name],!0))}if(0==this.bindings.length)throw new Error}return e.prototype.setupVertexAttribs=function(){var e=this.shader.manager.core;e.vertexAttribs.toggleAllWithArray(this.vertexAttribMap);for(var t=this.bindings,r=0;r<t.length;r++){var n=t[r];n.attr.setupVertexAttrib(n.index)}},e.prototype.dispose=function(){},e}();exports.ShaderGeometryBindings=ShaderGeometryBindings;var standardMaterials=[];exports.getUniformDeclarationsForMaterial=getUniformDeclarationsForMaterial;var ImportedMaterialInstance=function(e){function t(t,r){var n=this;e.call(this,t),this.source=r,r.addEventListener("disposed",this.disposeHandler=function(){return n.onSourceDisposed()})}return __extends(t,e),t.prototype.onSourceDisposed=function(){this.dispose()},t.prototype.dispose=function(){this.source.removeEventListener("disposed",this.disposeHandler),this.source=null,Materials_1.MaterialInstance.prototype.dispose.call(this)},t}(Materials_1.MaterialInstance),importedMaterialsCache=new IdWeakMap_1.IdWeakMapWithDisposable;exports.importThreeJsMaterial=importThreeJsMaterial},{"../public/Materials":29,"../utils/BitArray":48,"../utils/IdWeakMap":50,"../utils/IntegerMap":51,three:"three"}],40:[function(e,t,r){var n=e("three"),i=e("../core/TypedRenderBuffers"),o=e("../core/RenderBuffers"),a=e("../public/ReflectionProbe"),s=e("../utils/Geometry"),u=e("../utils/ObjectPool"),h=e("../core/GLFramebuffer"),c=function(){function e(e){this.renderer=e}return e.prototype.dispose=function(){},e.prototype.setupReflectionPass=function(e,t){var r=this,n=e.g0.width,a=e.g0.height,s=e.lit instanceof i.LinearRGBTextureRenderBufferInfo?new i.LinearRGBTextureRenderBufferInfo("Reflection Added",n,a,o.TextureRenderBufferFormat.RGBAF16):new i.HdrMosaicTextureRenderBufferInfo("Reflection Added Mosaicked",n,a,this.renderer.supportsSRGB?o.TextureRenderBufferFormat.SRGBA8:o.TextureRenderBufferFormat.RGBA8),u=e.lit instanceof i.LinearRGBTextureRenderBufferInfo?new i.LinearRGBTextureRenderBufferInfo("IBL Lit",n,a,o.TextureRenderBufferFormat.RGBAF16):new i.HdrMosaicTextureRenderBufferInfo("IBL Lit Mosaicked",n,a,this.renderer.supportsSRGB?o.TextureRenderBufferFormat.SRGBA8:o.TextureRenderBufferFormat.RGBA8),h=e.lit instanceof i.LinearRGBTextureRenderBufferInfo?e.lit:this.renderer.hdrDemosaic.setupFilter(e.lit,{halfSized:!1},t),c=e.depth.width==n&&e.depth.height==a&&e.depth.isDepthBuffer;return t.push({inputs:{g0:e.g0,g1:e.g1,g2:e.g2,g3:e.g3,linearDepth:e.linearDepth,depth:c?e.depth:null,ssao:e.ssao},outputs:{lit:u},bindings:["lit","lit"],optionalOutputs:[],name:"IBL Pass",factory:function(t){return new l(r,t.inputs.g0,t.inputs.g1,t.inputs.g2,t.inputs.g3,t.inputs.linearDepth,t.inputs.depth,t.inputs.ssao,t.outputs.lit,e.lit instanceof i.HdrMosaicTextureRenderBufferInfo)}}),t.push({inputs:{g0:e.g0,g1:e.g1,g2:e.g2,reflections:u,linearDepth:e.linearDepth,color:h,lit:e.lit},outputs:{lit:s},bindings:["lit","lit"],optionalOutputs:[],name:"Screen-space Reflections",factory:function(t){return new p(r,t.inputs.g0,t.inputs.g1,t.inputs.g2,t.inputs.reflections,t.inputs.color,t.inputs.linearDepth,t.inputs.lit,t.outputs.lit,e.lit instanceof i.HdrMosaicTextureRenderBufferInfo,h instanceof i.LogRGBTextureRenderBufferInfo);
}}),s},e}();r.ReflectionRenderer=c;var l=function(){function e(e,t,r,i,o,a,s,u,c,l){this.parent=e,this.inG0=t,this.inG1=r,this.inG2=i,this.inG3=o,this.inLinearDepth=a,this.inDepth=s,this.inSSAO=u,this.outLit=c,this.useHdrMosaic=l,this.fb=h.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:s?s.texture:null,colors:[c.texture]}),this.tmpMat=new n.Matrix4,this.projectionViewMat=new n.Matrix4,this.viewMat=null,this.viewVec=null,this.probes=[],this.ambientProgram=[];for(var p=0;2>p;++p)if(l||0!=(1&p)){var f=e.renderer.shaderManager.get("VS_DeferredAmbientIBL","FS_DeferredAmbientIBL",["a_position"],{isBlendPass:0!=(1&p),useHdrMosaic:l});this.ambientProgram.push({program:f,uniforms:f.getUniforms(["u_g0","u_g1","u_g2","u_linearDepth","u_ssao","u_reflection","u_viewDirCoefX","u_viewDirCoefY","u_viewDirOffset","u_reflectionMatrix","u_reflectionLodBias","u_reflectionSize","u_dither","u_ditherScale"]),attributes:f.getAttributes(["a_position"])})}else this.ambientProgram.push(null)}return e.prototype.beforeRender=function(){var e=this.parent.renderer.currentCamera;this.viewMat=e.matrixWorldInverse,this.invViewMat=e.matrixWorld,this.projectionViewMat.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this.viewVec=s.computeViewVectorCoefFromProjectionMatrix(e.projectionMatrix,this.viewVec)},e.prototype.perform=function(){var e=this.parent.renderer.currentScene,t=this.parent.renderer.gl;this.fb.bind(),t.viewport(0,0,this.outLit.width,this.outLit.height),this.parent.renderer.state.flags=3,t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT);var r=this.parent.renderer.uniformJitter;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.inG0.texture),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.inG1.texture),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.inG2.texture),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,r.texture),t.activeTexture(t.TEXTURE4),t.bindTexture(t.TEXTURE_2D,this.inLinearDepth.texture),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,this.inSSAO.texture);for(var n=0,i=this.ambientProgram;n<i.length;n++){var o=i[n];o&&(o.program.use(),t.uniform1i(o.uniforms.u_g0,0),t.uniform1i(o.uniforms.u_g1,1),t.uniform1i(o.uniforms.u_g2,2),t.uniform1i(o.uniforms.u_dither,3),t.uniform1i(o.uniforms.u_linearDepth,4),t.uniform1i(o.uniforms.u_ssao,5),t.uniform1i(o.uniforms.u_reflection,6),t.uniform2f(o.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),t.uniform2f(o.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),t.uniform2f(o.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y),t.uniform2f(o.uniforms.u_ditherScale,this.outLit.width/r.size/4,this.outLit.height/r.size/4))}this.probes.length=0,this.renderTree(e),this.probes.sort(function(e,t){return e.priority-t.priority}),this.parent.renderer.state.flags=139,t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);for(var a=0,s=this.probes;a<s.length;a++){var o=s[a];this.renderProbe(o,!0)}if(this.useHdrMosaic){this.parent.renderer.state.flags=123,t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);var u=this.parent.renderer.ext.get("EXT_blend_minmax");u&&t.blendEquation(u.MAX_EXT);for(var h=0,c=this.probes;h<c.length;h++){var o=c[h];this.renderProbe(o,!1)}u&&t.blendEquation(t.FUNC_ADD)}},e.prototype.renderTree=function(e){e instanceof a.ReflectionProbe&&this.probes.push(e);for(var t=0,r=e.children;t<r.length;t++){var n=r[t];this.renderTree(n)}},e.prototype.computeReflectionLodBias=function(e){return e.log2Size-20},e.prototype.renderProbe=function(e,t){var r=this.parent.renderer.gl,n=!isFinite(e.distance),i=this.parent.renderer.reflectionTextures.get(e.texture),o=0;t&&(o|=1);var a=this.tmpMat;if(a.getInverse(e.matrixWorld),a.multiply(this.invViewMat),n){var s=this.ambientProgram[o];s.program.use(),r.uniformMatrix4fv(s.uniforms.u_reflectionMatrix,!1,a.elements),r.uniform1f(s.uniforms.u_reflectionLodBias,this.computeReflectionLodBias(i)),r.uniform1f(s.uniforms.u_reflectionSize,1<<i.log2Size),r.activeTexture(r.TEXTURE6),i.bind();var u=this.parent.renderer.quadRenderer;r.depthFunc(r.GREATER),u.render(s.attributes.a_position),r.depthFunc(r.LESS)}},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}(),p=function(){function e(e,t,r,i,o,a,s,u,c,l,p){this.parent=e,this.inG0=t,this.inG1=r,this.inG2=i,this.inReflections=o,this.inColor=a,this.inLinearDepth=s,this.inLit=u,this.out=c,this.useHdrMosaic=l,this.fb=h.GLFramebuffer.createFramebuffer(e.renderer.gl,{depth:null,colors:[c.texture]}),this.tmpMat=new n.Matrix4,this.viewMat=null,this.viewVec=null;var f=e.renderer.shaderManager.get("VS_SSR","FS_SSR",["a_position"],{useHdrMosaic:l,colorIsLogRGB:p});this.program={program:f,uniforms:f.getUniforms(["u_linearDepth","u_g0","u_g1","u_g2","u_color","u_reflections","u_viewDirCoefX","u_viewDirCoefY","u_viewDirOffset","u_projectionMatrix","u_stride","u_jitter","u_jitterCoordScale"]),attributes:f.getAttributes(["a_position"])}}return e.prototype.beforeRender=function(){this.viewMat=this.parent.renderer.currentCamera.matrixWorldInverse,this.viewVec=s.computeViewVectorCoefFromProjectionMatrix(this.parent.renderer.currentCamera.projectionMatrix,this.viewVec)},e.prototype.perform=function(){this.fb.bind();var e=this.parent.renderer.gl;e.viewport(0,0,this.out.width,this.out.height),this.parent.renderer.state.flags=2,this.inLit!==this.out&&(this.parent.renderer.invalidateFramebuffer(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inLit.texture),this.parent.renderer.passthroughRenderer.render()),this.parent.renderer.state.flags=10,e.blendFunc(e.ONE,e.ONE),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.inG0.texture),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inG1.texture),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.inG2.texture),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,this.inColor.texture),e.activeTexture(e.TEXTURE5),e.bindTexture(e.TEXTURE_2D,this.inReflections.texture),e.activeTexture(e.TEXTURE6),e.bindTexture(e.TEXTURE_2D,this.parent.renderer.uniformDitherJitter.texture);var t=this.program;t.program.use(),e.uniform1i(t.uniforms.u_g0,0),e.uniform1i(t.uniforms.u_g1,1),e.uniform1i(t.uniforms.u_g2,2),e.uniform1i(t.uniforms.u_linearDepth,3),e.uniform1i(t.uniforms.u_color,4),e.uniform1i(t.uniforms.u_reflections,5),e.uniform1i(t.uniforms.u_jitter,6),e.uniform2f(t.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),e.uniform2f(t.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),e.uniform2f(t.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y),e.uniform1f(t.uniforms.u_stride,Math.ceil(this.inLinearDepth.height/20)),e.uniform2f(t.uniforms.u_jitterCoordScale,this.inLinearDepth.width/this.parent.renderer.uniformDitherJitter.size*(this.useHdrMosaic?.5:1),this.inLinearDepth.height/this.parent.renderer.uniformDitherJitter.size*(this.useHdrMosaic?.5:1));var r=u.Matrix4Pool.alloc(),n=u.Matrix4Pool.alloc();r.makeTranslation(1,1,1).multiply(this.parent.renderer.currentCamera.projectionMatrix),n.makeScale(this.inLinearDepth.width/2,this.inLinearDepth.height/2,.5).multiply(r),e.uniformMatrix4fv(t.uniforms.u_projectionMatrix,!1,n.elements),u.Matrix4Pool.free(r),u.Matrix4Pool.free(n);var i=this.parent.renderer.quadRenderer;i.render(t.attributes.a_position)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}();r.SSRRenderer=p},{"../core/GLFramebuffer":3,"../core/RenderBuffers":9,"../core/TypedRenderBuffers":15,"../public/ReflectionProbe":30,"../utils/Geometry":49,"../utils/ObjectPool":54,three:"three"}],41:[function(e,t,r){function n(e,t){var r=t+20-e,n=Math.max(Math.min(r/17.1,1),0);return n*n*(n*n)}function i(e,t,r){var i=e.shaderManager.get("VS_PrefilterCubemap","FS_PrefilterCubemap",["a_position"],{seamless:!0}),o=i.getUniforms(["u_axisMajor","u_axisU","u_axisV","u_texture","u_textureLod","u_roughness","u_textureSize","u_sampleRange","u_borderCoord","u_axisIsMinor","u_jitter","u_jitterScale"]),s=i.getAttributes(["a_position"]),u=e.gl,c=Math.min(a.ulog2(r),8),l=u.createTexture();u.bindTexture(u.TEXTURE_2D,l),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,4<<c,2<<c,0,u.RGBA,u.UNSIGNED_BYTE,null);var p=u.createFramebuffer();u.bindFramebuffer(u.FRAMEBUFFER,p),u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,l,0),e.state.flags=0,i.use(),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_CUBE_MAP,t),u.uniform1i(o.u_texture,0),u.uniform1f(o.u_textureSize,r);var f=e.uniformJitter;u.activeTexture(u.TEXTURE1),u.bindTexture(u.TEXTURE_2D,f.texture),u.uniform1i(o.u_jitter,1);for(var d=0;c>=d;++d){var m=1<<c-d;u.uniform1f(o.u_borderCoord,1-1/Math.max(2,m)),u.uniform1f(o.u_sampleRange,Math.min(16/m,.7)),u.uniform1f(o.u_textureLod,d+2),u.uniform1f(o.u_roughness,n(c,d)),u.uniform1f(o.u_jitterScale,.5*m/f.size);for(var g=0;g<h.length;g++){var v=h[g];u.viewport(v.x*m,v.y*m,m,m),u.uniform3i(o.u_axisIsMinor,0==v.dir.x?1:0,0==v.dir.y?1:0,0==v.dir.z?1:0),u.uniform3f(o.u_axisMajor,v.dir.x,v.dir.y,v.dir.z),u.uniform3f(o.u_axisU,v.u.x,v.u.y,v.u.z),u.uniform3f(o.u_axisV,v.v.x,v.v.y,v.v.z),e.quadRenderer.render(s.a_position)}}var x=new ArrayBuffer(32<<2*c),y=new Uint8Array(x),_=new Uint32Array(x);u.readPixels(0,0,4<<c,2<<c,u.RGBA,u.UNSIGNED_BYTE,y),u.bindFramebuffer(u.FRAMEBUFFER,null),u.deleteFramebuffer(p),u.deleteTexture(l);for(var b=[],w=4<<c,d=0;c>=d;++d)for(var m=1<<c-d,T=0;T<h.length;T++){var v=h[T],M=new ArrayBuffer(m*m*4),S=new Uint32Array(M),E=v.x*m+v.y*m*w;d==c&&(E=2);for(var C=0,R=0;m>R;++R){for(var D=0;m>D;++D)S[C++]=_[E++];E+=w-m}b.push(new Uint8Array(M))}return b}var o=e("three"),a=e("../utils/Utils"),s=function(){function e(e){this.core=e}return e.prototype.create=function(e,t){if(t instanceof o.CubeTexture)return new u(e,this.core,t);throw new Error("Should be CubeTexture")},e}();r.ReflectionTextureCubeProvider=s;var u=function(){function e(e,t,r){this.manager=e,this.core=t,this.textureCube=t.textureCubes.get(r),this.setupDone=!1,this.textureHandle=e.gl.createTexture(),this.log2Size=0}return e.prototype.setup=function(){if(this.setupDone)return!0;if(!this.textureCube.setup())return!1;var e=i(this.core,this.textureCube.textureHandle,this.textureCube.size),t=this.manager.gl;t.bindTexture(t.TEXTURE_CUBE_MAP,this.textureHandle),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR_MIPMAP_NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);var r=e.length/6;this.log2Size=r-1;for(var n=0;r>n;++n)for(var o=1<<r-n-1,a=0;6>a;++a)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,t.RGBA,o,o,0,t.RGBA,t.UNSIGNED_BYTE,e[a+6*n]);return this.setupDone=!0,!0},e.prototype.dispose=function(){this.manager.gl.deleteTexture(this.textureHandle),this.textureHandle=null},e.prototype.bind=function(){var e=this.manager.gl;!this.setup(),e.bindTexture(e.TEXTURE_CUBE_MAP,this.textureHandle)},e}();r.ReflectionTextureCube=u;var h=[{x:0,y:1,dir:new o.Vector3(1,0,0),u:new o.Vector3(0,0,-1),v:new o.Vector3(0,-1,0)},{x:1,y:1,dir:new o.Vector3(-1,0,0),u:new o.Vector3(0,0,1),v:new o.Vector3(0,-1,0)},{x:2,y:1,dir:new o.Vector3(0,1,0),u:new o.Vector3(1,0,0),v:new o.Vector3(0,0,1)},{x:3,y:1,dir:new o.Vector3(0,-1,0),u:new o.Vector3(1,0,0),v:new o.Vector3(0,0,-1)},{x:2,y:0,dir:new o.Vector3(0,0,1),u:new o.Vector3(1,0,0),v:new o.Vector3(0,-1,0)},{x:3,y:0,dir:new o.Vector3(0,0,-1),u:new o.Vector3(-1,0,0),v:new o.Vector3(0,-1,0)}]},{"../utils/Utils":57,three:"three"}],42:[function(e,t,r){var n=e("three"),i=e("../core/GLFramebuffer"),o=e("../utils/Geometry"),a=e("../utils/ObjectPool"),s=function(){function e(e,t,r,n,o){this.core=e,this.input=t,this.inLinearDepth=r,this.out=n,this.dir=o,this.fb=i.GLFramebuffer.createFramebuffer(e.gl,{depth:null,colors:[n.texture]}),this.light=null,this.program=[];for(var a=0;2>a;++a){var s=e.shaderManager.get("VS_ScreenSpaceSoftShadow","FS_ScreenSpaceSoftShadow",["a_position"],{isPositionalLight:0!=(1&a),direction:1==o?1:0,numSamples:8});this.program.push({program:s,uniforms:s.getUniforms(["u_input","u_linearDepth","u_maxBlur","u_viewDirOffset","u_viewDirCoefX","u_viewDirCoefY","u_covSScale","u_lightU","u_lightV","u_lightDir","u_jitter","u_jitterScale"]),attributes:s.getAttributes(["a_position"])})}this.viewVec=null}return e.prototype.beforeRender=function(){this.viewVec=o.computeViewVectorCoefFromProjectionMatrix(this.core.currentCamera.projectionMatrix,this.viewVec)},e.prototype.perform=function(){this.fb.bind();var e=this.core.gl;e.viewport(0,0,this.out.width,this.out.height),this.core.invalidateFramebuffer(e.COLOR_ATTACHMENT0),this.core.state.flags=2;var t=this.core.uniformJitter;e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.inLinearDepth.texture),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.input.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,t.texture);var r=this.light,i=0;r instanceof n.DirectionalLight||(i|=1);var o=this.program[i];o.program.use(),e.uniform1i(o.uniforms.u_input,0),e.uniform1i(o.uniforms.u_linearDepth,1),e.uniform1i(o.uniforms.u_jitter,2),e.uniform2f(o.uniforms.u_viewDirOffset,this.viewVec.offset.x,this.viewVec.offset.y),e.uniform2f(o.uniforms.u_viewDirCoefX,this.viewVec.coefX.x,this.viewVec.coefX.y),e.uniform2f(o.uniforms.u_viewDirCoefY,this.viewVec.coefY.x,this.viewVec.coefY.y);var s=1/this.viewVec.coefX.x,u=1/this.viewVec.coefY.y;if(e.uniform3f(o.uniforms.u_covSScale,s*s,u*u,-s*u),e.uniform2f(o.uniforms.u_jitterScale,this.out.width/t.size,this.out.height/t.size),r instanceof n.DirectionalLight){var h=a.Vector4Pool.alloc();h.set(r.position.x,r.position.y,r.position.z,0),h.applyMatrix4(this.core.currentCamera.matrixWorldInverse),h.normalize();var c=a.Vector3Pool.alloc(),l=a.Vector3Pool.alloc();c.set(h.x,h.y,h.z),e.uniform3f(o.uniforms.u_lightDir,c.x,c.y,c.z),Math.abs(c.z)>.5?l.set(1,0,0):l.set(0,0,1),c.cross(l),c.normalize(),e.uniform3f(o.uniforms.u_lightU,c.x,c.y,c.z),l.set(h.x,h.y,h.z),c.cross(l),e.uniform3f(o.uniforms.u_lightV,c.x,c.y,c.z),a.Vector3Pool.free(c),a.Vector3Pool.free(l),a.Vector4Pool.free(h)}e.uniform1f(o.uniforms.u_maxBlur,.05*.05);var p=this.core.quadRenderer;p.render(o.attributes.a_position),e.activeTexture(e.TEXTURE0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)},e.prototype.afterRender=function(){},e.prototype.dispose=function(){this.fb.dispose()},e}();r.ScreenSpaceSoftShadowRendererInstance=s},{"../core/GLFramebuffer":3,"../utils/Geometry":49,"../utils/ObjectPool":54,three:"three"}],43:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("three"),o=e("../core/RenderPipeline"),a=e("./BaseGeometryPassRenderer"),s=e("../core/GLFramebuffer"),u=function(){function e(e){this.renderer=e,this.gpMaterials=new l(e),this.gpCubeMaterials=new p(e);var t=e.gl;this.normalShadowMapSize=2048,this.cubeShadowMapSize=512;var r=e.ext.get("WEBGL_depth_texture");if(!r)throw new Error("Depth texture not supported");this.depthShadowMapTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.depthShadowMapTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_STENCIL,this.normalShadowMapSize,this.normalShadowMapSize,0,t.DEPTH_STENCIL,r.UNSIGNED_INT_24_8_WEBGL,null),this.colorShadowMapTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.colorShadowMapTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.normalShadowMapSize,this.normalShadowMapSize,0,t.RGBA,t.UNSIGNED_BYTE,null),this.normalShadowMapFramebuffer=s.GLFramebuffer.createFramebuffer(t,{depth:this.depthShadowMapTexture,colors:[this.colorShadowMapTexture]}),this.cubeShadowMapTexture=t.createTexture(),t.bindTexture(t.TEXTURE_CUBE_MAP,this.cubeShadowMapTexture),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);for(var n=0;6>n;++n)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,t.RGBA,this.cubeShadowMapSize,this.cubeShadowMapSize,0,t.RGBA,t.UNSIGNED_BYTE,null);this.cubeShadowMapDepthRB=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.cubeShadowMapDepthRB),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.cubeShadowMapSize,this.cubeShadowMapSize),this.cubeShadowMapFramebuffer=[];for(var n=0;6>n;++n)this.cubeShadowMapFramebuffer.push(s.GLFramebuffer.createFramebuffer(t,{depth:this.cubeShadowMapDepthRB,colors:[this.cubeShadowMapTexture]},t.TEXTURE_CUBE_MAP_POSITIVE_X+n))}return e.prototype.dispose=function(){this.gpMaterials.dispose();var e=this.renderer.gl;e.deleteTexture(this.depthShadowMapTexture),this.normalShadowMapFramebuffer.dispose(),e.deleteTexture(this.cubeShadowMapTexture),e.deleteRenderbuffer(this.cubeShadowMapDepthRB);for(var t=0,r=this.cubeShadowMapFramebuffer;t<r.length;t++){var n=r[t];n.dispose()}},e.prototype.setupShadowPass=function(e){var t=this,r={shadowMaps:new h};return e.push({inputs:{},outputs:{shadowMaps:r.shadowMaps},bindings:[],optionalOutputs:["shadowMaps"],name:"Geometry Pass",factory:function(e){return new d(t,e.outputs.shadowMaps)}}),r},e}();r.ShadowMapRenderer=u,function(e){e[e.Normal=0]="Normal"}(r.ShadowMapType||(r.ShadowMapType={}));var h=(r.ShadowMapType,function(e){function t(){e.call(this,"Shadow Maps"),this.hash=931810,this.cost=0}return n(t,e),t.prototype.canMergeWith=function(e){return e instanceof t?this==e:!1},t.prototype.create=function(e){return new c},Object.defineProperty(t.prototype,"physicalFormatDescription",{get:function(){return"Service"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"logicalFormatDescription",{get:function(){return"Shadow Maps Provider"},enumerable:!0,configurable:!0}),t}(o.RenderBufferInfo));r.ShadowMapRenderBufferInfo=h;var c=function(){function e(){this.service=null}return e.prototype.dispose=function(){},e}(),l=function(e){function t(t){e.call(this,t,"VS_ShadowMapGeometry","FS_ShadowMapGeometry")}return n(t,e),t}(a.BaseGeometryPassMaterialManager),p=function(e){function t(t){e.call(this,t,"VS_CubeShadowMapGeometry","FS_CubeShadowMapGeometry")}return n(t,e),t.prototype.createShader=function(e,t){return new f(this,e,t)},t}(a.BaseGeometryPassMaterialManager),f=function(e){function t(t,r,n){e.call(this,t,r,n),this.manager=t,this.source=r,this.geoUniforms=this.glProgram.getUniforms(["u_viewPositionScale"])}return n(t,e),t}(a.BaseGeometryPassShader),d=function(){function e(e,t){this.parent=e,this.outShadowMap=t,this.normalRenderer=new m(e),this.cubeRenderer=new g(e),this.outShadowMap.service=this}return e.prototype.beforeRender=function(){},e.prototype.perform=function(){},e.prototype.afterRender=function(){},Object.defineProperty(e.prototype,"currentShadowMapDepth",{get:function(){return this.parent.depthShadowMapTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadowMapWidth",{get:function(){return this.parent.normalShadowMapSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadowMapHeight",{get:function(){return this.parent.normalShadowMapSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentCubeShadowDistanceMap",{get:function(){return this.parent.cubeShadowMapTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cubeShadowDistanceMapSize",{get:function(){return this.parent.cubeShadowMapSize},enumerable:!0,configurable:!0}),e.prototype.prepareShadowMap=function(e,t){},e.prototype.renderShadowMap=function(e,t){var r=this.parent.renderer.profiler;if(e instanceof i.Camera)r.begin("Normal Shadow Maps"),this.normalRenderer.render(e),r.end();else{if(!(e instanceof i.CubeCamera))throw new Error("unknown camera type");r.begin("Cube Shadow Maps"),this.cubeRenderer.render(e),r.end()}},e.prototype.dispose=function(){a.BaseGeometryPassRenderer.prototype.dispose.call(this)},e}(),m=function(e){function t(t){e.call(this,t.renderer,t.gpMaterials,!1),this.parent=t}return n(t,e),t.prototype.skipsMesh=function(e){return!e.castShadow},t.prototype.render=function(e){var t=this.parent.renderer.gl;this.parent.normalShadowMapFramebuffer.bind(),t.viewport(0,0,this.parent.normalShadowMapSize,this.parent.normalShadowMapSize),this.parent.renderer.state.flags=1,t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT),this.parent.renderer.state.flags=241,t.polygonOffset(2,2),t.enable(t.POLYGON_OFFSET_FILL),this.renderGeometry(e.matrixWorldInverse,e.projectionMatrix),t.disable(t.POLYGON_OFFSET_FILL)},t.prototype.dispose=function(){a.BaseGeometryPassRenderer.prototype.dispose.call(this)},t}(a.BaseGeometryPassRenderer),g=function(e){function t(t){e.call(this,t.renderer,t.gpCubeMaterials,!1),this.parent=t,this.invFar=0}return n(t,e),t.prototype.skipsMesh=function(e){return!e.castShadow},t.prototype.render=function(e){var t=this.parent.renderer.profiler;t.begin("Setup");var r=this.parent.renderer.gl;r.viewport(0,0,this.parent.cubeShadowMapSize,this.parent.cubeShadowMapSize),this.parent.renderer.state.flags=513,r.clearColor(1,1,1,1),t.end();for(var n=0;6>n;++n){this.parent.cubeShadowMapFramebuffer[n].bind();var o=e.children[n];if(!(o instanceof i.PerspectiveCamera))throw new Error("child of CubeCamera wasn't camera");t.begin("Face"),r.clear(r.DEPTH_BUFFER_BIT|r.COLOR_BUFFER_BIT),o.matrixWorldInverse.getInverse(o.matrixWorld),this.invFar=1/o.far,this.renderGeometry(o.matrixWorldInverse,o.projectionMatrix),t.end()}},t.prototype.setupAdditionalUniforms=function(e,t){var r=t,n=this.parent.renderer.gl;n.uniform1f(r.geoUniforms.u_viewPositionScale,this.invFar)},t.prototype.dispose=function(){a.BaseGeometryPassRenderer.prototype.dispose.call(this)},t}(a.BaseGeometryPassRenderer)},{"../core/GLFramebuffer":3,"../core/RenderPipeline":10,"./BaseGeometryPassRenderer":33,three:"three"}],44:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("../utils/Utils"),o=e("../utils/Pack"),a=function(){function e(e,t,r,n){switch(this.core=e,this.program=t,this.needsLastPosition=r,this.mode=n,this.uniforms=t.getUniforms(["u_skinTexture","u_lastSkinTexture","u_skinTexSize","u_skinInvTexSize","u_skinInvTexSize2","u_skinBindMatrix","u_skinInvBindMatrix"]),this.numTextureStagesNeeded=0,this.textureStageIndex=-1,n){case 2:case 3:this.numTextureStagesNeeded++,r&&this.numTextureStagesNeeded++}}return e.prototype.createInstance=function(e){return new s(this.core,this.uniforms,e,this.needsLastPosition,this.mode,this)},e}();r.SkinningShader=a;var s=function(){function e(e,t,r,n,i,o){this.core=e,this.uniforms=t,this.mesh=r,this.needsLastPosition=n,this.mode=i,this.parent=o,this.texture=null,this.lastTexture=null;var a=r.skeleton.bones.length;switch(this.lastTexture=null,i){case 2:this.texture=new h(e,a),n&&(this.lastTexture=new h(e,a));break;case 3:this.texture=new c(e,a),n&&(this.lastTexture=new c(e,a))}this.firstTime=!0}return e.prototype.update=function(){var e=this.core.gl,t=this.parent;if(e.uniformMatrix4fv(this.uniforms.u_skinBindMatrix,!1,this.mesh.bindMatrix.elements),e.uniformMatrix4fv(this.uniforms.u_skinInvBindMatrix,!1,this.mesh.bindMatrixInverse.elements),e.activeTexture(e.TEXTURE0+t.textureStageIndex),this.texture.update(this.mesh),e.bindTexture(e.TEXTURE_2D,this.texture.texture),e.uniform1i(this.uniforms.u_skinTexture,t.textureStageIndex),this.needsLastPosition?(e.activeTexture(e.TEXTURE0+t.textureStageIndex+1),e.bindTexture(e.TEXTURE_2D,this.lastTexture.texture),e.uniform1i(this.uniforms.u_lastSkinTexture,t.textureStageIndex+1)):e.uniform1i(this.uniforms.u_lastSkinTexture,t.textureStageIndex),e.uniform2f(this.uniforms.u_skinTexSize,this.texture.texCols,this.texture.texRows),e.uniform2f(this.uniforms.u_skinInvTexSize,1/this.texture.texCols,1/this.texture.texRows),e.uniform4f(this.uniforms.u_skinInvTexSize2,1/this.texture.texWidth,1/this.texture.texHeight,.5/this.texture.texWidth,.5/this.texture.texHeight),this.needsLastPosition){var r=this.lastTexture;this.lastTexture=this.texture,this.texture=r}},e}();r.SkinningShaderInstance=s;var u=function(){function e(e,t){if(this.core=e,0==t)this.texCols=1,this.texRows=1;else{var r=i.ulog2(t-1),n=r>>1;this.texCols=1<<n,this.texRows=1<<r-n}this.texture=null}return e.prototype.dispose=function(){},e.prototype.update=function(e){throw new Error("not implemented")},e}(),h=function(e){function t(t,r){e.call(this,t,r),this.texWidth=4*this.texCols,this.texHeight=4*this.texRows,this.buffer=new Uint8Array(this.texWidth*this.texHeight*4);var n=t.gl;this.texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.texWidth,this.texHeight,0,n.RGBA,n.UNSIGNED_BYTE,null)}return n(t,e),t.prototype.dispose=function(){var e=this.core.gl;e.deleteTexture(this.texture),u.prototype.dispose.call(this)},t.prototype.update=function(e){if(e.skeleton){for(var t=e.skeleton.boneMatrices,r=0,n=0,i=this.texWidth,a=this.buffer,s=0;s<t.length;s+=16){for(var u=n+(r<<2),h=0;4>h;++h){for(var c=0;4>c;++c)o.pack32FToU8(a,u+(c<<2),t[s+h+(c<<2)]);u+=i<<2}r+=4,r==i&&(r=0,n+=i<<4)}var l=this.core.gl;l.bindTexture(l.TEXTURE_2D,this.texture),l.texSubImage2D(l.TEXTURE_2D,0,0,0,this.texWidth,this.texHeight,l.RGBA,l.UNSIGNED_BYTE,a)}},t}(u),c=function(e){function t(t,r){e.call(this,t,r),this.texWidth=2*this.texCols,this.texHeight=2*this.texRows,this.buffer=new Float32Array(this.texWidth*this.texHeight*4);var n=t.gl;this.texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.texture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.texWidth,this.texHeight,0,n.RGBA,n.FLOAT,null)}return n(t,e),t.prototype.dispose=function(){var e=this.core.gl;e.deleteTexture(this.texture),u.prototype.dispose.call(this)},t.prototype.update=function(e){if(e.skeleton){for(var t=e.skeleton.boneMatrices,r=0,n=0,i=this.texWidth,o=this.buffer,a=0;a<t.length;a+=16){for(var s=n+(r<<2),u=a,h=0;2>h;++h)o[s]=t[u],o[s+1]=t[u+1],o[s+2]=t[u+2],o[s+3]=t[u+3],o[s+4]=t[u+4],o[s+5]=t[u+5],o[s+6]=t[u+6],o[s+7]=t[u+7],s+=i<<2,u+=8;r+=2,r==i&&(r=0,n+=i<<3)}var c=this.core.gl;c.bindTexture(c.TEXTURE_2D,this.texture),c.texSubImage2D(c.TEXTURE_2D,0,0,0,this.texWidth,this.texHeight,c.RGBA,c.FLOAT,o)}},t}(u)},{"../utils/Pack":55,"../utils/Utils":57}],45:[function(e,t,r){var n=e("three"),i=e("../utils/IdWeakMap"),o=function(){function e(e,t){this.core=e,this.provider=t,this.gl=e.gl,this.map=new i.IdWeakMapWithDisposable}return e.prototype.dispose=function(){this.map.dispose()},e.prototype.get=function(e){if(null==e)return null;var t=this.map.get(e);return null==t&&(t=this.provider.create(this,e),this.map.set(e,t)),t},e.prototype.flush=function(e){this.map.remove(e)},e.prototype.internalFormatForTexture=function(e){switch(e.format){case n.RGBAFormat:return this.gl.RGBA;default:throw new Error("unsupported format: "+e.format)}},e.prototype.formatForTexture=function(e){switch(e.format){case n.RGBAFormat:return this.gl.RGBA;default:throw new Error("unsupported format: "+e.format)}},e.prototype.typeForTexture=function(e){switch(e.type){case n.UnsignedByteType:return this.gl.UNSIGNED_BYTE;default:throw new Error("unsupported type: "+e.type)}},e}();r.TextureManager=o},{"../utils/IdWeakMap":50,three:"three"}],46:[function(e,t,r){function n(e,t,r){var n=document.createElement("canvas");n.width=t,n.height=r;var i=n.getContext("2d");return i.drawImage(e,0,0,t,r),n}var i=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},o=e("three"),a=function(){function e(){}return e.prototype.create=function(e,t){if(t instanceof o.CubeTexture)throw new Error("Shouldn't be CubeTexture");return new h(e,t)},e}();r.Texture2DProvider=a;var s=function(){function e(){}return e.prototype.create=function(e,t){if(t instanceof o.CubeTexture)return new c(e,t);throw new Error("Should be CubeTexture")},e}();r.TextureCubeProvider=s;var u=function(){function e(e,t,r){this.manager=e,this.source=t,this.textureTarget=r,this.textureHandle=e.gl.createTexture()}return e.prototype.setupCommon=function(){var e=this.manager.gl;e.texParameteri(this.textureTarget,e.TEXTURE_MAG_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(this.textureTarget,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR)},e.prototype.dispose=function(){this.manager.gl.deleteTexture(this.textureHandle),this.textureHandle=null},e.prototype.bind=function(){throw new Error("not implemented")},e}();r.Texture=u;var h=function(e){function t(t,r){e.call(this,t,r,t.gl.TEXTURE_2D),this.setupDone=!1}return i(t,e),t.prototype.setup=function(){if(this.setupDone)return!0;var e=this.source.image;if(null==e||0==e.width)return!1;this.setupDone=!0;var t=this.manager.gl;t.bindTexture(this.textureTarget,this.textureHandle),this.setupCommon(),t.texParameteri(this.textureTarget,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(this.textureTarget,t.TEXTURE_WRAP_T,t.REPEAT);var r=t.getParameter(t.MAX_TEXTURE_SIZE);return(e.width>r||e.height>r)&&(e=n(e,r,r)),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,this.source.flipY?1:0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.source.premultiplyAlpha?1:0),t.pixelStorei(t.UNPACK_ALIGNMENT,this.source.unpackAlignment),t.texImage2D(this.textureTarget,0,this.manager.internalFormatForTexture(this.source),this.manager.formatForTexture(this.source),this.manager.typeForTexture(this.source),e),this.source.generateMipmaps&&t.generateMipmap(this.textureTarget),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),t.pixelStorei(t.UNPACK_ALIGNMENT,4),!0},t.prototype.bind=function(){var e=this.manager.gl;!this.setup(),e.bindTexture(this.textureTarget,this.textureHandle)},t}(u);r.Texture2D=h;var c=function(e){function t(t,r){e.call(this,t,r,t.gl.TEXTURE_CUBE_MAP),this.setupDone=!1,this.size=0}return i(t,e),t.prototype.setup=function(){if(this.setupDone)return!0;for(var e=this.source.image,t=0;6>t;++t){var r=e[t];if(null==r||0==r.width)return!1}this.setupDone=!0;var i=this.manager.gl;i.bindTexture(this.textureTarget,this.textureHandle),this.setupCommon(),i.texParameteri(this.textureTarget,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(this.textureTarget,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);var o=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE);if(e[0].width>o||e[0].height>o)for(var t=0;6>t;++t)e[t]=n(e[t],o,o);for(var t=0;6>t;++t){
var r=e[t];i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this.manager.internalFormatForTexture(this.source),this.manager.formatForTexture(this.source),this.manager.typeForTexture(this.source),r)}return this.size=e[0].width,this.source.generateMipmaps&&i.generateMipmap(this.textureTarget),!0},t.prototype.bind=function(){var e=this.manager.gl;!this.setup(),e.bindTexture(this.textureTarget,this.textureHandle)},t}(u);r.TextureCube=c},{three:"three"}],47:[function(e,t,r){r.shaderChunks={FS_Constant:{requires:[],parameters:[],attributes:[],source:"uniform mediump vec4 u_constantColor;\nvoid main()\n{\n    gl_FragColor = u_constantColor;\n}"},FS_Passthrough:{requires:[],parameters:[],attributes:[],source:"uniform sampler2D u_texture;\nvarying highp vec2 v_texCoord;\nvoid main()\n{\n    gl_FragColor = texture2D(u_texture, v_texCoord);\n}\n"},FS_PassthroughModulated:{requires:[],parameters:[],attributes:[],source:"uniform sampler2D u_texture;\nvarying highp vec2 v_texCoord;\nuniform vec4 u_modulation;\nvoid main()\n{\n    gl_FragColor = texture2D(u_texture, v_texCoord) * u_modulation;\n}\n"},VS_Passthrough:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nuniform vec4 u_uvScale;\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * u_uvScale.xy + u_uvScale.zw;\n}\n"},Complex:{requires:[],parameters:[],attributes:[],source:"\nvec2 complexMultiply(vec2 a, vec2 b)\n{\n    vec3 t = vec3(b, -b.y);\n    return vec2(dot(a.xy, t.xz), dot(a.xy, t.yx));\n}\n\n"},Constants:{requires:[],parameters:[],attributes:[],source:"#define M_PI 3.1415926535897932384626433832795"},DepthFetch:{requires:["Globals","Pack"],parameters:["globalUseFullResolutionGBuffer"],attributes:[],source:"\nvec4 encodeGDepth(highp float depth)\n{\n    return vec4(pack24(depth * u_globalInvDepthFar), 0.);\n}\n\nhighp float decodeGDepth(highp vec4 encoded)\n{\n    return unpack24(encoded.xyz) * u_globalDepthFar;\n}\n\nhighp float fetchDepth(sampler2D texDepth, highp vec2 texCoord)\n{\n    return decodeGDepth(texture2D(texDepth, texCoord));\n}\n"},DepthToNormal:{requires:["DepthFetch"],parameters:[],attributes:[],source:"\n#extension GL_OES_standard_derivatives : require\n\n// screen coord [0, 1] must be provided to texCoord.\nvec3 computeNormalFromDepthUsingStandardDerivatives(sampler2D texDepth, highp vec2 texCoord, highp vec3 viewDir)\n{\n	highp float depth = fetchDepth(texDepth, texCoord);\n	highp vec3 viewPos = depth * viewDir;\n\n	vec3 dx = dFdx(viewPos), dy = dFdy(viewPos);\n\n	return normalize(cross(dx, dy));\n}\n"},GBuffer:{requires:["SphereMap","Pack","VelocityMap"],parameters:["globalSupportsSRGB"],attributes:[],source:"\nstruct GBufferContents\n{\n    vec3 albedo;\n    vec3 normal;\n    vec2 velocity;\n    float roughness;\n    float metallic;\n    float specular;\n    float materialId;\n    float materialParam;\n\n    vec3 preshaded;\n};\n\nvec3 decodeGBufferNormal(vec4 g2)\n{\n    return decodeSpheremap(unpack12x2(g2.xyz));\n}\n\nvoid decodeGBuffer(out GBufferContents g, vec4 g0, vec4 g1, vec4 g2, vec4 g3)\n{\n    g.albedo = g0.xyz;\n#if !c_globalSupportsSRGB\n    g.albedo *= g.albedo;\n#endif\n\n    g.normal = decodeGBufferNormal(g2);\n\n    g.velocity = decodeVelocityMap(vec2(g0.w, g1.w));\n\n    g.roughness = g1.x * g1.x;\n    g.metallic = g1.y;\n    g.specular = g1.z;\n\n    float t = g1.y * (255.5 / 16.);\n    g.materialId = floor(t);\n    g.metallic = floor(fract(t) * 16.) * (1. / 15.);\n\n    g.materialParam = g2.w;\n\n    g.preshaded = g3.xyz * exp2(g3.w * 255. - 128.);\n}\n\nvoid encodeGBuffer(out vec4 g0, out vec4 g1, out vec4 g2, out vec4 g3, GBufferContents g)\n{\n    vec2 sphereMap = encodeSpheremap(g.normal);\n    vec2 vel = encodeVelocityMap(g.velocity);\n\n    vec3 preshaded = g.preshaded;\n    float lum = max(max(max(preshaded.x, preshaded.y), preshaded.z), 0.0001);\n    float lumLog = ceil(log2(lum));\n    preshaded *= exp2(-lumLog);\n\n    g0 = vec4(g.albedo, vel.x);\n    g1 = vec4(sqrt(g.roughness),\n        floor(g.metallic * 15.5) * (1. / 255.) + g.materialId * (16. / 255.),\n        g.specular,\n        vel.y);\n    g2 = vec4(pack12x2(sphereMap), g.materialParam);\n    g3 = vec4(preshaded, (lumLog + 128.) * (1. / 255.));\n}\n\nbool isGBufferEmpty(vec4 g0, vec4 g1, vec4 g2, vec4 g3)\n{\n    return g2.x < .001;\n}"},GBufferMosaic:{requires:[],parameters:[],attributes:[],source:"\nvec2 gBufferMosaicPatternNonNormalized(highp vec2 fragCoord) {\n    highp vec2 pos = floor(fragCoord.xy);\n    return fract(pos * 0.5);\n}\n\nvec2 gBufferMosaicPattern(highp vec2 fragCoord) {\n    return gBufferMosaicPatternNonNormalized(fragCoord) * 2.;\n}\n\nvec4 encodeGBufferMosaic(vec4 g0, vec4 g1, vec4 g2, vec4 g3) {\n#if 1\n    // using branch\n    vec2 pattern = gBufferMosaicPatternNonNormalized(gl_FragCoord.xy);\n\n    g0 = pattern.x > .25 ? g1 : g0;\n    g2 = pattern.x > .25 ? g3 : g2;\n\n    return pattern.y > .25 ? g2 : g0;\n#else\n    // branch-less\n    vec2 pattern = gBufferMosaicPattern(gl_FragCoord.xy);\n\n    g0 = mix(g0, g1, pattern.x);\n    g2 = mix(g2, g3, pattern.x);\n\n    return mix(g0, g2, pattern.y);\n#endif\n}\n"},Globals:{requires:[],parameters:[],attributes:[],source:"\nuniform highp vec2 u_globalRenderSize;\nuniform highp vec2 u_globalQuadRenderSize;\nuniform highp vec2 u_globalDoubleRenderSize;\nuniform highp vec2 u_globalHalfRenderSize;\nuniform highp vec2 u_globalInvRenderSize;\nuniform highp vec2 u_globalQuadInvRenderSize;\nuniform highp vec2 u_globalDoubleInvRenderSize;\nuniform highp vec2 u_globalHalfInvRenderSize;\nuniform highp vec2 u_globalQuarterInvRenderSize;\nuniform highp float u_globalDepthFar;\nuniform highp float u_globalInvDepthFar;\n"},HdrMosaic:{requires:[],parameters:["globalSupportsSRGB"],attributes:[],source:"\n#if c_globalSupportsSRGB\nconst float HdrMosaicLevel1 = 1. / 64.;\nconst float HdrMosaicLevel2 = 2.;\n#else\n// when sRGB is unavailable, dynamic range of the buffer is very very low.\nconst float HdrMosaicLevel1 = 1. / 16.;\nconst float HdrMosaicLevel2 = 1.;\n#endif\nconst float HdrMosaicMaximumLevel = 1. / HdrMosaicLevel1;\n\nfloat hdrMosaicMode(highp vec2 fragCoord) {\n    return step(fract(dot(floor(fragCoord.xy), vec2(0.5))), 0.25);\n}\n\nfloat hdrMosaicPatternForMode(float mode) {\n    // FIXME: support non-sRGB mode\n    return mix(HdrMosaicLevel1, HdrMosaicLevel2, mode);\n}\n\nfloat hdrMosaicInvPatternForMode(float mode) {\n    // FIXME: support non-sRGB mode\n    return mix(1. / HdrMosaicLevel1, 1. / HdrMosaicLevel2, mode);\n}\n\nfloat hdrMosaicPattern(highp vec2 fragCoord) {\n    return hdrMosaicPatternForMode(hdrMosaicMode(fragCoord));\n}\n\nvec4 encodeHdrMosaicDithered(vec3 color, vec3 dither) {\n    float lum = max(max(color.x, color.y), color.z);\n    vec3 mosaiced = color.rgb * hdrMosaicPattern(gl_FragCoord.xy);\n#if c_globalSupportsSRGB\n    // buffer is sRGB; error is almost proportional to the value\n    // (gamma is approximated to be 2.5)\n    // stored + error = value^-2.5 (0 <= error <= 1/255)\n    // dvalue/derror = d/derror((stored + error)^2.5)\n    //               = 2.5(stored + error)^1.3\n    //                 \\approx 2.5(value^-2.5)^1.3\n    //               < 2.5value\n    // furthermore, be aware of linear part of sRGB conversion used when input is very dark\n    mosaiced -= dither * ((2.5 / 255.) * mosaiced + 1. / 255. / 12.92) - .5 / 255. / 12.92;\n#else\n    // buffer is linear\n    mosaiced += dither * (1. / 255.) - .5 / 255.;\n#endif\n    return vec4(mosaiced, lum * HdrMosaicLevel2);\n}\n\nvec4 encodeHdrMosaic(vec3 color) {\n    return encodeHdrMosaicDithered(color, vec3(0.5));\n}\n"},HdrToneMapping:{requires:[],parameters:[],attributes:[],source:"\nvec3 encodeReinhard(vec3 hdr)\n{\n	hdr = sqrt(hdr);\n	return hdr / (1. + hdr);\n}\n\nvec3 decodeReinhard(vec3 ldr)\n{\n	ldr = ldr / (1.000001 - ldr);\n	return ldr * ldr; \n}"},LogRGB:{requires:[],parameters:[],attributes:[],source:'\n// actually not using "log"\n\nvec4 encodeLogRGB(vec3 rgb)\n{\n    float lum = max(max(rgb.r, rgb.g), rgb.b);\n    float logval = min(floor(lum * 4. + 1.), 64.) * (1. / 4.);\n    float invLogval = 1. / logval;\n    return vec4(rgb * invLogval, logval * (1. / 16.));\n}\n\nvec3 decodeLogRGB(vec4 p)\n{\n    float t = floor(p.a * 64. + .5) * (1. / 4.);\n    return p.rgb * t;\n}\n'},Materials:{requires:[],parameters:[],attributes:[],source:"\n#define MaterialIdUnlit         0.\n#define MaterialIdDefault         1.\n#define MaterialIdClearCoat     2.\n"},MatrixDeterminant:{requires:[],parameters:[],attributes:[],source:"float determinantOfMatrix2(mat2 m)\n{\n	return m[0][0] * m[1][1] - m[0][1] * m[1][0];\n}\nhighp float determinantOfMatrix2Highp(highp mat2 m)\n{\n	return m[0][0] * m[1][1] - m[0][1] * m[1][0];\n}\n\nfloat determinantOfMatrix3(mat3 m)\n{\n	return \n		m[0][0] * m[1][1] * m[2][2] + \n		m[1][0] * m[2][1] * m[0][2] +\n		m[2][0] * m[0][1] * m[1][2] -\n		m[2][0] * m[1][1] * m[0][2] -\n		m[1][0] * m[0][1] * m[2][2] -\n		m[0][0] * m[2][1] * m[1][2];\n}\nhighp float determinantOfMatrix3Highp(highp mat3 m)\n{\n	return \n		m[0][0] * m[1][1] * m[2][2] + \n		m[1][0] * m[2][1] * m[0][2] +\n		m[2][0] * m[0][1] * m[1][2] -\n		m[2][0] * m[1][1] * m[0][2] -\n		m[1][0] * m[0][1] * m[2][2] -\n		m[0][0] * m[2][1] * m[1][2];\n}\n"},MatrixInverse:{requires:["MatrixDeterminant"],parameters:[],attributes:[],source:"\nmat2 invertMatrix2(mat2 m, float safeMargin)\n{\n	return mat2(m[1][1], m[0][1], m[1][0], m[0][0]) /\n		(determinantOfMatrix2(m) + safeMargin);\n}\n\nhighp mat2 invertMatrix2Highp(highp mat2 m, highp float safeMargin)\n{\n	return mat2(m[1][1], m[0][1], m[1][0], m[0][0]) /\n		(determinantOfMatrix2Highp(m) + safeMargin);\n}\n\nmat3 invertMatrix3(mat3 m, float safeMargin)\n{\n	return mat3(\n		determinantOfMatrix2(mat2(m[1].yz, m[2].yz)),\n		determinantOfMatrix2(mat2(m[1].xz, m[2].xz)),\n		determinantOfMatrix2(mat2(m[1].xy, m[2].xy)),\n		determinantOfMatrix2(mat2(m[0].yz, m[2].yz)),\n		determinantOfMatrix2(mat2(m[0].xz, m[2].xz)),\n		determinantOfMatrix2(mat2(m[0].xy, m[2].xy)),\n		determinantOfMatrix2(mat2(m[0].yz, m[1].yz)),\n		determinantOfMatrix2(mat2(m[0].xz, m[1].xz)),\n		determinantOfMatrix2(mat2(m[0].xy, m[1].xy))\n	) / (determinantOfMatrix3(m) + safeMargin);\n}\n\nhighp mat3 invertMatrix3Highp(highp mat3 m, highp float safeMargin)\n{\n	return mat3(\n		determinantOfMatrix2Highp(mat2(m[1].yz, m[2].yz)),\n		determinantOfMatrix2Highp(mat2(m[1].xz, m[2].xz)),\n		determinantOfMatrix2Highp(mat2(m[1].xy, m[2].xy)),\n		determinantOfMatrix2Highp(mat2(m[0].yz, m[2].yz)),\n		determinantOfMatrix2Highp(mat2(m[0].xz, m[2].xz)),\n		determinantOfMatrix2Highp(mat2(m[0].xy, m[2].xy)),\n		determinantOfMatrix2Highp(mat2(m[0].yz, m[1].yz)),\n		determinantOfMatrix2Highp(mat2(m[0].xz, m[1].xz)),\n		determinantOfMatrix2Highp(mat2(m[0].xy, m[1].xy))\n	) / (determinantOfMatrix3Highp(m) + safeMargin);\n}\n"},MatrixTranspose:{requires:[],parameters:[],attributes:[],source:"\nmat2 transposeMatrix2(mat2 m)\n{\n	return mat2(m[0][0], m[1][0], m[0][1], m[1][1]);\n}\nhighp mat2 transposeMatrix2Highp (highp mat2 m)\n{\n	return mat2(m[0][0], m[1][0], m[0][1], m[1][1]);\n}\n\nmat3 transposeMatrix3(mat3 m)\n{\n	return mat3(\n		m[0][0], m[1][0], m[2][0],\n		m[0][1], m[1][1], m[2][1],\n		m[0][2], m[1][2], m[2][2]);\n}\n\nhighp mat3 transposeMatrix3Highp(highp mat3 m)\n{\n	return mat3(\n		m[0][0], m[1][0], m[2][0],\n		m[0][1], m[1][1], m[2][1],\n		m[0][2], m[1][2], m[2][2]);\n}\n"},Pack:{requires:[],parameters:[],attributes:[],source:"vec2 pack16(highp float value) {\n    value *= 255.;\n    highp float flr = floor(value);\n    return vec2(flr * (1. / 255.), value - flr);\n}\n\nhighp float unpack16(vec2 packedValue) {\n    return packedValue.x + packedValue.y * (1. / 255.);\n}\n\nvec3 pack24(highp float value) {\n    value *= 256.;\n    highp float i1 = floor(value);\n    highp float f1 = value - i1;\n    f1 *= 256.;\n    highp float i2 = floor(f1);\n    highp float f2 = f1 - i2;\n    return vec3(i1 * (1. / 255.), i2 * (1. / 255.), f2);\n}\n\nhighp float unpack24(vec3 packedValue) {\n    return dot(packedValue, vec3(1., 1. / 256., 1. / 256. / 256.) * 255. / 256.);\n}\n\nvec4 pack32f(highp float value)\n{\n    highp float absValue = abs(value);\n    if (absValue <= 1.e-16) {\n        // underflow\n        return vec4(0., 0., 0., 0.);\n    } else {\n        highp float exponent = ceil(log2(absValue));\n        absValue *= exp2(-exponent);\n\n        exponent += 63.; // bias\n        if (value < 0.) {\n            exponent += 128.; // sign\n        }\n        exponent *= 1. / 255.;\n\n        return vec4(pack24(absValue), exponent);\n    }\n}\n\nhighp float unpack32f(vec4 p)\n{\n    if (p.w == 0.) {\n        return 0.;\n    } else {\n        bool negative = false;\n        highp float exponent = floor(p.w * 255. + 0.5 - 63.);\n        if (exponent >= 128. - 63.) {\n            // negative\n            negative = true;\n            exponent -= 128.;\n        }\n\n        highp float mantissa = unpack24(p.xyz);\n        if (negative) {\n            mantissa = -mantissa;\n        }\n\n        return mantissa * exp2(exponent);\n    }\n}\n\nvec3 pack12x2(highp vec2 value)\n{\n    value *= 255.;\n    highp vec2 flr = floor(value);\n    highp vec2 frc = floor((value - flr) * 16.);\n    return vec3(flr * (1. / 255.), dot(frc, vec2(1., 16.) / 255.));\n}\nhighp vec2 unpack12x2(vec3 p)\n{\n    float yy = p.z * (255. / 16.);\n    float yi = floor(yy);\n    float yf = fract(yy);\n    return p.xy + vec2(yf, yi) * vec2(1. / 255., 1. / 16. / 255.);\n}"},ScreenSpaceRaytrace:{requires:["DepthFetch"],parameters:[],attributes:[],source:"\n/*\nbased on http://casual-effects.blogspot.jp/2014/08/screen-space-ray-tracing.html:\n    // By Morgan McGuire and Michael Mara at Williams College 2014\n    // Released as open source under the BSD 2-Clause License\n    // http://opensource.org/licenses/BSD-2-Clause\n*/\n\nbool rayTraceScreenSpace(\n    sampler2D linearDepth,\n    highp vec3 csOrig,\n    highp vec3 csDir,\n    highp mat4 projMat, // shoudl map to pixel coordinate\n    highp vec2 bufferSize,\n    highp vec2 invBufferSize,\n    float stride,\n    float jitter,\n    float maxDistance,\n    out highp vec2 hitPixel,\n    out highp vec3 hitPoint,\n    out float hitSteps\n)\n{\n    // clip ray to the near plane\n    const highp float nearPlaneZ = 0.01;\n    highp float rayLength = (csOrig.z + csDir.z * maxDistance) < nearPlaneZ ?\n        (nearPlaneZ - csOrig.z) / csDir.z : maxDistance;\n    highp vec3 csEnd = csOrig + csDir * rayLength;\n\n    // project into homogeneous clip space\n    highp vec4 h0 = projMat * vec4(csOrig, 1.);\n    highp vec4 h1 = projMat * vec4(csEnd, 1.);\n    highp float k0 = 1. / h0.w, k1 = 1. / h1.w;\n\n    // intepolated homogeneous version of the camera-space points\n    highp vec3 q0 = csOrig * k0;\n    highp vec3 q1 = csEnd * k1;\n\n    // screen-space points\n    highp vec2 p0 = h0.xy * k0;\n    highp vec2 p1 = h1.xy * k1;\n\n    highp vec2 delta = p1 - p0;\n    if (dot(delta, delta) < 0.000001) {\n        return false;\n    }\n\n    // permute xy for vertical line\n    bool permute = false;\n    if (abs(delta.x) < abs(delta.y)) {\n        permute = true;\n        delta = delta.yx;\n        p0 = p0.yx;\n        p1 = p1.yx;\n    }\n\n    highp float stepDir = sign(delta.x);\n    highp float invdx = abs(1. / delta.x);\n\n    // derivatives of Q and k\n    highp vec3 dq = (q1 - q0) * invdx;\n    highp float dk = (k1 - k0) * invdx;\n    highp vec2 dp = vec2(stepDir, delta.y * invdx);\n\n    // scale derivatives\n    dp *= stride; dq *= stride; dk *= stride;\n    p0 += dp * jitter; q0 += dq * jitter; k0 += dk * jitter;\n\n    // slice p from p0 to p1, q from q0 to q1, k from k0 to k1\n    highp vec3 q = q0;\n\n    // end condition\n    highp float end = p1.x * stepDir;\n\n    highp float k = k0, prevZMaxEstimate = csOrig.z;\n    highp float rayZMin = prevZMaxEstimate, rayZMax = prevZMaxEstimate;\n    highp float sceneZMax = rayZMax + 100000.;\n    const highp float zThickness = .1;\n    highp vec2 p = p0;\n    float stepCount = 0.;\n    const int numMaxSteps = 16;\n    for (int i = 0; i < numMaxSteps; ++i) {\n        if (((p.x * stepDir) > end) ||\n            ((rayZMax > sceneZMax) && (rayZMin < sceneZMax + zThickness)) ||\n            sceneZMax == 0.) {\n            break;\n        }\n\n        rayZMin = prevZMaxEstimate;\n        rayZMax = (dq.z * 0.5 + q.z) / (dk * 0.5 + k);\n        prevZMaxEstimate = rayZMax;\n\n        if (rayZMin > rayZMax) {\n            float t = rayZMin; rayZMin = rayZMax; rayZMax = t;\n        }\n\n        hitPixel = permute ? p.yx : p;\n\n        sceneZMax = fetchDepth(linearDepth, hitPixel * invBufferSize);\n\n        p += dp; q.z += dq.z; k += dk; stepCount += 1.;\n    }\n\n    q.xy += dq.xy * stepCount;\n    hitPoint = q * (1. / k);\n\n    hitSteps = (stepCount + jitter) * (1. / float(numMaxSteps + 1));\n\n    return (rayZMax >= sceneZMax) && (rayZMin < sceneZMax + zThickness);\n}\n"},ShadingModel:{requires:["Constants","GBuffer","Materials"],parameters:[],attributes:[],source:'\nstruct PointLightBRDFParameters\n{\n    float nhDot;\n    float nlDot;\n    float nvDot;\n    float hlDot;\n};\n\nstruct UniformLightBRDFParameters\n{\n    float nvDot;\n};\n\nstruct MaterialInfo\n{\n    vec3 albedo;\n    float roughness;\n    float metallic;\n    float specular;\n\n    float clearCoatRoughness;\n\n    float materialId;\n};\n\nfloat evaluateGGXSpecularDistribution(float nhDot, highp float roughness)\n{\n    // Walter et al. 2007, "Microfacet models for refraction through rough surfaces"\n    // http://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.pdf\n    highp float a = roughness * roughness;\n    highp float aa = a * a;\n    highp float t = nhDot * nhDot * (aa - 1.) + 1.;\n    return aa /\n        (t * t + 1.e-20);\n}\n\nfloat evaluateLambertDiffuse(float nlDot)\n{\n    return 1.;\n}\n\nfloat evaluateDisneyPrincipledDiffuse(float nlDot, float nvDot, float hlDot, float roughness)\n{\n    float fd90m1 = -0.5 + hlDot * hlDot * 2. * roughness;\n    float f1a = 1. - nlDot, f2a = 1. - nvDot;\n    float f1b = f1a * f1a, f2b = f2a * f2a;\n    float f1 = f1a * f1b * f1b, f2 = f2a * f2b * f2b;\n    return (1. + fd90m1 * f1) * (1. + fd90m1 * f2) * nlDot;\n}\n\nfloat evaluateSchlickFresnel(float hlDot)\n{\n    float t = 1. - hlDot;\n    float tt = t * t;\n    return tt * tt * t;\n}\n\n// evaluateXXXGeometryShadowing evaluates G(l, v, h) / (n dot v).\nfloat evaluateBeckmannGeometryShadowing(float nlDot, float nvDot, float roughness)\n{\n    // http://graphicrants.blogspot.jp/2013/08/specular-brdf-reference.html\n    float lct = .5 / (roughness * sqrt(1. - nlDot * nlDot) + 0.00001);\n    float vct = .5 / (roughness * sqrt(1. - nvDot * nvDot) + 0.00001);\n    float lc = lct * nlDot, vc = vct * nvDot;\n    float a = 3.353 * lc + 2.181 * lc * lc; // not typo\n    a *= 3.353 * vct + 2.181 * vct * vc;\n    float b = 1. + 2.276 * lc + 2.577 * lc * lc;\n    b *= 1. + 2.276 * vc + 2.577 * vc * vc;\n    return a / b;\n}\nfloat evaluateBeckmannGeometryShadowingSingleSide(float nlDot, float roughness)\n{\n    // http://graphicrants.blogspot.jp/2013/08/specular-brdf-reference.html\n    float lct = .5 / (roughness * sqrt(1. - nlDot * nlDot) + 0.00001);\n    float lc = lct * nlDot;\n    float a = 3.353 * lc + 2.181 * lc * lc; // not typo\n    float b = 1. + 2.276 * lc + 2.577 * lc * lc;\n    return a / b;\n}\n\nbool isMaterialClearCoat(MaterialInfo material)\n{\n    return material.materialId == MaterialIdClearCoat;\n}\n\nvec3 evaluatePointLight(\n    PointLightBRDFParameters params,\n    MaterialInfo material,\n    vec3 lightColor)\n{\n    if (material.materialId == MaterialIdUnlit) {\n        return vec3(0.);\n    }\n    if (params.nlDot <= 0.) {\n        return vec3(0.);\n    }\n\n    float fresnel = evaluateSchlickFresnel(params.hlDot);\n\n    vec3 minRefl = mix(vec3(material.specular), material.albedo, material.metallic);\n    vec3 refl = mix(minRefl, vec3(1.), fresnel);\n\n    float diffuseMix = 1. - mix(mix(material.specular, 1., material.metallic), 1., fresnel);\n    diffuseMix *= evaluateDisneyPrincipledDiffuse(params.nlDot, params.nvDot, params.hlDot, material.roughness);\n\n    float specular = evaluateGGXSpecularDistribution(params.nhDot, material.roughness);\n    specular *= evaluateBeckmannGeometryShadowing(params.nlDot, params.nvDot, material.roughness);\n\n    diffuseMix *= params.nlDot; specular *= params.nlDot;\n\n    vec3 diffuse = material.albedo;\n\n    vec3 final = diffuse * diffuseMix + refl * specular;\n\n    // clear coat\n    if (isMaterialClearCoat(material)) {\n        float ccspecular = evaluateGGXSpecularDistribution(params.nhDot, material.clearCoatRoughness);\n        ccspecular *= evaluateBeckmannGeometryShadowing(params.nlDot, params.nvDot, material.clearCoatRoughness);\n        ccspecular *= params.nlDot;\n        float refl = mix(0.03, 1., fresnel);\n        final = mix(final, vec3(ccspecular), refl);\n    }\n\n    return final * lightColor;\n}\n\nvec3 evaluateUniformLight(\n    UniformLightBRDFParameters params,\n    MaterialInfo material,\n    vec3 lightColor)\n{\n    if (material.materialId == MaterialIdUnlit) {\n        return vec3(0.);\n    }\n\n    // FIXME: verify this model\n    float fresnel = evaluateSchlickFresnel(params.nvDot);\n\n    vec3 minRefl = mix(vec3(material.specular), material.albedo, material.metallic);\n    vec3 refl = mix(minRefl, vec3(1.), fresnel);\n\n    float diffuseMix = 1. - mix(mix(material.specular, 1., material.metallic), 1., fresnel);\n\n    vec3 diffuse = material.albedo;\n\n    vec3 final = diffuse * diffuseMix;\n    return final * lightColor;\n}\n\nvec4 evaluateReflection(\n    float nvDot,\n    MaterialInfo material)\n{\n    if (material.materialId == MaterialIdUnlit) {\n        return vec4(0.);\n    }\n\n    // assume h = n now\n    float fresnel = evaluateSchlickFresnel(nvDot);\n\n    vec3 minRefl = mix(vec3(material.specular), material.albedo, material.metallic);\n    vec4 refl = vec4(mix(minRefl, vec3(1.), fresnel), 1.);\n\n    refl *= evaluateBeckmannGeometryShadowingSingleSide(nvDot, material.roughness);\n\n    return refl;\n}\n\nvec2 evaluateReflectionForClearCoat(\n    float nvDot,\n    MaterialInfo material)\n{\n    if (!isMaterialClearCoat(material)) {\n        return vec2(0.);\n    }\n\n    // assume h = n now\n    float fresnel = evaluateSchlickFresnel(nvDot);\n\n    float refl = mix(0.03, 1., fresnel);\n\n    float reflShadowed = refl * \n        evaluateBeckmannGeometryShadowing(nvDot, nvDot, material.clearCoatRoughness); // FIXME: optimize?\n\n    return vec2(reflShadowed, refl);\n}\n\nPointLightBRDFParameters computePointLightBRDFParameters(\n    vec3 normal, vec3 light, vec3 view)\n{\n    vec3 halfVec = normalize(light + view);\n    return PointLightBRDFParameters(\n        clamp(dot(normal, halfVec), 0., 1.),\n        clamp(dot(normal, light), 0., 1.),\n        clamp(dot(normal, view), 0., 1.),\n        clamp(dot(halfVec, light), 0., 1.));\n}\n\nUniformLightBRDFParameters computeUniformLightBRDFParameters(\n    vec3 normal, vec3 view)\n{\n    UniformLightBRDFParameters ret;\n    ret.nvDot = clamp(dot(normal, view), 0., 1.);\n    return ret;\n}\n\nMaterialInfo getMaterialInfoFromGBuffer(GBufferContents g)\n{\n    return MaterialInfo(\n        g.albedo,\n        mix(0.001, 1., g.roughness),\n        g.metallic,\n        g.specular,\n\n        mix(0.001, 1., g.materialParam), // clearCoatRoughness\n\n        g.materialId);\n}\n\n'},ShadowTexture:{requires:[],parameters:[],attributes:[],source:"float shadowTexture2D(highp sampler2D tex, highp vec3 coord)\n{\n    highp float value = texture2D(tex, coord.xy).r;\n    return step(coord.z, value);\n}\n"},SphereMap:{requires:[],parameters:[],attributes:[],source:"highp vec2 encodeSpheremap(highp vec3 normal) {\n    highp vec2 e = normal.xy * inversesqrt(8. + normal.z * 8.);\n    return e + 0.5;\n}\n\nhighp vec3 decodeSpheremap(highp vec2 encoded) {\n    highp vec4 nn = vec4(encoded * 2. - 1., 1., -1.);\n    highp float l = dot(nn.xyz, -nn.xyw);\n    nn.z = l; nn.xy *= sqrt(l);\n    return nn.xyz * 2. + vec3(0., 0., -1.);\n}\n"},TextureLod:{requires:[],parameters:[],attributes:[],source:"#extension GL_EXT_shader_texture_lod : enable\n#extension GL_OES_standard_derivatives : require\n\n#ifdef GL_EXT_shader_texture_lod\nvec4 myTextureCubeLod(samplerCube tex, highp vec3 coord, float lod, float texSize)\n{\n	return textureCubeLodEXT(tex, coord, lod);\n}\nvec4 myTextureCubeLodSeamless(samplerCube tex, highp vec3 coord, float lod, float texSize)\n{\n	highp vec3 coordAbs = abs(coord);\n	highp float majorValue = max(max(coordAbs.x, coordAbs.y), coordAbs.z);\n	bvec3 isMajor = equal(coordAbs, vec3(majorValue));\n\n	float logTexSize = log2(texSize); lod = min(lod, logTexSize - 2.);\n	float lodFloor = floor(lod);\n	float actualTexSizeInv1 = exp2(lodFloor - log2(texSize));\n	float actualTexSizeInv2 = actualTexSizeInv1 * 2.;\n	highp vec3 modifiedCoord1 = coord * (1. - actualTexSizeInv1);\n	highp vec3 modifiedCoord2 = coord * (1. - actualTexSizeInv2);\n\n	highp vec3 coord1, coord2;\n	coord1.x = isMajor.x ? coord.x : modifiedCoord1.x;\n	coord1.y = isMajor.y ? coord.y : modifiedCoord1.y;\n	coord1.z = isMajor.z ? coord.z : modifiedCoord1.z;\n	coord2.x = isMajor.x ? coord.x : modifiedCoord2.x;\n	coord2.y = isMajor.y ? coord.y : modifiedCoord2.y;\n	coord2.z = isMajor.z ? coord.z : modifiedCoord2.z;\n\n	return mix(textureCubeLodEXT(tex, coord1, lodFloor), textureCubeLodEXT(tex, coord2, lodFloor + 1.), fract(lod));\n}\n#else\nvec4 myTextureCubeLod(samplerCube tex, highp vec3 coord, float lod, float texSize)\n{\n	highp vec3 coordAbs = abs(coord);\n	highp vec3 cubeCoord = coord / max(coordAbs.x, max(coordAbs.y, coordAbs.z));\n	highp vec3 cubeCoordD = fwidth(cubeCoord);\n	float diff = max(max(cubeCoordD.x, cubeCoordD.y), cubeCoordD.z) * texSize * 0.5;\n	float autolod = max(log2(diff + .125), 0.);\n	return textureCube(tex, coord, lod - autolod);\n}\nvec4 myTextureCubeLodSeamless(samplerCube tex, highp vec3 coord, float lod, float texSize)\n{\n	// TODO\n	return myTextureCubeLod(tex, coord, lod, texSize);\n}\n#endif\n"},VelocityMap:{requires:[],parameters:[],attributes:[],source:"\nvec2 decodeVelocityMap(vec2 v)\n{\n    v = (v - 127. / 255.);\n\n    return v * length(v);\n}\n\nvec2 encodeVelocityMap(vec2 v)\n{\n    v *= inversesqrt(length(v));\n    return v + (127. / 255.);\n}\n"},YUV:{requires:[],parameters:[],attributes:[],source:"\nvec3 encodePalYuv(vec3 rgb)\n{\n    return vec3(\n        dot(rgb, vec3(0.299, 0.587, 0.114)),\n        dot(rgb, vec3(-0.14713, -0.28886, 0.436)),\n        dot(rgb, vec3(0.615, -0.51499, -0.10001))\n    );\n}\n\nvec3 decodePalYuv(vec3 yuv)\n{\n    return vec3(\n        dot(yuv, vec3(1., 0., 1.13983)),\n        dot(yuv, vec3(1., -0.39465, -0.58060)),\n        dot(yuv, vec3(1., 2.03211, 0.))\n    );\n}\n"},FS_GBufferDemosaic:{requires:["Globals","DepthFetch"],parameters:["gBufferIndex","globalSupportsSRGB","globalUseFullResolutionGBuffer"],attributes:[],source:"/** G-Buffer index.\n * 0 : G0, 1 : G1, 2 : G2, 3 : G3, 4 : Depth */\n\nuniform sampler2D u_mosaic;\nuniform highp sampler2D u_depth;\nvarying highp vec4 v_texCoords;\nvarying highp vec2 v_texCoord;\n\nuniform highp vec4 u_depthLinearizeCoef;\n\n// FIXME: better method\nhighp float wrapCoord(highp float coord)\n{\n    return fract(coord);\n}\nhighp vec2 wrapCoord2(highp vec2 coord)\n{\n    return fract(coord);\n}\n\nvoid main()\n{\n    highp float targetDepth = texture2D(u_depth, v_texCoord.xy).x;\n\n#if c_gBufferIndex == 4\n    // depth\n    targetDepth = targetDepth * 2. - 1.;\n    highp float a = dot(u_depthLinearizeCoef.xy, vec2(targetDepth, 1.));\n    highp float b = dot(u_depthLinearizeCoef.zw, vec2(targetDepth, 1.));\n\n    gl_FragColor = encodeGDepth(a / b);\n#else // c_gBufferIndex == 4\n\n    // see G-Buffer Demosaicing.ai\n\n#if c_globalUseFullResolutionGBuffer\n\n#if c_gBufferIndex == 0\n#define NumComparands 1\n    highp vec2 coord1 = v_texCoords.xy;\n#elif c_gBufferIndex == 1\n#define NumComparands 2\n    highp vec2 coord1 = v_texCoords.xy;\n    highp vec2 coord2 = v_texCoords.zw;\n    coord1.x = wrapCoord(coord1.x);\n    coord2.x = wrapCoord(coord2.x);\n#elif c_gBufferIndex == 2\n#define NumComparands 2\n    highp vec2 coord1 = v_texCoords.xy;\n    highp vec2 coord2 = v_texCoords.zw;\n    coord1.y = wrapCoord(coord1.y);\n    coord2.y = wrapCoord(coord2.y);\n#elif c_gBufferIndex == 3\n#define NumComparands 4\n    highp vec2 coord1 = v_texCoords.xy;\n    highp vec2 coord2 = v_texCoords.zy;\n    highp vec2 coord3 = v_texCoords.xw;\n    highp vec2 coord4 = v_texCoords.zw;\n    coord1 = wrapCoord2(coord1);\n    coord2 = wrapCoord2(coord2);\n    coord3 = wrapCoord2(coord3);\n    coord4 = wrapCoord2(coord4);\n#endif // c_gBufferIndex\n\n#else // c_globalUseFullResolutionGBuffer\n#define NumComparands 4\n    highp vec2 coord = gl_FragCoord.xy * .5 - 0.25;\n#if c_gBufferIndex == 1\n    coord.x -= 0.5;\n#elif c_gBufferIndex == 2\n    coord.y -= 0.5;\n#elif c_gBufferIndex == 3\n    coord.xy -= 0.5;\n#endif // c_gBufferIndex\n    highp vec2 err = fract(coord);\n    coord = floor(coord) + 0.25;\n#if c_gBufferIndex == 1\n    coord.x += .5;\n#elif c_gBufferIndex == 2\n    coord.y += .5;\n#elif c_gBufferIndex == 3\n    coord.xy += .5;\n#endif // c_gBufferIndex\n\n    coord *= u_globalDoubleInvRenderSize;\n    err *= u_globalQuadInvRenderSize;\n\n    highp vec4 coords = vec4(coord, coord + err);\n\n    coords = fract(coords);\n\n    highp vec2 coord1 = coords.xy;\n    highp vec2 coord2 = coords.zy;\n    highp vec2 coord3 = coords.xw;\n    highp vec2 coord4 = coords.zw;\n#endif // c_globalUseFullResolutionGBuffer\n\n    vec4 retValue = texture2D(u_mosaic, coord1);\n#if NumComparands > 1\n    highp float retDepth = abs(texture2D(u_depth, coord1).x - targetDepth);\n#endif // NumComparands > 1\n\n#if NumComparands >= 2\n    vec4 value2 = texture2D(u_mosaic, coord2);\n    highp float depth2 = abs(texture2D(u_depth, coord2).x - targetDepth);\n    if (depth2 < retDepth) {\n        retValue = value2;\n        retDepth = depth2;\n    }\n#endif\n\n#if NumComparands >= 3\n    vec4 value3 = texture2D(u_mosaic, coord3);\n    highp float depth3 = abs(texture2D(u_depth, coord3).x - targetDepth);\n    if (depth3 < retDepth) {\n        retValue = value3;\n        retDepth = depth3;\n    }\n#endif\n\n#if NumComparands >= 4\n    vec4 value4 = texture2D(u_mosaic, coord4);\n    highp float depth4 = abs(texture2D(u_depth, coord4).x - targetDepth);\n    if (depth4 < retDepth) {\n        retValue = value4;\n        retDepth = depth4;\n    }\n#endif\n    gl_FragColor = retValue;\n#endif // c_gBufferIndex == 4\n\n    // G0 contains color values. We should linearize them now\n    // if possible.\n#if (c_gBufferIndex == 0) && c_globalSupportsSRGB\n    // final G0 is sRGB buffer; we can rely on hardware\n    // from this point\n    // (if not, we should linearize them in every shader that reads them)\n    gl_FragColor.xyz *= gl_FragColor.xyz;\n#endif\n}\n"},FS_HdrDemosaic:{requires:["Globals","HdrMosaic","LogRGB"],parameters:[],attributes:[],source:"\nuniform sampler2D u_mosaic;\nvarying highp vec2 v_texCoord1;\nvarying highp vec2 v_texCoord2;\nvarying highp vec2 v_texCoord3;\n\nvoid main()\n{\n    vec4 mosaic1 = texture2D(u_mosaic, v_texCoord1.xy);\n    vec4 mosaic2 = texture2D(u_mosaic, vec2(v_texCoord1.x, v_texCoord2.y));\n    vec4 mosaic3 = texture2D(u_mosaic, vec2(v_texCoord1.x, v_texCoord3.y));\n    vec4 mosaic4 = texture2D(u_mosaic, vec2(v_texCoord2.x, v_texCoord1.y));\n    vec4 mosaic5 = texture2D(u_mosaic, vec2(v_texCoord3.x, v_texCoord1.y));\n    vec3 mosaicAvg = (mosaic2 + mosaic3 + mosaic4 + mosaic5).xyz * 0.25;\n\n    float overflowLevel;\n    {\n        float t1 = max(mosaic1.w, mosaic2.w);\n        float t2 = max(mosaic3.w, mosaic4.w);\n        float t3 = max(t1, mosaic5.w);\n        overflowLevel = max(t2, t3);\n    }\n    overflowLevel = max(overflowLevel * 10. - 9., 0.);\n\n    float currentPixelMode = hdrMosaicMode(gl_FragCoord.xy);\n    float mixamt = mix(1. - overflowLevel, overflowLevel, currentPixelMode);\n\n    float pat1 = hdrMosaicInvPatternForMode(currentPixelMode);\n    float pat2 = hdrMosaicInvPatternForMode(1. - currentPixelMode);\n\n    mosaic1.xyz *= pat1;\n    mosaicAvg.xyz *= pat2;\n\n    // gl_FragColor.xyz = vec3(overflowLevel); return;\n\n    vec3 demosaicedRGB = mix(mosaic1.xyz, mosaicAvg, mixamt);\n\n    gl_FragColor = encodeLogRGB(demosaicedRGB);\n}\n"
},VS_GBufferDemosaic:{requires:["Globals"],parameters:["gBufferIndex","globalUseFullResolutionGBuffer"],attributes:[],source:"\nattribute vec2 a_position;\nvarying vec4 v_texCoords; // FIXME: remove dependent texture fetch\nvarying vec2 v_texCoord;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n\n    vec2 normCoord = a_position * 0.5 + 0.5;\n\n    v_texCoord = normCoord;\n\n    // see G-Buffer Demosaicing.ai\n#if c_globalUseFullResolutionGBuffer\n    v_texCoord = normCoord - u_globalQuarterInvRenderSize;\n    v_texCoords = v_texCoord.xyxy;\n#if c_gBufferIndex == 1\n    v_texCoords.x += u_globalHalfInvRenderSize.x;\n    v_texCoords.z -= u_globalHalfInvRenderSize.x;\n#elif c_gBufferIndex == 2\n    v_texCoords.y += u_globalHalfInvRenderSize.y;\n    v_texCoords.w -= u_globalHalfInvRenderSize.y;\n#elif c_gBufferIndex == 3\n    v_texCoords.xy += u_globalHalfInvRenderSize;\n    v_texCoords.zw -= u_globalHalfInvRenderSize;\n#endif // c_gBufferIndex\n#else // c_globalUseFullResolutionGBuffer\n// FIXME: these are used because of precision problem\n    v_texCoords = vec4(normCoord, normCoord * u_globalHalfRenderSize - 0.25);\n#if c_gBufferIndex == 1\n    v_texCoords.z += 0.5;\n#elif c_gBufferIndex == 2\n    v_texCoords.w += 0.5;\n#elif c_gBufferIndex == 3\n    v_texCoords.zw += 0.5;\n#endif // c_gBufferIndex\n#endif // c_globalUseFullResolutionGBuffer\n}\n"},VS_HdrDemosaic:{requires:["Globals"],parameters:[],attributes:[],source:"\nattribute vec2 a_position;\nvarying vec2 v_texCoord1;\nvarying vec2 v_texCoord2;\nvarying vec2 v_texCoord3;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n\n    vec2 normCoord = a_position * 0.5 + 0.5;\n\n    v_texCoord1 = normCoord;\n    v_texCoord2 = normCoord - u_globalInvRenderSize;\n    v_texCoord3 = normCoord + u_globalInvRenderSize;\n}\n"},FS_BaseGeometry:{requires:[],parameters:[],attributes:[],source:"// this shader is abstract; must be imported and main function must be provided\n\nvec3 m_albedo;\nfloat m_roughness;\nfloat m_metallic;\nfloat m_specular;\nvec3 m_normal;\nvec3 m_emissive;\nfloat m_materialId;\nfloat m_materialParam;\n\nvarying highp vec3 v_worldPosition;\n\nvoid evaluateShader();\n\nvoid evaluateMaterial()\n{\n    m_albedo = vec3(1.);\n    m_roughness = 0.2;\n    m_metallic = 0.2;\n    m_specular = 0.03;\n    m_normal = vec3(0., 0., 1.);\n    m_emissive = vec3(0.);\n    m_materialId = 0.;\n    m_materialParam = 0.;\n\n    evaluateShader();\n}\n"},FS_CubeShadowMapGeometry:{requires:["FS_BaseGeometry","Pack"],parameters:[],attributes:[],source:"\nvarying highp vec3 v_viewPosition;\n\nvoid main()\n{\n    evaluateMaterial(); // might discard the fragment\n\n    highp float dist = min(length(v_viewPosition), 1.);\n    gl_FragColor = vec4(pack24(dist), 1.);\n}\n"},FS_Geometry:{requires:["GBuffer","GBufferMosaic","FS_BaseGeometry"],parameters:["useNormalMap"],attributes:[],source:"\n// prevent distorted reflection due to (probably) insufficient normal precision\n// FIXME: this is too much\n// --- precision highp ---\n\nvarying vec3 v_viewNormal;\n#if c_useNormalMap\nvarying vec3 v_viewTangent;\nvarying vec3 v_viewBitangent;\n#endif\n\nvarying highp vec3 v_screenPosition;\nvarying highp vec3 v_lastScreenPosition;\n\nvoid main()\n{\n    evaluateMaterial();\n\n    vec3 preshaded = m_emissive;\n#if c_useNormalMap\n    vec3 normal = v_viewNormal * m_normal.z;\n    normal += v_viewTangent * m_normal.x;\n    normal += v_viewBitangent * m_normal.y;\n#else\n    vec3 normal = v_viewNormal;\n#endif\n    normal = normalize(normal);\n\n    highp vec2 screenPos = v_screenPosition.xy / v_screenPosition.z;\n    highp vec2 lastScreenPos = v_lastScreenPosition.xy / v_lastScreenPosition.z;\n    vec2 screenVel = screenPos - lastScreenPos;\n\n    GBufferContents g;\n    g.albedo = m_albedo;\n    g.normal = normal;\n    g.velocity = screenVel;\n    g.roughness = m_roughness;\n    g.metallic = m_metallic;\n    g.specular = m_specular;\n    g.preshaded = preshaded;\n    g.materialId = m_materialId;\n    g.materialParam = m_materialParam;\n\n    vec4 g0, g1, g2, g3;\n\n    encodeGBuffer(g0, g1, g2, g3, g);\n\n    // mosaiced G-Buffer is not sRGB buffer, so\n    // we have to convert color to gamma space to\n    // prevent the loss of precision\n    g0.xyz = sqrt(g0.xyz);\n\n    gl_FragColor = encodeGBufferMosaic(g0, g1, g2, g3);\n}\n"},FS_ShadowMapGeometry:{requires:["FS_BaseGeometry"],parameters:[],attributes:[],source:"\nvoid main()\n{\n    evaluateMaterial(); // might discard the fragment\n}\n"},VS_BaseGeometry:{requires:["Pack","VS_BaseSkinning"],parameters:["skinningMode"],attributes:["position","normal","tangent","skinWeights","skinIndices"],source:"// this shader is abstract; must be imported and main function must be provided\n\n\n\n\nattribute vec4 a_skinWeights;\nattribute vec4 a_skinIndices;\n\nuniform mat4 u_modelMatrix;\nuniform mat4 u_lastModelMatrix;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec3 a_tangent;\n\nvec3 worldPosition;\nvec3 worldNormal;\nvec3 worldTangent;\n\nvec3 lastWorldPosition;\n\nvarying highp vec3 v_worldPosition;\n\nvoid computeExtraValues();\n\n#if c_skinningMode != SkinningModeNone\n\nvoid doSkinningOne(inout mat4 mat, inout mat4 lastMat, float index, float weight)\n{\n    if (weight == 0.) {\n        return;\n    }\n\n    BoneMatrix m = getBoneMatrix(index);\n\n    mat += m.current * weight;\n    lastMat += m.last * weight;\n}\n\n#endif\n\nvoid evaluateGeometry()\n{\n    vec3 position = a_position;\n    vec3 lastPosition = a_position;\n    vec3 normal = a_normal;\n    vec3 tangent = a_tangent;\n\n#if c_skinningMode != SkinningModeNone\n\n    mat4 skinMat = mat4(0.);\n    mat4 skinLastMat = mat4(0.);\n\n    doSkinningOne(skinMat, skinLastMat, a_skinIndices.x, a_skinWeights.x);\n    doSkinningOne(skinMat, skinLastMat, a_skinIndices.y, a_skinWeights.y);\n    doSkinningOne(skinMat, skinLastMat, a_skinIndices.z, a_skinWeights.z);\n    doSkinningOne(skinMat, skinLastMat, a_skinIndices.w, a_skinWeights.w);\n\n    skinMat = u_skinInvBindMatrix * skinMat * u_skinBindMatrix;\n    skinLastMat = u_skinInvBindMatrix * skinLastMat * u_skinBindMatrix;\n\n    position = (skinMat * vec4(position, 1.)).xyz;\n    lastPosition = (skinLastMat * vec4(lastPosition, 1.)).xyz;\n    normal = (skinMat * vec4(normal, 0.)).xyz;\n    tangent = (skinMat * vec4(tangent, 0.)).xyz;\n\n#endif\n\n    worldPosition = (u_modelMatrix * vec4(position, 1.)).xyz;\n    worldNormal = (u_modelMatrix * vec4(normal, 0.)).xyz;\n    worldTangent = (u_modelMatrix * vec4(tangent, 0.)).xyz;\n\n    lastWorldPosition = (u_lastModelMatrix * vec4(lastPosition, 1.)).xyz;\n\n    computeExtraValues();\n\n    v_worldPosition = worldPosition;\n}\n"},VS_BaseSkinning:{requires:[],parameters:["skinningMode"],attributes:[],source:'// this shader is abstract; must be imported and main function must be provided\n\n#define SkinningModeNone 0\n#define SkinningModeUniform 1\n#define SkinningModeTexture 2\n#define SkinningModeFloatTexture 3\n\n// #pragma parameter numBones\n\n#if c_skinningMode != SkinningModeNone\n\nstruct BoneMatrix\n{\n    mat4 current, last;\n};\n\nuniform mat4 u_skinBindMatrix;\nuniform mat4 u_skinInvBindMatrix;\n\n#if c_skinningMode == SkinningModeUniform\n\nuniform mat4 u_bones[c_numBones];\nuniform mat4 u_lastBones[c_numBones];\nBoneMatrix getBoneMatrix(float index)\n{\n    int intIndex = int(index);\n    return BoneMatrix(u_bones[intIndex], u_lastBones[intIndex]);\n}\n\n#elif c_skinningMode == SkinningModeTexture\n\nuniform sampler2D u_skinTexture;\nuniform sampler2D u_lastSkinTexture;\nuniform vec2 u_skinTexSize;        // "bone" indexing\nuniform vec2 u_skinInvTexSize;\nuniform vec4 u_skinInvTexSize2; // matrix element indexing [ 1/w, 1/h, 0.5/w, 0.5/h ]\nBoneMatrix getBoneMatrix(float index)\n{\n    float row = floor(index / u_skinTexSize.x);\n    float col = index - row * u_skinTexSize.x;\n    vec2 boneCoord = vec2(col, row) * u_skinInvTexSize + u_skinInvTexSize2.zw;\n    vec4 elemCoord1 = vec4(boneCoord, boneCoord + u_skinInvTexSize2.xy);\n    vec4 elemCoord2;\n    elemCoord2.xy = elemCoord1.zw + u_skinInvTexSize2.xy;\n    elemCoord2.zw = elemCoord2.xy + u_skinInvTexSize2.xy;\n\n    // left half\n    vec4 coordTL = elemCoord1;\n    vec4 coordBL = vec4(elemCoord1.x, elemCoord2.y, elemCoord1.z, elemCoord2.w);\n    vec4 col1 = vec4(\n        unpack32f(texture2D(u_skinTexture, coordTL.xy)),\n        unpack32f(texture2D(u_skinTexture, coordTL.xw)),\n        unpack32f(texture2D(u_skinTexture, coordBL.xy)),\n        unpack32f(texture2D(u_skinTexture, coordBL.xw))\n    );\n    vec4 col2 = vec4(\n        unpack32f(texture2D(u_skinTexture, coordTL.zy)),\n        unpack32f(texture2D(u_skinTexture, coordTL.zw)),\n        unpack32f(texture2D(u_skinTexture, coordBL.zy)),\n        unpack32f(texture2D(u_skinTexture, coordBL.zw))\n    );\n    vec4 lcol1 = vec4(\n        unpack32f(texture2D(u_lastSkinTexture, coordTL.xy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordTL.xw)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBL.xy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBL.xw))\n    );\n    vec4 lcol2 = vec4(\n        unpack32f(texture2D(u_lastSkinTexture, coordTL.zy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordTL.zw)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBL.zy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBL.zw))\n    );\n\n    // right half\n    vec4 coordTR = vec4(elemCoord2.x, elemCoord1.y, elemCoord2.z, elemCoord1.w);\n    vec4 coordBR = elemCoord2;\n    vec4 col3 = vec4(\n        unpack32f(texture2D(u_skinTexture, coordTR.xy)),\n        unpack32f(texture2D(u_skinTexture, coordTR.xw)),\n        unpack32f(texture2D(u_skinTexture, coordBR.xy)),\n        unpack32f(texture2D(u_skinTexture, coordBR.xw))\n    );\n    vec4 col4 = vec4(\n        unpack32f(texture2D(u_skinTexture, coordTR.zy)),\n        unpack32f(texture2D(u_skinTexture, coordTR.zw)),\n        unpack32f(texture2D(u_skinTexture, coordBR.zy)),\n        unpack32f(texture2D(u_skinTexture, coordBR.zw))\n    );\n    vec4 lcol3 = vec4(\n        unpack32f(texture2D(u_lastSkinTexture, coordTR.xy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordTR.xw)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBR.xy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBR.xw))\n    );\n    vec4 lcol4 = vec4(\n        unpack32f(texture2D(u_lastSkinTexture, coordTR.zy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordTR.zw)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBR.zy)),\n        unpack32f(texture2D(u_lastSkinTexture, coordBR.zw))\n    );\n\n    return BoneMatrix(\n        mat4(col1, col2, col3, col4),\n        mat4(lcol1, lcol2, lcol3, lcol4)\n    );\n}\n\n#elif c_skinningMode == SkinningModeFloatTexture\n\nuniform sampler2D u_skinTexture;\nuniform sampler2D u_lastSkinTexture;\nuniform vec2 u_skinTexSize;        // "bone" indexing\nuniform vec2 u_skinInvTexSize;\nuniform vec4 u_skinInvTexSize2; // matrix column indexing [ 1/w, 1/h, 0.5/w, 0.5/h ]\nBoneMatrix getBoneMatrix(float index)\n{\n    float row = floor(index / u_skinTexSize.x);\n    float col = index - row * u_skinTexSize.x;\n    vec2 boneCoord = vec2(col, row) * u_skinInvTexSize + u_skinInvTexSize2.zw;\n    vec4 colCoord = vec4(boneCoord, boneCoord + u_skinInvTexSize2.xy);\n\n    return BoneMatrix(\n        mat4(\n            texture2D(u_skinTexture, colCoord.xy),\n            texture2D(u_skinTexture, colCoord.zy),\n            texture2D(u_skinTexture, colCoord.xw),\n            texture2D(u_skinTexture, colCoord.zw)\n        ),\n        mat4(\n            texture2D(u_lastSkinTexture, colCoord.xy),\n            texture2D(u_lastSkinTexture, colCoord.zy),\n            texture2D(u_lastSkinTexture, colCoord.xw),\n            texture2D(u_lastSkinTexture, colCoord.zw)\n        )\n    );\n}\n\n#endif // c_skinningMode\n\n#endif // c_skinningMode != SkinningModeNone\n\n'},VS_CubeShadowMapGeometry:{requires:["VS_BaseGeometry"],parameters:[],attributes:[],source:"\n\nuniform mat4 u_viewProjectionMatrix;\nuniform mat4 u_viewMatrix;\n\nvarying vec3 v_viewPosition;\nuniform float u_viewPositionScale;\n\nvoid main()\n{\n    evaluateGeometry();\n\n    gl_Position = u_viewProjectionMatrix * vec4(worldPosition, 1.);\n\n    v_viewPosition = (u_viewMatrix * vec4(worldPosition, 1.)).xyz * u_viewPositionScale;\n}\n\n"},VS_Geometry:{requires:["VS_BaseGeometry"],parameters:["useNormalMap"],attributes:[],source:"\n\nuniform mat4 u_viewProjectionMatrix;\nuniform mat4 u_viewMatrix;\nvarying vec3 v_viewNormal;\n#if c_useNormalMap\nvarying vec3 v_viewTangent;\nvarying vec3 v_viewBitangent;\n#endif\n\nvarying vec3 v_screenPosition;\nvarying vec3 v_lastScreenPosition;\n\nuniform mat4 u_lastViewProjectionMatrix;\nuniform vec2 u_screenVelOffset;\n\nvoid main()\n{\n    evaluateGeometry();\n\n    gl_Position = u_viewProjectionMatrix * vec4(worldPosition, 1.);\n\n    v_screenPosition = gl_Position.xyw;\n    v_lastScreenPosition = (u_lastViewProjectionMatrix * vec4(lastWorldPosition, 1.)).xyw;\n    v_screenPosition.xy += u_screenVelOffset * v_screenPosition.z;\n\n    v_viewNormal = (u_viewMatrix * vec4(worldNormal, 0.)).xyz;\n#if c_useNormalMap\n    v_viewTangent = (u_viewMatrix * vec4(worldTangent, 0.)).xyz;\n    v_viewBitangent = cross(v_viewNormal, v_viewTangent);\n#endif\n}\n"},VS_ShadowMapGeometry:{requires:["VS_BaseGeometry"],parameters:[],attributes:[],source:"\n\nuniform mat4 u_viewProjectionMatrix;\nuniform mat4 u_viewMatrix;\n\n\nvoid main()\n{\n    evaluateGeometry();\n\n    gl_Position = u_viewProjectionMatrix * vec4(worldPosition, 1.);\n    gl_Position.z += 0.001 * gl_Position.w; // polygonOffset sometimes doesn't work well?\n}\n\n"},FS_BaseIBL:{requires:["GBuffer","ShadingModel","HdrMosaic","DepthFetch","TextureLod"],parameters:["isBlendPass","useHdrMosaic"],attributes:[],source:"// this shader is abstract; must be imported and function implementations must be provided\n\nuniform sampler2D u_g0;\nuniform sampler2D u_g1;\nuniform sampler2D u_g2;\nuniform sampler2D u_linearDepth;\nuniform sampler2D u_ssao;\n\nvarying highp vec2 v_texCoord;\nvarying mediump vec2 v_viewDir;\n\nuniform samplerCube u_reflection;\nuniform float u_reflectionSize;\n\nuniform mat4 u_reflectionMatrix;\nuniform float u_reflectionLodBias;\n\nuniform sampler2D u_dither;\nvarying highp vec2 v_ditherCoord;\n\n// to be provided by derived shader\nfloat evaluateWeight(vec3 viewPos);\n\nvoid emitIBLOutput(vec3 lit, float weight)\n{\n    // dither\n    vec3 dither = texture2D(u_dither, v_ditherCoord).xyz;\n\n#if c_useHdrMosaic\n    vec4 mosaicked = encodeHdrMosaicDithered(lit, dither);\n    gl_FragColor = mosaicked;\n\n#if c_isBlendPass\n    gl_FragColor.w = weight;\n#endif // c_isBlendPass\n#else // c_useHdrMosaic\n    if (lit != lit) lit *= 0.; // reject denormals\n    gl_FragColor = vec4(lit, weight);\n#endif // c_useHdrMosaic\n}\n\nvoid main()\n{\n    vec4 g0 = texture2D(u_g0, v_texCoord);\n    vec4 g1 = texture2D(u_g1, v_texCoord);\n    vec4 g2 = texture2D(u_g2, v_texCoord);\n    vec4 g3 = vec4(0.);\n\n    if (isGBufferEmpty(g0, g1, g2, g3)) {\n        discard;\n        return;\n    }\n\n    GBufferContents g;\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n    MaterialInfo mat = getMaterialInfoFromGBuffer(g);\n\n    highp vec3 viewDir = vec3(v_viewDir, 1.);\n    highp float depth = fetchDepth(u_linearDepth, v_texCoord);\n    highp vec3 viewPos = viewDir * depth;\n\n    float weight = evaluateWeight(viewPos);\n\n    vec3 reflVector = reflect(-(viewDir), g.normal);\n    reflVector = (u_reflectionMatrix * vec4(reflVector, 0.)).xyz;\n\n    float ssao = texture2D(u_ssao, v_texCoord).r;\n    ssao *= ssao;\n    ssao = mix(1., ssao, min(mat.roughness * 4., 1.));\n\n    // sampling from image\n    float lod = u_reflectionLodBias + 17.1 * sqrt(sqrt(mat.roughness));\n    vec3 refl = myTextureCubeLodSeamless(u_reflection, reflVector, lod, u_reflectionSize).xyz;\n    refl.xyz *= refl.xyz; // linearize\n\n    refl *= evaluateReflection(clamp(dot(g.normal, normalize(viewDir)), 0., 1.), mat).xyz;\n\n    if (isMaterialClearCoat(mat)) {\n        // second specular lobe\n        float lodcc = u_reflectionLodBias + 17.1 * sqrt(sqrt(mat.clearCoatRoughness));\n        vec3 reflcc = myTextureCubeLodSeamless(u_reflection, reflVector, lodcc, u_reflectionSize).xyz;\n        reflcc.xyz *= reflcc.xyz; // linearize\n\n        vec2 reflFactorCC = evaluateReflectionForClearCoat(clamp(dot(g.normal, normalize(viewDir)), 0., 1.), mat);\n        reflcc *= reflFactorCC.x;\n\n        refl *= 1. - reflFactorCC.y;\n        refl += reflcc;\n    }\n\n    // apply SSAO\n    refl *= ssao;\n\n    // lighting model\n\n    emitIBLOutput(refl.xyz, weight);\n}\n\n"},FS_DeferredAmbientIBL:{requires:["FS_BaseIBL"],parameters:[],attributes:[],source:"\n\nfloat evaluateWeight(vec3 viewPos)\n{\n    return 1.;\n}\n"},VS_DeferredAmbientIBL:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\n\nuniform vec2 u_ditherScale;\nvarying vec2 v_ditherCoord;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 1., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * a_position.x;\n    v_viewDir += u_viewDirCoefY * a_position.y;\n\n    v_ditherCoord.xy = u_ditherScale * a_position;\n}\n"},FS_BaseLight:{requires:["HdrMosaic","GBuffer","ShadingModel","DepthFetch"],parameters:["useHdrMosaic"],attributes:[],source:"// this shader is abstract; must be imported and main function must be provided\n\n\n\nuniform sampler2D u_g0;\nuniform sampler2D u_g1;\nuniform sampler2D u_g2;\nuniform sampler2D u_g3;\nuniform sampler2D u_linearDepth;\n\nuniform vec3 u_lightColor;\nuniform highp float u_lightStrength;\n\nvarying highp vec2 v_texCoord;\nvarying highp vec2 v_viewDir;\n\nuniform sampler2D u_dither;\nvarying highp vec2 v_ditherCoord;\n\nhighp float perspectiveScaling = 1.;\nhighp vec3 viewDir;\nhighp vec3 viewDirNormalized;\nhighp vec3 viewPos;\n\nvoid setupLight()\n{\n    viewDir = vec3(v_viewDir * perspectiveScaling, 1.);\n    viewPos = viewDir * fetchDepth(u_linearDepth, v_texCoord * perspectiveScaling);\n    viewPos = -viewPos; // FIXME: ??\n\n    viewDirNormalized = normalize(viewDir);\n}\n\nvoid emitLightPassOutput(vec3 lit)\n{\n#if c_useHdrMosaic\n    float lum = max(max(lit.x, lit.y), lit.z);\n\n    // overflow protection\n    const float lumLimit = HdrMosaicMaximumLevel * 0.7;\n    if (lum > lumLimit) {\n        lit *= lumLimit / lum;\n    }\n\n    // dither\n    vec3 dither = texture2D(u_dither, v_ditherCoord * perspectiveScaling).xyz;\n\n    gl_FragColor = encodeHdrMosaicDithered(lit, dither);\n#else\n    if (lit != lit) lit *= 0.; // reject denormals\n    gl_FragColor = vec4(lit, 0.);\n#endif\n}\n"},FS_BasePointLight:{requires:["FS_BaseLight"],parameters:[],attributes:[],source:"// this shader is abstract; must be imported and main function must be provided\n\n\nGBufferContents g;\nMaterialInfo mat;\n\nvoid setupPointLight()\n{\n    vec4 g0 = texture2D(u_g0, v_texCoord * perspectiveScaling);\n    vec4 g1 = texture2D(u_g1, v_texCoord * perspectiveScaling);\n    vec4 g2 = texture2D(u_g2, v_texCoord * perspectiveScaling);\n    vec4 g3 = vec4(0.);\n\n    if (isGBufferEmpty(g0, g1, g2, g3)) {\n        discard;\n    }\n\n    decodeGBuffer(g, g0, g1, g2, g3);\n}\n\nvoid doPointLight(vec3 lightDir, highp float shadow)\n{\n    mat = getMaterialInfoFromGBuffer(g);\n\n    PointLightBRDFParameters params = computePointLightBRDFParameters(\n        g.normal, lightDir, viewDirNormalized);\n\n    vec3 lit = evaluatePointLight(params, mat, u_lightColor);\n\n    lit *= shadow * u_lightStrength;\n\n    emitLightPassOutput(lit);\n}\n"},FS_BasePositionalLight:{requires:["FS_BaseLight"],parameters:["isFullScreen"],attributes:[],source:"\n#if !c_isFullScreen\nvarying float v_w;\n#endif\n\n\nvoid setupPositionalLight()\n{\n#if !c_isFullScreen\n    perspectiveScaling = 1. / v_w;\n#endif\n}\n"},FS_DeferredAmbientLight:{requires:["GBuffer","ShadingModel","FS_BaseLight"],parameters:[],attributes:[],source:"\nuniform sampler2D u_ssao;\n\nvoid main()\n{\n    setupLight();\n\n    vec4 g0 = texture2D(u_g0, v_texCoord);\n    vec4 g1 = texture2D(u_g1, v_texCoord);\n    vec4 g2 = texture2D(u_g2, v_texCoord);\n    vec4 g3 = vec4(0.);\n\n    if (isGBufferEmpty(g0, g1, g2, g3)) {\n        discard;\n        return;\n    }\n\n    GBufferContents g;\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n    MaterialInfo mat = getMaterialInfoFromGBuffer(g);\n\n    float ssao = texture2D(u_ssao, v_texCoord).r;\n    ssao *= ssao;\n\n    vec3 viewDir = vec3(v_viewDir, 1.);\n    UniformLightBRDFParameters params = computeUniformLightBRDFParameters(\n        g.normal, normalize(viewDir));\n\n    vec3 lit = evaluateUniformLight(params, mat, u_lightColor * ssao);\n\n    emitLightPassOutput(lit);\n}\n"},FS_DeferredDirectionalLight:{requires:["GBuffer","ShadingModel","DepthFetch","FS_BasePointLight"],parameters:["hasShadow"],attributes:[],source:"\n\nuniform vec3 u_lightDir;\n\n#if c_hasShadow\nuniform sampler2D u_shadow;\n#endif\n\nvoid main()\n{\n    setupLight();\n    setupPointLight();\n\n#if c_hasShadow\n\n    float shadowValue = texture2D(u_shadow, v_texCoord).x;\n    if (shadowValue < 0.0001) {\n        discard;\n    }\n\n#else // c_hasShadow\n\n    float shadowValue = 1.;\n\n#endif // c_hasShadow\n\n    doPointLight(u_lightDir, shadowValue * u_lightStrength);\n\n}\n"},FS_DeferredPointLight:{requires:["GBuffer","ShadingModel","DepthFetch","FS_BasePointLight","FS_BasePositionalLight","Pack"],parameters:["isFullScreen","hasShadowMap"],attributes:[],source:"\nuniform highp vec3 u_lightPos;\nuniform highp float u_lightInvInfluenceRadiusSquared;\nuniform highp float u_minimumDistance; // squared\nuniform highp float u_lightRadius;\nuniform highp float u_lightLength;\nuniform vec3 u_lightDir; // capsule\n\n#if c_hasShadowMap\nuniform samplerCube u_shadowMap;\nuniform sampler2D u_jitter;\nuniform highp mat4 u_shadowMapMatrix;\nuniform vec2 u_jitterAmount;\nvarying vec2 v_jitterCoord;\nuniform float u_invDistanceToJitter;\n#endif\n\nfloat shadowTextureCubePack24(samplerCube tex, highp vec3 coord, highp float comparand)\n{\n    highp float value = unpack24(textureCube(tex, coord.xyz).xyz);\n    return step(comparand, value);\n}\n\nvoid makePerpendicularVectors(vec3 source, out vec3 out1, out vec3 out2)\n{\n    vec3 up = abs(source.z) > sqrt(0.5) ? vec3(1., 0., 0.) : vec3(0., 0., 1.);\n    out1 = normalize(cross(source, up));\n    out2 = cross(source, out1);\n}\n\nvoid main()\n{\n    setupPositionalLight();\n    setupLight();\n    setupPointLight();\n\n#if c_hasShadowMap\n\n    highp vec3 viewPos = viewPos;\n    vec3 shadowCoord = (u_shadowMapMatrix * vec4(viewPos, 1.)).xyz;\n\n    float shadowDist = length(shadowCoord);\n    shadowCoord = normalize(shadowCoord);\n\n    float shadowValue = 0.;\n    vec4 jitter1 = texture2D(u_jitter, v_ditherCoord.xy) - 0.5;\n    vec4 jitter2 = texture2D(u_jitter, v_jitterCoord.xy) - 0.5;\n\n    vec2 jamt = u_jitterAmount;\n    jamt += u_invDistanceToJitter / shadowDist; // soft shadow near the light\n\n    jitter1 *= jamt.xyxy;\n    jitter2 *= jamt.xyxy;\n\n    vec3 jitterVec1, jitterVec2;\n    makePerpendicularVectors(shadowCoord, jitterVec1, jitterVec2);\n\n    shadowDist -= 0.001;\n\n    shadowValue += shadowTextureCubePack24(u_shadowMap, shadowCoord + jitter1.x * jitterVec1 + jitter1.y * jitterVec2, shadowDist);\n    shadowValue += shadowTextureCubePack24(u_shadowMap, shadowCoord + jitter1.z * jitterVec1 + jitter1.w * jitterVec2, shadowDist);\n    shadowValue += shadowTextureCubePack24(u_shadowMap, shadowCoord + jitter2.x * jitterVec1 + jitter2.y * jitterVec2, shadowDist);\n    shadowValue += shadowTextureCubePack24(u_shadowMap, shadowCoord + jitter2.z * jitterVec1 + jitter2.w * jitterVec2, shadowDist);\n\n    if (shadowValue < 0.0001) {\n        discard;\n    }\n\n    shadowValue *= 1. / 4.;\n\n#else // c_hasShadowMap\n\n    float shadowValue = 1.;\n\n#endif // c_hasShadowMap\n\n    highp vec3 lightDir = u_lightPos - viewPos;\n    float dist = dot(lightDir, lightDir) * u_lightInvInfluenceRadiusSquared;\n\n    if (dist >= 1.) {\n        discard;\n    }\n\n    if (u_lightRadius > 0. || u_lightLength > 0.) {\n        // TODO: sized point light\n    }\n\n    highp float strength = 1. - dist;\n\n    strength *= 1. / max(u_minimumDistance, dot(lightDir, lightDir));\n\n    doPointLight(normalize(lightDir), shadowValue * strength);\n}\n"},FS_DeferredUnlit:{requires:["GBuffer","FS_BaseLight"],parameters:[],attributes:[],source:"\nvoid main()\n{\n    vec4 g0 = vec4(0.);\n    vec4 g1 = vec4(0.);\n    vec4 g2 = vec4(0.);\n    vec4 g3 = texture2D(u_g3, v_texCoord);\n\n    GBufferContents g;\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n    emitLightPassOutput(g.preshaded);\n}\n"},VS_BasePositionalLight:{requires:[],parameters:["isFullScreen"],attributes:[],source:"\n#if c_isFullScreen\nattribute vec2 a_position;\n#endif\n\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\nuniform vec2 u_ditherScale;\nvarying vec2 v_ditherCoord;\nvarying vec2 v_jitterCoord;\n\n#if !c_isFullScreen\nvarying float v_w;\nuniform mat4 u_viewProjectionMatrix;\n\nvec3 computeWorldPosition();\n#endif\n\nvoid main()\n{\n\n#if c_isFullScreen\n    gl_Position = vec4(a_position, 1., 1.);\n    float v_w = 1.;\n#else\n    gl_Position = vec4(computeWorldPosition(), 1.);\n    gl_Position = u_viewProjectionMatrix * gl_Position;\n    v_w = gl_Position.w;\n#endif\n\n    v_texCoord = gl_Position.xy * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * gl_Position.x;\n    v_viewDir += u_viewDirCoefY * gl_Position.y;\n\n    v_ditherCoord.xy = u_ditherScale * gl_Position.xy;\n    v_jitterCoord.xy = v_ditherCoord.xy + vec2(.1, .1);\n\n    v_texCoord *= v_w;\n    v_viewDir *= v_w;\n    v_ditherCoord *= v_w;\n    v_jitterCoord *= v_w;\n\n}\n"},VS_DeferredAmbientLight:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\nuniform vec2 u_ditherScale;\nvarying vec2 v_ditherCoord;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 1., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * a_position.x;\n    v_viewDir += u_viewDirCoefY * a_position.y;\n\n    v_ditherCoord.xy = u_ditherScale * a_position;\n}\n"},VS_DeferredDirectionalLight:{requires:[],parameters:[],attributes:[],source:"\nattribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\nuniform vec2 u_ditherScale;\nvarying vec2 v_ditherCoord;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 1., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * a_position.x;\n    v_viewDir += u_viewDirCoefY * a_position.y;\n\n    v_ditherCoord.xy = u_ditherScale * a_position;\n}\n"},VS_DeferredPointLight:{requires:["VS_BasePositionalLight"],parameters:[],attributes:[],source:"\n#if !c_isFullScreen\nattribute vec3 a_position;\n\nuniform vec3 u_lightPos;\nuniform float u_lightInfluenceRadius;\n\nvec3 computeWorldPosition()\n{\n    return u_lightPos + a_position * u_lightInfluenceRadius;\n}\n#endif\n"},VS_DeferredUnlit:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nuniform vec2 u_ditherScale;\nvarying vec2 v_ditherCoord;\nvarying vec2 v_viewDir;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 1., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_ditherCoord.xy = u_ditherScale * a_position;\n\n    v_viewDir = vec2(0.); // unused by required by FS_BaseLight\n}\n"},FS_BilateralFilter:{requires:["DepthFetch","Globals"],parameters:[],attributes:[],source:"\nuniform sampler2D u_input;\nuniform sampler2D u_linearDepth;\n\nvarying highp vec2 v_texCoord;\n\nvarying highp vec2 v_texCoord1;\nvarying highp vec2 v_texCoord2;\nvarying highp vec2 v_texCoord3;\nvarying highp vec2 v_texCoord4;\nvarying highp vec2 v_texCoord5;\nvarying highp vec2 v_texCoord6;\n\nhighp float baseDepth;\nhighp float weightScale;\n\nvec2 bilateralSample(highp vec2 at)\n{\n    float color = texture2D(u_input, at).r;\n    highp float depth = fetchDepth(u_linearDepth, at);\n    float weight = abs(depth - baseDepth) * weightScale;\n    weight = exp2(-weight * weight);\n    return vec2(color * weight, weight);\n}\n\n\nvoid main()\n{\n    vec2 sum = vec2(texture2D(u_input, v_texCoord).r, 1.);\n    baseDepth = fetchDepth(u_linearDepth, v_texCoord);\n\n    weightScale = 100. / baseDepth;\n\n    sum += bilateralSample(v_texCoord1);\n    sum += bilateralSample(v_texCoord2);\n    sum += bilateralSample(v_texCoord3);\n    sum += bilateralSample(v_texCoord4);\n    sum += bilateralSample(v_texCoord5);\n    sum += bilateralSample(v_texCoord6);\n\n    float result = sum.x / sum.y;\n    gl_FragColor = vec4(result);\n}\n"},FS_Blur:{requires:["Globals","LogRGB"],parameters:[],attributes:[],source:"\nuniform sampler2D u_texture;\nvarying highp vec2 v_texCoord1;\nvarying highp vec2 v_texCoord2;\nvarying highp vec2 v_texCoord3;\n\nvoid main()\n{\n    vec3 color0 = decodeLogRGB(texture2D(u_texture, v_texCoord1));\n    vec3 color1 = decodeLogRGB(texture2D(u_texture, vec2(v_texCoord1.x, v_texCoord2.y)));\n    vec3 color2 = decodeLogRGB(texture2D(u_texture, vec2(v_texCoord1.x, v_texCoord3.y)));\n    vec3 color3 = decodeLogRGB(texture2D(u_texture, vec2(v_texCoord2.x, v_texCoord1.y)));\n    vec3 color4 = decodeLogRGB(texture2D(u_texture, vec2(v_texCoord3.x, v_texCoord1.y)));\n\n    vec3 outColor = color0 * 0.5 + (color1 + color2 + color3 + color4) * 0.125;\n\n    gl_FragColor = encodeLogRGB(outColor);\n}\n"},FS_GaussianBlur:{requires:["LogRGB"],parameters:["kernelSize"],attributes:[],source:"\nvarying highp vec2 v_texCoord;\n\nuniform sampler2D u_input;\n\nuniform highp vec2 u_texCoordIncr;\n\n// In WebGL 1.0, array of uniforms is not allowed in fragment shader\nuniform float u_weight1;\n#if c_kernelSize >= 2\nuniform float u_weight2;\n#endif\n#if c_kernelSize >= 3\nuniform float u_weight3;\n#endif\n#if c_kernelSize >= 4\nuniform float u_weight4;\n#endif\n#if c_kernelSize >= 5\nuniform float u_weight5;\n#endif\n#if c_kernelSize >= 6\nuniform float u_weight6;\n#endif\n#if c_kernelSize >= 7\nuniform float u_weight7;\n#endif\n#if c_kernelSize >= 8\nuniform float u_weight8;\n#endif\n#if c_kernelSize >= 9\nuniform float u_weight9;\n#endif\n#if c_kernelSize >= 10\nuniform float u_weight10;\n#endif\n#if c_kernelSize >= 11\nuniform float u_weight11;\n#endif\n\nvec4 outp = vec4(0.);\nhighp vec2 coord;\n\nvoid addOne(float weight)\n{\n    outp += weight * texture2D(u_input, coord);\n    coord += u_texCoordIncr;\n}\n\nvoid main()\n{\n    coord = v_texCoord;\n#if c_kernelSize >= 1\n    addOne(u_weight1);\n#endif\n#if c_kernelSize >= 2\n    addOne(u_weight2);\n#endif\n#if c_kernelSize >= 3\n    addOne(u_weight3);\n#endif\n#if c_kernelSize >= 4\n    addOne(u_weight4);\n#endif\n#if c_kernelSize >= 5\n    addOne(u_weight5);\n#endif\n#if c_kernelSize >= 6\n    addOne(u_weight6);\n#endif\n#if c_kernelSize >= 7\n    addOne(u_weight7);\n#endif\n#if c_kernelSize >= 8\n    addOne(u_weight8);\n#endif\n#if c_kernelSize >= 9\n    addOne(u_weight9);\n#endif\n#if c_kernelSize >= 10\n    addOne(u_weight10);\n#endif\n#if c_kernelSize >= 11\n    addOne(u_weight11);\n#endif\n    gl_FragColor = outp;\n}\n"},FS_HdrCompress:{requires:["Globals","HdrToneMapping"],parameters:["direction","operatorType"],attributes:[],source:"\n#define OperatorType_Reinhard 0\n\nuniform sampler2D u_input;\nuniform sampler2D u_jitter;\nvarying highp vec2 v_texCoord;\nvarying highp vec2 v_jitterCoord;\n\nuniform float u_gain;\n\nvoid main()\n{\n    vec4 inp = texture2D(u_input, v_texCoord);\n\n#if !c_direction\n	inp.xyz *= u_gain;\n#endif\n\n#if c_operatorType == OperatorType_Reinhard\n#if c_direction\n	inp.xyz = encodeReinhard(inp.xyz);\n#else // c_direction\n	inp.xyz = decodeReinhard(inp.xyz);\n#endif // c_direction\n#endif // c_operatorType\n\n#if c_direction\n	inp.xyz *= u_gain;\n#endif\n\n	inp += inp * ((texture2D(u_jitter, v_jitterCoord).x - 0.5) * (1. / 1024.));\n\n	gl_FragColor = inp;\n}\n"
},FS_SSAO:{requires:["DepthFetch","Complex","Globals","GBuffer"],parameters:[],attributes:[],source:"\nuniform sampler2D u_g2;\nuniform sampler2D u_linearDepth;\n\nvarying highp vec2 v_texCoord;\nvarying mediump vec2 v_viewDir;\n\nuniform highp vec2 u_viewDirCoefX;\nuniform highp vec2 u_viewDirCoefY;\n\nuniform mediump vec2 u_sampleOffsetScale;\n\nvoid main()\n{\n    vec4 g2 = texture2D(u_g2, v_texCoord);\n\n    highp float baseDepth = fetchDepth(u_linearDepth, v_texCoord);\n    highp vec3 baseViewPos = vec3(v_viewDir, 1.) * baseDepth;\n    vec3 baseNormal = decodeGBufferNormal(g2);\n\n    highp vec2 patternPos = fract(gl_FragCoord.xy * 0.5);\n    highp float patternPos2 = fract(dot(floor(gl_FragCoord.xy), vec2(0.25)));\n\n    float depthDecayScale = -16. / baseDepth;\n\n    vec2 sampleOffsetScale = u_sampleOffsetScale;\n\n\n    float sampleDistance = 1. + patternPos2 * 2.;\n    const float sampleRotAngle = 1.0;\n    vec2 sampleRot = vec2(sin(sampleRotAngle), cos(sampleRotAngle));\n\n    vec2 sampleDir = vec2(patternPos.x > .5 ? 1. : -1., 0.);\n    sampleDir = patternPos.y > .5 ? sampleDir : sampleDir.yx;\n\n    float sampleDecay = 1.;\n\n    float ret = 0.;\n\n    for (int i = 0; i < 12; ++i) {\n        vec2 sampleOffset = sampleDir * sampleDistance;\n        vec2 sampleCoordOffs = sampleOffset * sampleOffsetScale;\n        highp vec2 sampleAt = v_texCoord + sampleCoordOffs;\n        highp float depth = fetchDepth(u_linearDepth, sampleAt) + 0.1; // FIXME: this value needs to be tweaked?\n        vec3 viewPos = vec3(v_viewDir + u_viewDirCoefX * sampleCoordOffs.x\n            + u_viewDirCoefY * sampleCoordOffs.y, 1.) * depth;\n        vec3 relViewPos = normalize(viewPos - baseViewPos);\n        float cosHorizon = -dot(relViewPos, baseNormal);\n        float depthDecay = exp2(depthDecayScale * abs(depth - baseDepth));\n\n        ret = mix(ret, max(ret, cosHorizon), sampleDecay * depthDecay);\n\n        sampleDistance += 1. + sampleDistance * mix(.1, .2, patternPos2);\n        sampleDir = complexMultiply(sampleDir, sampleRot);\n        sampleDecay *= .9;\n    }\n\n    gl_FragColor.xyzw = vec4(1. - ret);\n}"},FS_SSR:{requires:["DepthFetch","ScreenSpaceRaytrace","Globals","GBuffer","LogRGB","HdrMosaic","ShadingModel"],parameters:["useHdrMosaic","colorIsLogRGB"],attributes:[],source:"\n\nuniform sampler2D u_g0;\nuniform sampler2D u_g1;\nuniform sampler2D u_g2;\nuniform sampler2D u_linearDepth;\nuniform sampler2D u_color; // LogRGB\nuniform sampler2D u_reflections; // HdrMosaic\nuniform sampler2D u_jitter;\n\nvarying highp vec2 v_texCoord;\nvarying mediump vec2 v_viewDir;\nvarying highp vec2 v_jitterCoord;\n\nuniform highp vec2 u_viewDirCoefX;\nuniform highp vec2 u_viewDirCoefY;\n\nuniform highp mat4 u_projectionMatrix;\n\nuniform mediump float u_stride;\n\n// DDA based ray caster\n// see http://casual-effects.blogspot.jp/2014/08/screen-space-ray-tracing.html\n\nGBufferContents g;\n\nvec3 decodeInputColor(vec4 color)\n{\n#if c_colorIsLogRGB\n    return decodeLogRGB(color);\n#else\n    return color.xyz;\n#endif\n}\n\nvec3 doSSR(out float confidence)\n{\n    highp float baseDepth = fetchDepth(u_linearDepth, v_texCoord);\n    highp vec3 baseViewDir = vec3(v_viewDir, 1.);\n    highp vec3 baseViewPos = baseViewDir * baseDepth;\n    vec3 baseNormal = g.normal;\n\n    vec3 reflectionVec = normalize(reflect(baseViewDir, baseNormal));\n\n    float jitter = texture2D(u_jitter, v_jitterCoord).x;\n\n    vec3 hitPoint;\n    vec2 hitPixel;\n    float hitSteps;\n\n    if (rayTraceScreenSpace(\n        u_linearDepth,\n        baseViewPos,\n        reflectionVec,\n        u_projectionMatrix,\n        u_globalRenderSize,\n        u_globalInvRenderSize,\n        u_stride,\n        0.5 + jitter,\n        64. + baseDepth * 64.,\n        hitPixel,\n        hitPoint,\n        hitSteps\n        )) {\n\n        hitPixel.xy *= u_globalInvRenderSize;\n\n        vec3 color = decodeInputColor(texture2D(u_color, hitPixel.xy));\n\n        // distance fade\n        hitSteps = clamp(2. - hitSteps * 2., 0., 1.); hitSteps *= hitSteps;\n        float fade = hitSteps;\n\n        // screen border fade\n        float dfb = min(hitPixel.x, 1. - hitPixel.x);\n        dfb = min(dfb, min(hitPixel.y, 1. - hitPixel.y));\n        dfb = clamp(dfb * 10., 0., 1.);\n        fade *= dfb;\n\n        confidence = fade;\n\n        return color.xyz;\n    } else {\n        confidence = 0.;\n        return vec3(0.);\n    }\n}\n\nvoid main()\n{\n    vec4 g0 = texture2D(u_g0, v_texCoord);\n    vec4 g1 = texture2D(u_g1, v_texCoord);\n    vec4 g2 = texture2D(u_g2, v_texCoord);\n    vec4 g3 = vec4(0.); // unused\n\n    if (isGBufferEmpty(g0, g1, g2, g3)) {\n        discard;\n        return;\n    }\n\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n    gl_FragColor = texture2D(u_reflections, v_texCoord);\n\n    // TODO: adjust SSR confidence value\n    float nvDot = clamp(dot(g.normal, normalize(vec3(v_viewDir, 1.))), 0., 1.);\n    float fresnel = 1. - nvDot;\n    MaterialInfo mat = getMaterialInfoFromGBuffer(g);\n    float roughness = mat.roughness;\n    if (isMaterialClearCoat(mat)) {\n        roughness = min(roughness, mat.clearCoatRoughness);\n    }\n    float ssrAmount = min(1., 1.5 - roughness * 6.);\n    if (ssrAmount > 0.) {\n        vec4 reflAmt = evaluateReflection(nvDot, mat);\n        vec2 ccRefl = evaluateReflectionForClearCoat(nvDot, mat);\n        reflAmt = reflAmt * (1. - ccRefl.y) + ccRefl.x;\n        if (reflAmt.w > 0.00001) {\n            ssrAmount = 1.;\n\n            // FIXME: why does reflAmt sometimes become greater than pi (energy conservation)?\n            //        maybe it's bug in ShadingModel.glsl?\n            reflAmt.xyz = min(reflAmt.xyz, M_PI);\n\n            float ssrConfidence;\n            vec3 ssr = doSSR(ssrConfidence);\n            ssr *= reflAmt.xyz * (1. / M_PI);\n\n            ssrConfidence *= ssrAmount;\n\n#if c_useHdrMosaic\n            vec4 encoded = encodeHdrMosaic(ssr);\n            gl_FragColor.xyz = mix(gl_FragColor.xyz, encoded.xyz, ssrConfidence);\n            gl_FragColor.w = max(gl_FragColor.w, encoded.w);\n#else\n            gl_FragColor.xyz = mix(gl_FragColor.xyz, ssr, ssrConfidence);\n            gl_FragColor.w = 1.;\n#endif\n        }\n    }\n\n}"},FS_ScreenSpaceSoftShadow:{requires:["DepthFetch","Globals","DepthToNormal","MatrixInverse","MatrixTranspose"],parameters:["isPositionalLight","direction","numSamples"],attributes:[],source:"\n\nuniform sampler2D u_input;\nuniform sampler2D u_linearDepth;\n\nvarying highp vec2 v_texCoord;\nvarying highp vec2 v_viewDir;\n\nuniform vec3 u_covSScale;\n\nuniform float u_maxBlur;\n\nuniform vec3 u_lightU, u_lightV, u_lightDir;\n\nuniform sampler2D u_jitter;\nvarying highp vec2 v_jitterCoord;\n\nvoid main()\n{\n    highp float baseDepth = fetchDepth(u_linearDepth, v_texCoord);\n    highp vec3 baseViewPos = baseDepth * vec3(v_viewDir, 1.);\n    vec3 normal = computeNormalFromDepthUsingStandardDerivatives(u_linearDepth, v_texCoord, vec3(v_viewDir, 1.));\n\n    // Read penumbra size\n    vec4 inValue = texture2D(u_input, v_texCoord);\n    float penumbraSize = (inValue.y + 0.005) * baseDepth * 0.05; // FIXME: make this adjustable\n\n    // Penumbra matrix + normal row (world space), transposed\n    mat3 mW2PT = mat3(u_lightU, u_lightV, normal);\n    // Inverse\n    mat3 mP2WT = invertMatrix3(mW2PT, 0.01);\n\n    // Covariance matrix on world space = mP2W * SigmaP * mP2WT\n    // SigmaP is defined as SigmaP * (x, y, z) = (sigma * x, sigma * y, 0)\n    float sigma = penumbraSize;\n    mat3 sigmaP = mat3(\n        sigma, 0., 0.,\n        0., sigma, 0.,\n        0., 0., 0.);\n    mat3 covW = (mP2WT) * sigmaP * transposeMatrix3(mP2WT);\n\n    // Compute the covariance matrix on screen space\n    // mW2S = [ 1 / w    0    -x/w^2 ]\n    //        [   0    1 / w  -y/w^2 ]\n    highp float baseDepthInv = 1. / baseDepth;\n    vec2 mW2Spart = -baseViewPos.xy * (baseDepthInv * baseDepthInv);\n    vec3 covS = vec3(\n        covW[0][0] * (baseDepthInv * baseDepthInv) +\n            baseDepthInv * mW2Spart.x * (covW[0][2] * covW[0][2]) +\n            covW[2][2] * (mW2Spart.x * mW2Spart.x),   // sigma x ^ 2\n        covW[1][1] * (baseDepthInv * baseDepthInv) +\n            baseDepthInv * mW2Spart.y * (covW[1][2] * covW[1][2]) +\n            covW[2][2] * (mW2Spart.y * mW2Spart.y),   // sigma y ^ 2\n        baseDepthInv * baseDepthInv * covW[0][1] +\n        baseDepthInv * mW2Spart.x * covW[1][2] +\n        baseDepthInv * mW2Spart.y * covW[0][2] +\n        mW2Spart.x * mW2Spart.y * covW[2][2]  // sigma xy\n    );\n\n    covS *= u_covSScale;\n\n    // Compute cross convolution axis\n    vec2 axis1, axis2;\n    axis1.y = 0.;\n    axis2.y = sqrt(max(0., covS.y));\n    axis2.x = covS.z / (axis2.y + 0.00001);\n    axis1.x = sqrt(max(0., covS.x - axis2.x * axis2.x));\n\n    float cx = dot(v_texCoord, axis1 / dot(axis1, axis1));\n    float cy = dot(v_texCoord, axis2 / dot(axis2, axis2));\n\n    float maxlen = max(dot(axis1, axis1), dot(axis2, axis2));\n    if (maxlen > u_maxBlur) {\n        float scale = sqrt(u_maxBlur / maxlen);\n        axis1 *= scale; axis2 *= scale;\n    }\n\n    // Bilateral filtering\n    highp float weightScale = 30. / baseDepth;\n\n    vec2 sum = vec2(1., 1.) * 0.001;\n\n    highp vec2 coordOffset = c_direction != 0 ? axis1 : axis2;\n    highp vec2 coord = v_texCoord - coordOffset * 0.5;\n    coordOffset *= 1. / float(c_numSamples);\n\n    float shift = -0.5;\n\n#if c_direction\n    float jitter = texture2D(u_jitter, v_jitterCoord).x;\n#else\n    float jitter = texture2D(u_jitter, v_jitterCoord).y;\n#endif\n    coord += coordOffset * jitter;\n    shift += (1. / float(c_numSamples)) * jitter;\n\n    for (int i = 0; i < c_numSamples; ++i) {\n        float value = texture2D(u_input, coord).x;\n        highp float depth = fetchDepth(u_linearDepth, coord);\n\n        float weight = abs(depth - baseDepth) * weightScale + abs(shift) * 3.;\n        weight = exp2(-weight * weight);\n\n        sum += vec2(value, 1.) * weight;\n\n        coord += coordOffset;\n        shift += 1. / float(c_numSamples);\n    }\n\n    float result = sum.x / sum.y;\n    gl_FragColor = vec4(result, inValue.yzw);\n}"},FS_TemporalAA:{requires:["Globals","GBuffer","DepthFetch","YUV"],parameters:["useWiderFilter"],attributes:[],source:"\nuniform sampler2D u_input;\nuniform sampler2D u_linearDepth;\nuniform sampler2D u_g0;\nuniform sampler2D u_g1;\nuniform sampler2D u_oldAccum;\nuniform sampler2D u_oldDepth;\n\nvarying highp vec2 v_texCoord;\n\nvoid main()\n{\n\n    vec4 g0 = texture2D(u_g0, v_texCoord);\n    vec4 g1 = texture2D(u_g1, v_texCoord);\n    vec4 g2 = vec4(0.);\n    vec4 g3 = vec4(0.);\n\n    GBufferContents g;\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n    vec3 currentColor = texture2D(u_input, v_texCoord).xyz;\n\n    highp vec2 curCoord = v_texCoord.xy;\n#if c_useWiderFilter\n    highp vec4 curCoord2 = curCoord.xyxy + vec4(u_globalDoubleInvRenderSize, -u_globalDoubleInvRenderSize);\n    vec3 currentColor5 = texture2D(u_input, curCoord2.xy).xyz;\n    vec3 currentColor6 = texture2D(u_input, curCoord2.xw).xyz;\n    vec3 currentColor7 = texture2D(u_input, curCoord2.zy).xyz;\n    vec3 currentColor8 = texture2D(u_input, curCoord2.zw).xyz;\n    curCoord2 = curCoord.xyxy + vec4(u_globalInvRenderSize, -u_globalInvRenderSize);\n#else\n    highp vec4 curCoord2 = curCoord.xyxy + vec4(u_globalInvRenderSize, -u_globalInvRenderSize);\n    vec3 currentColor5 = texture2D(u_input, curCoord2.xy).xyz;\n    vec3 currentColor6 = texture2D(u_input, curCoord2.xw).xyz;\n    vec3 currentColor7 = texture2D(u_input, curCoord2.zy).xyz;\n    vec3 currentColor8 = texture2D(u_input, curCoord2.zw).xyz;\n#endif\n    vec3 currentColor1 = texture2D(u_input, vec2(curCoord.x, curCoord2.y)).xyz;\n    vec3 currentColor2 = texture2D(u_input, vec2(curCoord.x, curCoord2.w)).xyz;\n    vec3 currentColor3 = texture2D(u_input, vec2(curCoord2.x, curCoord.y)).xyz;\n    vec3 currentColor4 = texture2D(u_input, vec2(curCoord2.z, curCoord.y)).xyz;\n\n    highp vec4 neighborCoords = curCoord.xyxy + vec4(u_globalQuadInvRenderSize, -u_globalQuadInvRenderSize);\n\n    vec4 lastValue = texture2D(u_oldAccum, curCoord);\n    vec3 lastColor = lastValue.xyz;\n\n    vec3 currentColor0 = encodePalYuv(currentColor);\n    currentColor1 = encodePalYuv(currentColor1);\n    currentColor2 = encodePalYuv(currentColor2);\n    currentColor3 = encodePalYuv(currentColor3);\n    currentColor4 = encodePalYuv(currentColor4);\n    currentColor5 = encodePalYuv(currentColor5);\n    currentColor6 = encodePalYuv(currentColor6);\n    currentColor7 = encodePalYuv(currentColor7);\n    currentColor8 = encodePalYuv(currentColor8);\n\n    vec3 minColor = min(min(currentColor1, currentColor2), min(currentColor3, min(currentColor4, currentColor0)));\n    vec3 maxColor = max(max(currentColor1, currentColor2), max(currentColor3, max(currentColor4, currentColor0)));\n    minColor = mix(minColor, min(min(currentColor5, currentColor6), min(currentColor7, min(currentColor8, minColor))), 0.5);\n    maxColor = mix(maxColor, max(max(currentColor5, currentColor6), max(currentColor7, max(currentColor8, maxColor))), 0.5);\n\n    vec3 oldLastColor = lastColor;\n    lastColor = encodePalYuv(lastColor);\n    lastColor = clamp(lastColor, minColor, maxColor);\n    lastColor = decodePalYuv(lastColor);\n\n    vec3 diffLastColor = oldLastColor - lastColor;\n    lastValue.w *= max(0., 1. - dot(diffLastColor, diffLastColor) * 5.);\n\n    // prevent ghosting\n    float blendAmount = lastValue.w;\n    blendAmount = min(blendAmount, texture2D(u_oldAccum, neighborCoords.xy).w);\n    blendAmount = min(blendAmount, texture2D(u_oldAccum, neighborCoords.xw).w);\n    blendAmount = min(blendAmount, texture2D(u_oldAccum, neighborCoords.zy).w);\n    blendAmount = min(blendAmount, texture2D(u_oldAccum, neighborCoords.zw).w);\n\n    gl_FragColor.xyz = mix(currentColor, lastColor, blendAmount);\n    gl_FragColor.w = lastValue.w;\n}\n"},FS_TemporalAAPrepass:{requires:["Globals","GBuffer","DepthFetch"],parameters:[],attributes:[],source:"\nuniform sampler2D u_input;\nuniform sampler2D u_linearDepth;\nuniform sampler2D u_g0;\nuniform sampler2D u_g1;\nuniform sampler2D u_oldAccum;\nuniform sampler2D u_oldDepth;\n\nvarying highp vec2 v_texCoord;\n\nfloat calculateLuminance(vec3 color)\n{\n    return color.x + color.y;\n}\n\nvec3 fetchVelocity(highp vec2 coord)\n{\n    vec4 g0 = texture2D(u_g0, coord);\n    vec4 g1 = texture2D(u_g1, coord);\n    vec4 g2 = vec4(0.);\n    vec4 g3 = vec4(0.);\n\n    GBufferContents g;\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n    return vec3(g.velocity * 0.5, dot(g.velocity, g.velocity));\n}\n\nvoid main()\n{\n    // velocity dilation\n    vec4 coords = vec4(v_texCoord.xyxy + vec4(u_globalInvRenderSize, -u_globalInvRenderSize));\n    vec3 best = fetchVelocity(v_texCoord.xy);\n    {\n        vec3 v = fetchVelocity(coords.xy);\n        if (v.z > best.z) best = v;\n    }\n    {\n        vec3 v = fetchVelocity(coords.zy);\n        if (v.z > best.z) best = v;\n    }\n    {\n        vec3 v = fetchVelocity(coords.xw);\n        if (v.z > best.z) best = v;\n    }\n    {\n        vec3 v = fetchVelocity(coords.zw);\n        if (v.z > best.z) best = v;\n    }\n\n    vec2 velocity = best.xy;\n    float velocityLen = length(velocity * u_globalRenderSize);\n\n    highp vec2 oldCoord = v_texCoord - velocity;\n\n    vec4 lastValue = texture2D(u_oldAccum, oldCoord);\n    vec3 lastColor = lastValue.xyz;\n\n    gl_FragColor.xyz = lastColor;\n\n    if (oldCoord.x < 0. || oldCoord.x > 1. ||\n        oldCoord.y < 0. || oldCoord.y > 1. ||\n        velocityLen > 50.) {\n        // too much movement. reset blend amount\n        gl_FragColor.w = 0.0;\n        return;\n    }\n\n    float blendAmt = lastValue.w;\n    blendAmt = 1. / (1.001 - blendAmt);\n    blendAmt += 1.;\n    blendAmt = min(1.001 - 1. / blendAmt, 1.);\n\n    gl_FragColor.w = blendAmt;\n}\n"},FS_ToneMapping:{requires:["Globals","LogRGB"],parameters:["globalSupportsSRGB","inputIsLogRGB"],attributes:[],source:"\nuniform sampler2D u_input;\nvarying highp vec2 v_texCoord;\n\nvarying vec2 v_vignetteCoord;\nuniform mediump float u_vignetteAmount;\n\nuniform float u_gain;\n\nuniform vec3 u_color;\n\nuniform float u_highlightCrush;\nuniform float u_contrast;\n\nvoid main()\n{\n#if c_inputIsLogRGB\n    vec3 color = decodeLogRGB(texture2D(u_input, v_texCoord));\n#else\n    vec3 color = texture2D(u_input, v_texCoord).xyz;\n#endif\n\n    // vignette\n    float vigTan2 = dot(v_vignetteCoord, v_vignetteCoord);\n    float vigCos2 =  1. / (1. + vigTan2);\n    float vigCos4 = vigCos2 * vigCos2;\n    color *= max(mix(1., vigCos4, u_vignetteAmount) * u_gain, 0.);\n\n    // apply color\n    color *= u_color;\n\n    // tone mapping\n    float luma = dot(color, vec3(0.2126, 0.7152, 0.0722));\n    float toneMapScale = 1. / (1. + luma * u_highlightCrush);\n    color *= toneMapScale;\n\n    color = mix(color, smoothstep(vec3(0.), vec3(1.), color), u_contrast);\n\n    gl_FragColor.xyz = color;\n\n#if !c_globalSupportsSRGB\n    gl_FragColor.xyz = sqrt(gl_FragColor.xyz);\n#endif\n\n    gl_FragColor.w = 1.;\n}\n"},VS_BilateralFilter:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\n\nvarying vec2 v_texCoord;\n\nvarying highp vec2 v_texCoord1;\nvarying highp vec2 v_texCoord2;\nvarying highp vec2 v_texCoord3;\nvarying highp vec2 v_texCoord4;\nvarying highp vec2 v_texCoord5;\nvarying highp vec2 v_texCoord6;\n\nuniform vec2 u_texCoordOffset;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_texCoord1 = v_texCoord + u_texCoordOffset;\n    v_texCoord2 = v_texCoord - u_texCoordOffset;\n    v_texCoord3 = v_texCoord1 + u_texCoordOffset;\n    v_texCoord4 = v_texCoord2 - u_texCoordOffset;\n    v_texCoord5 = v_texCoord3 + u_texCoordOffset;\n    v_texCoord6 = v_texCoord4 - u_texCoordOffset;\n}\n"},VS_Blur:{requires:["Globals"],parameters:[],attributes:[],source:"\nattribute vec2 a_position;\nvarying vec2 v_texCoord1;\nvarying vec2 v_texCoord2;\nvarying vec2 v_texCoord3;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n\n    vec2 normCoord = a_position * 0.5 + 0.5;\n\n    v_texCoord1 = normCoord;\n    v_texCoord2 = normCoord - u_globalInvRenderSize;\n    v_texCoord3 = normCoord + u_globalInvRenderSize;\n}\n"},VS_GaussianBlur:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nuniform vec2 u_texCoordOffset;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * 0.5 + 0.5 + u_texCoordOffset;\n}\n"},VS_HdrCompress:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_jitterCoord;\nuniform vec2 u_jitterScale;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n    v_jitterCoord = v_texCoord * u_jitterScale;\n}\n"},VS_SSAO:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * a_position.x;\n    v_viewDir += u_viewDirCoefY * a_position.y;\n}\n"},VS_SSR:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\n\nvarying highp vec2 v_jitterCoord;\nuniform vec2 u_jitterCoordScale;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * a_position.x;\n    v_viewDir += u_viewDirCoefY * a_position.y;\n\n    v_jitterCoord = v_texCoord * u_jitterCoordScale;\n}\n"},VS_ScreenSpaceSoftShadow:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\nvarying vec2 v_jitterCoord;\nuniform vec2 u_jitterScale;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * a_position.x;\n    v_viewDir += u_viewDirCoefY * a_position.y;\n\n    v_jitterCoord.xy = u_jitterScale * a_position;\n}\n"},VS_TemporalAA:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * .5 + .5;\n}\n"},VS_ToneMapping:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nuniform vec4 u_uvScale;\n\nvarying vec2 v_vignetteCoord; // tangent\nuniform vec2 u_vignetteScale;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * .5 + .5;\n\n    v_vignetteCoord = a_position * u_vignetteScale;\n}\n"},FS_PrefilterCubemap:{requires:["ShadingModel","TextureLod"],parameters:["seamless"],attributes:[],source:"\nuniform samplerCube u_texture;\nuniform sampler2D u_jitter;\nuniform float u_textureLod;\nuniform float u_textureSize;\nuniform float u_roughness;\nuniform float u_borderCoord;\nuniform bvec3 u_axisIsMinor;\nuniform float u_sampleRange;\n\nvarying vec3 v_dir;\nvarying vec2 v_jitterCoord;\n\n// Lambert azimuthal equal-area projection\nvec3 spheremap(vec2 v)\n{\n	vec4 nn = vec4(v, 1., -1.);\n    float l = dot(nn.xyz, -nn.xyw);\n    nn.z = l; nn.xy *= sqrt(l);\n    return nn.xyz * 2. + vec3(0., 0., -1.); \n}\n\nvoid makeAxis(vec3 ax, out vec3 ay, out vec3 az)\n{\n	vec3 up = abs(ax.z) > 0.5 ? vec3(1., 0., 0.) : vec3(0., 0., 1.);\n	ay = cross(ax, up);\n	az = cross(ay, ax);\n}\n\nvoid main()\n{\n	vec3 dir = v_dir;\n\n	// texture cube seam elimination\n	if (u_axisIsMinor.x) {\n		dir.x /= u_borderCoord;\n	}\n	if (u_axisIsMinor.y) {\n		dir.y /= u_borderCoord;\n	}\n	if (u_axisIsMinor.z) {\n		dir.z /= u_borderCoord;\n	}\n\n	vec3 dirU, dirV;\n	makeAxis(dir, dirU, dirV);\n\n	dir = normalize(dir);\n	dirU = normalize(dirU);\n	dirV = normalize(dirV);\n\n	highp vec4 sum = vec4(0.);\n\n	vec2 offs = texture2D(u_jitter, v_jitterCoord).xy * 0.1 - 0.05;\n\n	for (float x = -0.95; x <= 1.0; x += 0.1) {\n		for (float y = -0.95; y <= 1.0; y += 0.1) {\n			vec2 pv = vec2(x, y) + offs;\n			\n			float borderrad = max(abs(pv.x), abs(pv.y)) / length(pv);\n			pv *= borderrad;\n			float chance2 = borderrad;\n			float ln = length(pv);\n			pv *= ln; chance2 *= ln;\n\n			vec3 lrdir = spheremap(pv * u_sampleRange);\n			vec3 rdir = lrdir.z * dir + lrdir.y * dirU + lrdir.x * dirV;\n			float nhDot = lrdir.z;\n			highp float chance = evaluateGGXSpecularDistribution(nhDot, u_roughness);\n			chance *= max(0., nhDot);\n			chance *= evaluateBeckmannGeometryShadowingSingleSide(nhDot, u_roughness);\n			vec4 value = myTextureCubeLod(u_texture, rdir, u_textureLod, u_textureSize);\n			highp vec3 color = value.xyz * value.xyz; // linearize\n			sum += vec4(color, 1.) * chance * chance2;\n		}\n	}\n\n	highp vec3 result = sum.xyz / sum.w;\n	gl_FragColor = vec4(sqrt(result), 1.);\n}\n"},VS_PrefilterCubemap:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec3 v_dir;\nuniform vec3 u_axisMajor;\nuniform vec3 u_axisU;\nuniform vec3 u_axisV;\nvarying vec2 v_jitterCoord;\nuniform float u_jitterScale;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n\n    v_jitterCoord = a_position * u_jitterScale;\n\n    v_dir = u_axisMajor;\n    v_dir += u_axisU * a_position.x;\n    v_dir += u_axisV * a_position.y;\n}\n"},FS_VisualizeColor:{requires:[],parameters:["globalSupportsSRGB"],attributes:[],source:"uniform sampler2D u_texture;\nvarying highp vec2 v_texCoord;\nvoid main()\n{\n    gl_FragColor = texture2D(u_texture, v_texCoord);\n#if c_globalSupportsSRGB\n    gl_FragColor.xyz = sqrt(gl_FragColor.xyz);\n#endif\n    gl_FragColor.w = 1.;\n}\n"},FS_VisualizeGBuffer:{requires:["GBuffer"],parameters:["visualizedAttribute"],attributes:[],source:"uniform sampler2D u_g0;\nuniform sampler2D u_g1;\nuniform sampler2D u_g2;\nuniform sampler2D u_g3;\nvarying highp vec2 v_texCoord;\nvoid main()\n{\n    vec4 g0 = texture2D(u_g0, v_texCoord);\n    vec4 g1 = texture2D(u_g1, v_texCoord);\n    vec4 g2 = texture2D(u_g2, v_texCoord);\n    vec4 g3 = texture2D(u_g3, v_texCoord);\n\n    GBufferContents g;\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n#if c_visualizedAttribute == 0 // Albedo\n    gl_FragColor.xyz = sqrt(g.albedo);\n#elif c_visualizedAttribute == 1 // Normal\n    gl_FragColor.xyz = g.normal * .5 + .5;\n#elif c_visualizedAttribute == 2 // Velocity\n    gl_FragColor.xy = g.velocity * .5 + .5;\n    gl_FragColor.z = 0.5;\n#elif c_visualizedAttribute == 3 // Roughness\n    gl_FragColor.xyz = vec3(g.roughness);\n#elif c_visualizedAttribute == 4 // Metallic\n    gl_FragColor.xyz = vec3(g.metallic);\n#elif c_visualizedAttribute == 5 // Specular\n    gl_FragColor.xyz = vec3(g.specular);\n#elif c_visualizedAttribute == 6 // Preshaded\n    gl_FragColor.xyz = sqrt(g.preshaded);\n#elif c_visualizedAttribute == 7 // MaterialId\n    float id = g.materialId;\n    gl_FragColor.x = frac(id * (1. / 2.));\n    gl_FragColor.y = frac(id * (1. / 4.)) > 0.25 ? .5 : 0.;\n    gl_FragColor.z = frac(id * (1. / 8.)) > 0.25 ? .5 : 0.;\n    if (id > 7.5) {\n        gl_FragColor.xyz += .5;\n    }\n#endif\n\n    gl_FragColor.w = 1.;\n}\n"},FS_VisualizeLinearDepth:{requires:["DepthFetch"],parameters:[],attributes:[],source:"uniform sampler2D u_texture;\nvarying highp vec2 v_texCoord;\n\nvoid main()\n{\n    highp float depth = decodeGDepth(texture2D(u_texture, v_texCoord));\n    highp float depthScaled = depth * u_globalInvDepthFar;\n\n    gl_FragColor.xyz = vec3(0.2, 0.05, 1.) * clamp(depthScaled * 3., 0., 1.);\n\n    gl_FragColor.xyz = mix(gl_FragColor.xyz, vec3(1.0, 0.8, 0.0), clamp(depthScaled * 3. - 1., 0., 1.));\n\n    gl_FragColor.xyz = mix(gl_FragColor.xyz, vec3(1.0, 1.0, 0.0), clamp(depthScaled * 3. - 1.5, 0., 1.));\n\n    gl_FragColor.xyz = mix(gl_FragColor.xyz, vec3(1.0, 1.0, 1.0), clamp(depthScaled * 3. - 2.0, 0., 1.));\n\n    float frac = fract(depth);\n    gl_FragColor.xyz += vec3(0., 1., 1.) * max(0., 1. - abs(frac - 0.5) * 5.);\n\n    gl_FragColor.w = 1.;\n}\n"},FS_DirectionalLightShadow:{requires:["DepthFetch","ShadowTexture"],parameters:["clipByFarPlane","clipByNearPlane"],attributes:[],source:"\n\n#extension GL_OES_standard_derivatives : enable\n\nuniform sampler2D u_linearDepth;\n\nvarying highp vec2 v_texCoord;\nvarying highp vec2 v_viewDir;\n\nuniform highp float u_farPlane;\nuniform highp float u_nearPlane;\n\nuniform mat4 u_shadowMapMatrix;\nuniform highp sampler2D u_shadowMap;\n\nuniform float u_shadowMapZScale;\n\n// warning: result.x is inverted (1 = occluded)\nhighp vec2 shadowTexture2DWithDistance(highp sampler2D tex, highp vec3 coord)\n{\n    highp float value = texture2D(tex, coord.xy).r;\n    return vec2(1., coord.z - value) * step(value, coord.z);\n}\n\nvoid main()\n{\n	highp float depth = fetchDepth(u_linearDepth, v_texCoord);\n\n#if c_clipByFarPlane\n	if (depth > u_farPlane) {\n		discard;\n	}\n#endif\n#if c_clipByNearPlane\n	if (depth < u_nearPlane) {\n		discard;\n	}\n#endif\n\n	highp vec3 viewDir = vec3(v_viewDir, 1.);\n    highp vec3 viewPos = viewDir * -depth;\n\n    vec4 shadowCoordProj = u_shadowMapMatrix * vec4(viewPos, 1.);\n    vec3 shadowCoord = shadowCoordProj.xyz / shadowCoordProj.w;\n\n    float shadowValue = shadowTexture2D(u_shadowMap, shadowCoord);\n\n    // search blocker\n    // FIXME: this is too slow\n    vec3 scale = u_globalRenderSize.xyx * 0.02;\n    vec3 offX = dFdx(shadowCoord) * scale;\n    vec3 offY = dFdy(shadowCoord) * scale;\n    vec2 blockerSum = vec2(1., depth) * 0.0001; // default value\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord + offX + offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord + offX - offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord - offX + offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord - offX - offY);\n\n    offX *= 2.; offY *= 2.;\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord + offX + offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord + offX - offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord - offX + offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord - offX - offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord + offX);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord - offX);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord + offY);\n    blockerSum += shadowTexture2DWithDistance(u_shadowMap, shadowCoord - offY);\n\n    float penumbraSize = (blockerSum.y / blockerSum.x) * u_shadowMapZScale / depth * shadowCoordProj.w * 0.1;\n\n    gl_FragColor = vec4(shadowValue, penumbraSize, 0., 1.);\n}"},VS_DirectionalLightShadow:{requires:[],parameters:[],attributes:[],source:"\nattribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying vec2 v_viewDir;\nuniform vec2 u_viewDirCoefX;\nuniform vec2 u_viewDirCoefY;\nuniform vec2 u_viewDirOffset;\nuniform highp float u_depthValue;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, u_depthValue, 1.);\n    v_texCoord = a_position * 0.5 + 0.5;\n\n    v_viewDir = u_viewDirOffset;\n    v_viewDir += u_viewDirCoefX * a_position.x;\n    v_viewDir += u_viewDirCoefY * a_position.y;\n}\n"},FS_Bloom:{requires:["Globals","LogRGB"],parameters:["useLogRGB","hasTexture"],attributes:[],source:"\n\nuniform sampler2D u_input;\nuniform sampler2D u_bloom;\nuniform sampler2D u_texture;\nvarying highp vec2 v_texCoord;\nvarying highp vec2 v_dustCoord;\n\nuniform mediump float u_strength;\nuniform mediump float u_saturation;\n\nvoid main()\n{\n#if c_useLogRGB\n    vec3 color = decodeLogRGB(texture2D(u_input, v_texCoord));\n#else\n    vec3 color = texture2D(u_input, v_texCoord).xyz;\n#endif\n\n    vec3 bloom = texture2D(u_bloom, v_texCoord).xyz;\n\n    bloom = mix(vec3(dot(bloom, vec3(0.2126, 0.7152, 0.0722))), bloom, u_saturation);\n\n#if c_hasTexture\n	vec3 dust = texture2D(u_texture, v_dustCoord).xyz;\n	bloom *= dust * dust; // linearize & multiply\n#endif\n\n    color += bloom * u_strength;\n\n#if c_useLogRGB\n    gl_FragColor = encodeLogRGB(color);\n#else\n    gl_FragColor = vec4(color, 1.);\n#endif\n}\n"},FS_BloomDownsample:{requires:["Globals","LogRGB"],parameters:[],attributes:[],source:"\nuniform sampler2D u_input;\nvarying highp vec4 v_texCoord;\n\nuniform mediump float u_gain;\n\nvoid main()\n{\n    vec4 sample1 = texture2D(u_input, v_texCoord.xy);\n    vec4 sample2 = texture2D(u_input, v_texCoord.zy);\n    vec4 sample3 = texture2D(u_input, v_texCoord.xw);\n    vec4 sample4 = texture2D(u_input, v_texCoord.zw);\n    vec3 color1 = decodeLogRGB(sample1);\n    vec3 color2 = decodeLogRGB(sample2);\n    vec3 color3 = decodeLogRGB(sample3);\n    vec3 color4 = decodeLogRGB(sample4);\n    vec3 color = (color1 + color2 + color3 + color4) * u_gain;\n\n    gl_FragColor.xyz = color;\n}\n"},VS_Bloom:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nvarying highp vec2 v_dustCoord;\nuniform vec2 u_dustScale;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * .5 + .5;\n    v_dustCoord = a_position * u_dustScale + .5;\n}\n"},VS_BloomDownsample:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec4 v_texCoord;\nuniform vec2 u_texCoordOffset;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = (a_position * .5 + .5).xyxy;\n    v_texCoord.xy -= u_texCoordOffset;\n    v_texCoord.zw += u_texCoordOffset;\n}\n"
},FS_MotionBlur:{requires:["GBuffer","DepthFetch","LogRGB"],parameters:["numSamples","useLogRGB"],attributes:[],source:'\n\n\nvarying highp vec2 v_texCoord;\nvarying highp vec2 v_jitterCoord;\n\nuniform sampler2D u_g0;\nuniform sampler2D u_g1;\nuniform sampler2D u_velTile;\nuniform sampler2D u_color;\nuniform sampler2D u_linearDepth;\nuniform sampler2D u_jitter;\n\nuniform vec2 u_velocityScale;\nuniform vec2 u_velocityInvScale;\nuniform float u_amount;\n\nuniform float u_minimumVelocitySquared;\nuniform float u_minimumVelocity;\n\nfloat cone(float dist, float vel)\n{\n    return clamp(1. - dist / vel, 0., 1.);\n}\n\nfloat cylinder(float dist, float vel)\n{\n    float ln = vel;\n    return 1. - smoothstep(ln * 0.95, ln * 1.05, dist);\n}\n\nfloat softDepthCompare(highp float a, highp float b)\n{\n    const float extent = 0.01;\n    return clamp(1. - (a - b) * (1. / extent), 0., 1.);\n}\n\nvec2 velocityAt(highp vec2 coord)\n{\n    vec4 g0 = texture2D(u_g0, coord);\n    vec4 g1 = texture2D(u_g1, coord);\n    vec4 g2 = vec4(0.), g3 = vec4(0.);\n\n    GBufferContents g;\n    decodeGBuffer(g, g0, g1, g2, g3);\n\n    return g.velocity * u_velocityScale * u_amount;\n}\n\nvoid main()\n{\n\n    // velocity in the neighborhood\n    vec2 vn = texture2D(u_velTile, v_texCoord).xy - 0.5;\n    float fnLenSq = dot(vn, vn);\n    if (fnLenSq < u_minimumVelocitySquared * 8.) {\n        // no blur\n        gl_FragColor = texture2D(u_color, v_texCoord);\n        return;\n    }\n\n    vec2 localVel = velocityAt(v_texCoord);\n    highp float localDepth = fetchDepth(u_linearDepth, v_texCoord);\n    float localVelLn = max(length(localVel), u_minimumVelocity);\n\n    // sample initial point\n    vec4 sum = vec4(\n#if c_useLogRGB\n        decodeLogRGB(texture2D(u_color, v_texCoord)),\n#else\n        texture2D(u_color, v_texCoord).xyz,\n#endif\n        1.);\n    sum *= .25 * u_minimumVelocity / localVelLn;\n\n    // start sampling neighbor points\n    highp vec2 coord = v_texCoord;\n\n    float edgeFade = max(u_globalQuadInvRenderSize.x, u_globalQuadInvRenderSize.y);\n    float jitter = texture2D(u_jitter, v_jitterCoord).x;\n\n    vn *= u_velocityInvScale;\n    coord -= vn * 0.5; // make blur "double-sided" (actually this is wrong but artifact is subtle)\n    vn *= (1. / float(c_numSamples));\n    coord += vn * jitter;\n\n    float fpos = -1.;\n\n    for (int i = 1; i < c_numSamples; ++i) {\n        coord += vn;\n        fpos += 2. / float(c_numSamples);\n\n        highp float depth = fetchDepth(u_linearDepth, coord);\n#if c_useLogRGB\n        vec3 color = decodeLogRGB(texture2D(u_color, coord));\n#else\n        vec3 color = texture2D(u_color, coord).xyz;\n#endif\n        vec2 vel = velocityAt(coord);\n\n        float b = softDepthCompare(localDepth, depth);\n        float f = softDepthCompare(depth, localDepth);\n\n        float distln = distance(coord * u_velocityScale, v_texCoord * u_velocityScale); // FIXME: optimize\n        float velln = max(length(vel), u_minimumVelocity);\n\n        float weight = f * cone(distln, velln) + b * cone(distln, localVelLn) +\n            cylinder(distln + u_minimumVelocity * 2., velln) * cylinder(distln + u_minimumVelocity * 2., localVelLn) * 2.;\n\n        // fade the border artifact\n        weight *= clamp((min(min(coord.x, coord.y), 1. - max(coord.x, coord.y)) - edgeFade) * 100., 0., 1.);\n\n        // fade the endpoint of blur\n        weight *= 1. - fpos * fpos;\n\n        sum += vec4(color, 1.) * weight;\n    }\n\n    vec3 result = sum.xyz / sum.w;\n#if c_useLogRGB\n    gl_FragColor = encodeLogRGB(result);\n#else\n    gl_FragColor.xyz = result;\n    gl_FragColor.w = 1.;\n#endif\n}'},FS_MotionBlurDownsample:{requires:["GBuffer","Globals"],parameters:["scale"],attributes:[],source:"\n\nvarying highp vec2 v_texCoord;\n\nuniform sampler2D u_g0;\nuniform sampler2D u_g1;\n\nuniform highp vec2 u_texCoordIncr;\n\nuniform vec2 u_velocityScale;\nuniform float u_amount;\n\n// based on:\n//\n// Morgan McGuire, Padraic Hennessy, Michael Bukowski, and Brian Osman. 2012.\n// A reconstruction filter for plausible motion blur. In Proceedings of the\n// ACM SIGGRAPH Symposium on Interactive 3D Graphics and Games (I3D '12),\n// Stephen N. Spencer (Ed.). ACM, New York, NY, USA, 135-142.\n// DOI=10.1145/2159616.2159639 http://doi.acm.org/10.1145/2159616.2159639\n\n\nvoid main()\n{\n    vec2 coords[c_scale];\n    coords[0] = v_texCoord;\n    for (int i = 1; i < c_scale; ++i) {\n        coords[i] = coords[i - 1] + u_texCoordIncr;\n        coords[i].y = min(coords[i].y,\n            1. - u_globalDoubleInvRenderSize.y);\n    }\n\n    vec3 best = vec3(0.);\n    for (int y = 0; y < c_scale; ++y) {\n        for (int x = 0; x < c_scale; ++x) {\n            vec2 coord = vec2(coords[x].x, coords[y].y);\n            vec4 g0 = texture2D(u_g0, coord);\n            vec4 g1 = texture2D(u_g1, coord);\n            vec4 g2 = vec4(0.), g3 = vec4(0.);\n\n            GBufferContents g;\n            decodeGBuffer(g, g0, g1, g2, g3);\n\n            g.velocity *= u_velocityScale * u_amount;\n            vec3 vel = vec3(g.velocity, dot(g.velocity, g.velocity));\n            if (vel.z > best.z) {\n                best = vel;\n            }\n        }\n    }\n\n    if (best.z > 0.25) {\n        best.xy *= inversesqrt(best.z) * 0.5;\n    }\n    best.z = length(best.xy) * 2.;\n\n    best.xy += 0.5;\n    gl_FragColor = vec4(best, 0.);\n}\n"},FS_MotionBlurNeighborMax:{requires:[],parameters:[],attributes:[],source:"\nvarying highp vec2 v_texCoord1;\nvarying highp vec4 v_texCoord2;\n\nuniform sampler2D u_input;\n\nvoid main()\n{\n    vec3 result = texture2D(u_input, v_texCoord1.xy).xyz;\n    vec3 s;\n\n    s = texture2D(u_input, vec2(v_texCoord1.x, v_texCoord2.y)).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    s = texture2D(u_input, vec2(v_texCoord1.x, v_texCoord2.w)).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    s = texture2D(u_input, vec2(v_texCoord2.x, v_texCoord1.y)).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    s = texture2D(u_input, vec2(v_texCoord2.z, v_texCoord1.y)).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    s = texture2D(u_input, v_texCoord2.xy).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    s = texture2D(u_input, v_texCoord2.xw).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    s = texture2D(u_input, v_texCoord2.zy).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    s = texture2D(u_input, v_texCoord2.zw).xyz;\n    if (s.z > result.z) {\n        result = s;\n    }\n\n    gl_FragColor = vec4(result, 0.);\n}\n"},VS_MotionBlur:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\n\nuniform vec2 u_jitterScale;\nvarying vec2 v_jitterCoord;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * .5 + .5;\n\n    v_jitterCoord = v_texCoord * u_jitterScale;\n}\n"},VS_MotionBlurDownsample:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord;\nuniform vec2 u_texCoordOffset;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord = a_position * .5 + .5 + u_texCoordOffset;\n}\n"},VS_MotionBlurNeighborMax:{requires:[],parameters:[],attributes:[],source:"attribute vec2 a_position;\nvarying vec2 v_texCoord1;\nvarying vec4 v_texCoord2;\nuniform vec2 u_texCoordOffset;\n\nvoid main()\n{\n    gl_Position = vec4(a_position, 0., 1.);\n    v_texCoord1 = a_position * .5 + .5;\n    v_texCoord2 = v_texCoord1.xyxy + vec4(u_texCoordOffset, -u_texCoordOffset);\n}\n"}}},{}],48:[function(e,t,r){var n=function(){function e(){this.map=new Int32Array([0]),this.range=0}return e.prototype.reserve=function(e){var t=this.map;t.length<<4<e&&(this.map=new Int32Array(e+3>>4),this.map.set(t))},e.prototype.setRange=function(e){this.reserve(e<<4);var t=this.range,r=this.map;if(this.range=e,e>t)for(var n=t;e>n;++n)r[n]=0;else if(t>e)for(var n=e;t>n;++n)for(var i=r[n],o=0;16>o;o+=4){var a=i>>o&15;if(a)for(var s=0;4>s;++s)a&1<<s&&this.onToggledFalse(o+s+(n<<4))}},e.prototype.onToggledTrue=function(e){},e.prototype.onToggledFalse=function(e){},e.prototype.toggleOne=function(e,t){this.reserve(e+1);var r=this.map,n=1<<(15&e),i=e>>4;if(t)if(i>=this.range){for(var o=i-1;o>=this.range;--o)r[o]=0;this.range=i+1,r[i]=n,this.onToggledTrue(e)}else 0==(r[i]&n)&&(r[i]|=n,this.onToggledTrue(e));else{if(i>=this.range)return;r[i]&n&&(r[i]&=~n,this.onToggledFalse(e))}},e.prototype.toggleAllWithTrueIndex=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(0==e.length)return void this.setRange(0);var r=Math.max.apply(Math,e),n=r+16>>4;this.reserve(r+1),this.setRange(n);for(var i=this.map,o=0;o<e.length;o++){var a=e[o];i[a>>4]|=65536<<(15&a)}for(var s=0;n>s;++s){var u=i[s],h=65535&u,c=u>>>16,l=h^c;if(i[s]=c,l)for(var p=0;16>p;p+=4){var f=l>>p&15;if(f)for(var d=0;4>d;++d)f&1<<d&&(c&1<<p+d?this.onToggledTrue(p+d+(s<<4)):this.onToggledFalse(p+d+(s<<4)))}}},e.prototype.toggleAllWithArray=function(e){var t=e.range;this.reserve(t<<4),this.setRange(t);for(var r=e.map,n=this.map,i=0;t>i;++i){var o=n[i],a=r[i],s=o^a;if(s){n[i]=a;for(var u=0;16>u;u+=4){var h=s>>u&15;if(h)for(var c=0;4>c;++c)h&1<<c&&(a&1<<u+c?this.onToggledTrue(u+c+(i<<4)):this.onToggledFalse(u+c+(i<<4)))}}}},e}();r.BitArray=n},{}],49:[function(e,t,r){function n(e,t){t||(t={offset:new a.Vector2,coefX:new a.Vector2,coefY:new a.Vector2});var r=s.Vector4Pool.alloc(),n=s.Vector4Pool.alloc(),i=s.Matrix4Pool.alloc();return r.set(0,0,1,1),r.applyMatrix4(e),i.getInverse(e),n.set(0,0,r.z,r.w),n.applyMatrix4(i),t.offset.set(n.x,n.y),n.set(-1,0,r.z,r.w),n.applyMatrix4(i),t.coefX.set(n.x,n.y),n.set(0,-1,r.z,r.w),n.applyMatrix4(i),t.coefY.set(n.x,n.y),s.Vector4Pool.free(r),s.Vector4Pool.free(n),s.Matrix4Pool.free(i),t}function i(e){return(e.elements[15]-e.elements[14])/(e.elements[11]-e.elements[10])}var o=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},a=e("three"),s=e("./ObjectPool");r.computeViewVectorCoefFromProjectionMatrix=n,r.computeFarDepthFromProjectionMatrix=i;var u=function(){function e(){}return e.prototype.computeBoundingBox=function(e,t){return null==t&&(t=new a.Box3),t.makeEmpty(),this.traverse(e,t),t},e.prototype.traverse=function(e,t){for(var r=0,n=e.children;r<n.length;r++){var i=n[r];this.traverse(i,t)}this.addObject(e,t)},e.prototype.addObject=function(e,t){if(e instanceof a.Mesh){var r=e.geometry;if(null==r)return;null==r.boundingSphere&&r.computeBoundingSphere();var n=s.Vector3Pool.alloc(),i=r.boundingSphere.radius;n.set(i,i,i),n.applyMatrix4(e.matrixWorld);var o=s.Vector3Pool.alloc();e.getWorldPosition(o);var u=o.distanceTo(n);n.copy(o),o.addScalar(u),n.subScalar(u),t.expandByPoint(n),t.expandByPoint(o),s.Vector3Pool.free(n),s.Vector3Pool.free(o)}},e}();r.ObjectBoundingBoxCalculator=u;var h=function(e){function t(){e.apply(this,arguments)}return o(t,e),t.prototype.traverse=function(e,t){return e.visible?u.prototype.traverse.call(this,e,t):void 0},t.prototype.addObject=function(e,t){return e.castShadow?u.prototype.addObject.call(this,e,t):void 0},t}(u);r.ShadowCastingObjectBoundingBoxCalculator=h},{"./ObjectPool":54,three:"three"}],50:[function(e,t,r){var n=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},i=e("./IntegerMap"),o=function(){function e(){this.map=new i.IntegerMap}return Object.defineProperty(e.prototype,"isEmpty",{get:function(){return this.map.isEmpty},enumerable:!0,configurable:!0}),e.prototype.disposeValue=function(e){},e.prototype.get=function(e){var t=this.map.get(e.id);if(t){if(t.key!=e)throw new Error;return t.value}return null},e.prototype.set=function(e,t){var r=this,n=this.map.get(e.id);if(n){if(n.key!=e)throw new Error;n.value=t}else{var i=e.id,o=function(){return r.onItemDisposed(i)};e.addEventListener("disposed",o),this.map.set(e.id,{key:e,value:t,handler:o})}return t},e.prototype.remove=function(e){var t=this.map.get(e.id);if(null==t)return!1;if(t.key!=e)throw new Error;return this.map.remove(e.id),t.key.removeEventListener("disposed",t.handler),this.disposeValue(t.value),!0},e.prototype.dispose=function(){var e=this;this.map.forEach(function(t,r){r.key.removeEventListener("disposed",r.handler),e.disposeValue(r.value),e.map.remove(t)})},e.prototype.onItemDisposed=function(e){var t=this.map.get(e);this.map.remove(e),t.key.removeEventListener("disposed",t.handler),this.disposeValue(t.value)},e}();r.IdWeakMap=o;var a=function(e){function t(){e.apply(this,arguments)}return n(t,e),t.prototype.disposeValue=function(e){e.dispose()},t}(o);r.IdWeakMapWithDisposable=a},{"./IntegerMap":51}],51:[function(e,t,r){var n=function(){function e(){this.map=new Map}return Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0==this.map.size},enumerable:!0,configurable:!0}),e.prototype.get=function(e,t){var r=this.map.get(e);return"undefined"==typeof r?t:r},e.prototype.set=function(e,t){return this.map.set(e,t),t},e.prototype.remove=function(e){return this.map["delete"](e)},e.prototype.forEach=function(e){this.map.forEach(function(t,r){e(r,t)})},e}();r.IntegerMap=n},{}],52:[function(e,t,r){var n=function(){function e(){this.topics=new Map,this.omni=!1,this.enabledTopics=new Map,this.disabledTopics=new Map}return e.prototype.enableTopic=function(e){this.enabledTopics.set(e,!0),this.disabledTopics["delete"](e);var t=this.topics.get(e);t&&(t.enabled=!0)},e.prototype.disableTopic=function(e){this.disabledTopics.set(e,!0);var t=this.topics.get(e);t&&(t.enabled=!1)},e.prototype.enableAllTopics=function(){this.omni=!0,this.disabledTopics.clear(),this.enabledTopics.clear(),this.topics.forEach(function(e){e.enabled=!0})},e.prototype.disableAllTopics=function(){this.omni=!1,this.disabledTopics.clear(),this.enabledTopics.clear(),this.topics.forEach(function(e){e.enabled=!1})},e.prototype.isTopicEnabled=function(e){return!this.disabledTopics.has(e)&&(this.omni||this.enabledTopics.has(e))},e.prototype.getLogger=function(e){var t=this.topics.get(e);return t||(t=new i(e),t.enabled=this.isTopicEnabled(e),this.topics.set(e,t)),t},e}();r.LogManager=n;var i=function(){function e(e){this.topic=e}return Object.defineProperty(e.prototype,"isEnabled",{get:function(){return this.enabled},enumerable:!0,configurable:!0}),e.prototype.log=function(e){this.enabled&&console.log("Hyper3D ["+this.topic+"]",e)},e.prototype.warn=function(e){console.warn("Hyper3D ["+this.topic+"]",e)},e.prototype.error=function(e){console.error("Hyper3D ["+this.topic+"]",e)},e}()},{}],53:[function(e,t,r){var n=function(){function e(){this.table=[],this.first=null}return e.prototype.computeHash=function(e){throw new Error("not implemented")},e.prototype.equals=function(e,t){throw new Error("not implemented")},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return null==this.first},enumerable:!0,configurable:!0}),e.prototype.get=function(e,t){var r=this.computeHash(e),n=this.table[r];if(n)for(var i=n.head;null!=i;){if(this.equals(e,i.key))return i.value;i=i.next}return t},e.prototype.set=function(e,t){var r=this.computeHash(e),n=this.table[r];if(n)for(var i=n.head;null!=i;){if(this.equals(e,i.key))return i.value=t;i=i.next}var o={key:e,value:t,next:n?n.head:null};return n?n.head=o:(n={head:o,prev:null,next:null},this.first?(n.next=this.first,n.prev=this.first.prev,n.next.prev=n,n.prev.next=n):this.first=n.prev=n.next=n,this.table[r]=n),t},e.prototype.remove=function(e){var t=this.computeHash(e),r=this.table[t];if(r)for(var n=null,i=r.head;null!=i;){if(this.equals(e,i.key))return n?n.next=i.next:null==i.next?(delete this.table[t],this.first==r&&(r.next==r?this.first=null:this.first=r.next),r.next!=r&&(r.next.prev=r.prev,r.prev.next=r.next)):r.head=i.next,!0;n=i,i=i.next}return!1},e.prototype.forEach=function(e){if(this.first){var t=this.first;do{var r=t.next,n=t.head;do{var i=n.next;e(n.key,n.value),n=i}while(n);t=r}while(t!=this.first)}},e}();r.Map=n},{}],54:[function(e,t,r){var n=e("three"),i=function(){function e(e){this.factory=e,this.pool=[]}return e.prototype.alloc=function(){var e=this.pool.pop();return e?e:this.factory()},e.prototype.free=function(e){this.pool.push(e)},e}();r.Vector2Pool=new i(function(){return new n.Vector2}),r.Vector3Pool=new i(function(){return new n.Vector3}),r.Vector4Pool=new i(function(){return new n.Vector4}),r.Matrix4Pool=new i(function(){return new n.Matrix4})},{three:"three"}],55:[function(e,t,r){function n(e,t,r){r*=255;var n=Math.floor(r),i=255*(r-n),o=Math.floor(i),a=255*(i-o);e[t]=Math.max(Math.min(n,255),0),e[t+1]=o,e[t+2]=a}function i(e,t,r){var i=Math.abs(r);if(1e-16>i||i>1e16)e[t]=e[t+1]=e[t+2]=e[t+3]=0;else{var o=Math.ceil(a(i))+63;i*=s[o],0>r&&(o+=128),n(e,t,i),e[t+3]=o}}r.pack24ToU8=n;for(var o=1/Math.LN2,a=Math.log2||function(e){return Math.log(e)*o},s=[],u=0;128>u;++u)s.push(Math.pow(2,63-u));r.pack32FToU8=i},{}],56:[function(e,t,r){var n=e("three"),i=[.281064,.645281,-.167313,.685935,-.160711,-.113289,1.08453,-.0970135,-.3655,-.51894,.275308,-830889e-9,-.0431051,.574405,-.163071,-.30989,.372959,-.0161521,.131741,.456781,.0165477,-.0975113,-.273682,-.509164,.573244,-.714618,-.479023,.0525875,.316595,-.148211,-.423713,-.22462,-.528986,.390866,.0439115,-.274567,.106133,-.377686,.481055,.398664,.314325,.839894,-.625382,.0543475,-.201899,.198677,.0182834,.621111,.128773,-.265686,.602337,.296946,.773769,.0479956,-.132997,-.0410526,-.254838,.326185,.347585,-.580061,.405482,.101755,-.201249,.306534,.469578,-.111657,-.796765,-.0773768,-.538891,.206104,-.0794146,.098465,.413728,.0259771,-.823897,.0925169,.88273,-.184931,-.134422,-.247737,-.682095,.177566,.299386,-.329205,.0488276,.504052,.268825,.395508,-1.10225,.101069,-.0408943,-.580797,-.00804806,-.402047,-.418787,.697977,-.308492,-.122199,.628944,.54588,.0622768,-.488552,.0474367,.215963,-.679212,.311237,-920773e-9,-.721814,.579613,-.0458724,-.467233,.268248,.246741,-.15576,.0473638,.0246596,-.572414,-.419131,-.357526,.452787,-.112269,.710673,-.41551,.429337,.0882859,-.433878,-.0818105,-.180361,.36754,-.49486,.449489,-.837214,-1.09047,.168766,-.163687,.256186,.633943,-.012522,.631576,-.27161,-.15392,-.471082,-.071748,-.275351,-.134404,.126987,-.478438,-.144772,-.38336,.37449,-.458729,-.318997,-.313852,.081244,-.287645,.200266,-.45997,.108317,-.216842,-.165177,-.296687,.771041,.933613,.617833,-.263007,-.236543,-.406302,.241173,-.225985,-.108225,.087069,-.0444767,.645569,-.112983,-.689477,.498425,.0738087,.447277,.0972104,-.314627,.393365,-.0919185,-.32199,-.193414,-.126091,.185217,.318475,.140509,-.115877,-.911059,.336104,-.645395,.00686884,-.172296,-.513633,-.302956,-1.20699,.148284,.357629,.58123,.106886,-.872183,-.49183,-.202535,-.869357,.0371933,-.0869231,.22624,.198995,.191016,.151591,.347114,.056674,-.213039,-.228541,-.473257,-.574876,-.0826995,-.730448,.343791,.795006,.366191,.419235,-1.11688,.227321,-.0937171,.156708,-.3307,.328026,-.454046,.432153,-.189323,.31821,.312532,.0963759,.126471,-.396326,.0353236,-.366891,-.279321,.106791,.0697961,.383726,.260039,.00297499,.45812,-.544967,-.230453,-.150821,-.374241,-.739835,.462278,-.76681,-.455701,.261229,.274824,.161605,-.402379,.571192,.0844102,-.47416,.683535,.144919,-.134556,-.0414159,.357005,-.643226,-.00324917,-.173286,.770447,.261563,.707628,.131681,.539707,-.367105,.150912,-.310055,-.270554,.686523,.195065,.282361,.569649,.106642,.296521,.185682,.124763,.182832,.42824,-.489455,.55954,.383582,.52804,-.236162,-.356153,.70445,-.300133,1.06101,.0289559,.4671,-.0455821,-1.18106,.26797,.223324,.793996,-.833809,-.412982,-.443497,-.634181,-902414e-9,-.319155,.629076,-.378669,-.230422,.489184,.122302,.397895,.421496,-.41475,.192182,-.477254,-.32989,.285264,-.0248513,-.224073,.520192,.138148,.783388,.540348,-.468401,.189778,.327808,.387399,.0163817,.340137,-.174623,-.560019,-.32246,.353305,.513422,-.472848,-.0151656,.0802364,-.0833406,303745e-9,-.359159,-.666926,.446711,-.254889,-.263977,.534997,.555322,-.315034,-.62762,-.14342,-.78082,.29739,.0783401,-.665565,-.177726,.62018,-.723053,.108446,.550657,.00324011,.387362,-.251661,-.616413,-.260163,-.798613,.0174665,-.208833,-.0398486,-.506167,.00121689,-.75707,-.0326216,.30282,.085227,-.27267,.25662,.182456,-.184061,-.577699,-.685311,.587003,.35393,-.276868,-.0617566,-.365888,.673723,-.0476918,-.0914235,.560627,-.387913,-.194537,.135256,-.0808623,.315394,-.0383463,.267406,.545766,-.659403,-.410556,.305285,.0364261,.396365,-.284096,.137003,.611792,.191185,.440866,.87738,.470405,-.372227,-.84977,.676291,-.0709138,-.456707,.222892,-.728947,.2414,.109269,.707531,.027894,-.381266,-.1872,-.674006,-.441284,-.151681,-.695721,.360165,-.397063,.02772,.271526,-.170258,-.198509,.524165,.29589,-.895699,-.266005,.0971003,.640709,-.169635,.0263381,-.779951,-.37692,-.703577,.00526047,-.822414,-.152364,.10004,.194787,.453202,-.495236,1.01192,-.682168,-.453866,.387515,-.355192,.214262,.2677,-.263514,.334733,.683574,.181592,.599759,-.182972,.402297,-.319075,.553958,-.990873,-.143754,.506054,.0535431,-.647583,.53928,-.510285,.452258,-.796479,.186279,-.0960782,-.124537,.509105,-.1712,.219554,-.528307,-.377211,-.447177,-.0283537,.856948,-.128052,.482509,.528981,-.785958,.816482,.213728,-.433917,-.0413878,-.997625,.228201,-.113198,.425206,.0261474,.68678,.224967,.48489,.53184,.572936,-.419627,-.70428,-.216836,.57302,.640487,-.172722,.237492,-.390903,.0717416,.852097,-.0422118,.151465,-.638427,.132246,-.0552788,.436714,-.281931,.411517,-.340499,-.725834,-.478547,.332275,-.0243354,-.499295,.238681,-.324647,-.182754,.520306,-.0762625,.631812,-.652095,-.504378,-.534564,.118165,-.384134,.611485,.635868,.100705,.25619,.197184,.328731,-.0750947,-.763023,.516191,.375317,-.17778,.880709,.668956,.376694,.425053,-.930982,.0534644,-.0423658,.695356,.352989,.0400925,.383482,.188746,.0193305,.128885,-.23603,-.288163,-.311799,-.425027,-.297739,-.349681,-.278894,.00934887,-.38221,.542819,.234533,-.213422,.198418,.694582,-.43395,-.417672,.553686,-.10748,-.352711,-.0115025,.0581546,.962054,.210576,.339536,-.0818458,-.358587,-.342001,-.0689676,.0470595,-.3791,.212149,-.00608754,.318279,.246769,.514428,.457749,.759536,.236433,.422228,.571146,-.247402,.667306,-.558038,-.158556,-.369374,-.341798,.30697,-.535024,-.487844,-.0888073,.404439,-.580029,.457389,.297961,-.0356712,.508803,.325652,-.239089,-.743984,.21902,.455838,.149938,-.150058,.342239,.147549,-.044282,-.634129,.266822,-.764306,-.13691,-.59542,-.503302,-.581097,.455914,.193022,-.255091,.0782733,.354385,.181455,-.579845,-.597151,-.747541,-.471478,-.257622,.80429,.908564,.11331,-.210526,.893246,-.354708,-.581153,.366957,682831e-9,1.05443,.310998,.455284,-.251732,-.567471,-.660306,-.202108,.836359,-.467352,-.20453,.0710459,.0628843,-.132979,-.755594,.0600963,.725805,-.221625,.133578,-.802764,.00850201,.748137,-.411616,-.136451,.0531707,-.977616,.162951,.0394506,-.0480862,.797194,.52012,.238174,.169073,.249234,.00133944,-.01138,.107195,.0101681,-.247766,-.415877,-.450288,.800731],o=function(){function e(){this.index=0}return e.prototype.sample=function(){var e=this.index;return e+2==i.length?this.index=0:this.index=e+2,new n.Vector2(.89*i[e],.89*i[e+1])},e}();r.CenteredNoise=o},{three:"three"}],57:[function(e,t,r){function n(e){var t=[];for(var r in e)t.push(r);return t}function i(e,t){try{return t(e)}finally{e.dispose()}}function o(e,t){for(var r=[],n=0;t>n;++n)r.push(e);return r.join("")}function a(e,t,r){return e+o(r,Math.max(0,t-e.length))}function s(e,t,r){return o(r,Math.max(0,t-e.length))+e}var u=Math.imul,h=[0,9,1,10,13,21,2,29,11,14,16,18,22,25,3,30,8,12,20,28,15,17,24,7,19,27,23,6,26,5,4,31];r.ulog2=u?function(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,h[u(e,125613361)>>>27]}:function(e){for(var t=0;0!=e;)++t,e>>>=1;return t},r.getKeysOfObject=n,r.using=i,r.stringRepeat=o,r.fillWith=a,r.fillWithRightAligned=s},{}],58:[function(e,t,r){function n(e){var t=e.gl,r=e.ext.get("OES_texture_half_float");if(null==r)return console.warn("validateHalfFloatColorBuffer: OES_texture_half_float is not available."),!1;var n=t.createTexture();try{for(t.bindTexture(t.TEXTURE_2D,n);t.getError(););if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,7,7,0,t.RGBA,r.HALF_FLOAT_OES,null),t.getError())return console.warn("validateHalfFloatColorBuffer: could not create half float texture."),!1;t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);var o=i.GLFramebuffer.createFramebuffer(t,{colors:[n]});o.dispose()}catch(a){return console.warn("validateHalfFloatColorBuffer: error: "+a),!1}finally{t.deleteTexture(n)}return!0}var i=e("../core/GLFramebuffer");r.validateHalfFloatColorBuffer=n},{"../core/GLFramebuffer":3}],59:[function(e,t,r){function n(e){var t=e.shaderManager.get("VS_Passthrough","FS_Constant",["a_position"]),r=t.getAttributes(["a_position"]),n=t.getUniforms(["u_constantColor"]),o=e.quadRenderer,a=e.gl,s=e.ext.get("EXT_sRGB");t.use();var u=a.createTexture();try{if(a.bindTexture(a.TEXTURE_2D,u),a.texImage2D(a.TEXTURE_2D,0,s.SRGB_ALPHA_EXT,8,8,0,s.SRGB_ALPHA_EXT,a.UNSIGNED_BYTE,null),a.getError())return console.warn("validateSRGBCompliance: could not create sRGB texture."),!1;a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);var h=i.GLFramebuffer.createFramebuffer(a,{colors:[u]});try{h.bind(),e.state.flags=0,a.viewport(0,0,8,8);for(var c=[[0,0],[13,63],[54,127],[133,191],[255,255]],l=new Uint8Array(256),p=0;p<c.length;p++){var f=c[p],d=f[0]/255,m=f[1];a.uniform4f(n.u_constantColor,d,d,d,1),o.render(r.a_position),a.readPixels(0,0,8,8,a.RGBA,a.UNSIGNED_BYTE,l);for(var g=0;g<l.length;++g){var v=3==(3&g)?255:m;if(Math.abs(l[g]-v)>1)return console.warn("validateSRGBCompliance: expected "+v+", got "+l[g]),!1}}}finally{h.dispose()}}catch(x){return console.warn("validateSRGBCompliance: error: "+x),!1}finally{a.deleteTexture(u)}return!0}var i=e("../core/GLFramebuffer");r.validateSRGBCompliance=n},{"../core/GLFramebuffer":3}],hyper3d:[function(e,t,r){function n(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}n(e("./renderer/public/Lights")),n(e("./renderer/public/Materials")),n(e("./renderer/public/ReflectionProbe")),n(e("./renderer/public/WebGLHyperRenderer"))},{"./renderer/public/Lights":28,"./renderer/public/Materials":29,"./renderer/public/ReflectionProbe":30,"./renderer/public/WebGLHyperRenderer":32}],patroljs:[function(e,t,r){/*
	PatrolJS - Navigation mesh toolkit for ThreeJS
	http://github.com/nickjanssen/patroljs
	Licensed under MIT
*/
!function(r){function n(e,t){var r=new Number(e+"").toFixed(parseInt(t));return parseFloat(r)}function i(){var e,t,r,n,i,o,a=[],s={};for(o=arguments.length-1,r=arguments[0].length,t=0,e=0;o>=e;e++)n=arguments[e].length,r>n&&(t=e,r=n);for(e=0;o>=e;e++){n=e===t?0:e||t,i=arguments[n].length;for(var u=0;i>u;u++){var h=arguments[n][u];s[h]===e-1?e===o?(a.push(h),s[h]=0):s[h]=e:0===e&&(s[h]=0)}}return a}
// Freely distributable under the MIT License.
// Implements the astar search algorithm in javascript using a binary heap.
function o(e){this.content=[],this.scoreFunction=e}function a(e,t){for(var r=!1,n=-1,i=e.length,o=i-1;++n<i;o=n)(e[n].z<=t.z&&t.z<e[o].z||e[o].z<=t.z&&t.z<e[n].z)&&t.x<(e[o].x-e[n].x)*(t.z-e[n].z)/(e[o].z-e[n].z)+e[n].x&&(r=!r);return r}function s(e,t,r){var n=(t.centroid,1e5),i=-1e5,o=[];return l.each(t.vertexIds,function(e){n=Math.min(r[e].y,n),i=Math.max(r[e].y,i),o.push(r[e])}),e.y<i+.5&&e.y>n-.5&&a(o,e)?!0:!1}function u(e,t,r){var n=t.x-e.x,i=t.z-e.z,o=r.x-e.x,a=r.z-e.z;return o*i-n*a}function h(e,t){return M(e,t)<1e-5}function c(){this.portals=[]}var l,p,f;"undefined"!=typeof t&&t.exports?(l=e("underscore"),p=e("three"),f=e("./../../src/progressbar-stub")):(l=window._,p=window.THREE,f=function(){return{tick:function(){}}});var d,m=function(e){var t,r,n;for(t=0,r=e.faces.length;r>t;t++)n=e.faces[t],n.centroid=new p.Vector3(0,0,0),n.centroid.add(e.vertices[n.a]),n.centroid.add(e.vertices[n.b]),n.centroid.add(e.vertices[n.c]),n.centroid.divideScalar(3)},g=1,v={width:30},x=function(e){var t=e.polygons;e.vertices;d=new f("Building polygon groups[:bar] :percent",l.extend(v,{total:t.length}));var r=[],n=0,i=function(e){l.each(e.neighbours,function(t){l.isUndefined(t.group)&&(t.group=e.group,i(t))})};return l.each(t,function(e,t){d.tick(),l.isUndefined(e.group)&&(e.group=n++,i(e)),r[e.group]||(r[e.group]=[]),r[e.group].push(e)}),console.log("Groups built: ",r.length),r},y=function(e,t){e.neighbours=[];for(var r=0,n=t.polygons.length;n>r;r++)if(e!==t.polygons[r]&&!(e.centroid.distanceToSquared(t.polygons[r].centroid)>1e4)){var o=i(e.vertexIds,t.polygons[r].vertexIds);o.length>=2&&e.neighbours.push(t.polygons[r])}},_=function(e){console.log("Vertices:",e.vertices.length,"polygons:",e.faces.length);var t=[],r=e.vertices,n=e.faceVertexUvs;d=new f("Building polygons      [:bar] :percent",l.extend(v,{total:e.faces.length})),l.each(e.faces,function(e){d.tick(),t.push({id:g++,vertexIds:[e.a,e.b,e.c],centroid:e.centroid,normal:e.normal,neighbours:[]})});var i={polygons:t,vertices:r,faceVertexUvs:n};return d=new f("Calculating neighbours [:bar] :percent",l.extend(v,{total:t.length})),l.each(t,function(e){d.tick(),y(e,i)}),i},b=function(e){m(e),e.mergeVertices();var t=_(e);return t},w=function(e,t){var r=e.vertexIds,n=t.vertexIds,i=[];return l.each(r,function(e){l.contains(n,e)&&i.push(e)}),i.length<2?[]:(l.contains(i,r[0])&&l.contains(i,r[r.length-1])&&r.push(r.shift()),l.contains(i,n[0])&&l.contains(i,n[n.length-1])&&n.push(n.shift()),i=[],l.each(r,function(e){l.contains(n,e)&&i.push(e)}),i)},T=function(e){var t={};l.each(e.vertices,function(e){e.x=n(e.x,2),e.y=n(e.y,2),e.z=n(e.z,2)}),t.vertices=e.vertices;var r=x(e);t.groups=[];var i=function(e,t){for(var r=0;r<e.length;r++)if(t===e[r])return r};return d=new f("Grouping               [:bar] :percent",l.extend(v,{total:r.length})),l.each(r,function(e){d.tick();var r=[];l.each(e,function(t){var o=[];l.each(t.neighbours,function(t){o.push(i(e,t))});var a=[];l.each(t.neighbours,function(e){a.push(w(t,e))}),t.centroid.x=n(t.centroid.x,2),t.centroid.y=n(t.centroid.y,2),t.centroid.z=n(t.centroid.z,2),r.push({id:i(e,t),neighbours:o,vertexIds:t.vertexIds,centroid:t.centroid,portals:a})}),t.groups.push(r)}),t};o.prototype={push:function(e){this.content.push(e),this.sinkDown(this.content.length-1)},pop:function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},remove:function(e){var t=this.content.indexOf(e),r=this.content.pop();t!==this.content.length-1&&(this.content[t]=r,this.scoreFunction(r)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},size:function(){return this.content.length},rescoreElement:function(e){this.sinkDown(this.content.indexOf(e))},sinkDown:function(e){for(var t=this.content[e];e>0;){var r=(e+1>>1)-1,n=this.content[r];if(!(this.scoreFunction(t)<this.scoreFunction(n)))break;this.content[r]=t,this.content[e]=n,e=r}},bubbleUp:function(e){for(var t=this.content.length,r=this.content[e],n=this.scoreFunction(r);;){var i=e+1<<1,o=i-1,a=null;if(t>o){var s=this.content[o],u=this.scoreFunction(s);n>u&&(a=o)}if(t>i){var h=this.content[i],c=this.scoreFunction(h);(null===a?n:u)>c&&(a=i)}if(null===a)break;this.content[e]=this.content[a],this.content[a]=r,e=a}}};var M=function(e,t){var r=e.x-t.x,n=e.y-t.y,i=e.z-t.z;return r*r+n*n+i*i},S={init:function(e){for(var t=0;t<e.length;t++){var r=e[t];r.f=0,r.g=0,r.h=0,r.cost=1,r.visited=!1,r.closed=!1,r.parent=null}},cleanUp:function(e){for(var t=0;t<e.length;t++){var r=e[t];delete r.f,delete r.g,delete r.h,delete r.cost,delete r.visited,delete r.closed,delete r.parent}},heap:function(){return new o(function(e){return e.f})},search:function(e,t,r){S.init(e);var n=S.heap();for(n.push(t);n.size()>0;){var i=n.pop();if(i===r){for(var o=i,a=[];o.parent;)a.push(o),o=o.parent;return this.cleanUp(a),a.reverse()}i.closed=!0;for(var s=S.neighbours(e,i),u=0,h=s.length;h>u;u++){var c=s[u];if(!c.closed){var l=i.g+c.cost,p=c.visited;(!p||l<c.g)&&(c.visited=!0,c.parent=i,!c.centroid||!r.centroid,c.h=c.h||S.heuristic(c.centroid,r.centroid),c.g=l,c.f=c.g+c.h,p?n.rescoreElement(c):n.push(c))}}}return[]},heuristic:function(e,t){return M(e,t)},neighbours:function(e,t){for(var r=[],n=0;n<t.neighbours.length;n++)r.push(e[t.neighbours[n]]);return r}},M=function(e,t){var r=e.x-t.x,n=e.y-t.y,i=e.z-t.z;return r*r+n*n+i*i};c.prototype.push=function(e,t){void 0===t&&(t=e),this.portals.push({left:e,right:t})},c.prototype.stringPull=function(){var e,t,r,n=this.portals,i=[],o=0,a=0,s=0;e=n[0].left,t=n[0].left,r=n[0].right,i.push(e);for(var c=1;c<n.length;c++){var l=n[c].left,p=n[c].right;if(u(e,r,p)<=0){if(!(h(e,r)||u(e,t,p)>0)){i.push(t),e=t,o=a,t=e,r=e,a=o,s=o,c=o;continue}r=p,s=c}if(u(e,t,l)>=0){if(!(h(e,t)||u(e,r,l)<0)){i.push(r),e=r,o=s,t=e,r=e,a=o,s=o,c=o;continue}t=l,a=c}}return 0!==i.length&&h(i[i.length-1],n[n.length-1].left)||i.push(n[n.length-1].left),this.path=i,i};var E={};l.extend(r,{buildNodes:function(e){var t=b(e),r=T(t);return r},setZoneData:function(e,t){E[e]=t},getGroup:function(e,t){if(!E[e])return null;var r=null,n=Math.pow(50,2);return l.each(E[e].groups,function(e,i){l.each(e,function(e){var o=M(e.centroid,t);n>o&&(r=i,n=o)})}),r},getRandomNode:function(e,t,r,n){if(!E[e])return new p.Vector3;r=r||null,n=n||0;var i=[],o=E[e].groups[t];return l.each(o,function(e){r&&n?M(r,e.centroid)<n*n&&i.push(e.centroid):i.push(e.centroid)}),l.sample(i)||new p.Vector3},findPath:function(e,t,r,n){var i=E[r].groups[n],o=E[r].vertices,a=null,u=Math.pow(50,2);l.each(i,function(t){var r=M(t.centroid,e);u>r&&(a=t,u=r)},this);var h=null;if(u=Math.pow(50,2),l.each(i,function(e){var r=M(e.centroid,t);u>r&&s(t,e,o)&&(h=e,u=r)},this),!a||!h)return null;var f=S.search(i,a,h),d=function(e,t){for(var r=0;r<e.neighbours.length;r++)if(e.neighbours[r]===t.id)return e.portals[r]},m=new c;m.push(e);for(var g=0;g<f.length;g++){var v=f[g],x=f[g+1];if(x){var y=d(v,x);m.push(o[y[0]],o[y[1]])}}m.push(t),m.stringPull();var _=[];return l.each(m.path,function(e){var t=new p.Vector3(e.x,e.y,e.z);_.push(t)}),_.shift(),_}})}("undefined"==typeof r?this.patrol={}:r)},{"./../../src/progressbar-stub":2,three:"three",underscore:1}],"threejs-geometry-hittest":[function(e,t,r){"use strict";function n(e,t,r,n,i,o,a,s,u,h,c){var l,p;l=s.x*(s.x>0?t:i),p=s.x*(s.x>0?i:t),l+=s.y*(s.y>0?r:o),p+=s.y*(s.y>0?o:r),l+=s.z*(s.z>0?n:a),p+=s.z*(s.z>0?a:n);var f=s.x*u.x+s.y*u.y+s.z*u.z,d=s.x*h.x+s.y*h.y+s.z*h.z,m=s.x*c.x+s.y*c.y+s.z*c.z,g=Math.min(f,d,m),v=Math.max(f,d,m);if(0===e)return l>v||g>p;var x=1/s.length();isFinite(x)&&(y=Math.min(y,(v-l)*x,(p-g)*x))}function i(e,t,r,i,o,a,s,u,h,c,l,p,f){switch(p.subVectors(h,c),u){case 0:p.set(0,-p.z,p.y);break;case 1:p.set(-p.z,0,p.x);break;case 2:p.set(-p.y,p.x,0)}return n(e,t,r,i,o,a,s,p,h,c,l)}function o(e,t){for(var r=e.faces,o=e.vertices,a=t.min.x,s=t.max.x,u=t.min.y,h=t.max.y,c=t.min.z,l=t.max.z,p=[],g=0;g<r.length;++g){var v=r[g],x=o[v.a],_=o[v.b],b=o[v.c],w=Math.min(x.x,_.x,b.x),T=Math.min(x.y,_.y,b.y),M=Math.min(x.z,_.z,b.z),S=Math.max(x.x,_.x,b.x),E=Math.max(x.y,_.y,b.y),C=Math.max(x.z,_.z,b.z);w>s||T>h||M>l||a>S||u>E||c>C||(d.subVectors(_,x),m.subVectors(b,x),f.crossVectors(d,m),n(0,a,u,c,s,h,l,f,x,_,b)||i(0,a,u,c,s,h,l,0,x,_,b,d,m)||i(0,a,u,c,s,h,l,0,x,b,_,d,m)||i(0,a,u,c,s,h,l,0,_,b,x,d,m)||i(0,a,u,c,s,h,l,1,x,_,b,d,m)||i(0,a,u,c,s,h,l,1,x,b,_,d,m)||i(0,a,u,c,s,h,l,1,_,b,x,d,m)||i(0,a,u,c,s,h,l,2,x,_,b,d,m)||i(0,a,u,c,s,h,l,2,x,b,_,d,m)||i(0,a,u,c,s,h,l,2,_,b,x,d,m)||(y=1/0,n(1,a,u,c,s,h,l,f,x,_,b),i(1,a,u,c,s,h,l,0,x,_,b,d,m),i(1,a,u,c,s,h,l,0,x,b,_,d,m),i(1,a,u,c,s,h,l,0,_,b,x,d,m),i(1,a,u,c,s,h,l,1,x,_,b,d,m),i(1,a,u,c,s,h,l,1,x,b,_,d,m),i(1,a,u,c,s,h,l,1,_,b,x,d,m),i(1,a,u,c,s,h,l,2,x,_,b,d,m),i(1,a,u,c,s,h,l,2,x,b,_,d,m),i(1,a,u,c,s,h,l,2,_,b,x,d,m),p.push({faceIndex:g,depth:y})))}return p}function a(e,t){for(var r=e.faces,n=e.vertices,i=t.center,o=i.x,a=i.y,s=i.z,u=t.radius,c=o-u,l=o+u,p=a-u,y=a+u,_=s-u,b=s+u,w=[],T=0;T<r.length;++T){var M=r[T],S=n[M.a],E=n[M.b],C=n[M.c],R=Math.min(S.x,E.x,C.x),D=Math.min(S.y,E.y,C.y),A=Math.min(S.z,E.z,C.z),P=Math.max(S.x,E.x,C.x),L=Math.max(S.y,E.y,C.y),B=Math.max(S.z,E.z,C.z);if(!(R>l||D>y||A>b||c>P||p>L||_>B)&&(d.subVectors(E,S),m.subVectors(C,S),f.crossVectors(d,m),0!=f.x||0!=f.y||0!=f.z)){f.normalize();var F=f.dot(S),G=f.dot(i),U=Math.abs(G-F);if(!(U>u)){d.subVectors(E,S),d.crossVectors(d,f),m.subVectors(i,S);var k=d.dot(m);d.subVectors(C,E),d.crossVectors(d,f),m.subVectors(i,E);var V=d.dot(m);d.subVectors(S,C),d.crossVectors(d,f),m.subVectors(i,C);var I=d.dot(m);if(0>=k&&0>=V&&0>=I)w.push({faceIndex:T,depth:u-U,pos:new h(o-(G-F)*f.x,a-(G-F)*f.y,s-(G-F)*f.z)});else{var O=1/0,z=0;d.subVectors(E,S),m.subVectors(C,E),g.subVectors(S,C);var N,j=d.lengthSq(),H=m.lengthSq(),X=g.lengthSq();if(v.subVectors(i,S),N=v.dot(d),N>=0&&j>=N&&(x.subVectors(i,E),v.crossVectors(v,x),N=v.lengthSq()/j,O>N&&(O=N,z=0)),v.subVectors(i,E),N=v.dot(m),N>=0&&H>=N&&(x.subVectors(i,C),v.crossVectors(v,x),N=v.lengthSq()/H,O>N&&(O=N,z=1)),v.subVectors(i,C),N=v.dot(g),N>=0&&X>=N&&(x.subVectors(i,S),v.crossVectors(v,x),N=v.lengthSq()/X,O>N&&(O=N,z=2)),v.subVectors(i,S),N=v.lengthSq(),O>N&&(O=N,z=3),v.subVectors(i,E),N=v.lengthSq(),O>N&&(O=N,z=4),v.subVectors(i,C),N=v.lengthSq(),O>N&&(O=N,z=5),O>u*u)continue;var W=null;switch(z){case 0:v.subVectors(i,S),W=x.copy(S),W.addScaledVector(d,Math.sqrt(v.dot(d)/j));break;case 1:v.subVectors(i,E),W=x.copy(E),W.addScaledVector(m,Math.sqrt(v.dot(m)/H));break;case 2:v.subVectors(i,C),W=x.copy(C),W.addScaledVector(g,Math.sqrt(v.dot(g)/X));break;case 3:W=S;break;case 4:W=E;break;case 5:W=C}w.push({faceIndex:T,depth:u-Math.sqrt(O),pos:W.clone()})}}}}return w}function s(e,t){throw new Error("specified combination is not supported.")}var u=e("three"),h=u.Vector3,c=u.Box3,l=u.Sphere,p=u.Geometry,f=new u.Vector3,d=new u.Vector3,m=new u.Vector3,g=new u.Vector3,v=new u.Vector3,x=new u.Vector3,y=0,_=r.intersects=function(e,t){return e instanceof p?t instanceof c?o(e,t):t instanceof l?a(e,t):s(e,t):t instanceof p?_(t,e):s(e,t)}},{three:"three"}],three:[function(e,t,r){var n=n||{},i={REVISION:"73"};"function"==typeof define&&define.amd?define("three",i):"undefined"!=typeof r&&"undefined"!=typeof t&&(t.exports=i),(void 0===n.requestAnimationFrame||void 0===n.cancelAnimationFrame)&&!function(){for(var e=0,t=["ms","moz","webkit","o"],r=0;r<t.length&&!n.requestAnimationFrame;++r)n.requestAnimationFrame=n[t[r]+"RequestAnimationFrame"],n.cancelAnimationFrame=n[t[r]+"CancelAnimationFrame"]||n[t[r]+"CancelRequestAnimationFrame"];void 0===n.requestAnimationFrame&&void 0!==n.setTimeout&&(n.requestAnimationFrame=function(t){var r=Date.now(),i=Math.max(0,16-(r-e)),o=n.setTimeout(function(){t(r+i)},i);return e=r+i,o}),void 0===n.cancelAnimationFrame&&void 0!==n.clearTimeout&&(n.cancelAnimationFrame=function(e){n.clearTimeout(e)})}(),void 0===n.performance&&(n.performance={}),void 0===n.performance.now&&!function(){var e=Date.now();n.performance.now=function(){return Date.now()-e}}(),void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(e){return 0>e?-1:e>0?1:+e}),void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),i.MOUSE={LEFT:0,MIDDLE:1,RIGHT:2},i.CullFaceNone=0,i.CullFaceBack=1,i.CullFaceFront=2,i.CullFaceFrontBack=3,i.FrontFaceDirectionCW=0,i.FrontFaceDirectionCCW=1,i.BasicShadowMap=0,i.PCFShadowMap=1,i.PCFSoftShadowMap=2,i.FrontSide=0,i.BackSide=1,i.DoubleSide=2,i.FlatShading=1,i.SmoothShading=2,i.NoColors=0,i.FaceColors=1,i.VertexColors=2,i.NoBlending=0,i.NormalBlending=1,i.AdditiveBlending=2,i.SubtractiveBlending=3,i.MultiplyBlending=4,i.CustomBlending=5,i.AddEquation=100,i.SubtractEquation=101,i.ReverseSubtractEquation=102,i.MinEquation=103,i.MaxEquation=104,i.ZeroFactor=200,i.OneFactor=201,i.SrcColorFactor=202,i.OneMinusSrcColorFactor=203,i.SrcAlphaFactor=204,i.OneMinusSrcAlphaFactor=205,i.DstAlphaFactor=206,i.OneMinusDstAlphaFactor=207,i.DstColorFactor=208,i.OneMinusDstColorFactor=209,i.SrcAlphaSaturateFactor=210,i.NeverDepth=0,i.AlwaysDepth=1,i.LessDepth=2,i.LessEqualDepth=3,i.EqualDepth=4,i.GreaterEqualDepth=5,i.GreaterDepth=6,i.NotEqualDepth=7,i.MultiplyOperation=0,i.MixOperation=1,i.AddOperation=2,i.UVMapping=300,i.CubeReflectionMapping=301,i.CubeRefractionMapping=302,i.EquirectangularReflectionMapping=303,i.EquirectangularRefractionMapping=304,i.SphericalReflectionMapping=305,i.RepeatWrapping=1e3,i.ClampToEdgeWrapping=1001,i.MirroredRepeatWrapping=1002,i.NearestFilter=1003,i.NearestMipMapNearestFilter=1004,i.NearestMipMapLinearFilter=1005,i.LinearFilter=1006,i.LinearMipMapNearestFilter=1007,i.LinearMipMapLinearFilter=1008,i.UnsignedByteType=1009,i.ByteType=1010,i.ShortType=1011,i.UnsignedShortType=1012,i.IntType=1013,i.UnsignedIntType=1014,i.FloatType=1015,i.HalfFloatType=1025,i.UnsignedShort4444Type=1016,i.UnsignedShort5551Type=1017,i.UnsignedShort565Type=1018,i.AlphaFormat=1019,i.RGBFormat=1020,i.RGBAFormat=1021,i.LuminanceFormat=1022,i.LuminanceAlphaFormat=1023,i.RGBEFormat=i.RGBAFormat,i.RGB_S3TC_DXT1_Format=2001,i.RGBA_S3TC_DXT1_Format=2002,i.RGBA_S3TC_DXT3_Format=2003,i.RGBA_S3TC_DXT5_Format=2004,i.RGB_PVRTC_4BPPV1_Format=2100,i.RGB_PVRTC_2BPPV1_Format=2101,i.RGBA_PVRTC_4BPPV1_Format=2102,i.RGBA_PVRTC_2BPPV1_Format=2103,i.LoopOnce=2200,i.LoopRepeat=2201,i.LoopPingPong=2202,i.Projector=function(){console.error("THREE.Projector has been moved to /examples/js/renderers/Projector.js."),this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")}},i.CanvasRenderer=function(){console.error("THREE.CanvasRenderer has been moved to /examples/js/renderers/CanvasRenderer.js"),this.domElement=document.createElement("canvas"),this.clear=function(){},this.render=function(){},this.setClearColor=function(){},this.setSize=function(){}},i.Color=function(e){return 3===arguments.length?this.fromArray(arguments):this.set(e)},i.Color.prototype={constructor:i.Color,r:1,g:1,b:1,set:function(e){return e instanceof i.Color?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,r){return this.r=e,this.g=t,this.b=r,this},setHSL:function(){function e(e,t,r){return 0>r&&(r+=1),r>1&&(r-=1),1/6>r?e+6*(t-e)*r:.5>r?t:2/3>r?e+6*(t-e)*(2/3-r):e}return function(t,r,n){if(t=i.Math.euclideanModulo(t,1),r=i.Math.clamp(r,0,1),n=i.Math.clamp(n,0,1),0===r)this.r=this.g=this.b=n;else{var o=.5>=n?n*(1+r):n+r-n*r,a=2*n-o;this.r=e(a,o,t+1/3),this.g=e(a,o,t),this.b=e(a,o,t-1/3)}return this}}(),setStyle:function(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}var r;if(r=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){var n,o=r[1],a=r[2];switch(o){case"rgb":case"rgba":if(n=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a))return this.r=Math.min(255,parseInt(n[1],10))/255,this.g=Math.min(255,parseInt(n[2],10))/255,this.b=Math.min(255,parseInt(n[3],10))/255,t(n[5]),this;if(n=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a))return this.r=Math.min(100,parseInt(n[1],10))/100,this.g=Math.min(100,parseInt(n[2],10))/100,this.b=Math.min(100,parseInt(n[3],10))/100,t(n[5]),this;break;case"hsl":case"hsla":if(n=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a)){var s=parseFloat(n[1])/360,u=parseInt(n[2],10)/100,h=parseInt(n[3],10)/100;return t(n[5]),this.setHSL(s,u,h)}}}else if(r=/^\#([A-Fa-f0-9]+)$/.exec(e)){var c=r[1],l=c.length;if(3===l)return this.r=parseInt(c.charAt(0)+c.charAt(0),16)/255,this.g=parseInt(c.charAt(1)+c.charAt(1),16)/255,this.b=parseInt(c.charAt(2)+c.charAt(2),16)/255,this;if(6===l)return this.r=parseInt(c.charAt(0)+c.charAt(1),16)/255,this.g=parseInt(c.charAt(2)+c.charAt(3),16)/255,this.b=parseInt(c.charAt(4)+c.charAt(5),16)/255,this}if(e&&e.length>0){var c=i.ColorKeywords[e];void 0!==c?this.setHex(c):console.warn("THREE.Color: Unknown color "+e)}return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var r=t>0?1/t:1;return this.r=Math.pow(e.r,r),this.g=Math.pow(e.g,r),this.b=Math.pow(e.b,r),this},convertGammaToLinear:function(){var e=this.r,t=this.g,r=this.b;return this.r=e*e,this.g=t*t,this.b=r*r,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,r,n=e||{h:0,s:0,l:0},i=this.r,o=this.g,a=this.b,s=Math.max(i,o,a),u=Math.min(i,o,a),h=(u+s)/2;if(u===s)t=0,r=0;else{var c=s-u;switch(r=.5>=h?c/(s+u):c/(2-s-u),s){case i:t=(o-a)/c+(a>o?6:0);break;case o:t=(a-i)/c+2;break;case a:t=(i-o)/c+4}t/=6}return n.h=t,n.s=r,n.l=h,n},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,r){var n=this.getHSL();return n.h+=e,n.s+=t,n.l+=r,this.setHSL(n.h,n.s,n.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}},i.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},i.Quaternion=function(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==n?n:1},i.Quaternion.prototype={constructor:i.Quaternion,get x(){return this._x},set x(e){this._x=e,this.onChangeCallback()},get y(){return this._y},set y(e){this._y=e,this.onChangeCallback()},get z(){return this._z},set z(e){this._z=e,this.onChangeCallback()},get w(){return this._w},set w(e){this._w=e,this.onChangeCallback()},set:function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._w=n,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(e instanceof i.Euler==!1)throw new Error("THREE.Quaternion: .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var r=Math.cos(e._x/2),n=Math.cos(e._y/2),o=Math.cos(e._z/2),a=Math.sin(e._x/2),s=Math.sin(e._y/2),u=Math.sin(e._z/2),h=e.order;return"XYZ"===h?(this._x=a*n*o+r*s*u,this._y=r*s*o-a*n*u,this._z=r*n*u+a*s*o,this._w=r*n*o-a*s*u):"YXZ"===h?(this._x=a*n*o+r*s*u,this._y=r*s*o-a*n*u,this._z=r*n*u-a*s*o,this._w=r*n*o+a*s*u):"ZXY"===h?(this._x=a*n*o-r*s*u,this._y=r*s*o+a*n*u,this._z=r*n*u+a*s*o,this._w=r*n*o-a*s*u):"ZYX"===h?(this._x=a*n*o-r*s*u,this._y=r*s*o+a*n*u,this._z=r*n*u-a*s*o,this._w=r*n*o+a*s*u):"YZX"===h?(this._x=a*n*o+r*s*u,this._y=r*s*o+a*n*u,this._z=r*n*u-a*s*o,this._w=r*n*o-a*s*u):"XZY"===h&&(this._x=a*n*o-r*s*u,this._y=r*s*o-a*n*u,this._z=r*n*u+a*s*o,this._w=r*n*o+a*s*u),t!==!1&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var r=t/2,n=Math.sin(r);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(r),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,r=e.elements,n=r[0],i=r[4],o=r[8],a=r[1],s=r[5],u=r[9],h=r[2],c=r[6],l=r[10],p=n+s+l;return p>0?(t=.5/Math.sqrt(p+1),this._w=.25/t,this._x=(c-u)*t,this._y=(o-h)*t,this._z=(a-i)*t):n>s&&n>l?(t=2*Math.sqrt(1+n-s-l),this._w=(c-u)/t,this._x=.25*t,this._y=(i+a)/t,this._z=(o+h)/t):s>l?(t=2*Math.sqrt(1+s-n-l),this._w=(o-h)/t,this._x=(i+a)/t,this._y=.25*t,this._z=(u+c)/t):(t=2*Math.sqrt(1+l-n-s),this._w=(a-i)/t,this._x=(o+h)/t,this._y=(u+c)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t,r=1e-6;return function(n,o){return void 0===e&&(e=new i.Vector3),t=n.dot(o)+1,r>t?(t=0,Math.abs(n.x)>Math.abs(n.z)?e.set(-n.y,n.x,0):e.set(0,-n.z,n.y)):e.crossVectors(n,o),this._x=e.x,this._y=e.y,this._z=e.z,this._w=t,this.normalize(),this}}(),inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},multiplyQuaternions:function(e,t){var r=e._x,n=e._y,i=e._z,o=e._w,a=t._x,s=t._y,u=t._z,h=t._w;return this._x=r*h+o*a+n*u-i*s,this._y=n*h+o*s+i*a-r*u,this._z=i*h+o*u+r*s-n*a,this._w=o*h-r*a-n*s-i*u,this.onChangeCallback(),this},multiplyVector3:function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,n=this._y,i=this._z,o=this._w,a=o*e._w+r*e._x+n*e._y+i*e._z;if(0>a?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=o,this._x=r,this._y=n,this._z=i,this;var s=Math.acos(a),u=Math.sqrt(1-a*a);if(Math.abs(u)<.001)return this._w=.5*(o+this._w),this._x=.5*(r+this._x),this._y=.5*(n+this._y),this._z=.5*(i+this._z),this;var h=Math.sin((1-t)*s)/u,c=Math.sin(t*s)/u;return this._w=o*h+this._w*c,this._x=r*h+this._x*c,this._y=n*h+this._y*c,this._z=i*h+this._z*c,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}},i.Quaternion.slerp=function(e,t,r,n){return r.copy(e).slerp(t,n)},i.Vector2=function(e,t){this.x=e||0,this.y=t||0},i.Vector2.prototype={constructor:i.Vector2,get width(){return this.x},set width(e){this.x=e},get height(){return this.y},set height(e){this.y=e},set:function(e,t){return this.x=e,this.y=t,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return isFinite(e)?(this.x*=e,this.y*=e):(this.x=0,this.y=0),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(){var e,t;return function(r,n){return void 0===e&&(e=new i.Vector2,t=new i.Vector2),e.set(r,r),t.set(n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,r))/r),this},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e),this},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromAttribute:function(e,t,r){return void 0===r&&(r=0),t=t*e.itemSize+r,this.x=e.array[t],this.y=e.array[t+1],this},rotateAround:function(e,t){var r=Math.cos(t),n=Math.sin(t),i=this.x-e.x,o=this.y-e.y;return this.x=i*r-o*n+e.x,this.y=i*n+o*r+e.y,this}},i.Vector3=function(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0},i.Vector3.prototype={constructor:i.Vector3,set:function(e,t,r){return this.x=e,this.y=t,this.z=r,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,
this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return isFinite(e)?(this.x*=e,this.y*=e,this.z*=e):(this.x=0,this.y=0,this.z=0),this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(){var e;return function(t){return t instanceof i.Euler==!1&&console.error("THREE.Vector3: .applyEuler() now expects a Euler rotation rather than a Vector3 and order."),void 0===e&&(e=new i.Quaternion),this.applyQuaternion(e.setFromEuler(t)),this}}(),applyAxisAngle:function(){var e;return function(t,r){return void 0===e&&(e=new i.Quaternion),this.applyQuaternion(e.setFromAxisAngle(t,r)),this}}(),applyMatrix3:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[3]*r+i[6]*n,this.y=i[1]*t+i[4]*r+i[7]*n,this.z=i[2]*t+i[5]*r+i[8]*n,this},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[4]*r+i[8]*n+i[12],this.y=i[1]*t+i[5]*r+i[9]*n+i[13],this.z=i[2]*t+i[6]*r+i[10]*n+i[14],this},applyProjection:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements,o=1/(i[3]*t+i[7]*r+i[11]*n+i[15]);return this.x=(i[0]*t+i[4]*r+i[8]*n+i[12])*o,this.y=(i[1]*t+i[5]*r+i[9]*n+i[13])*o,this.z=(i[2]*t+i[6]*r+i[10]*n+i[14])*o,this},applyQuaternion:function(e){var t=this.x,r=this.y,n=this.z,i=e.x,o=e.y,a=e.z,s=e.w,u=s*t+o*n-a*r,h=s*r+a*t-i*n,c=s*n+i*r-o*t,l=-i*t-o*r-a*n;return this.x=u*s+l*-i+h*-a-c*-o,this.y=h*s+l*-o+c*-i-u*-a,this.z=c*s+l*-a+u*-o-h*-i,this},project:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.multiplyMatrices(t.projectionMatrix,e.getInverse(t.matrixWorld)),this.applyProjection(e)}}(),unproject:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyProjection(e)}}(),transformDirection:function(e){var t=this.x,r=this.y,n=this.z,i=e.elements;return this.x=i[0]*t+i[4]*r+i[8]*n,this.y=i[1]*t+i[5]*r+i[9]*n,this.z=i[2]*t+i[6]*r+i[10]*n,this.normalize(),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(){var e,t;return function(r,n){return void 0===e&&(e=new i.Vector3,t=new i.Vector3),e.set(r,r,r),t.set(n,n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,r))/r),this},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e),this},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var r=this.x,n=this.y,i=this.z;return this.x=n*e.z-i*e.y,this.y=i*e.x-r*e.z,this.z=r*e.y-n*e.x,this},crossVectors:function(e,t){var r=e.x,n=e.y,i=e.z,o=t.x,a=t.y,s=t.z;return this.x=n*s-i*a,this.y=i*o-r*s,this.z=r*a-n*o,this},projectOnVector:function(){var e,t;return function(r){return void 0===e&&(e=new i.Vector3),e.copy(r).normalize(),t=this.dot(e),this.copy(e).multiplyScalar(t)}}(),projectOnPlane:function(){var e;return function(t){return void 0===e&&(e=new i.Vector3),e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e;return function(t){return void 0===e&&(e=new i.Vector3),this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/(this.length()*e.length());return Math.acos(i.Math.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return t*t+r*r+n*n},setEulerFromRotationMatrix:function(e,t){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(e,t){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,t)},setFromMatrixPosition:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},setFromMatrixScale:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),r=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),n=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=r,this.z=n,this},setFromMatrixColumn:function(e,t){var r=4*e,n=t.elements;return this.x=n[r],this.y=n[r+1],this.z=n[r+2],this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromAttribute:function(e,t,r){return void 0===r&&(r=0),t=t*e.itemSize+r,this.x=e.array[t],this.y=e.array[t+1],this.z=e.array[t+2],this}},i.Vector4=function(e,t,r,n){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==n?n:1},i.Vector4.prototype={constructor:i.Vector4,set:function(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return isFinite(e)?(this.x*=e,this.y*=e,this.z*=e,this.w*=e):(this.x=0,this.y=0,this.z=0,this.w=0),this},applyMatrix4:function(e){var t=this.x,r=this.y,n=this.z,i=this.w,o=e.elements;return this.x=o[0]*t+o[4]*r+o[8]*n+o[12]*i,this.y=o[1]*t+o[5]*r+o[9]*n+o[13]*i,this.z=o[2]*t+o[6]*r+o[10]*n+o[14]*i,this.w=o[3]*t+o[7]*r+o[11]*n+o[15]*i,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return 1e-4>t?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,r,n,i,o=.01,a=.1,s=e.elements,u=s[0],h=s[4],c=s[8],l=s[1],p=s[5],f=s[9],d=s[2],m=s[6],g=s[10];if(Math.abs(h-l)<o&&Math.abs(c-d)<o&&Math.abs(f-m)<o){if(Math.abs(h+l)<a&&Math.abs(c+d)<a&&Math.abs(f+m)<a&&Math.abs(u+p+g-3)<a)return this.set(1,0,0,0),this;t=Math.PI;var v=(u+1)/2,x=(p+1)/2,y=(g+1)/2,_=(h+l)/4,b=(c+d)/4,w=(f+m)/4;return v>x&&v>y?o>v?(r=0,n=.707106781,i=.707106781):(r=Math.sqrt(v),n=_/r,i=b/r):x>y?o>x?(r=.707106781,n=0,i=.707106781):(n=Math.sqrt(x),r=_/n,i=w/n):o>y?(r=.707106781,n=.707106781,i=0):(i=Math.sqrt(y),r=b/i,n=w/i),this.set(r,n,i,t),this}var T=Math.sqrt((m-f)*(m-f)+(c-d)*(c-d)+(l-h)*(l-h));return Math.abs(T)<.001&&(T=1),this.x=(m-f)/T,this.y=(c-d)/T,this.z=(l-h)/T,this.w=Math.acos((u+p+g-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e,t;return function(r,n){return void 0===e&&(e=new i.Vector4,t=new i.Vector4),e.set(r,r,r,r),t.set(n,n,n,n),this.clamp(e,t)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e),this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromAttribute:function(e,t,r){return void 0===r&&(r=0),t=t*e.itemSize+r,this.x=e.array[t],this.y=e.array[t+1],this.z=e.array[t+2],this.w=e.array[t+3],this}},i.Euler=function(e,t,r,n){this._x=e||0,this._y=t||0,this._z=r||0,this._order=n||i.Euler.DefaultOrder},i.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],i.Euler.DefaultOrder="XYZ",i.Euler.prototype={constructor:i.Euler,get x(){return this._x},set x(e){this._x=e,this.onChangeCallback()},get y(){return this._y},set y(e){this._y=e,this.onChangeCallback()},get z(){return this._z},set z(e){this._z=e,this.onChangeCallback()},get order(){return this._order},set order(e){this._order=e,this.onChangeCallback()},set:function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._order=n||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,r){var n=i.Math.clamp,o=e.elements,a=o[0],s=o[4],u=o[8],h=o[1],c=o[5],l=o[9],p=o[2],f=o[6],d=o[10];return t=t||this._order,"XYZ"===t?(this._y=Math.asin(n(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-s,a)):(this._x=Math.atan2(f,c),this._z=0)):"YXZ"===t?(this._x=Math.asin(-n(l,-1,1)),Math.abs(l)<.99999?(this._y=Math.atan2(u,d),this._z=Math.atan2(h,c)):(this._y=Math.atan2(-p,a),this._z=0)):"ZXY"===t?(this._x=Math.asin(n(f,-1,1)),Math.abs(f)<.99999?(this._y=Math.atan2(-p,d),this._z=Math.atan2(-s,c)):(this._y=0,this._z=Math.atan2(h,a))):"ZYX"===t?(this._y=Math.asin(-n(p,-1,1)),Math.abs(p)<.99999?(this._x=Math.atan2(f,d),this._z=Math.atan2(h,a)):(this._x=0,this._z=Math.atan2(-s,c))):"YZX"===t?(this._z=Math.asin(n(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(-l,c),this._y=Math.atan2(-p,a)):(this._x=0,this._y=Math.atan2(u,d))):"XZY"===t?(this._z=Math.asin(-n(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(f,c),this._y=Math.atan2(u,a)):(this._x=Math.atan2(-l,d),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,r!==!1&&this.onChangeCallback(),this},setFromQuaternion:function(){var e;return function(t,r,n){return void 0===e&&(e=new i.Matrix4),e.makeRotationFromQuaternion(t),this.setFromRotationMatrix(e,r,n),this}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:function(){var e=new i.Quaternion;return function(t){e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new i.Vector3(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}},i.Line3=function(e,t){this.start=void 0!==e?e:new i.Vector3,this.end=void 0!==t?t:new i.Vector3},i.Line3.prototype={constructor:i.Line3,set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},center:function(e){var t=e||new i.Vector3;return t.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){var t=e||new i.Vector3;return t.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var r=t||new i.Vector3;return this.delta(r).multiplyScalar(e).add(this.start)},closestPointToPointParameter:function(){var e=new i.Vector3,t=new i.Vector3;return function(r,n){e.subVectors(r,this.start),t.subVectors(this.end,this.start);var o=t.dot(t),a=t.dot(e),s=a/o;return n&&(s=i.Math.clamp(s,0,1)),s}}(),closestPointToPoint:function(e,t,r){var n=this.closestPointToPointParameter(e,t),o=r||new i.Vector3;return this.delta(o).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}},i.Box2=function(e,t){this.min=void 0!==e?e:new i.Vector2(1/0,1/0),this.max=void 0!==t?t:new i.Vector2(-(1/0),-(1/0))},i.Box2.prototype={constructor:i.Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;r>t;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new i.Vector2;return function(t,r){var n=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-(1/0),this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},center:function(e){var t=e||new i.Vector2;return t.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(e){var t=e||new i.Vector2;return t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y?!0:!1},getParameter:function(e,t){var r=t||new i.Vector2;return r.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y?!1:!0},clampPoint:function(e,t){var r=t||new i.Vector2;return r.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new i.Vector2;return function(t){var r=e.copy(t).clamp(this.min,this.max);return r.sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}},i.Box3=function(e,t){this.min=void 0!==e?e:new i.Vector3(1/0,1/0,1/0),this.max=void 0!==t?t:new i.Vector3(-(1/0),-(1/0),-(1/0))},i.Box3.prototype={constructor:i.Box3,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;r>t;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new i.Vector3;return function(t,r){var n=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),setFromObject:function(){var e=new i.Vector3;return function(t){var r=this;return t.updateMatrixWorld(!0),this.makeEmpty(),t.traverse(function(t){var n=t.geometry;if(void 0!==n)if(n instanceof i.Geometry)for(var o=n.vertices,a=0,s=o.length;s>a;a++)e.copy(o[a]),e.applyMatrix4(t.matrixWorld),r.expandByPoint(e);else if(n instanceof i.BufferGeometry&&void 0!==n.attributes.position)for(var u=n.attributes.position.array,a=0,s=u.length;s>a;a+=3)e.set(u[a],u[a+1],u[a+2]),e.applyMatrix4(t.matrixWorld),r.expandByPoint(e)}),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-(1/0),this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(e){var t=e||new i.Vector3;return t.addVectors(this.min,this.max).multiplyScalar(.5)},size:function(e){var t=e||new i.Vector3;return t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z?!1:!0},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z?!0:!1},getParameter:function(e,t){var r=t||new i.Vector3;return r.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(e){return e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z?!1:!0},clampPoint:function(e,t){var r=t||new i.Vector3;return r.copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new i.Vector3;return function(t){var r=e.copy(t).clamp(this.min,this.max);return r.sub(t).length()}}(),getBoundingSphere:function(){var e=new i.Vector3;return function(t){var r=t||new i.Sphere;return r.center=this.center(),r.radius=.5*this.size(e).length(),r}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var e=[new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3];return function(t){return e[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),e[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),e[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),e[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),e[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),e[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),e[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),e[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.makeEmpty(),this.setFromPoints(e),this}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}},i.Matrix3=function(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1]),arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")},i.Matrix3.prototype={constructor:i.Matrix3,set:function(e,t,r,n,i,o,a,s,u){var h=this.elements;return h[0]=e,h[3]=t,h[6]=r,h[1]=n,h[4]=i,h[7]=o,h[2]=a,h[5]=s,h[8]=u,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this},multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix3: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},applyToVector3Array:function(){var e;return function(t,r,n){void 0===e&&(e=new i.Vector3),void 0===r&&(r=0),void 0===n&&(n=t.length);for(var o=0,a=r;n>o;o+=3,a+=3)e.fromArray(t,a),e.applyMatrix3(this),e.toArray(t,a);return t}}(),applyToBuffer:function(){var e;return function(t,r,n){void 0===e&&(e=new i.Vector3),void 0===r&&(r=0),void 0===n&&(n=t.length/t.itemSize);for(var o=0,a=r;n>o;o++,a++)e.x=t.getX(a),e.y=t.getY(a),e.z=t.getZ(a),e.applyMatrix3(this),t.setXYZ(e.x,e.y,e.z);return t}}(),multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],o=e[4],a=e[5],s=e[6],u=e[7],h=e[8];return t*o*h-t*a*u-r*i*h+r*a*s+n*i*u-n*o*s},getInverse:function(e,t){var r=e.elements,n=this.elements;n[0]=r[10]*r[5]-r[6]*r[9],n[1]=-r[10]*r[1]+r[2]*r[9],n[2]=r[6]*r[1]-r[2]*r[5],n[3]=-r[10]*r[4]+r[6]*r[8],n[4]=r[10]*r[0]-r[2]*r[8],n[5]=-r[6]*r[0]+r[2]*r[4],n[6]=r[9]*r[4]-r[5]*r[8],n[7]=-r[9]*r[0]+r[1]*r[8],n[8]=r[5]*r[0]-r[1]*r[4];var i=r[0]*n[0]+r[1]*n[3]+r[2]*n[6];if(0===i){var o="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(o);return console.warn(o),this.identity(),this}return this.multiplyScalar(1/i),this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},flattenToArrayOffset:function(e,t){var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e},getNormalMatrix:function(e){return this.getInverse(e).transpose(),this},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},fromArray:function(e){return this.elements.set(e),this},toArray:function(){var e=this.elements;return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]}},i.Matrix4=function(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")},i.Matrix4.prototype={constructor:i.Matrix4,set:function(e,t,r,n,i,o,a,s,u,h,c,l,p,f,d,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=r,g[12]=n,g[1]=i,g[5]=o,g[9]=a,g[13]=s,g[2]=u,g[6]=h,g[10]=c,g[14]=l,g[3]=p,g[7]=f,g[11]=d,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new i.Matrix4).fromArray(this.elements)},copy:function(e){return this.elements.set(e.elements),this},extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},copyPosition:function(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this},extractBasis:function(e,t,r){var n=this.elements;return e.set(n[0],n[1],n[2]),t.set(n[4],n[5],n[6]),r.set(n[8],n[9],n[10]),this},makeBasis:function(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this},extractRotation:function(){var e;return function(t){void 0===e&&(e=new i.Vector3);var r=this.elements,n=t.elements,o=1/e.set(n[0],n[1],n[2]).length(),a=1/e.set(n[4],n[5],n[6]).length(),s=1/e.set(n[8],n[9],n[10]).length();return r[0]=n[0]*o,r[1]=n[1]*o,r[2]=n[2]*o,r[4]=n[4]*a,r[5]=n[5]*a,r[6]=n[6]*a,r[8]=n[8]*s,r[9]=n[9]*s,r[10]=n[10]*s,this}}(),makeRotationFromEuler:function(e){e instanceof i.Euler==!1&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,n=e.y,o=e.z,a=Math.cos(r),s=Math.sin(r),u=Math.cos(n),h=Math.sin(n),c=Math.cos(o),l=Math.sin(o);if("XYZ"===e.order){var p=a*c,f=a*l,d=s*c,m=s*l;t[0]=u*c,t[4]=-u*l,t[8]=h,t[1]=f+d*h,t[5]=p-m*h,t[9]=-s*u,t[2]=m-p*h,t[6]=d+f*h,t[10]=a*u}else if("YXZ"===e.order){var g=u*c,v=u*l,x=h*c,y=h*l;t[0]=g+y*s,t[4]=x*s-v,t[8]=a*h,t[1]=a*l,t[5]=a*c,t[9]=-s,t[2]=v*s-x,t[6]=y+g*s,t[10]=a*u}else if("ZXY"===e.order){var g=u*c,v=u*l,x=h*c,y=h*l;t[0]=g-y*s,t[4]=-a*l,t[8]=x+v*s,t[1]=v+x*s,t[5]=a*c,t[9]=y-g*s,t[2]=-a*h,t[6]=s,t[10]=a*u}else if("ZYX"===e.order){var p=a*c,f=a*l,d=s*c,m=s*l;t[0]=u*c,t[4]=d*h-f,t[8]=p*h+m,t[1]=u*l,t[5]=m*h+p,t[9]=f*h-d,t[2]=-h,t[6]=s*u,t[10]=a*u}else if("YZX"===e.order){var _=a*u,b=a*h,w=s*u,T=s*h;t[0]=u*c,t[4]=T-_*l,t[8]=w*l+b,t[1]=l,t[5]=a*c,t[9]=-s*c,t[2]=-h*c,t[6]=b*l+w,t[10]=_-T*l}else if("XZY"===e.order){var _=a*u,b=a*h,w=s*u,T=s*h;t[0]=u*c,t[4]=-l,t[8]=h*c,t[1]=_*l+T,t[5]=a*c,t[9]=b*l-w,t[2]=w*l-b,t[6]=s*c,t[10]=T*l+_}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},makeRotationFromQuaternion:function(e){var t=this.elements,r=e.x,n=e.y,i=e.z,o=e.w,a=r+r,s=n+n,u=i+i,h=r*a,c=r*s,l=r*u,p=n*s,f=n*u,d=i*u,m=o*a,g=o*s,v=o*u;return t[0]=1-(p+d),t[4]=c-v,t[8]=l+g,t[1]=c+v,t[5]=1-(h+d),t[9]=f-m,t[2]=l-g,t[6]=f+m,t[10]=1-(h+p),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var e,t,r;return function(n,o,a){void 0===e&&(e=new i.Vector3),void 0===t&&(t=new i.Vector3),void 0===r&&(r=new i.Vector3);var s=this.elements;return r.subVectors(n,o).normalize(),0===r.lengthSq()&&(r.z=1),e.crossVectors(a,r).normalize(),0===e.lengthSq()&&(r.x+=1e-4,e.crossVectors(a,r).normalize()),t.crossVectors(r,e),s[0]=e.x,s[4]=t.x,s[8]=r.x,s[1]=e.y,s[5]=t.y,s[9]=r.y,s[2]=e.z,s[6]=t.z,s[10]=r.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},multiplyMatrices:function(e,t){var r=e.elements,n=t.elements,i=this.elements,o=r[0],a=r[4],s=r[8],u=r[12],h=r[1],c=r[5],l=r[9],p=r[13],f=r[2],d=r[6],m=r[10],g=r[14],v=r[3],x=r[7],y=r[11],_=r[15],b=n[0],w=n[4],T=n[8],M=n[12],S=n[1],E=n[5],C=n[9],R=n[13],D=n[2],A=n[6],P=n[10],L=n[14],B=n[3],F=n[7],G=n[11],U=n[15];return i[0]=o*b+a*S+s*D+u*B,i[4]=o*w+a*E+s*A+u*F,i[8]=o*T+a*C+s*P+u*G,i[12]=o*M+a*R+s*L+u*U,i[1]=h*b+c*S+l*D+p*B,i[5]=h*w+c*E+l*A+p*F,i[9]=h*T+c*C+l*P+p*G,i[13]=h*M+c*R+l*L+p*U,i[2]=f*b+d*S+m*D+g*B,i[6]=f*w+d*E+m*A+g*F,i[10]=f*T+d*C+m*P+g*G,i[14]=f*M+d*R+m*L+g*U,i[3]=v*b+x*S+y*D+_*B,i[7]=v*w+x*E+y*A+_*F,i[11]=v*T+x*C+y*P+_*G,i[15]=v*M+x*R+y*L+_*U,this},multiplyToArray:function(e,t,r){var n=this.elements;return this.multiplyMatrices(e,t),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),e.applyProjection(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},applyToVector3Array:function(){var e;return function(t,r,n){void 0===e&&(e=new i.Vector3),void 0===r&&(r=0),void 0===n&&(n=t.length);for(var o=0,a=r;n>o;o+=3,a+=3)e.fromArray(t,a),e.applyMatrix4(this),e.toArray(t,a);return t}}(),applyToBuffer:function(){var e;return function(t,r,n){
void 0===e&&(e=new i.Vector3),void 0===r&&(r=0),void 0===n&&(n=t.length/t.itemSize);for(var o=0,a=r;n>o;o++,a++)e.x=t.getX(a),e.y=t.getY(a),e.z=t.getZ(a),e.applyMatrix4(this),t.setXYZ(e.x,e.y,e.z);return t}}(),rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},determinant:function(){var e=this.elements,t=e[0],r=e[4],n=e[8],i=e[12],o=e[1],a=e[5],s=e[9],u=e[13],h=e[2],c=e[6],l=e[10],p=e[14],f=e[3],d=e[7],m=e[11],g=e[15];return f*(+i*s*c-n*u*c-i*a*l+r*u*l+n*a*p-r*s*p)+d*(+t*s*p-t*u*l+i*o*l-n*o*p+n*u*h-i*s*h)+m*(+t*u*c-t*a*p-i*o*c+r*o*p+i*a*h-r*u*h)+g*(-n*a*h-t*s*c+t*a*l+n*o*c-r*o*l+r*s*h)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArrayOffset:function(e,t){var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e},getPosition:function(){var e;return function(){void 0===e&&(e=new i.Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead.");var t=this.elements;return e.set(t[12],t[13],t[14])}}(),setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var r=this.elements,n=e.elements,i=n[0],o=n[4],a=n[8],s=n[12],u=n[1],h=n[5],c=n[9],l=n[13],p=n[2],f=n[6],d=n[10],m=n[14],g=n[3],v=n[7],x=n[11],y=n[15];r[0]=c*m*v-l*d*v+l*f*x-h*m*x-c*f*y+h*d*y,r[4]=s*d*v-a*m*v-s*f*x+o*m*x+a*f*y-o*d*y,r[8]=a*l*v-s*c*v+s*h*x-o*l*x-a*h*y+o*c*y,r[12]=s*c*f-a*l*f-s*h*d+o*l*d+a*h*m-o*c*m,r[1]=l*d*g-c*m*g-l*p*x+u*m*x+c*p*y-u*d*y,r[5]=a*m*g-s*d*g+s*p*x-i*m*x-a*p*y+i*d*y,r[9]=s*c*g-a*l*g-s*u*x+i*l*x+a*u*y-i*c*y,r[13]=a*l*p-s*c*p+s*u*d-i*l*d-a*u*m+i*c*m,r[2]=h*m*g-l*f*g+l*p*v-u*m*v-h*p*y+u*f*y,r[6]=s*f*g-o*m*g-s*p*v+i*m*v+o*p*y-i*f*y,r[10]=o*l*g-s*h*g+s*u*v-i*l*v-o*u*y+i*h*y,r[14]=s*h*p-o*l*p-s*u*f+i*l*f+o*u*m-i*h*m,r[3]=c*f*g-h*d*g-c*p*v+u*d*v+h*p*x-u*f*x,r[7]=o*d*g-a*f*g+a*p*v-i*d*v-o*p*x+i*f*x,r[11]=a*h*g-o*c*g-a*u*v+i*c*v+o*u*x-i*h*x,r[15]=o*c*p-a*h*p+a*u*f-i*c*f-o*u*d+i*h*d;var _=i*r[0]+u*r[4]+p*r[8]+g*r[12];if(0===_){var b="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(b);return console.warn(b),this.identity(),this}return this.multiplyScalar(1/_),this},translate:function(e){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(e){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(e){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(e){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(e,t){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},scale:function(e){var t=this.elements,r=e.x,n=e.y,i=e.z;return t[0]*=r,t[4]*=n,t[8]*=i,t[1]*=r,t[5]*=n,t[9]*=i,t[2]*=r,t[6]*=n,t[10]*=i,t[3]*=r,t[7]*=n,t[11]*=i,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,n))},makeTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var r=Math.cos(t),n=Math.sin(t),i=1-r,o=e.x,a=e.y,s=e.z,u=i*o,h=i*a;return this.set(u*o+r,u*a-n*s,u*s+n*a,0,u*a+n*s,h*a+r,h*s-n*o,0,u*s-n*a,h*s+n*o,i*s*s+r,0,0,0,0,1),this},makeScale:function(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this},compose:function(e,t,r){return this.makeRotationFromQuaternion(t),this.scale(r),this.setPosition(e),this},decompose:function(){var e,t;return function(r,n,o){void 0===e&&(e=new i.Vector3),void 0===t&&(t=new i.Matrix4);var a=this.elements,s=e.set(a[0],a[1],a[2]).length(),u=e.set(a[4],a[5],a[6]).length(),h=e.set(a[8],a[9],a[10]).length(),c=this.determinant();0>c&&(s=-s),r.x=a[12],r.y=a[13],r.z=a[14],t.elements.set(this.elements);var l=1/s,p=1/u,f=1/h;return t.elements[0]*=l,t.elements[1]*=l,t.elements[2]*=l,t.elements[4]*=p,t.elements[5]*=p,t.elements[6]*=p,t.elements[8]*=f,t.elements[9]*=f,t.elements[10]*=f,n.setFromRotationMatrix(t),o.x=s,o.y=u,o.z=h,this}}(),makeFrustum:function(e,t,r,n,i,o){var a=this.elements,s=2*i/(t-e),u=2*i/(n-r),h=(t+e)/(t-e),c=(n+r)/(n-r),l=-(o+i)/(o-i),p=-2*o*i/(o-i);return a[0]=s,a[4]=0,a[8]=h,a[12]=0,a[1]=0,a[5]=u,a[9]=c,a[13]=0,a[2]=0,a[6]=0,a[10]=l,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makePerspective:function(e,t,r,n){var o=r*Math.tan(i.Math.degToRad(.5*e)),a=-o,s=a*t,u=o*t;return this.makeFrustum(s,u,a,o,r,n)},makeOrthographic:function(e,t,r,n,i,o){var a=this.elements,s=t-e,u=r-n,h=o-i,c=(t+e)/s,l=(r+n)/u,p=(o+i)/h;return a[0]=2/s,a[4]=0,a[8]=0,a[12]=-c,a[1]=0,a[5]=2/u,a[9]=0,a[13]=-l,a[2]=0,a[6]=0,a[10]=-2/h,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},equals:function(e){for(var t=this.elements,r=e.elements,n=0;16>n;n++)if(t[n]!==r[n])return!1;return!0},fromArray:function(e){return this.elements.set(e),this},toArray:function(){var e=this.elements;return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]}},i.Ray=function(e,t){this.origin=void 0!==e?e:new i.Vector3,this.direction=void 0!==t?t:new i.Vector3},i.Ray.prototype={constructor:i.Ray,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){var r=t||new i.Vector3;return r.copy(this.direction).multiplyScalar(e).add(this.origin)},recast:function(){var e=new i.Vector3;return function(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){var r=t||new i.Vector3;r.subVectors(e,this.origin);var n=r.dot(this.direction);return 0>n?r.copy(this.origin):r.copy(this.direction).multiplyScalar(n).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new i.Vector3;return function(t){var r=e.subVectors(t,this.origin).dot(this.direction);return 0>r?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(r).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:function(){var e=new i.Vector3,t=new i.Vector3,r=new i.Vector3;return function(n,i,o,a){e.copy(n).add(i).multiplyScalar(.5),t.copy(i).sub(n).normalize(),r.copy(this.origin).sub(e);var s,u,h,c,l=.5*n.distanceTo(i),p=-this.direction.dot(t),f=r.dot(this.direction),d=-r.dot(t),m=r.lengthSq(),g=Math.abs(1-p*p);if(g>0)if(s=p*d-f,u=p*f-d,c=l*g,s>=0)if(u>=-c)if(c>=u){var v=1/g;s*=v,u*=v,h=s*(s+p*u+2*f)+u*(p*s+u+2*d)+m}else u=l,s=Math.max(0,-(p*u+f)),h=-s*s+u*(u+2*d)+m;else u=-l,s=Math.max(0,-(p*u+f)),h=-s*s+u*(u+2*d)+m;else-c>=u?(s=Math.max(0,-(-p*l+f)),u=s>0?-l:Math.min(Math.max(-l,-d),l),h=-s*s+u*(u+2*d)+m):c>=u?(s=0,u=Math.min(Math.max(-l,-d),l),h=u*(u+2*d)+m):(s=Math.max(0,-(p*l+f)),u=s>0?l:Math.min(Math.max(-l,-d),l),h=-s*s+u*(u+2*d)+m);else u=p>0?-l:l,s=Math.max(0,-(p*u+f)),h=-s*s+u*(u+2*d)+m;return o&&o.copy(this.direction).multiplyScalar(s).add(this.origin),a&&a.copy(t).multiplyScalar(u).add(e),h}}(),isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},intersectSphere:function(){var e=new i.Vector3;return function(t,r){e.subVectors(t.center,this.origin);var n=e.dot(this.direction),i=e.dot(e)-n*n,o=t.radius*t.radius;if(i>o)return null;var a=Math.sqrt(o-i),s=n-a,u=n+a;return 0>s&&0>u?null:0>s?this.at(u,r):this.at(s,r)}}(),isIntersectionPlane:function(e){var t=e.distanceToPoint(this.origin);if(0===t)return!0;var r=e.normal.dot(this.direction);return 0>r*t?!0:!1},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var r=-(this.origin.dot(e.normal)+e.constant)/t;return r>=0?r:null},intersectPlane:function(e,t){var r=this.distanceToPlane(e);return null===r?null:this.at(r,t)},isIntersectionBox:function(){var e=new i.Vector3;return function(t){return null!==this.intersectBox(t,e)}}(),intersectBox:function(e,t){var r,n,i,o,a,s,u=1/this.direction.x,h=1/this.direction.y,c=1/this.direction.z,l=this.origin;return u>=0?(r=(e.min.x-l.x)*u,n=(e.max.x-l.x)*u):(r=(e.max.x-l.x)*u,n=(e.min.x-l.x)*u),h>=0?(i=(e.min.y-l.y)*h,o=(e.max.y-l.y)*h):(i=(e.max.y-l.y)*h,o=(e.min.y-l.y)*h),r>o||i>n?null:((i>r||r!==r)&&(r=i),(n>o||n!==n)&&(n=o),c>=0?(a=(e.min.z-l.z)*c,s=(e.max.z-l.z)*c):(a=(e.max.z-l.z)*c,s=(e.min.z-l.z)*c),r>s||a>n?null:((a>r||r!==r)&&(r=a),(n>s||n!==n)&&(n=s),0>n?null:this.at(r>=0?r:n,t)))},intersectTriangle:function(){var e=new i.Vector3,t=new i.Vector3,r=new i.Vector3,n=new i.Vector3;return function(i,o,a,s,u){t.subVectors(o,i),r.subVectors(a,i),n.crossVectors(t,r);var h,c=this.direction.dot(n);if(c>0){if(s)return null;h=1}else{if(!(0>c))return null;h=-1,c=-c}e.subVectors(this.origin,i);var l=h*this.direction.dot(r.crossVectors(e,r));if(0>l)return null;var p=h*this.direction.dot(t.cross(e));if(0>p)return null;if(l+p>c)return null;var f=-h*e.dot(n);return 0>f?null:this.at(f/c,u)}}(),applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}},i.Sphere=function(e,t){this.center=void 0!==e?e:new i.Vector3,this.radius=void 0!==t?t:0},i.Sphere.prototype={constructor:i.Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(){var e=new i.Box3;return function(t,r){var n=this.center;void 0!==r?n.copy(r):e.setFromPoints(t).center(n);for(var i=0,o=0,a=t.length;a>o;o++)i=Math.max(i,n.distanceToSquared(t[o]));return this.radius=Math.sqrt(i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},clampPoint:function(e,t){var r=this.center.distanceToSquared(e),n=t||new i.Vector3;return n.copy(e),r>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n},getBoundingBox:function(e){var t=e||new i.Box3;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}},i.Frustum=function(e,t,r,n,o,a){this.planes=[void 0!==e?e:new i.Plane,void 0!==t?t:new i.Plane,void 0!==r?r:new i.Plane,void 0!==n?n:new i.Plane,void 0!==o?o:new i.Plane,void 0!==a?a:new i.Plane]},i.Frustum.prototype={constructor:i.Frustum,set:function(e,t,r,n,i,o){var a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(r),a[3].copy(n),a[4].copy(i),a[5].copy(o),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,r=0;6>r;r++)t[r].copy(e.planes[r]);return this},setFromMatrix:function(e){var t=this.planes,r=e.elements,n=r[0],i=r[1],o=r[2],a=r[3],s=r[4],u=r[5],h=r[6],c=r[7],l=r[8],p=r[9],f=r[10],d=r[11],m=r[12],g=r[13],v=r[14],x=r[15];return t[0].setComponents(a-n,c-s,d-l,x-m).normalize(),t[1].setComponents(a+n,c+s,d+l,x+m).normalize(),t[2].setComponents(a+i,c+u,d+p,x+g).normalize(),t[3].setComponents(a-i,c-u,d-p,x-g).normalize(),t[4].setComponents(a-o,c-h,d-f,x-v).normalize(),t[5].setComponents(a+o,c+h,d+f,x+v).normalize(),this},intersectsObject:function(){var e=new i.Sphere;return function(t){var r=t.geometry;return null===r.boundingSphere&&r.computeBoundingSphere(),e.copy(r.boundingSphere),e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,r=e.center,n=-e.radius,i=0;6>i;i++){var o=t[i].distanceToPoint(r);if(n>o)return!1}return!0},intersectsBox:function(){var e=new i.Vector3,t=new i.Vector3;return function(r){for(var n=this.planes,i=0;6>i;i++){var o=n[i];e.x=o.normal.x>0?r.min.x:r.max.x,t.x=o.normal.x>0?r.max.x:r.min.x,e.y=o.normal.y>0?r.min.y:r.max.y,t.y=o.normal.y>0?r.max.y:r.min.y,e.z=o.normal.z>0?r.min.z:r.max.z,t.z=o.normal.z>0?r.max.z:r.min.z;var a=o.distanceToPoint(e),s=o.distanceToPoint(t);if(0>a&&0>s)return!1}return!0}}(),containsPoint:function(e){for(var t=this.planes,r=0;6>r;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0}},i.Plane=function(e,t){this.normal=void 0!==e?e:new i.Vector3(1,0,0),this.constant=void 0!==t?t:0},i.Plane.prototype={constructor:i.Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,r,n){return this.normal.set(e,t,r),this.constant=n,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new i.Vector3,t=new i.Vector3;return function(r,n,i){var o=e.subVectors(i,n).cross(t.subVectors(r,n)).normalize();return this.setFromNormalAndCoplanarPoint(o,r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(e,t){var r=this.distanceToPoint(e),n=t||new i.Vector3;return n.copy(this.normal).multiplyScalar(r)},isIntersectionLine:function(e){var t=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return 0>t&&r>0||0>r&&t>0},intersectLine:function(){var e=new i.Vector3;return function(t,r){var n=r||new i.Vector3,o=t.delta(e),a=this.normal.dot(o);if(0!==a){var s=-(t.start.dot(this.normal)+this.constant)/a;if(!(0>s||s>1))return n.copy(o).multiplyScalar(s).add(t.start)}else if(0===this.distanceToPoint(t.start))return n.copy(t.start)}}(),coplanarPoint:function(e){var t=e||new i.Vector3;return t.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new i.Vector3,t=new i.Vector3,r=new i.Matrix3;return function(n,i){var o=i||r.getNormalMatrix(n),a=e.copy(this.normal).applyMatrix3(o),s=this.coplanarPoint(t);return s.applyMatrix4(n),this.setFromNormalAndCoplanarPoint(a,s),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}},i.Math={generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=new Array(36),n=0;return function(){for(var i=0;36>i;i++)8===i||13===i||18===i||23===i?r[i]="-":14===i?r[i]="4":(2>=n&&(n=33554432+16777216*Math.random()|0),e=15&n,n>>=4,r[i]=t[19===i?3&e|8:e]);return r.join("")}}(),clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,n,i){return n+(e-t)*(i-n)/(r-t)},smoothstep:function(e,t,r){return t>=e?0:e>=r?1:(e=(e-t)/(r-t),e*e*(3-2*e))},smootherstep:function(e,t,r){return t>=e?0:e>=r?1:(e=(e-t)/(r-t),e*e*e*(e*(6*e-15)+10))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(){var e=Math.PI/180;return function(t){return t*e}}(),radToDeg:function(){var e=180/Math.PI;return function(t){return t*e}}(),isPowerOfTwo:function(e){return 0===(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}},i.Spline=function(e){function t(e,t,r,n,i,o,a){var s=.5*(r-e),u=.5*(n-t);return(2*(t-r)+s+u)*a+(-3*(t-r)-2*s-u)*o+s*i+t}this.points=e;var r,n,o,a,s,u,h,c,l,p=[],f={x:0,y:0,z:0};this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return r=(this.points.length-1)*e,n=Math.floor(r),o=r-n,p[0]=0===n?n:n-1,p[1]=n,p[2]=n>this.points.length-2?this.points.length-1:n+1,p[3]=n>this.points.length-3?this.points.length-1:n+2,u=this.points[p[0]],h=this.points[p[1]],c=this.points[p[2]],l=this.points[p[3]],a=o*o,s=o*a,f.x=t(u.x,h.x,c.x,l.x,o,a,s),f.y=t(u.y,h.y,c.y,l.y,o,a,s),f.z=t(u.z,h.z,c.z,l.z,o,a,s),f},this.getControlPointsArray=function(){var e,t,r=this.points.length,n=[];for(e=0;r>e;e++)t=this.points[e],n[e]=[t.x,t.y,t.z];return n},this.getLength=function(e){var t,r,n,o,a=0,s=0,u=0,h=new i.Vector3,c=new i.Vector3,l=[],p=0;for(l[0]=0,e||(e=100),n=this.points.length*e,h.copy(this.points[0]),t=1;n>t;t++)r=t/n,o=this.getPoint(r),c.copy(o),p+=c.distanceTo(h),h.copy(o),a=(this.points.length-1)*r,s=Math.floor(a),s!==u&&(l[s]=p,u=s);return l[l.length]=p,{chunks:l,total:p}},this.reparametrizeByArcLength=function(e){var t,r,n,o,a,s,u,h,c=[],l=new i.Vector3,p=this.getLength();for(c.push(l.copy(this.points[0]).clone()),t=1;t<this.points.length;t++){for(s=p.chunks[t]-p.chunks[t-1],u=Math.ceil(e*s/p.total),o=(t-1)/(this.points.length-1),a=t/(this.points.length-1),r=1;u-1>r;r++)n=o+r*(1/u)*(a-o),h=this.getPoint(n),c.push(l.copy(h).clone());c.push(l.copy(this.points[t]).clone())}this.points=c}},i.Triangle=function(e,t,r){this.a=void 0!==e?e:new i.Vector3,this.b=void 0!==t?t:new i.Vector3,this.c=void 0!==r?r:new i.Vector3},i.Triangle.normal=function(){var e=new i.Vector3;return function(t,r,n,o){var a=o||new i.Vector3;a.subVectors(n,r),e.subVectors(t,r),a.cross(e);var s=a.lengthSq();return s>0?a.multiplyScalar(1/Math.sqrt(s)):a.set(0,0,0)}}(),i.Triangle.barycoordFromPoint=function(){var e=new i.Vector3,t=new i.Vector3,r=new i.Vector3;return function(n,o,a,s,u){e.subVectors(s,o),t.subVectors(a,o),r.subVectors(n,o);var h=e.dot(e),c=e.dot(t),l=e.dot(r),p=t.dot(t),f=t.dot(r),d=h*p-c*c,m=u||new i.Vector3;if(0===d)return m.set(-2,-1,-1);var g=1/d,v=(p*l-c*f)*g,x=(h*f-c*l)*g;return m.set(1-v-x,x,v)}}(),i.Triangle.containsPoint=function(){var e=new i.Vector3;return function(t,r,n,o){var a=i.Triangle.barycoordFromPoint(t,r,n,o,e);return a.x>=0&&a.y>=0&&a.x+a.y<=1}}(),i.Triangle.prototype={constructor:i.Triangle,set:function(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this},setFromPointsAndIndices:function(e,t,r,n){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[n]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var e=new i.Vector3,t=new i.Vector3;return function(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),midpoint:function(e){var t=e||new i.Vector3;return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return i.Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){var t=e||new i.Plane;return t.setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return i.Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return i.Triangle.containsPoint(e,this.a,this.b,this.c)},equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}},i.Channels=function(){this.mask=1},i.Channels.prototype={constructor:i.Channels,set:function(e){this.mask=1<<e},enable:function(e){this.mask|=1<<e},toggle:function(e){this.mask^=1<<e},disable:function(e){this.mask&=~(1<<e)}},i.Clock=function(e){this.autoStart=void 0!==e?e:!0,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},i.Clock.prototype={constructor:i.Clock,start:function(){this.startTime=n.performance.now(),this.oldTime=this.startTime,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=n.performance.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e}},i.EventDispatcher=function(){},i.EventDispatcher.prototype={constructor:i.EventDispatcher,apply:function(e){e.addEventListener=i.EventDispatcher.prototype.addEventListener,e.hasEventListener=i.EventDispatcher.prototype.hasEventListener,e.removeEventListener=i.EventDispatcher.prototype.removeEventListener,e.dispatchEvent=i.EventDispatcher.prototype.dispatchEvent},addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var r=this._listeners;return void 0!==r[e]&&-1!==r[e].indexOf(t)?!0:!1},removeEventListener:function(e,t){if(void 0!==this._listeners){var r=this._listeners,n=r[e];if(void 0!==n){var i=n.indexOf(t);-1!==i&&n.splice(i,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners,r=t[e.type];if(void 0!==r){e.target=this;for(var n=[],i=r.length,o=0;i>o;o++)n[o]=r[o];for(var o=0;i>o;o++)n[o].call(this,e)}}}},function(e){function t(e,t){return e.distance-t.distance}function r(e,t,n,i){if(e.visible!==!1&&(e.raycast(t,n),i===!0))for(var o=e.children,a=0,s=o.length;s>a;a++)r(o[a],t,n,!0)}e.Raycaster=function(t,r,n,i){this.ray=new e.Ray(t,r),this.near=n||0,this.far=i||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})},e.Raycaster.prototype={constructor:e.Raycaster,linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(t,r){r instanceof e.PerspectiveCamera?(this.ray.origin.setFromMatrixPosition(r.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(r).sub(this.ray.origin).normalize()):r instanceof e.OrthographicCamera?(this.ray.origin.set(t.x,t.y,-1).unproject(r),this.ray.direction.set(0,0,-1).transformDirection(r.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,n){var i=[];return r(e,this,i,n),i.sort(t),i},intersectObjects:function(e,n){var i=[];if(Array.isArray(e)===!1)return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),i;for(var o=0,a=e.length;a>o;o++)r(e[o],this,i,n);return i.sort(t),i}}}(i),i.Object3D=function(){function e(){o.setFromEuler(n,!1)}function t(){n.setFromQuaternion(o,void 0,!1)}Object.defineProperty(this,"id",{value:i.Object3DIdCount++}),this.uuid=i.Math.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.channels=new i.Channels,this.children=[],this.up=i.Object3D.DefaultUp.clone();var r=new i.Vector3,n=new i.Euler,o=new i.Quaternion,a=new i.Vector3(1,1,1);n.onChange(e),o.onChange(t),Object.defineProperties(this,{position:{enumerable:!0,value:r},rotation:{enumerable:!0,value:n},quaternion:{enumerable:!0,value:o},scale:{enumerable:!0,value:a},modelViewMatrix:{value:new i.Matrix4},normalMatrix:{value:new i.Matrix3}}),this.rotationAutoUpdate=!0,this.matrix=new i.Matrix4,this.matrixWorld=new i.Matrix4,this.matrixAutoUpdate=i.Object3D.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}},i.Object3D.DefaultUp=new i.Vector3(0,1,0),i.Object3D.DefaultMatrixAutoUpdate=!0,i.Object3D.prototype={constructor:i.Object3D,get eulerOrder(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set eulerOrder(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e},get useQuaternion(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set useQuaternion(e){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set renderDepth(e){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(){var e=new i.Quaternion;return function(t,r){return e.setFromAxisAngle(t,r),this.quaternion.multiply(e),this}}(),rotateX:function(){var e=new i.Vector3(1,0,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new i.Vector3(0,1,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new i.Vector3(0,0,1);return function(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new i.Vector3;return function(t,r){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(r)),this}}(),translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)},translateX:function(){var e=new i.Vector3(1,0,0);return function(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new i.Vector3(0,1,0);return function(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new i.Vector3(0,0,1);return function(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var e=new i.Matrix4;return function(t){return t.applyMatrix4(e.getInverse(this.matrixWorld))}}(),lookAt:function(){var e=new i.Matrix4;return function(t){e.lookAt(t,this.position,this.up),this.quaternion.setFromRotationMatrix(e)}}(),add:function(e){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e instanceof i.Object3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1)for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);var r=this.children.indexOf(e);-1!==r&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(r,1))},getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var r=0,n=this.children.length;n>r;r++){var i=this.children[r],o=i.getObjectByProperty(e,t);if(void 0!==o)return o}},getWorldPosition:function(e){var t=e||new i.Vector3;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(){var e=new i.Vector3,t=new i.Vector3;return function(r){var n=r||new i.Quaternion;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,n,t),n}}(),getWorldRotation:function(){var e=new i.Quaternion;return function(t){var r=t||new i.Euler;return this.getWorldQuaternion(e),r.setFromQuaternion(e,this.rotation.order,!1)}}(),getWorldScale:function(){var e=new i.Vector3,t=new i.Quaternion;return function(r){var n=r||new i.Vector3;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,n),n}}(),getWorldDirection:function(){var e=new i.Quaternion;return function(t){var r=t||new i.Vector3;return this.getWorldQuaternion(e),r.set(0,0,1).applyQuaternion(e)}}(),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,r=0,n=t.length;n>r;r++)t[r].traverse(e)},traverseVisible:function(e){if(this.visible!==!1){e(this);for(var t=this.children,r=0,n=t.length;n>r;r++)t[r].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate===!0&&this.updateMatrix(),(this.matrixWorldNeedsUpdate===!0||e===!0)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=0,r=this.children.length;r>t;t++)this.children[t].updateMatrixWorld(e)},toJSON:function(e){function t(e){var t=[];for(var r in e){var n=e[r];delete n.metadata,t.push(n)}return t}var r=void 0===e,n={};r&&(e={geometries:{},materials:{},textures:{},images:{}},n.metadata={version:4.4,type:"Object",generator:"Object3D.toJSON"});var i={};if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),this.castShadow===!0&&(i.castShadow=!0),this.receiveShadow===!0&&(i.receiveShadow=!0),this.visible===!1&&(i.visible=!1),i.matrix=this.matrix.toArray(),void 0!==this.geometry&&(void 0===e.geometries[this.geometry.uuid]&&(e.geometries[this.geometry.uuid]=this.geometry.toJSON(e)),i.geometry=this.geometry.uuid),void 0!==this.material&&(void 0===e.materials[this.material.uuid]&&(e.materials[this.material.uuid]=this.material.toJSON(e)),i.material=this.material.uuid),this.children.length>0){i.children=[];for(var o=0;o<this.children.length;o++)i.children.push(this.children[o].toJSON(e).object)}if(r){var a=t(e.geometries),s=t(e.materials),u=t(e.textures),h=t(e.images);a.length>0&&(n.geometries=a),s.length>0&&(n.materials=s),u.length>0&&(n.textures=u),h.length>0&&(n.images=h)}return n.object=i,n},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.rotationAutoUpdate=e.rotationAutoUpdate,this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),t===!0)for(var r=0;r<e.children.length;r++){var n=e.children[r];this.add(n.clone())}return this}},i.EventDispatcher.prototype.apply(i.Object3D.prototype),i.Object3DIdCount=0,i.Face3=function(e,t,r,n,o,a){this.a=e,this.b=t,this.c=r,this.normal=n instanceof i.Vector3?n:new i.Vector3,this.vertexNormals=Array.isArray(n)?n:[],this.color=o instanceof i.Color?o:new i.Color,
this.vertexColors=Array.isArray(o)?o:[],this.materialIndex=void 0!==a?a:0},i.Face3.prototype={constructor:i.Face3,clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,r=e.vertexNormals.length;r>t;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(var t=0,r=e.vertexColors.length;r>t;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}},i.Face4=function(e,t,r,n,o,a,s){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new i.Face3(e,t,r,o,a,s)},i.BufferAttribute=function(e,t){this.uuid=i.Math.generateUUID(),this.array=e,this.itemSize=t,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0},i.BufferAttribute.prototype={constructor:i.BufferAttribute,get length(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Please use .count."),this.array.length},get count(){return this.array.length/this.itemSize},set needsUpdate(e){e===!0&&this.version++},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.dynamic=e.dynamic,this},copyAt:function(e,t,r){e*=this.itemSize,r*=t.itemSize;for(var n=0,i=this.itemSize;i>n;n++)this.array[e+n]=t.array[r+n];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,r=0,n=0,o=e.length;o>n;n++){var a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),a=new i.Color),t[r++]=a.r,t[r++]=a.g,t[r++]=a.b}return this},copyIndicesArray:function(e){for(var t=this.array,r=0,n=0,i=e.length;i>n;n++){var o=e[n];t[r++]=o.a,t[r++]=o.b,t[r++]=o.c}return this},copyVector2sArray:function(e){for(var t=this.array,r=0,n=0,o=e.length;o>n;n++){var a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",n),a=new i.Vector2),t[r++]=a.x,t[r++]=a.y}return this},copyVector3sArray:function(e){for(var t=this.array,r=0,n=0,o=e.length;o>n;n++){var a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),a=new i.Vector3),t[r++]=a.x,t[r++]=a.y,t[r++]=a.z}return this},copyVector4sArray:function(e){for(var t=this.array,r=0,n=0,o=e.length;o>n;n++){var a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),a=new i.Vector4),t[r++]=a.x,t[r++]=a.y,t[r++]=a.z,t[r++]=a.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this},setXYZW:function(e,t,r,n,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=n,this.array[e+3]=i,this},clone:function(){return(new this.constructor).copy(this)}},i.Int8Attribute=function(e,t){return new i.BufferAttribute(new Int8Array(e),t)},i.Uint8Attribute=function(e,t){return new i.BufferAttribute(new Uint8Array(e),t)},i.Uint8ClampedAttribute=function(e,t){return new i.BufferAttribute(new Uint8ClampedArray(e),t)},i.Int16Attribute=function(e,t){return new i.BufferAttribute(new Int16Array(e),t)},i.Uint16Attribute=function(e,t){return new i.BufferAttribute(new Uint16Array(e),t)},i.Int32Attribute=function(e,t){return new i.BufferAttribute(new Int32Array(e),t)},i.Uint32Attribute=function(e,t){return new i.BufferAttribute(new Uint32Array(e),t)},i.Float32Attribute=function(e,t){return new i.BufferAttribute(new Float32Array(e),t)},i.Float64Attribute=function(e,t){return new i.BufferAttribute(new Float64Array(e),t)},i.DynamicBufferAttribute=function(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setDynamic( true ) instead."),new i.BufferAttribute(e,t).setDynamic(!0)},i.InstancedBufferAttribute=function(e,t,r){i.BufferAttribute.call(this,e,t),this.meshPerAttribute=r||1},i.InstancedBufferAttribute.prototype=Object.create(i.BufferAttribute.prototype),i.InstancedBufferAttribute.prototype.constructor=i.InstancedBufferAttribute,i.InstancedBufferAttribute.prototype.copy=function(e){return i.BufferAttribute.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},i.InterleavedBuffer=function(e,t){this.uuid=i.Math.generateUUID(),this.array=e,this.stride=t,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0},i.InterleavedBuffer.prototype={constructor:i.InterleavedBuffer,get length(){return this.array.length},get count(){return this.array.length/this.stride},set needsUpdate(e){e===!0&&this.version++},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){this.array=new e.array.constructor(e.array),this.stride=e.stride,this.dynamic=e.dynamic},copyAt:function(e,t,r){e*=this.stride,r*=t.stride;for(var n=0,i=this.stride;i>n;n++)this.array[e+n]=t.array[r+n];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)}},i.InstancedInterleavedBuffer=function(e,t,r){i.InterleavedBuffer.call(this,e,t),this.meshPerAttribute=r||1},i.InstancedInterleavedBuffer.prototype=Object.create(i.InterleavedBuffer.prototype),i.InstancedInterleavedBuffer.prototype.constructor=i.InstancedInterleavedBuffer,i.InstancedInterleavedBuffer.prototype.copy=function(e){return i.InterleavedBuffer.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},i.InterleavedBufferAttribute=function(e,t,r){this.uuid=i.Math.generateUUID(),this.data=e,this.itemSize=t,this.offset=r},i.InterleavedBufferAttribute.prototype={constructor:i.InterleavedBufferAttribute,get length(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Please use .count."),this.array.length},get count(){return this.data.array.length/this.data.stride},setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this},setXYZ:function(e,t,r,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this},setXYZW:function(e,t,r,n,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=n,this.data.array[e+3]=i,this}},i.Geometry=function(){Object.defineProperty(this,"id",{value:i.GeometryIdCount++}),this.uuid=i.Math.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1},i.Geometry.prototype={constructor:i.Geometry,applyMatrix:function(e){for(var t=(new i.Matrix3).getNormalMatrix(e),r=0,n=this.vertices.length;n>r;r++){var o=this.vertices[r];o.applyMatrix4(e)}for(var r=0,n=this.faces.length;n>r;r++){var a=this.faces[r];a.normal.applyMatrix3(t).normalize();for(var s=0,u=a.vertexNormals.length;u>s;s++)a.vertexNormals[s].applyMatrix3(t).normalize()}null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0},rotateX:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e;return function(t,r,n){return void 0===e&&(e=new i.Matrix4),e.makeTranslation(t,r,n),this.applyMatrix(e),this}}(),scale:function(){var e;return function(t,r,n){return void 0===e&&(e=new i.Matrix4),e.makeScale(t,r,n),this.applyMatrix(e),this}}(),lookAt:function(){var e;return function(t){void 0===e&&(e=new i.Object3D),e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),fromBufferGeometry:function(e){function t(e,t,n){var o=void 0!==s?[l[e].clone(),l[t].clone(),l[n].clone()]:[],a=void 0!==u?[r.colors[e].clone(),r.colors[t].clone(),r.colors[n].clone()]:[],d=new i.Face3(e,t,n,o,a);r.faces.push(d),void 0!==h&&r.faceVertexUvs[0].push([p[e].clone(),p[t].clone(),p[n].clone()]),void 0!==c&&r.faceVertexUvs[1].push([f[e].clone(),f[t].clone(),f[n].clone()])}var r=this,n=null!==e.index?e.index.array:void 0,o=e.attributes,a=o.position.array,s=void 0!==o.normal?o.normal.array:void 0,u=void 0!==o.color?o.color.array:void 0,h=void 0!==o.uv?o.uv.array:void 0,c=void 0!==o.uv2?o.uv2.array:void 0;void 0!==c&&(this.faceVertexUvs[1]=[]);for(var l=[],p=[],f=[],d=0,m=0,g=0;d<a.length;d+=3,m+=2,g+=4)r.vertices.push(new i.Vector3(a[d],a[d+1],a[d+2])),void 0!==s&&l.push(new i.Vector3(s[d],s[d+1],s[d+2])),void 0!==u&&r.colors.push(new i.Color(u[d],u[d+1],u[d+2])),void 0!==h&&p.push(new i.Vector2(h[m],h[m+1])),void 0!==c&&f.push(new i.Vector2(c[m],c[m+1]));if(void 0!==n){var v=e.groups;if(v.length>0)for(var d=0;d<v.length;d++)for(var x=v[d],y=x.start,_=x.count,m=y,b=y+_;b>m;m+=3)t(n[m],n[m+1],n[m+2]);else for(var d=0;d<n.length;d+=3)t(n[d],n[d+1],n[d+2])}else for(var d=0;d<a.length/3;d+=3)t(d,d+1,d+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.center().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,r=0===t?1:1/t,n=new i.Matrix4;return n.set(r,0,0,-r*e.x,0,r,0,-r*e.y,0,0,r,-r*e.z,0,0,0,1),this.applyMatrix(n),this},computeFaceNormals:function(){for(var e=new i.Vector3,t=new i.Vector3,r=0,n=this.faces.length;n>r;r++){var o=this.faces[r],a=this.vertices[o.a],s=this.vertices[o.b],u=this.vertices[o.c];e.subVectors(u,s),t.subVectors(a,s),e.cross(t),e.normalize(),o.normal.copy(e)}},computeVertexNormals:function(e){var t,r,n,o,a,s;for(s=new Array(this.vertices.length),t=0,r=this.vertices.length;r>t;t++)s[t]=new i.Vector3;if(e){var u,h,c,l=new i.Vector3,p=new i.Vector3;for(n=0,o=this.faces.length;o>n;n++)a=this.faces[n],u=this.vertices[a.a],h=this.vertices[a.b],c=this.vertices[a.c],l.subVectors(c,h),p.subVectors(u,h),l.cross(p),s[a.a].add(l),s[a.b].add(l),s[a.c].add(l)}else for(n=0,o=this.faces.length;o>n;n++)a=this.faces[n],s[a.a].add(a.normal),s[a.b].add(a.normal),s[a.c].add(a.normal);for(t=0,r=this.vertices.length;r>t;t++)s[t].normalize();for(n=0,o=this.faces.length;o>n;n++){a=this.faces[n];var f=a.vertexNormals;3===f.length?(f[0].copy(s[a.a]),f[1].copy(s[a.b]),f[2].copy(s[a.c])):(f[0]=s[a.a].clone(),f[1]=s[a.b].clone(),f[2]=s[a.c].clone())}},computeMorphNormals:function(){var e,t,r,n,o;for(r=0,n=this.faces.length;n>r;r++)for(o=this.faces[r],o.__originalFaceNormal?o.__originalFaceNormal.copy(o.normal):o.__originalFaceNormal=o.normal.clone(),o.__originalVertexNormals||(o.__originalVertexNormals=[]),e=0,t=o.vertexNormals.length;t>e;e++)o.__originalVertexNormals[e]?o.__originalVertexNormals[e].copy(o.vertexNormals[e]):o.__originalVertexNormals[e]=o.vertexNormals[e].clone();var a=new i.Geometry;for(a.faces=this.faces,e=0,t=this.morphTargets.length;t>e;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var s,u,h=this.morphNormals[e].faceNormals,c=this.morphNormals[e].vertexNormals;for(r=0,n=this.faces.length;n>r;r++)s=new i.Vector3,u={a:new i.Vector3,b:new i.Vector3,c:new i.Vector3},h.push(s),c.push(u)}var l=this.morphNormals[e];a.vertices=this.morphTargets[e].vertices,a.computeFaceNormals(),a.computeVertexNormals();var s,u;for(r=0,n=this.faces.length;n>r;r++)o=this.faces[r],s=l.faceNormals[r],u=l.vertexNormals[r],s.copy(o.normal),u.a.copy(o.vertexNormals[0]),u.b.copy(o.vertexNormals[1]),u.c.copy(o.vertexNormals[2])}for(r=0,n=this.faces.length;n>r;r++)o=this.faces[r],o.normal=o.__originalFaceNormal,o.vertexNormals=o.__originalVertexNormals},computeTangents:function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},computeLineDistances:function(){for(var e=0,t=this.vertices,r=0,n=t.length;n>r;r++)r>0&&(e+=t[r].distanceTo(t[r-1])),this.lineDistances[r]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new i.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new i.Sphere),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,r){if(e instanceof i.Geometry==!1)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);var n,o=this.vertices.length,a=this.vertices,s=e.vertices,u=this.faces,h=e.faces,c=this.faceVertexUvs[0],l=e.faceVertexUvs[0];void 0===r&&(r=0),void 0!==t&&(n=(new i.Matrix3).getNormalMatrix(t));for(var p=0,f=s.length;f>p;p++){var d=s[p],m=d.clone();void 0!==t&&m.applyMatrix4(t),a.push(m)}for(p=0,f=h.length;f>p;p++){var g,v,x,y=h[p],_=y.vertexNormals,b=y.vertexColors;g=new i.Face3(y.a+o,y.b+o,y.c+o),g.normal.copy(y.normal),void 0!==n&&g.normal.applyMatrix3(n).normalize();for(var w=0,T=_.length;T>w;w++)v=_[w].clone(),void 0!==n&&v.applyMatrix3(n).normalize(),g.vertexNormals.push(v);g.color.copy(y.color);for(var w=0,T=b.length;T>w;w++)x=b[w],g.vertexColors.push(x.clone());g.materialIndex=y.materialIndex+r,u.push(g)}for(p=0,f=l.length;f>p;p++){var M=l[p],S=[];if(void 0!==M){for(var w=0,T=M.length;T>w;w++)S.push(M[w].clone());c.push(S)}}},mergeMesh:function(e){return e instanceof i.Mesh==!1?void console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e):(e.matrixAutoUpdate&&e.updateMatrix(),void this.merge(e.geometry,e.matrix))},mergeVertices:function(){var e,t,r,n,i,o,a,s,u={},h=[],c=[],l=4,p=Math.pow(10,l);for(r=0,n=this.vertices.length;n>r;r++)e=this.vertices[r],t=Math.round(e.x*p)+"_"+Math.round(e.y*p)+"_"+Math.round(e.z*p),void 0===u[t]?(u[t]=r,h.push(this.vertices[r]),c[r]=h.length-1):c[r]=c[u[t]];var f=[];for(r=0,n=this.faces.length;n>r;r++){i=this.faces[r],i.a=c[i.a],i.b=c[i.b],i.c=c[i.c],o=[i.a,i.b,i.c];for(var d=-1,m=0;3>m;m++)if(o[m]===o[(m+1)%3]){d=m,f.push(r);break}}for(r=f.length-1;r>=0;r--){var g=f[r];for(this.faces.splice(g,1),a=0,s=this.faceVertexUvs.length;s>a;a++)this.faceVertexUvs[a].splice(g,1)}var v=this.vertices.length-h.length;return this.vertices=h,v},sortFacesByMaterialIndex:function(){function e(e,t){return e.materialIndex-t.materialIndex}for(var t=this.faces,r=t.length,n=0;r>n;n++)t[n]._id=n;t.sort(e);var i,o,a=this.faceVertexUvs[0],s=this.faceVertexUvs[1];a&&a.length===r&&(i=[]),s&&s.length===r&&(o=[]);for(var n=0;r>n;n++){var u=t[n]._id;i&&i.push(a[u]),o&&o.push(s[u])}i&&(this.faceVertexUvs[0]=i),o&&(this.faceVertexUvs[1]=o)},toJSON:function(){function e(e,t,r){return r?e|1<<t:e&~(1<<t)}function t(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==p[t]?p[t]:(p[t]=l.length/3,l.push(e.x,e.y,e.z),p[t])}function r(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==d[t]?d[t]:(d[t]=f.length,f.push(e.getHex()),d[t])}function n(e){var t=e.x.toString()+e.y.toString();return void 0!==g[t]?g[t]:(g[t]=m.length/2,m.push(e.x,e.y),g[t])}var i={metadata:{version:4.4,type:"Geometry",generator:"Geometry.toJSON"}};if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),void 0!==this.parameters){var o=this.parameters;for(var a in o)void 0!==o[a]&&(i[a]=o[a]);return i}for(var s=[],u=0;u<this.vertices.length;u++){var h=this.vertices[u];s.push(h.x,h.y,h.z)}for(var c=[],l=[],p={},f=[],d={},m=[],g={},u=0;u<this.faces.length;u++){var v=this.faces[u],x=!1,y=!1,_=void 0!==this.faceVertexUvs[0][u],b=v.normal.length()>0,w=v.vertexNormals.length>0,T=1!==v.color.r||1!==v.color.g||1!==v.color.b,M=v.vertexColors.length>0,S=0;if(S=e(S,0,0),S=e(S,1,x),S=e(S,2,y),S=e(S,3,_),S=e(S,4,b),S=e(S,5,w),S=e(S,6,T),S=e(S,7,M),c.push(S),c.push(v.a,v.b,v.c),_){var E=this.faceVertexUvs[0][u];c.push(n(E[0]),n(E[1]),n(E[2]))}if(b&&c.push(t(v.normal)),w){var C=v.vertexNormals;c.push(t(C[0]),t(C[1]),t(C[2]))}if(T&&c.push(r(v.color)),M){var R=v.vertexColors;c.push(r(R[0]),r(R[1]),r(R[2]))}}return i.data={},i.data.vertices=s,i.data.normals=l,f.length>0&&(i.data.colors=f),m.length>0&&(i.data.uvs=[m]),i.data.faces=c,i},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.vertices=[],this.faces=[],this.faceVertexUvs=[[]];for(var t=e.vertices,r=0,n=t.length;n>r;r++)this.vertices.push(t[r].clone());for(var i=e.faces,r=0,n=i.length;n>r;r++)this.faces.push(i[r].clone());for(var r=0,n=e.faceVertexUvs.length;n>r;r++){var o=e.faceVertexUvs[r];void 0===this.faceVertexUvs[r]&&(this.faceVertexUvs[r]=[]);for(var a=0,s=o.length;s>a;a++){for(var u=o[a],h=[],c=0,l=u.length;l>c;c++){var p=u[c];h.push(p.clone())}this.faceVertexUvs[r].push(h)}}return this},dispose:function(){this.dispatchEvent({type:"dispose"})}},i.EventDispatcher.prototype.apply(i.Geometry.prototype),i.GeometryIdCount=0,i.DirectGeometry=function(){Object.defineProperty(this,"id",{value:i.GeometryIdCount++}),this.uuid=i.Math.generateUUID(),this.name="",this.type="DirectGeometry",this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1},i.DirectGeometry.prototype={constructor:i.DirectGeometry,computeBoundingBox:i.Geometry.prototype.computeBoundingBox,computeBoundingSphere:i.Geometry.prototype.computeBoundingSphere,computeFaceNormals:function(){console.warn("THREE.DirectGeometry: computeFaceNormals() is not a method of this type of geometry.")},computeVertexNormals:function(){console.warn("THREE.DirectGeometry: computeVertexNormals() is not a method of this type of geometry.")},computeGroups:function(e){for(var t,r,n=[],i=e.faces,o=0;o<i.length;o++){var a=i[o];a.materialIndex!==r&&(r=a.materialIndex,void 0!==t&&(t.count=3*o-t.start,n.push(t)),t={start:3*o,materialIndex:r})}void 0!==t&&(t.count=3*o-t.start,n.push(t)),this.groups=n},fromGeometry:function(e){var t=e.faces,r=e.vertices,n=e.faceVertexUvs,o=n[0]&&n[0].length>0,a=n[1]&&n[1].length>0,s=e.morphTargets,u=s.length;if(u>0){for(var h=[],c=0;u>c;c++)h[c]=[];this.morphTargets.position=h}var l=e.morphNormals,p=l.length;if(p>0){for(var f=[],c=0;p>c;c++)f[c]=[];this.morphTargets.normal=f}for(var d=e.skinIndices,m=e.skinWeights,g=d.length===r.length,v=m.length===r.length,c=0;c<t.length;c++){var x=t[c];this.vertices.push(r[x.a],r[x.b],r[x.c]);var y=x.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{var _=x.normal;this.normals.push(_,_,_)}var b=x.vertexColors;if(3===b.length)this.colors.push(b[0],b[1],b[2]);else{var w=x.color;this.colors.push(w,w,w)}if(o===!0){var T=n[0][c];void 0!==T?this.uvs.push(T[0],T[1],T[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",c),this.uvs.push(new i.Vector2,new i.Vector2,new i.Vector2))}if(a===!0){var T=n[1][c];void 0!==T?this.uvs2.push(T[0],T[1],T[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",c),this.uvs2.push(new i.Vector2,new i.Vector2,new i.Vector2))}for(var M=0;u>M;M++){var S=s[M].vertices;h[M].push(S[x.a],S[x.b],S[x.c])}for(var M=0;p>M;M++){var E=l[M].vertexNormals[c];f[M].push(E.a,E.b,E.c)}g&&this.skinIndices.push(d[x.a],d[x.b],d[x.c]),v&&this.skinWeights.push(m[x.a],m[x.b],m[x.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}},i.EventDispatcher.prototype.apply(i.DirectGeometry.prototype),i.BufferGeometry=function(){Object.defineProperty(this,"id",{value:i.GeometryIdCount++}),this.uuid=i.Math.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}},i.BufferGeometry.prototype={constructor:i.BufferGeometry,addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},getIndex:function(){return this.index},setIndex:function(e){this.index=e},addAttribute:function(e,t){return t instanceof i.BufferAttribute==!1&&t instanceof i.InterleavedBufferAttribute==!1?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new i.BufferAttribute(arguments[1],arguments[2]))):"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):void(this.attributes[e]=t)},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){delete this.attributes[e]},get drawcalls(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups},get offsets(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups},addDrawCall:function(e,t,r){void 0!==r&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},addGroup:function(e,t,r){this.groups.push({start:e,count:t,materialIndex:void 0!==r?r:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToVector3Array(t.array),t.needsUpdate=!0);var r=this.attributes.normal;if(void 0!==r){var n=(new i.Matrix3).getNormalMatrix(e);n.applyToVector3Array(r.array),r.needsUpdate=!0}null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere()},rotateX:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e;return function(t){return void 0===e&&(e=new i.Matrix4),e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e;return function(t,r,n){return void 0===e&&(e=new i.Matrix4),e.makeTranslation(t,r,n),this.applyMatrix(e),this}}(),scale:function(){var e;return function(t,r,n){return void 0===e&&(e=new i.Matrix4),e.makeScale(t,r,n),this.applyMatrix(e),this}}(),lookAt:function(){var e;return function(t){void 0===e&&(e=new i.Object3D),e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){this.computeBoundingBox();var e=this.boundingBox.center().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e instanceof i.Points||e instanceof i.Line){var r=new i.Float32Attribute(3*t.vertices.length,3),n=new i.Float32Attribute(3*t.colors.length,3);if(this.addAttribute("position",r.copyVector3sArray(t.vertices)),this.addAttribute("color",n.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){var o=new i.Float32Attribute(t.lineDistances.length,1);this.addAttribute("lineDistance",o.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e instanceof i.Mesh&&t instanceof i.Geometry&&this.fromGeometry(t);return this},updateFromObject:function(e){var t=e.geometry;if(e instanceof i.Mesh){var r=t.__directGeometry;if(void 0===r)return this.fromGeometry(t);r.verticesNeedUpdate=t.verticesNeedUpdate,r.normalsNeedUpdate=t.normalsNeedUpdate,r.colorsNeedUpdate=t.colorsNeedUpdate,r.uvsNeedUpdate=t.uvsNeedUpdate,r.groupsNeedUpdate=t.groupsNeedUpdate,t.verticesNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.groupsNeedUpdate=!1,t=r}if(t.verticesNeedUpdate===!0){var n=this.attributes.position;void 0!==n&&(n.copyVector3sArray(t.vertices),n.needsUpdate=!0),t.verticesNeedUpdate=!1}if(t.normalsNeedUpdate===!0){var n=this.attributes.normal;void 0!==n&&(n.copyVector3sArray(t.normals),n.needsUpdate=!0),t.normalsNeedUpdate=!1}if(t.colorsNeedUpdate===!0){var n=this.attributes.color;void 0!==n&&(n.copyColorsArray(t.colors),n.needsUpdate=!0),t.colorsNeedUpdate=!1}if(t.uvsNeedUpdate){var n=this.attributes.uv;void 0!==n&&(n.copyVector2sArray(t.uvs),n.needsUpdate=!0),t.uvsNeedUpdate=!1}if(t.lineDistancesNeedUpdate){var n=this.attributes.lineDistance;void 0!==n&&(n.copyArray(t.lineDistances),n.needsUpdate=!0),t.lineDistancesNeedUpdate=!1}return t.groupsNeedUpdate&&(t.computeGroups(e.geometry),this.groups=t.groups,t.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new i.DirectGeometry).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new i.BufferAttribute(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var r=new Float32Array(3*e.normals.length);this.addAttribute("normal",new i.BufferAttribute(r,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var n=new Float32Array(3*e.colors.length);this.addAttribute("color",new i.BufferAttribute(n,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var o=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new i.BufferAttribute(o,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var a=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new i.BufferAttribute(a,2).copyVector2sArray(e.uvs2))}if(e.indices.length>0){var s=e.vertices.length>65535?Uint32Array:Uint16Array,u=new s(3*e.indices.length);this.setIndex(new i.BufferAttribute(u,1).copyIndicesArray(e.indices))}this.groups=e.groups;for(var h in e.morphTargets){for(var c=[],l=e.morphTargets[h],p=0,f=l.length;f>p;p++){var d=l[p],m=new i.Float32Attribute(3*d.length,3);c.push(m.copyVector3sArray(d))}this.morphAttributes[h]=c}if(e.skinIndices.length>0){var g=new i.Float32Attribute(4*e.skinIndices.length,4);this.addAttribute("skinIndex",g.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var v=new i.Float32Attribute(4*e.skinWeights.length,4);this.addAttribute("skinWeight",v.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){var e=new i.Vector3;return function(){null===this.boundingBox&&(this.boundingBox=new i.Box3);var t=this.attributes.position.array;if(t){var r=this.boundingBox;r.makeEmpty();for(var n=0,o=t.length;o>n;n+=3)e.fromArray(t,n),r.expandByPoint(e)}(void 0===t||0===t.length)&&(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}}(),computeBoundingSphere:function(){var e=new i.Box3,t=new i.Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new i.Sphere);var r=this.attributes.position.array;if(r){e.makeEmpty();for(var n=this.boundingSphere.center,o=0,a=r.length;a>o;o+=3)t.fromArray(r,o),e.expandByPoint(t);e.center(n);for(var s=0,o=0,a=r.length;a>o;o+=3)t.fromArray(r,o),s=Math.max(s,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,r=this.groups;if(t.position){var n=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new i.BufferAttribute(new Float32Array(n.length),3));else for(var o=t.normal.array,a=0,s=o.length;s>a;a++)o[a]=0;var u,h,c,o=t.normal.array,l=new i.Vector3,p=new i.Vector3,f=new i.Vector3,d=new i.Vector3,m=new i.Vector3;if(e){var g=e.array;0===r.length&&this.addGroup(0,g.length);for(var v=0,x=r.length;x>v;++v)for(var y=r[v],_=y.start,b=y.count,a=_,s=_+b;s>a;a+=3)u=3*g[a+0],h=3*g[a+1],c=3*g[a+2],l.fromArray(n,u),p.fromArray(n,h),f.fromArray(n,c),d.subVectors(f,p),m.subVectors(l,p),d.cross(m),o[u]+=d.x,o[u+1]+=d.y,o[u+2]+=d.z,o[h]+=d.x,o[h+1]+=d.y,o[h+2]+=d.z,o[c]+=d.x,o[c+1]+=d.y,o[c+2]+=d.z}else for(var a=0,s=n.length;s>a;a+=9)l.fromArray(n,a),p.fromArray(n,a+3),f.fromArray(n,a+6),d.subVectors(f,p),m.subVectors(l,p),d.cross(m),o[a]=d.x,o[a+1]=d.y,o[a+2]=d.z,o[a+3]=d.x,o[a+4]=d.y,o[a+5]=d.z,o[a+6]=d.x,o[a+7]=d.y,o[a+8]=d.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(e){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")},merge:function(e,t){if(e instanceof i.BufferGeometry==!1)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);void 0===t&&(t=0);var r=this.attributes;for(var n in r)if(void 0!==e.attributes[n])for(var o=r[n],a=o.array,s=e.attributes[n],u=s.array,h=s.itemSize,c=0,l=h*t;c<u.length;c++,l++)a[l]=u[c];return this},normalizeNormals:function(){for(var e,t,r,n,i=this.attributes.normal.array,o=0,a=i.length;a>o;o+=3)e=i[o],t=i[o+1],r=i[o+2],n=1/Math.sqrt(e*e+t*t+r*r),i[o]*=n,i[o+1]*=n,i[o+2]*=n},toJSON:function(){var e={metadata:{version:4.4,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}e.data={attributes:{}};var n=this.index;if(null!==n){var i=Array.prototype.slice.call(n.array);e.data.index={type:n.array.constructor.name,array:i}}var o=this.attributes;for(var r in o){var a=o[r],i=Array.prototype.slice.call(a.array);e.data.attributes[r]={itemSize:a.itemSize,type:a.array.constructor.name,array:i}}var s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));var u=this.boundingSphere;return null!==u&&(e.data.boundingSphere={
center:u.center.toArray(),radius:u.radius}),e},clone:function(){return(new this.constructor).copy(this)},copy:function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var r=e.attributes;for(var n in r){var i=r[n];this.addAttribute(n,i.clone())}for(var o=e.groups,a=0,s=o.length;s>a;a++){var u=o[a];this.addGroup(u.start,u.count)}return this},dispose:function(){this.dispatchEvent({type:"dispose"})}},i.EventDispatcher.prototype.apply(i.BufferGeometry.prototype),i.BufferGeometry.MaxIndex=65535,i.InstancedBufferGeometry=function(){i.BufferGeometry.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0},i.InstancedBufferGeometry.prototype=Object.create(i.BufferGeometry.prototype),i.InstancedBufferGeometry.prototype.constructor=i.InstancedBufferGeometry,i.InstancedBufferGeometry.prototype.addGroup=function(e,t,r){this.groups.push({start:e,count:t,instances:r})},i.InstancedBufferGeometry.prototype.copy=function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var r=e.attributes;for(var n in r){var i=r[n];this.addAttribute(n,i.clone())}for(var o=e.groups,a=0,s=o.length;s>a;a++){var u=o[a];this.addGroup(u.start,u.count,u.instances)}return this},i.EventDispatcher.prototype.apply(i.InstancedBufferGeometry.prototype),i.AnimationAction=function(e,t,r,n,o){if(void 0===e)throw new Error("clip is null");this.clip=e,this.localRoot=null,this.startTime=t||0,this.timeScale=r||1,this.weight=n||1,this.loop=o||i.LoopRepeat,this.loopCount=0,this.enabled=!0,this.actionTime=-this.startTime,this.clipTime=0,this.propertyBindings=[]},i.AnimationAction.prototype={constructor:i.AnimationAction,setLocalRoot:function(e){return this.localRoot=e,this},updateTime:function(e){var t=this.clipTime,r=this.loopCount,n=(this.actionTime,this.clip.duration);if(this.actionTime=this.actionTime+e,this.loop===i.LoopOnce)return this.loopCount=0,this.clipTime=Math.min(Math.max(this.actionTime,0),n),this.clipTime!==t&&(this.clipTime===n?this.mixer.dispatchEvent({type:"finished",action:this,direction:1}):0===this.clipTime&&this.mixer.dispatchEvent({type:"finished",action:this,direction:-1})),this.clipTime;this.loopCount=Math.floor(this.actionTime/n);var o=this.actionTime-this.loopCount*n;return o%=n,this.loop==i.LoopPingPong&&1===Math.abs(this.loopCount%2)&&(o=n-o),this.clipTime=o,this.loopCount!==r&&this.mixer.dispatchEvent({type:"loop",action:this,loopDelta:this.loopCount-this.loopCount}),this.clipTime},syncWith:function(e){return this.actionTime=e.actionTime,this.timeScale=e.timeScale,this},warpToDuration:function(e){return this.timeScale=this.clip.duration/e,this},init:function(e){return this.clipTime=e-this.startTime,this},update:function(e){this.updateTime(e);var t=this.clip.getAt(this.clipTime);return t},getTimeScaleAt:function(e){return this.timeScale.getAt?this.timeScale.getAt(e):this.timeScale},getWeightAt:function(e){return this.weight.getAt?this.weight.getAt(e):this.weight}},i.AnimationClip=function(e,t,r){if(this.name=e,this.tracks=r,this.duration=void 0!==t?t:-1,this.duration<0)for(var n=0;n<this.tracks.length;n++){var i=this.tracks[n];this.duration=Math.max(i.keys[i.keys.length-1].time)}this.trim(),this.optimize(),this.results=[]},i.AnimationClip.prototype={constructor:i.AnimationClip,getAt:function(e){e=Math.max(0,Math.min(e,this.duration));for(var t=0;t<this.tracks.length;t++){var r=this.tracks[t];this.results[t]=r.getAt(e)}return this.results},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}},i.AnimationClip.CreateFromMorphTargetSequence=function(e,t,r){for(var n=t.length,o=[],a=0;n>a;a++){var s=[];s.push({time:(a+n-1)%n,value:0}),s.push({time:a,value:1}),s.push({time:(a+1)%n,value:0}),s.sort(i.KeyframeTrack.keyComparer),0===s[0].time&&s.push({time:n,value:s[0].value}),o.push(new i.NumberKeyframeTrack(".morphTargetInfluences["+t[a].name+"]",s).scale(1/r))}return new i.AnimationClip(e,-1,o)},i.AnimationClip.findByName=function(e,t){for(var r=0;r<e.length;r++)if(e[r].name===t)return e[r];return null},i.AnimationClip.CreateClipsFromMorphTargetSequences=function(e,t){for(var r={},n=/^([\w-]*?)([\d]+)$/,o=0,a=e.length;a>o;o++){var s=e[o],u=s.name.match(n);if(u&&u.length>1){var h=u[1],c=r[h];c||(r[h]=c=[]),c.push(s)}}var l=[];for(var h in r)l.push(i.AnimationClip.CreateFromMorphTargetSequence(h,r[h],t));return l},i.AnimationClip.parse=function(e){for(var t=[],r=0;r<e.tracks.length;r++)t.push(i.KeyframeTrack.parse(e.tracks[r]).scale(1/e.fps));return new i.AnimationClip(e.name,e.duration,t)},i.AnimationClip.parseAnimation=function(e,t,r){if(!e)return console.error("  no animation in JSONLoader data"),null;for(var n=function(e,t,r,n,i){for(var o=[],a=0;a<t.length;a++){var s=t[a];void 0!==s[r]&&o.push({time:s.time,value:i(s)})}return o.length>0?new n(e,o):null},o=[],a=e.name||"default",s=e.length||-1,u=e.fps||30,h=e.hierarchy||[],c=0;c<h.length;c++){var l=h[c].keys;if(l&&0!=l.length)if(l[0].morphTargets){for(var p={},f=0;f<l.length;f++)if(l[f].morphTargets)for(var d=0;d<l[f].morphTargets.length;d++)p[l[f].morphTargets[d]]=-1;for(var m in p){for(var g=[],d=0;d<l[f].morphTargets.length;d++){var v=l[f];g.push({time:v.time,value:v.morphTarget===m?1:0})}o.push(new i.NumberKeyframeTrack(r+".morphTargetInfluence["+m+"]",g))}s=p.length*(u||1)}else{var x=r+".bones["+t[c].name+"]",y=n(x+".position",l,"pos",i.VectorKeyframeTrack,function(e){return(new i.Vector3).fromArray(e.pos)});y&&o.push(y);var _=n(x+".quaternion",l,"rot",i.QuaternionKeyframeTrack,function(e){return e.rot.slerp?e.rot.clone():(new i.Quaternion).fromArray(e.rot)});_&&o.push(_);var b=n(x+".scale",l,"scl",i.VectorKeyframeTrack,function(e){return(new i.Vector3).fromArray(e.scl)});b&&o.push(b)}}if(0===o.length)return null;var w=new i.AnimationClip(a,s,o);return w},i.AnimationMixer=function(e){this.root=e,this.time=0,this.timeScale=1,this.actions=[],this.propertyBindingMap={}},i.AnimationMixer.prototype={constructor:i.AnimationMixer,addAction:function(e){this.actions.push(e),e.init(this.time),e.mixer=this;for(var t=e.clip.tracks,r=e.localRoot||this.root,n=0;n<t.length;n++){var o=t[n],a=r.uuid+"-"+o.name,s=this.propertyBindingMap[a];void 0===s&&(s=new i.PropertyBinding(r,o.name),this.propertyBindingMap[a]=s),e.propertyBindings.push(s),s.referenceCount+=1}},removeAllActions:function(){for(var e=0;e<this.actions.length;e++)this.actions[e].mixer=null;for(var t in this.propertyBindingMap)this.propertyBindingMap[t].unbind();return this.actions=[],this.propertyBindingMap={},this},removeAction:function(e){var t=this.actions.indexOf(e);-1!==t&&(this.actions.splice(t,1),e.mixer=null);for(var r=e.localRoot||this.root,n=e.clip.tracks,i=0;i<n.length;i++){var o=n[i],a=r.uuid+"-"+o.name,s=this.propertyBindingMap[a];s.referenceCount-=1,s.referenceCount<=0&&(s.unbind(),delete this.propertyBindingMap[a])}return this},findActionByName:function(e){for(var t=0;t<this.actions.length;t++)if(this.actions[t].name===e)return this.actions[t];return null},play:function(e,t){return e.startTime=this.time,this.addAction(e),this},fadeOut:function(e,t){var r=[];return r.push({time:this.time,value:1}),r.push({time:this.time+t,value:0}),e.weight=new i.NumberKeyframeTrack("weight",r),this},fadeIn:function(e,t){var r=[];return r.push({time:this.time,value:0}),r.push({time:this.time+t,value:1}),e.weight=new i.NumberKeyframeTrack("weight",r),this},warp:function(e,t,r,n){var o=[];return o.push({time:this.time,value:t}),o.push({time:this.time+n,value:r}),e.timeScale=new i.NumberKeyframeTrack("timeScale",o),this},crossFade:function(e,t,r,n){if(this.fadeOut(e,r),this.fadeIn(t,r),n){var i=e.clip.duration/t.clip.duration,o=1/i;this.warp(e,1,i,r),this.warp(t,o,1,r)}return this},update:function(e){var t=e*this.timeScale;this.time+=t;for(var r=0;r<this.actions.length;r++){var n=this.actions[r],i=n.getWeightAt(this.time),o=n.getTimeScaleAt(this.time),a=t*o,s=n.update(a);if(!(n.weight<=0)&&n.enabled)for(var u=0;u<s.length;u++){n.clip.tracks[u].name;n.propertyBindings[u].accumulate(s[u],i)}}for(var h in this.propertyBindingMap)this.propertyBindingMap[h].apply();return this}},i.EventDispatcher.prototype.apply(i.AnimationMixer.prototype),i.AnimationUtils={getEqualsFunc:function(e){return e.equals?function(e,t){return e.equals(t)}:function(e,t){return e===t}},clone:function(e){var t=typeof e;if("object"===t){if(e.clone)return e.clone();console.error("can not figure out how to copy exemplarValue",e)}return e},lerp:function(e,t,r,n){var o=i.AnimationUtils.getLerpFunc(e,n);return o(e,t,r)},lerp_object:function(e,t,r){return e.lerp(t,r)},slerp_object:function(e,t,r){return e.slerp(t,r)},lerp_number:function(e,t,r){return e*(1-r)+t*r},lerp_boolean:function(e,t,r){return.5>r?e:t},lerp_boolean_immediate:function(e,t,r){return e},lerp_string:function(e,t,r){return.5>r?e:t},lerp_string_immediate:function(e,t,r){return e},getLerpFunc:function(e,t){if(void 0===e||null===e)throw new Error("examplarValue is null");var r=typeof e;switch(r){case"object":if(e.lerp)return i.AnimationUtils.lerp_object;if(e.slerp)return i.AnimationUtils.slerp_object;break;case"number":return i.AnimationUtils.lerp_number;case"boolean":return t?i.AnimationUtils.lerp_boolean:i.AnimationUtils.lerp_boolean_immediate;case"string":return t?i.AnimationUtils.lerp_string:i.AnimationUtils.lerp_string_immediate}}},i.KeyframeTrack=function(e,t){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keys in track named "+e);this.name=e,this.keys=t,this.lastIndex=0,this.validate(),this.optimize()},i.KeyframeTrack.prototype={constructor:i.KeyframeTrack,getAt:function(e){for(;this.lastIndex<this.keys.length&&e>=this.keys[this.lastIndex].time;)this.lastIndex++;for(;this.lastIndex>0&&e<this.keys[this.lastIndex-1].time;)this.lastIndex--;if(this.lastIndex>=this.keys.length)return this.setResult(this.keys[this.keys.length-1].value),this.result;if(0===this.lastIndex)return this.setResult(this.keys[0].value),this.result;var t=this.keys[this.lastIndex-1];if(this.setResult(t.value),t.constantToNext)return this.result;var r=this.keys[this.lastIndex],n=(e-t.time)/(r.time-t.time);return this.result=this.lerpValues(this.result,r.value,n),this.result},shift:function(e){if(0!==e)for(var t=0;t<this.keys.length;t++)this.keys[t].time+=e;return this},scale:function(e){if(1!==e)for(var t=0;t<this.keys.length;t++)this.keys[t].time*=e;return this},trim:function(e,t){for(var r=0,n=1;n<this.keys.length;n++)this.keys[n]<=e&&r++;for(var i=0,n=this.keys.length-2;n>0&&this.keys[n]>=t;n++)i++;return r+i>0&&(this.keys=this.keys.splice(r,this.keys.length-i-r)),this},validate:function(){var e=null;if(0===this.keys.length)return void console.error("  track is empty, no keys",this);for(var t=0;t<this.keys.length;t++){var r=this.keys[t];if(!r)return void console.error("  key is null in track",this,t);if("number"!=typeof r.time||isNaN(r.time))return void console.error("  key.time is not a valid number",this,t,r);if(void 0===r.value||null===r.value)return void console.error("  key.value is null in track",this,t,r);if(e&&e.time>r.time)return void console.error("  key.time is less than previous key time, out of order keys",this,t,r,e);e=r}return this},optimize:function(){var e=[],t=this.keys[0];e.push(t);for(var r=(i.AnimationUtils.getEqualsFunc(t.value),1);r<this.keys.length-1;r++){var n=this.keys[r],o=this.keys[r+1];t.time!==n.time&&(this.compareValues(t.value,n.value)&&this.compareValues(n.value,o.value)||(t.constantToNext=this.compareValues(t.value,n.value),e.push(n),t=n))}return e.push(this.keys[this.keys.length-1]),this.keys=e,this}},i.KeyframeTrack.keyComparer=function(e,t){return e.time-t.time},i.KeyframeTrack.parse=function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=i.KeyframeTrack.GetTrackTypeForTypeName(e.type);return t.parse(e)},i.KeyframeTrack.GetTrackTypeForTypeName=function(e){switch(e.toLowerCase()){case"vector":case"vector2":case"vector3":case"vector4":return i.VectorKeyframeTrack;case"quaternion":return i.QuaternionKeyframeTrack;case"integer":case"scalar":case"double":case"float":case"number":return i.NumberKeyframeTrack;case"bool":case"boolean":return i.BooleanKeyframeTrack;case"string":return i.StringKeyframeTrack}throw new Error("Unsupported typeName: "+e)},i.PropertyBinding=function(e,t){this.rootNode=e,this.trackName=t,this.referenceCount=0,this.originalValue=null;var r=i.PropertyBinding.parseTrackName(t);this.directoryName=r.directoryName,this.nodeName=r.nodeName,this.objectName=r.objectName,this.objectIndex=r.objectIndex,this.propertyName=r.propertyName,this.propertyIndex=r.propertyIndex,this.node=i.PropertyBinding.findNode(e,this.nodeName)||e,this.cumulativeValue=null,this.cumulativeWeight=0},i.PropertyBinding.prototype={constructor:i.PropertyBinding,reset:function(){this.cumulativeValue=null,this.cumulativeWeight=0},accumulate:function(e,t){if(this.isBound||this.bind(),0===this.cumulativeWeight)t>0&&(null===this.cumulativeValue&&(this.cumulativeValue=i.AnimationUtils.clone(e)),this.cumulativeWeight=t);else{var r=t/(this.cumulativeWeight+t);this.cumulativeValue=this.lerpValue(this.cumulativeValue,e,r),this.cumulativeWeight+=t}},unbind:function(){this.isBound&&(this.setValue(this.originalValue),this.setValue=null,this.getValue=null,this.lerpValue=null,this.equalsValue=null,this.triggerDirty=null,this.isBound=!1)},bind:function(){if(!this.isBound){var e=this.node;if(!e)return void console.error("  trying to update node for track: "+this.trackName+" but it wasn't found.");if(this.objectName){if("materials"===this.objectName){if(!e.material)return void console.error("  can not bind to material as node does not have a material",this);if(!e.material.materials)return void console.error("  can not bind to material.materials as node.material does not have a materials array",this);e=e.material.materials}else if("bones"===this.objectName){if(!e.skeleton)return void console.error("  can not bind to bones as node does not have a skeleton",this);e=e.skeleton.bones;for(var t=0;t<e.length;t++)if(e[t].name===this.objectIndex){this.objectIndex=t;break}}else{if(void 0===e[this.objectName])return void console.error("  can not bind to objectName of node, undefined",this);e=e[this.objectName]}if(void 0!==this.objectIndex){if(void 0===e[this.objectIndex])return void console.error("  trying to bind to objectIndex of objectName, but is undefined:",this,e);e=e[this.objectIndex]}}var r=e[this.propertyName];if(!r)return void console.error("  trying to update property for track: "+this.nodeName+"."+this.propertyName+" but it wasn't found.",e);if(void 0!==this.propertyIndex){if("morphTargetInfluences"===this.propertyName){e.geometry||console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry",this),e.geometry.morphTargets||console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry.morphTargets",this);for(var t=0;t<this.node.geometry.morphTargets.length;t++)if(e.geometry.morphTargets[t].name===this.propertyIndex){this.propertyIndex=t;break}}this.setValue=function(e){return this.equalsValue(r[this.propertyIndex],e)?!1:(r[this.propertyIndex]=e,!0)},this.getValue=function(){return r[this.propertyIndex]}}else r.copy?(this.setValue=function(e){return this.equalsValue(r,e)?!1:(r.copy(e),!0)},this.getValue=function(){return r}):(this.setValue=function(t){return this.equalsValue(e[this.propertyName],t)?!1:(e[this.propertyName]=t,!0)},this.getValue=function(){return e[this.propertyName]});void 0!==e.needsUpdate?this.triggerDirty=function(){this.node.needsUpdate=!0}:void 0!==e.matrixWorldNeedsUpdate&&(this.triggerDirty=function(){e.matrixWorldNeedsUpdate=!0}),this.originalValue=this.getValue(),this.equalsValue=i.AnimationUtils.getEqualsFunc(this.originalValue),this.lerpValue=i.AnimationUtils.getLerpFunc(this.originalValue,!0),this.isBound=!0}},apply:function(){if(this.isBound||this.bind(),this.cumulativeWeight>0){if(this.cumulativeWeight<1){var e=1-this.cumulativeWeight,t=e/(this.cumulativeWeight+e);this.cumulativeValue=this.lerpValue(this.cumulativeValue,this.originalValue,t)}var r=this.setValue(this.cumulativeValue);r&&this.triggerDirty&&this.triggerDirty(),this.cumulativeValue=null,this.cumulativeWeight=0}}},i.PropertyBinding.parseTrackName=function(e){var t=/^(([\w]+\/)*)([\w-\d]+)?(\.([\w]+)(\[([\w\d\[\]\_. ]+)\])?)?(\.([\w.]+)(\[([\w\d\[\]\_. ]+)\])?)$/,r=t.exec(e);if(!r)throw new Error("cannot parse trackName at all: "+e);r.index===t.lastIndex&&t.lastIndex++;var n={directoryName:r[1],nodeName:r[3],objectName:r[5],objectIndex:r[7],propertyName:r[9],propertyIndex:r[11]};if(null===n.propertyName||0===n.propertyName.length)throw new Error("can not parse propertyName from trackName: "+e);return n},i.PropertyBinding.findNode=function(e,t){function r(e){for(var r=0;r<e.bones.length;r++){var n=e.bones[r];if(n.name===t)return n}return null}function n(e){for(var r=0;r<e.length;r++){var i=e[r];if(i.name===t||i.uuid===t)return i;var o=n(i.children);if(o)return o}return null}if(!t||""===t||"root"===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){var i=r(e.skeleton);if(i)return i}if(e.children){var o=n(e.children);if(o)return o}return null},i.VectorKeyframeTrack=function(e,t){i.KeyframeTrack.call(this,e,t),this.result=this.keys[0].value.clone()},i.VectorKeyframeTrack.prototype=Object.create(i.KeyframeTrack.prototype),i.VectorKeyframeTrack.prototype.constructor=i.VectorKeyframeTrack,i.VectorKeyframeTrack.prototype.setResult=function(e){this.result.copy(e)},i.VectorKeyframeTrack.prototype.lerpValues=function(e,t,r){return e.lerp(t,r)},i.VectorKeyframeTrack.prototype.compareValues=function(e,t){return e.equals(t)},i.VectorKeyframeTrack.prototype.clone=function(){for(var e=[],t=0;t<this.keys.length;t++){var r=this.keys[t];e.push({time:r.time,value:r.value.clone()})}return new i.VectorKeyframeTrack(this.name,e)},i.VectorKeyframeTrack.parse=function(e){for(var t=e.keys[0].value.length,r=i["Vector"+t],n=[],o=0;o<e.keys.length;o++){var a=e.keys[o];n.push({value:(new r).fromArray(a.value),time:a.time})}return new i.VectorKeyframeTrack(e.name,n)},i.QuaternionKeyframeTrack=function(e,t){i.KeyframeTrack.call(this,e,t),this.result=this.keys[0].value.clone()},i.QuaternionKeyframeTrack.prototype=Object.create(i.KeyframeTrack.prototype),i.QuaternionKeyframeTrack.prototype.constructor=i.QuaternionKeyframeTrack,i.QuaternionKeyframeTrack.prototype.setResult=function(e){this.result.copy(e)},i.QuaternionKeyframeTrack.prototype.lerpValues=function(e,t,r){return e.slerp(t,r)},i.QuaternionKeyframeTrack.prototype.compareValues=function(e,t){return e.equals(t)},i.QuaternionKeyframeTrack.prototype.multiply=function(e){for(var t=0;t<this.keys.length;t++)this.keys[t].value.multiply(e);return this},i.QuaternionKeyframeTrack.prototype.clone=function(){for(var e=[],t=0;t<this.keys.length;t++){var r=this.keys[t];e.push({time:r.time,value:r.value.clone()})}return new i.QuaternionKeyframeTrack(this.name,e)},i.QuaternionKeyframeTrack.parse=function(e){for(var t=[],r=0;r<e.keys.length;r++){var n=e.keys[r];t.push({value:(new i.Quaternion).fromArray(n.value),time:n.time})}return new i.QuaternionKeyframeTrack(e.name,t)},i.StringKeyframeTrack=function(e,t){i.KeyframeTrack.call(this,e,t),this.result=this.keys[0].value},i.StringKeyframeTrack.prototype=Object.create(i.KeyframeTrack.prototype),i.StringKeyframeTrack.prototype.constructor=i.StringKeyframeTrack,i.StringKeyframeTrack.prototype.setResult=function(e){this.result=e},i.StringKeyframeTrack.prototype.lerpValues=function(e,t,r){return 1>r?e:t},i.StringKeyframeTrack.prototype.compareValues=function(e,t){return e===t},i.StringKeyframeTrack.prototype.clone=function(){for(var e=[],t=0;t<this.keys.length;t++){var r=this.keys[t];e.push({time:r.time,value:r.value})}return new i.StringKeyframeTrack(this.name,e)},i.StringKeyframeTrack.parse=function(e){return new i.StringKeyframeTrack(e.name,e.keys)},i.BooleanKeyframeTrack=function(e,t){i.KeyframeTrack.call(this,e,t),this.result=this.keys[0].value},i.BooleanKeyframeTrack.prototype=Object.create(i.KeyframeTrack.prototype),i.BooleanKeyframeTrack.prototype.constructor=i.BooleanKeyframeTrack,i.BooleanKeyframeTrack.prototype.setResult=function(e){this.result=e},i.BooleanKeyframeTrack.prototype.lerpValues=function(e,t,r){return 1>r?e:t},i.BooleanKeyframeTrack.prototype.compareValues=function(e,t){return e===t},i.BooleanKeyframeTrack.prototype.clone=function(){for(var e=[],t=0;t<this.keys.length;t++){var r=this.keys[t];e.push({time:r.time,value:r.value})}return new i.BooleanKeyframeTrack(this.name,e)},i.BooleanKeyframeTrack.parse=function(e){return new i.BooleanKeyframeTrack(e.name,e.keys)},i.NumberKeyframeTrack=function(e,t){i.KeyframeTrack.call(this,e,t),this.result=this.keys[0].value},i.NumberKeyframeTrack.prototype=Object.create(i.KeyframeTrack.prototype),i.NumberKeyframeTrack.prototype.constructor=i.NumberKeyframeTrack,i.NumberKeyframeTrack.prototype.setResult=function(e){this.result=e},i.NumberKeyframeTrack.prototype.lerpValues=function(e,t,r){return e*(1-r)+t*r},i.NumberKeyframeTrack.prototype.compareValues=function(e,t){return e===t},i.NumberKeyframeTrack.prototype.clone=function(){for(var e=[],t=0;t<this.keys.length;t++){var r=this.keys[t];e.push({time:r.time,value:r.value})}return new i.NumberKeyframeTrack(this.name,e)},i.NumberKeyframeTrack.parse=function(e){return new i.NumberKeyframeTrack(e.name,e.keys)},i.Camera=function(){i.Object3D.call(this),this.type="Camera",this.matrixWorldInverse=new i.Matrix4,this.projectionMatrix=new i.Matrix4},i.Camera.prototype=Object.create(i.Object3D.prototype),i.Camera.prototype.constructor=i.Camera,i.Camera.prototype.getWorldDirection=function(){var e=new i.Quaternion;return function(t){var r=t||new i.Vector3;return this.getWorldQuaternion(e),r.set(0,0,-1).applyQuaternion(e)}}(),i.Camera.prototype.lookAt=function(){var e=new i.Matrix4;return function(t){e.lookAt(this.position,t,this.up),this.quaternion.setFromRotationMatrix(e)}}(),i.Camera.prototype.clone=function(){return(new this.constructor).copy(this)},i.Camera.prototype.copy=function(e){return i.Object3D.prototype.copy.call(this,e),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},i.CubeCamera=function(e,t,r){i.Object3D.call(this),this.type="CubeCamera";var n=90,o=1,a=new i.PerspectiveCamera(n,o,e,t);a.up.set(0,-1,0),a.lookAt(new i.Vector3(1,0,0)),this.add(a);var s=new i.PerspectiveCamera(n,o,e,t);s.up.set(0,-1,0),s.lookAt(new i.Vector3(-1,0,0)),this.add(s);var u=new i.PerspectiveCamera(n,o,e,t);u.up.set(0,0,1),u.lookAt(new i.Vector3(0,1,0)),this.add(u);var h=new i.PerspectiveCamera(n,o,e,t);h.up.set(0,0,-1),h.lookAt(new i.Vector3(0,-1,0)),this.add(h);var c=new i.PerspectiveCamera(n,o,e,t);c.up.set(0,-1,0),c.lookAt(new i.Vector3(0,0,1)),this.add(c);var l=new i.PerspectiveCamera(n,o,e,t);l.up.set(0,-1,0),l.lookAt(new i.Vector3(0,0,-1)),this.add(l),this.renderTarget=new i.WebGLRenderTargetCube(r,r,{format:i.RGBFormat,magFilter:i.LinearFilter,minFilter:i.LinearFilter}),this.updateCubeMap=function(e,t){null===this.parent&&this.updateMatrixWorld();var r=this.renderTarget,n=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,r.activeCubeFace=0,e.render(t,a,r),r.activeCubeFace=1,e.render(t,s,r),r.activeCubeFace=2,e.render(t,u,r),r.activeCubeFace=3,e.render(t,h,r),r.activeCubeFace=4,e.render(t,c,r),r.texture.generateMipmaps=n,r.activeCubeFace=5,e.render(t,l,r),e.setRenderTarget(null)}},i.CubeCamera.prototype=Object.create(i.Object3D.prototype),i.CubeCamera.prototype.constructor=i.CubeCamera,i.OrthographicCamera=function(e,t,r,n,o,a){i.Camera.call(this),this.type="OrthographicCamera",this.zoom=1,this.left=e,this.right=t,this.top=r,this.bottom=n,this.near=void 0!==o?o:.1,this.far=void 0!==a?a:2e3,this.updateProjectionMatrix()},i.OrthographicCamera.prototype=Object.create(i.Camera.prototype),i.OrthographicCamera.prototype.constructor=i.OrthographicCamera,i.OrthographicCamera.prototype.updateProjectionMatrix=function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,n=(this.top+this.bottom)/2;this.projectionMatrix.makeOrthographic(r-e,r+e,n+t,n-t,this.near,this.far)},i.OrthographicCamera.prototype.copy=function(e){return i.Camera.prototype.copy.call(this,e),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this},i.OrthographicCamera.prototype.toJSON=function(e){var t=i.Object3D.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,t},i.PerspectiveCamera=function(e,t,r,n){i.Camera.call(this),this.type="PerspectiveCamera",this.zoom=1,this.fov=void 0!==e?e:50,this.aspect=void 0!==t?t:1,this.near=void 0!==r?r:.1,this.far=void 0!==n?n:2e3,this.updateProjectionMatrix()},i.PerspectiveCamera.prototype=Object.create(i.Camera.prototype),i.PerspectiveCamera.prototype.constructor=i.PerspectiveCamera,i.PerspectiveCamera.prototype.setLens=function(e,t){void 0===t&&(t=24),this.fov=2*i.Math.radToDeg(Math.atan(t/(2*e))),this.updateProjectionMatrix()},i.PerspectiveCamera.prototype.setViewOffset=function(e,t,r,n,i,o){this.fullWidth=e,this.fullHeight=t,this.x=r,this.y=n,this.width=i,this.height=o,this.updateProjectionMatrix()},i.PerspectiveCamera.prototype.updateProjectionMatrix=function(){var e=i.Math.radToDeg(2*Math.atan(Math.tan(.5*i.Math.degToRad(this.fov))/this.zoom));if(this.fullWidth){var t=this.fullWidth/this.fullHeight,r=Math.tan(i.Math.degToRad(.5*e))*this.near,n=-r,o=t*n,a=t*r,s=Math.abs(a-o),u=Math.abs(r-n);this.projectionMatrix.makeFrustum(o+this.x*s/this.fullWidth,o+(this.x+this.width)*s/this.fullWidth,r-(this.y+this.height)*u/this.fullHeight,r-this.y*u/this.fullHeight,this.near,this.far)}else this.projectionMatrix.makePerspective(e,this.aspect,this.near,this.far)},i.PerspectiveCamera.prototype.copy=function(e){return i.Camera.prototype.copy.call(this,e),this.fov=e.fov,this.aspect=e.aspect,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this},i.PerspectiveCamera.prototype.toJSON=function(e){var t=i.Object3D.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.fov=this.fov,t.object.aspect=this.aspect,t.object.near=this.near,t.object.far=this.far,t},i.Light=function(e){i.Object3D.call(this),this.type="Light",this.color=new i.Color(e),this.receiveShadow=void 0},i.Light.prototype=Object.create(i.Object3D.prototype),i.Light.prototype.constructor=i.Light,Object.defineProperties(i.Light.prototype,{onlyShadow:{set:function(e){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){this.shadow.camera.far=e}},shadowCameraVisible:{set:function(e){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow ) instead.")}},shadowBias:{set:function(e){this.shadow.bias=e}},shadowDarkness:{set:function(e){this.shadow.darkness=e}},shadowMapWidth:{set:function(e){this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){this.shadow.mapSize.height=e}}}),i.Light.prototype.copy=function(e){return i.Object3D.prototype.copy.call(this,e),this.color.copy(e.color),this},i.Light.prototype.toJSON=function(e){var t=i.Object3D.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.intensity&&(t.object.intensity=this.intensity),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.exponent&&(t.object.exponent=this.exponent),t},i.LightShadow=function(e){this.camera=e,this.bias=0,this.darkness=1,this.mapSize=new i.Vector2(512,512),this.map=null,this.matrix=null},i.LightShadow.prototype={constructor:i.LightShadow,copy:function(e){this.camera=e.camera.clone(),this.bias=e.bias,this.darkness=e.darkness,this.mapSize.copy(e.mapSize)},clone:function(){return(new this.constructor).copy(this)}},i.AmbientLight=function(e){i.Light.call(this,e),this.type="AmbientLight",this.castShadow=void 0},i.AmbientLight.prototype=Object.create(i.Light.prototype),i.AmbientLight.prototype.constructor=i.AmbientLight,i.DirectionalLight=function(e,t){i.Light.call(this,e),this.type="DirectionalLight",this.position.set(0,1,0),this.updateMatrix(),this.target=new i.Object3D,this.intensity=void 0!==t?t:1,this.shadow=new i.LightShadow(new i.OrthographicCamera(-500,500,500,-500,50,5e3))},i.DirectionalLight.prototype=Object.create(i.Light.prototype),i.DirectionalLight.prototype.constructor=i.DirectionalLight,i.DirectionalLight.prototype.copy=function(e){return i.Light.prototype.copy.call(this,e),this.intensity=e.intensity,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this},i.HemisphereLight=function(e,t,r){i.Light.call(this,e),this.type="HemisphereLight",this.castShadow=void 0,this.position.set(0,1,0),this.updateMatrix(),this.groundColor=new i.Color(t),this.intensity=void 0!==r?r:1},i.HemisphereLight.prototype=Object.create(i.Light.prototype),i.HemisphereLight.prototype.constructor=i.HemisphereLight,i.HemisphereLight.prototype.copy=function(e){return i.Light.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this.intensity=e.intensity,this},i.PointLight=function(e,t,r,n){i.Light.call(this,e),this.type="PointLight",this.intensity=void 0!==t?t:1,this.distance=void 0!==r?r:0,this.decay=void 0!==n?n:1,this.shadow=new i.LightShadow(new i.PerspectiveCamera(90,1,1,500))},i.PointLight.prototype=Object.create(i.Light.prototype),i.PointLight.prototype.constructor=i.PointLight,i.PointLight.prototype.copy=function(e){return i.Light.prototype.copy.call(this,e),this.intensity=e.intensity,this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this},i.SpotLight=function(e,t,r,n,o,a){i.Light.call(this,e),this.type="SpotLight",this.position.set(0,1,0),this.updateMatrix(),this.target=new i.Object3D,this.intensity=void 0!==t?t:1,this.distance=void 0!==r?r:0,this.angle=void 0!==n?n:Math.PI/3,this.exponent=void 0!==o?o:10,this.decay=void 0!==a?a:1,this.shadow=new i.LightShadow(new i.PerspectiveCamera(50,1,50,5e3))},i.SpotLight.prototype=Object.create(i.Light.prototype),i.SpotLight.prototype.constructor=i.SpotLight,i.SpotLight.prototype.copy=function(e){return i.Light.prototype.copy.call(this,e),this.intensity=e.intensity,this.distance=e.distance,this.angle=e.angle,this.exponent=e.exponent,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this},i.Cache={enabled:!1,files:{},add:function(e,t){this.enabled!==!1&&(this.files[e]=t)},get:function(e){return this.enabled!==!1?this.files[e]:void 0},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},i.Loader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}},i.Loader.prototype={constructor:i.Loader,crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,r){for(var n=[],i=0;i<e.length;++i)n[i]=this.createMaterial(e[i],t,r);return n},createMaterial:function(){var e,t,r;return function(n,o,a){function s(e,r,n,s,h){var c,l=o+e,p=i.Loader.Handlers.get(l);null!==p?c=p.load(l):(t.setCrossOrigin(a),c=t.load(l)),void 0!==r&&(c.repeat.fromArray(r),1!==r[0]&&(c.wrapS=i.RepeatWrapping),1!==r[1]&&(c.wrapT=i.RepeatWrapping)),void 0!==n&&c.offset.fromArray(n),void 0!==s&&("repeat"===s[0]&&(c.wrapS=i.RepeatWrapping),
"mirror"===s[0]&&(c.wrapS=i.MirroredRepeatWrapping),"repeat"===s[1]&&(c.wrapT=i.RepeatWrapping),"mirror"===s[1]&&(c.wrapT=i.MirroredRepeatWrapping)),void 0!==h&&(c.anisotropy=h);var f=i.Math.generateUUID();return u[f]=c,f}void 0===e&&(e=new i.Color),void 0===t&&(t=new i.TextureLoader),void 0===r&&(r=new i.MaterialLoader);var u={},h={uuid:i.Math.generateUUID(),type:"MeshLambertMaterial"};for(var c in n){var l=n[c];switch(c){case"DbgColor":h.color=l;break;case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":h.name=l;break;case"blending":h.blending=i[l];break;case"colorDiffuse":h.color=e.fromArray(l).getHex();break;case"colorSpecular":h.specular=e.fromArray(l).getHex();break;case"colorEmissive":h.emissive=e.fromArray(l).getHex();break;case"specularCoef":h.shininess=l;break;case"shading":"basic"===l.toLowerCase()&&(h.type="MeshBasicMaterial"),"phong"===l.toLowerCase()&&(h.type="MeshPhongMaterial");break;case"mapDiffuse":h.map=s(l,n.mapDiffuseRepeat,n.mapDiffuseOffset,n.mapDiffuseWrap,n.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapLight":h.lightMap=s(l,n.mapLightRepeat,n.mapLightOffset,n.mapLightWrap,n.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":h.aoMap=s(l,n.mapAORepeat,n.mapAOOffset,n.mapAOWrap,n.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":h.bumpMap=s(l,n.mapBumpRepeat,n.mapBumpOffset,n.mapBumpWrap,n.mapBumpAnisotropy);break;case"mapBumpScale":h.bumpScale=l;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":h.normalMap=s(l,n.mapNormalRepeat,n.mapNormalOffset,n.mapNormalWrap,n.mapNormalAnisotropy);break;case"mapNormalFactor":h.normalScale=[l,l];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":h.specularMap=s(l,n.mapSpecularRepeat,n.mapSpecularOffset,n.mapSpecularWrap,n.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapAlpha":h.alphaMap=s(l,n.mapAlphaRepeat,n.mapAlphaOffset,n.mapAlphaWrap,n.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":h.side=i.BackSide;break;case"doubleSided":h.side=i.DoubleSide;break;case"transparency":console.warn("THREE.Loader: transparency has been renamed to opacity"),h.opacity=l;break;case"opacity":case"transparent":case"depthTest":case"depthWrite":case"transparent":case"visible":case"wireframe":h[c]=l;break;case"vertexColors":l===!0&&(h.vertexColors=i.VertexColors),"face"===l&&(h.vertexColors=i.FaceColors);break;default:console.error("Loader.createMaterial: Unsupported",c,l)}}return"MeshPhongMaterial"!==h.type&&delete h.specular,h.opacity<1&&(h.transparent=!0),r.setTextures(u),r.parse(h)}}()},i.Loader.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,r=0,n=t.length;n>r;r+=2){var i=t[r],o=t[r+1];if(i.test(e))return o}return null}},i.XHRLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager},i.XHRLoader.prototype={constructor:i.XHRLoader,load:function(e,t,r,n){var o=this,a=i.Cache.get(e);if(void 0!==a)return t&&setTimeout(function(){t(a)},0),a;var s=new XMLHttpRequest;return s.open("GET",e,!0),s.addEventListener("load",function(r){var n=r.target.response;i.Cache.add(e,n),t&&t(n),o.manager.itemEnd(e)},!1),void 0!==r&&s.addEventListener("progress",function(e){r(e)},!1),s.addEventListener("error",function(t){n&&n(t),o.manager.itemError(e)},!1),void 0!==this.crossOrigin&&(s.crossOrigin=this.crossOrigin),void 0!==this.responseType&&(s.responseType=this.responseType),void 0!==this.withCredentials&&(s.withCredentials=this.withCredentials),s.send(null),o.manager.itemStart(e),s},setResponseType:function(e){this.responseType=e},setCrossOrigin:function(e){this.crossOrigin=e},setWithCredentials:function(e){this.withCredentials=e}},i.ImageLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager},i.ImageLoader.prototype={constructor:i.ImageLoader,load:function(e,t,r,n){var o=this,a=i.Cache.get(e);if(void 0!==a)return o.manager.itemStart(e),t?setTimeout(function(){t(a),o.manager.itemEnd(e)},0):o.manager.itemEnd(e),a;var s=document.createElement("img");return s.addEventListener("load",function(r){i.Cache.add(e,this),t&&t(this),o.manager.itemEnd(e)},!1),void 0!==r&&s.addEventListener("progress",function(e){r(e)},!1),s.addEventListener("error",function(t){n&&n(t),o.manager.itemError(e)},!1),void 0!==this.crossOrigin&&(s.crossOrigin=this.crossOrigin),o.manager.itemStart(e),s.src=e,s},setCrossOrigin:function(e){this.crossOrigin=e}},i.JSONLoader=function(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:i.DefaultLoadingManager,this.withCredentials=!1},i.JSONLoader.prototype={constructor:i.JSONLoader,get statusDomElement(){return void 0===this._statusDomElement&&(this._statusDomElement=document.createElement("div")),console.warn("THREE.JSONLoader: .statusDomElement has been removed."),this._statusDomElement},load:function(e,t,r,n){var o=this,a=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:i.Loader.prototype.extractUrlBase(e),s=new i.XHRLoader(this.manager);s.setCrossOrigin(this.crossOrigin),s.setWithCredentials(this.withCredentials),s.load(e,function(r){var n=JSON.parse(r),i=n.metadata;if(void 0!==i){if("object"===i.type)return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.ObjectLoader instead.");if("scene"===i.type)return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.SceneLoader instead.")}var s=o.parse(n,a);t(s.geometry,s.materials)})},setCrossOrigin:function(e){this.crossOrigin=e},setTexturePath:function(e){this.texturePath=e},parse:function(e,t){function r(t){function r(e,t){return e&1<<t}var n,o,a,u,h,c,l,p,f,d,m,g,v,x,y,_,b,w,T,M,S,E,C,R,D,A,P,L=e.faces,B=e.vertices,F=e.normals,G=e.colors,U=0;if(void 0!==e.uvs){for(n=0;n<e.uvs.length;n++)e.uvs[n].length&&U++;for(n=0;U>n;n++)s.faceVertexUvs[n]=[]}for(u=0,h=B.length;h>u;)w=new i.Vector3,w.x=B[u++]*t,w.y=B[u++]*t,w.z=B[u++]*t,s.vertices.push(w);for(u=0,h=L.length;h>u;)if(d=L[u++],m=r(d,0),g=r(d,1),v=r(d,3),x=r(d,4),y=r(d,5),_=r(d,6),b=r(d,7),m){if(M=new i.Face3,M.a=L[u],M.b=L[u+1],M.c=L[u+3],S=new i.Face3,S.a=L[u+1],S.b=L[u+2],S.c=L[u+3],u+=4,g&&(f=L[u++],M.materialIndex=f,S.materialIndex=f),a=s.faces.length,v)for(n=0;U>n;n++)for(R=e.uvs[n],s.faceVertexUvs[n][a]=[],s.faceVertexUvs[n][a+1]=[],o=0;4>o;o++)p=L[u++],A=R[2*p],P=R[2*p+1],D=new i.Vector2(A,P),2!==o&&s.faceVertexUvs[n][a].push(D),0!==o&&s.faceVertexUvs[n][a+1].push(D);if(x&&(l=3*L[u++],M.normal.set(F[l++],F[l++],F[l]),S.normal.copy(M.normal)),y)for(n=0;4>n;n++)l=3*L[u++],C=new i.Vector3(F[l++],F[l++],F[l]),2!==n&&M.vertexNormals.push(C),0!==n&&S.vertexNormals.push(C);if(_&&(c=L[u++],E=G[c],M.color.setHex(E),S.color.setHex(E)),b)for(n=0;4>n;n++)c=L[u++],E=G[c],2!==n&&M.vertexColors.push(new i.Color(E)),0!==n&&S.vertexColors.push(new i.Color(E));s.faces.push(M),s.faces.push(S)}else{if(T=new i.Face3,T.a=L[u++],T.b=L[u++],T.c=L[u++],g&&(f=L[u++],T.materialIndex=f),a=s.faces.length,v)for(n=0;U>n;n++)for(R=e.uvs[n],s.faceVertexUvs[n][a]=[],o=0;3>o;o++)p=L[u++],A=R[2*p],P=R[2*p+1],D=new i.Vector2(A,P),s.faceVertexUvs[n][a].push(D);if(x&&(l=3*L[u++],T.normal.set(F[l++],F[l++],F[l])),y)for(n=0;3>n;n++)l=3*L[u++],C=new i.Vector3(F[l++],F[l++],F[l]),T.vertexNormals.push(C);if(_&&(c=L[u++],T.color.setHex(G[c])),b)for(n=0;3>n;n++)c=L[u++],T.vertexColors.push(new i.Color(G[c]));s.faces.push(T)}}function n(){var t=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var r=0,n=e.skinWeights.length;n>r;r+=t){var o=e.skinWeights[r],a=t>1?e.skinWeights[r+1]:0,u=t>2?e.skinWeights[r+2]:0,h=t>3?e.skinWeights[r+3]:0;s.skinWeights.push(new i.Vector4(o,a,u,h))}if(e.skinIndices)for(var r=0,n=e.skinIndices.length;n>r;r+=t){var c=e.skinIndices[r],l=t>1?e.skinIndices[r+1]:0,p=t>2?e.skinIndices[r+2]:0,f=t>3?e.skinIndices[r+3]:0;s.skinIndices.push(new i.Vector4(c,l,p,f))}s.bones=e.bones,s.bones&&s.bones.length>0&&(s.skinWeights.length!==s.skinIndices.length||s.skinIndices.length!==s.vertices.length)&&console.warn("When skinning, number of vertices ("+s.vertices.length+"), skinIndices ("+s.skinIndices.length+"), and skinWeights ("+s.skinWeights.length+") should match.")}function o(t){if(void 0!==e.morphTargets)for(var r=0,n=e.morphTargets.length;n>r;r++){s.morphTargets[r]={},s.morphTargets[r].name=e.morphTargets[r].name,s.morphTargets[r].vertices=[];for(var o=s.morphTargets[r].vertices,a=e.morphTargets[r].vertices,u=0,h=a.length;h>u;u+=3){var c=new i.Vector3;c.x=a[u]*t,c.y=a[u+1]*t,c.z=a[u+2]*t,o.push(c)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');for(var l=s.faces,p=e.morphColors[0].colors,r=0,n=l.length;n>r;r++)l[r].color.fromArray(p,3*r)}}function a(){var t=[],r=[];void 0!==e.animation&&r.push(e.animation),void 0!==e.animations&&(e.animations.length?r=r.concat(e.animations):r.push(e.animations));for(var n=0;n<r.length;n++){var o=i.AnimationClip.parseAnimation(r[n],s.bones);o&&t.push(o)}if(s.morphTargets){var a=i.AnimationClip.CreateClipsFromMorphTargetSequences(s.morphTargets,10);t=t.concat(a)}t.length>0&&(s.animations=t)}var s=new i.Geometry,u=void 0!==e.scale?1/e.scale:1;if(r(u),n(),o(u),a(),s.computeFaceNormals(),s.computeBoundingSphere(),void 0===e.materials||0===e.materials.length)return{geometry:s};var h=i.Loader.prototype.initMaterials(e.materials,t,this.crossOrigin);return{geometry:s,materials:h}}},i.LoadingManager=function(e,t,r){var n=this,i=!1,o=0,a=0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){a++,i===!1&&void 0!==n.onStart&&n.onStart(e,o,a),i=!0},this.itemEnd=function(e){o++,void 0!==n.onProgress&&n.onProgress(e,o,a),o===a&&(i=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)}},i.DefaultLoadingManager=new i.LoadingManager,i.BufferGeometryLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager},i.BufferGeometryLoader.prototype={constructor:i.BufferGeometryLoader,load:function(e,t,r,n){var o=this,a=new i.XHRLoader(o.manager);a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){t(o.parse(JSON.parse(e)))},r,n)},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e){var t=new i.BufferGeometry,r=e.data.index;if(void 0!==r){var o=new n[r.type](r.array);t.setIndex(new i.BufferAttribute(o,1))}var a=e.data.attributes;for(var s in a){var u=a[s],o=new n[u.type](u.array);t.addAttribute(s,new i.BufferAttribute(o,u.itemSize))}var h=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==h)for(var c=0,l=h.length;c!==l;++c){var p=h[c];t.addGroup(p.start,p.count)}var f=e.data.boundingSphere;if(void 0!==f){var d=new i.Vector3;void 0!==f.center&&d.fromArray(f.center),t.boundingSphere=new i.Sphere(d,f.radius)}return t}},i.MaterialLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager,this.textures={}},i.MaterialLoader.prototype={constructor:i.MaterialLoader,load:function(e,t,r,n){var o=this,a=new i.XHRLoader(o.manager);a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){t(o.parse(JSON.parse(e)))},r,n)},setCrossOrigin:function(e){this.crossOrigin=e},setTextures:function(e){this.textures=e},getTexture:function(e){var t=this.textures;return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]},parse:function(e){var t=new i[e.type];if(t.uuid=e.uuid,void 0!==e.name&&(t.name=e.name),void 0!==e.color&&t.color.setHex(e.color),void 0!==e.emissive&&t.emissive.setHex(e.emissive),void 0!==e.specular&&t.specular.setHex(e.specular),void 0!==e.shininess&&(t.shininess=e.shininess),void 0!==e.uniforms&&(t.uniforms=e.uniforms),void 0!==e.vertexShader&&(t.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(t.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(t.vertexColors=e.vertexColors),void 0!==e.shading&&(t.shading=e.shading),void 0!==e.blending&&(t.blending=e.blending),void 0!==e.side&&(t.side=e.side),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.transparent&&(t.transparent=e.transparent),void 0!==e.alphaTest&&(t.alphaTest=e.alphaTest),void 0!==e.depthTest&&(t.depthTest=e.depthTest),void 0!==e.depthWrite&&(t.depthWrite=e.depthWrite),void 0!==e.wireframe&&(t.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(t.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.size&&(t.size=e.size),void 0!==e.sizeAttenuation&&(t.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(t.map=this.getTexture(e.map)),void 0!==e.alphaMap&&(t.alphaMap=this.getTexture(e.alphaMap),t.transparent=!0),void 0!==e.bumpMap&&(t.bumpMap=this.getTexture(e.bumpMap)),void 0!==e.bumpScale&&(t.bumpScale=e.bumpScale),void 0!==e.normalMap&&(t.normalMap=this.getTexture(e.normalMap)),e.normalScale&&(t.normalScale=new i.Vector2(e.normalScale,e.normalScale)),void 0!==e.displacementMap&&(t.displacementMap=this.getTexture(e.displacementMap)),void 0!==e.displacementScale&&(t.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(t.displacementBias=e.displacementBias),void 0!==e.specularMap&&(t.specularMap=this.getTexture(e.specularMap)),void 0!==e.envMap&&(t.envMap=this.getTexture(e.envMap),t.combine=i.MultiplyOperation),e.reflectivity&&(t.reflectivity=e.reflectivity),void 0!==e.lightMap&&(t.lightMap=this.getTexture(e.lightMap)),void 0!==e.lightMapIntensity&&(t.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(t.aoMap=this.getTexture(e.aoMap)),void 0!==e.aoMapIntensity&&(t.aoMapIntensity=e.aoMapIntensity),void 0!==e.materials)for(var r=0,n=e.materials.length;n>r;r++)t.materials.push(this.parse(e.materials[r]));return t}},i.ObjectLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager,this.texturePath=""},i.ObjectLoader.prototype={constructor:i.ObjectLoader,load:function(e,t,r,n){""===this.texturePath&&(this.texturePath=e.substring(0,e.lastIndexOf("/")+1));var o=this,a=new i.XHRLoader(o.manager);a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){o.parse(JSON.parse(e),t)},r,n)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var r=this.parseGeometries(e.geometries),n=this.parseImages(e.images,function(){void 0!==t&&t(a)}),i=this.parseTextures(e.textures,n),o=this.parseMaterials(e.materials,i),a=this.parseObject(e.object,r,o);return e.animations&&(a.animations=this.parseAnimations(e.animations)),(void 0===e.images||0===e.images.length)&&void 0!==t&&t(a),a},parseGeometries:function(e){var t={};if(void 0!==e)for(var r=new i.JSONLoader,n=new i.BufferGeometryLoader,o=0,a=e.length;a>o;o++){var s,u=e[o];switch(u.type){case"PlaneGeometry":case"PlaneBufferGeometry":s=new i[u.type](u.width,u.height,u.widthSegments,u.heightSegments);break;case"BoxGeometry":case"CubeGeometry":s=new i.BoxGeometry(u.width,u.height,u.depth,u.widthSegments,u.heightSegments,u.depthSegments);break;case"CircleBufferGeometry":s=new i.CircleBufferGeometry(u.radius,u.segments,u.thetaStart,u.thetaLength);break;case"CircleGeometry":s=new i.CircleGeometry(u.radius,u.segments,u.thetaStart,u.thetaLength);break;case"CylinderGeometry":s=new i.CylinderGeometry(u.radiusTop,u.radiusBottom,u.height,u.radialSegments,u.heightSegments,u.openEnded,u.thetaStart,u.thetaLength);break;case"SphereGeometry":s=new i.SphereGeometry(u.radius,u.widthSegments,u.heightSegments,u.phiStart,u.phiLength,u.thetaStart,u.thetaLength);break;case"SphereBufferGeometry":s=new i.SphereBufferGeometry(u.radius,u.widthSegments,u.heightSegments,u.phiStart,u.phiLength,u.thetaStart,u.thetaLength);break;case"DodecahedronGeometry":s=new i.DodecahedronGeometry(u.radius,u.detail);break;case"IcosahedronGeometry":s=new i.IcosahedronGeometry(u.radius,u.detail);break;case"OctahedronGeometry":s=new i.OctahedronGeometry(u.radius,u.detail);break;case"TetrahedronGeometry":s=new i.TetrahedronGeometry(u.radius,u.detail);break;case"RingGeometry":s=new i.RingGeometry(u.innerRadius,u.outerRadius,u.thetaSegments,u.phiSegments,u.thetaStart,u.thetaLength);break;case"TorusGeometry":s=new i.TorusGeometry(u.radius,u.tube,u.radialSegments,u.tubularSegments,u.arc);break;case"TorusKnotGeometry":s=new i.TorusKnotGeometry(u.radius,u.tube,u.radialSegments,u.tubularSegments,u.p,u.q,u.heightScale);break;case"BufferGeometry":s=n.parse(u);break;case"Geometry":s=r.parse(u.data,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+u.type+'"');continue}s.uuid=u.uuid,void 0!==u.name&&(s.name=u.name),t[u.uuid]=s}return t},parseMaterials:function(e,t){var r={};if(void 0!==e){var n=new i.MaterialLoader;n.setTextures(t);for(var o=0,a=e.length;a>o;o++){var s=n.parse(e[o]);r[s.uuid]=s}}return r},parseAnimations:function(e){for(var t=[],r=0;r<e.length;r++){var n=i.AnimationClip.parse(e[r]);t.push(n)}return t},parseImages:function(e,t){function r(e){return n.manager.itemStart(e),s.load(e,function(){n.manager.itemEnd(e)})}var n=this,o={};if(void 0!==e&&e.length>0){var a=new i.LoadingManager(t),s=new i.ImageLoader(a);s.setCrossOrigin(this.crossOrigin);for(var u=0,h=e.length;h>u;u++){var c=e[u],l=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(c.url)?c.url:n.texturePath+c.url;o[c.uuid]=r(l)}}return o},parseTextures:function(e,t){function r(e){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),i[e])}var n={};if(void 0!==e)for(var o=0,a=e.length;a>o;o++){var s=e[o];void 0===s.image&&console.warn('THREE.ObjectLoader: No "image" specified for',s.uuid),void 0===t[s.image]&&console.warn("THREE.ObjectLoader: Undefined image",s.image);var u=new i.Texture(t[s.image]);u.needsUpdate=!0,u.uuid=s.uuid,void 0!==s.name&&(u.name=s.name),void 0!==s.mapping&&(u.mapping=r(s.mapping)),void 0!==s.offset&&(u.offset=new i.Vector2(s.offset[0],s.offset[1])),void 0!==s.repeat&&(u.repeat=new i.Vector2(s.repeat[0],s.repeat[1])),void 0!==s.minFilter&&(u.minFilter=r(s.minFilter)),void 0!==s.magFilter&&(u.magFilter=r(s.magFilter)),void 0!==s.anisotropy&&(u.anisotropy=s.anisotropy),Array.isArray(s.wrap)&&(u.wrapS=r(s.wrap[0]),u.wrapT=r(s.wrap[1])),n[s.uuid]=u}return n},parseObject:function(){var e=new i.Matrix4;return function(t,r,n){function o(e){return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),r[e]}function a(e){return void 0!==e?(void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),n[e]):void 0}var s;switch(t.type){case"Scene":s=new i.Scene;break;case"PerspectiveCamera":s=new i.PerspectiveCamera(t.fov,t.aspect,t.near,t.far);break;case"OrthographicCamera":s=new i.OrthographicCamera(t.left,t.right,t.top,t.bottom,t.near,t.far);break;case"AmbientLight":s=new i.AmbientLight(t.color);break;case"DirectionalLight":s=new i.DirectionalLight(t.color,t.intensity);break;case"PointLight":s=new i.PointLight(t.color,t.intensity,t.distance,t.decay);break;case"SpotLight":s=new i.SpotLight(t.color,t.intensity,t.distance,t.angle,t.exponent,t.decay);break;case"HemisphereLight":s=new i.HemisphereLight(t.color,t.groundColor,t.intensity);break;case"Mesh":s=new i.Mesh(o(t.geometry),a(t.material));break;case"LOD":s=new i.LOD;break;case"Line":s=new i.Line(o(t.geometry),a(t.material),t.mode);break;case"PointCloud":case"Points":s=new i.Points(o(t.geometry),a(t.material));break;case"Sprite":s=new i.Sprite(a(t.material));break;case"Group":s=new i.Group;break;default:s=new i.Object3D}if(s.uuid=t.uuid,void 0!==t.name&&(s.name=t.name),void 0!==t.matrix?(e.fromArray(t.matrix),e.decompose(s.position,s.quaternion,s.scale)):(void 0!==t.position&&s.position.fromArray(t.position),void 0!==t.rotation&&s.rotation.fromArray(t.rotation),void 0!==t.scale&&s.scale.fromArray(t.scale)),void 0!==t.castShadow&&(s.castShadow=t.castShadow),void 0!==t.receiveShadow&&(s.receiveShadow=t.receiveShadow),void 0!==t.visible&&(s.visible=t.visible),void 0!==t.userData&&(s.userData=t.userData),void 0!==t.children)for(var u in t.children)s.add(this.parseObject(t.children[u],r,n));if("LOD"===t.type)for(var h=t.levels,c=0;c<h.length;c++){var l=h[c],u=s.getObjectByProperty("uuid",l.object);void 0!==u&&s.addLevel(u,l.distance)}return s}}()},i.TextureLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager},i.TextureLoader.prototype={constructor:i.TextureLoader,load:function(e,t,r,n){var o=new i.Texture,a=new i.ImageLoader(this.manager);return a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){o.image=e,o.needsUpdate=!0,void 0!==t&&t(o)},r,n),o},setCrossOrigin:function(e){this.crossOrigin=e}},i.CubeTextureLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager},i.CubeTextureLoader.prototype={constructor:i.CubeTextureLoader,load:function(e,t,r,n){function o(r){s.load(e[r],function(e){a.images[r]=e,u++,6===u&&(a.needsUpdate=!0,t&&t(a))},void 0,n)}var a=new i.CubeTexture([]),s=new i.ImageLoader;s.setCrossOrigin(this.crossOrigin);for(var u=0,h=0;h<e.length;++h)o(h);return a},setCrossOrigin:function(e){this.crossOrigin=e}},i.DataTextureLoader=i.BinaryTextureLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager,this._parser=null},i.BinaryTextureLoader.prototype={constructor:i.BinaryTextureLoader,load:function(e,t,r,n){var o=this,a=new i.DataTexture,s=new i.XHRLoader(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setResponseType("arraybuffer"),s.load(e,function(e){var r=o._parser(e);r&&(void 0!==r.image?a.image=r.image:void 0!==r.data&&(a.image.width=r.width,a.image.height=r.height,a.image.data=r.data),a.wrapS=void 0!==r.wrapS?r.wrapS:i.ClampToEdgeWrapping,a.wrapT=void 0!==r.wrapT?r.wrapT:i.ClampToEdgeWrapping,a.magFilter=void 0!==r.magFilter?r.magFilter:i.LinearFilter,a.minFilter=void 0!==r.minFilter?r.minFilter:i.LinearMipMapLinearFilter,a.anisotropy=void 0!==r.anisotropy?r.anisotropy:1,void 0!==r.format&&(a.format=r.format),void 0!==r.type&&(a.type=r.type),void 0!==r.mipmaps&&(a.mipmaps=r.mipmaps),1===r.mipmapCount&&(a.minFilter=i.LinearFilter),a.needsUpdate=!0,t&&t(a,r))},r,n),a},setCrossOrigin:function(e){this.crossOrigin=e}},i.CompressedTextureLoader=function(e){this.manager=void 0!==e?e:i.DefaultLoadingManager,this._parser=null},i.CompressedTextureLoader.prototype={constructor:i.CompressedTextureLoader,load:function(e,t,r,n){var o=this,a=[],s=new i.CompressedTexture;s.image=a;var u=new i.XHRLoader(this.manager);if(u.setCrossOrigin(this.crossOrigin),u.setResponseType("arraybuffer"),Array.isArray(e))for(var h=0,c=function(c){u.load(e[c],function(e){var r=o._parser(e,!0);a[c]={width:r.width,height:r.height,format:r.format,mipmaps:r.mipmaps},h+=1,6===h&&(1===r.mipmapCount&&(s.minFilter=i.LinearFilter),s.format=r.format,s.needsUpdate=!0,t&&t(s))},r,n)},l=0,p=e.length;p>l;++l)c(l);else u.load(e,function(e){var r=o._parser(e,!0);if(r.isCubemap)for(var n=r.mipmaps.length/r.mipmapCount,u=0;n>u;u++){a[u]={mipmaps:[]};for(var h=0;h<r.mipmapCount;h++)a[u].mipmaps.push(r.mipmaps[u*r.mipmapCount+h]),a[u].format=r.format,a[u].width=r.width,a[u].height=r.height}else s.image.width=r.width,s.image.height=r.height,s.mipmaps=r.mipmaps;1===r.mipmapCount&&(s.minFilter=i.LinearFilter),s.format=r.format,s.needsUpdate=!0,t&&t(s)},r,n);return s},setCrossOrigin:function(e){this.crossOrigin=e}},i.Material=function(){Object.defineProperty(this,"id",{value:i.MaterialIdCount++}),this.uuid=i.Math.generateUUID(),this.name="",this.type="Material",this.side=i.FrontSide,this.opacity=1,this.transparent=!1,this.blending=i.NormalBlending,this.blendSrc=i.SrcAlphaFactor,this.blendDst=i.OneMinusSrcAlphaFactor,this.blendEquation=i.AddEquation,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=i.LessEqualDepth,this.depthTest=!0,this.depthWrite=!0,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.overdraw=0,this.visible=!0,this._needsUpdate=!0},i.Material.prototype={constructor:i.Material,get needsUpdate(){return this._needsUpdate},set needsUpdate(e){e===!0&&this.update(),this._needsUpdate=e},setValues:function(e){if(void 0!==e)for(var t in e){var r=e[t];if(void 0!==r){var n=this[t];void 0!==n?n instanceof i.Color?n.set(r):n instanceof i.Vector3&&r instanceof i.Vector3?n.copy(r):"overdraw"===t?this[t]=Number(r):this[t]=r:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){var t={metadata:{version:4.4,type:"Material",generator:"Material.toJSON"}};return t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),this.color instanceof i.Color&&(t.color=this.color.getHex()),this.emissive instanceof i.Color&&(t.emissive=this.emissive.getHex()),this.specular instanceof i.Color&&(t.specular=this.specular.getHex()),void 0!==this.shininess&&(t.shininess=this.shininess),this.map instanceof i.Texture&&(t.map=this.map.toJSON(e).uuid),this.alphaMap instanceof i.Texture&&(t.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap instanceof i.Texture&&(t.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap instanceof i.Texture&&(t.bumpMap=this.bumpMap.toJSON(e).uuid,t.bumpScale=this.bumpScale),this.normalMap instanceof i.Texture&&(t.normalMap=this.normalMap.toJSON(e).uuid,t.normalScale=this.normalScale),this.displacementMap instanceof i.Texture&&(t.displacementMap=this.displacementMap.toJSON(e).uuid,t.displacementScale=this.displacementScale,t.displacementBias=this.displacementBias),this.specularMap instanceof i.Texture&&(t.specularMap=this.specularMap.toJSON(e).uuid),this.envMap instanceof i.Texture&&(t.envMap=this.envMap.toJSON(e).uuid,t.reflectivity=this.reflectivity),void 0!==this.size&&(t.size=this.size),void 0!==this.sizeAttenuation&&(t.sizeAttenuation=this.sizeAttenuation),void 0!==this.vertexColors&&this.vertexColors!==i.NoColors&&(t.vertexColors=this.vertexColors),void 0!==this.shading&&this.shading!==i.SmoothShading&&(t.shading=this.shading),void 0!==this.blending&&this.blending!==i.NormalBlending&&(t.blending=this.blending),void 0!==this.side&&this.side!==i.FrontSide&&(t.side=this.side),this.opacity<1&&(t.opacity=this.opacity),this.transparent===!0&&(t.transparent=this.transparent),this.alphaTest>0&&(t.alphaTest=this.alphaTest),this.wireframe===!0&&(t.wireframe=this.wireframe),this.wireframeLinewidth>1&&(t.wireframeLinewidth=this.wireframeLinewidth),t},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.side=e.side,this.opacity=e.opacity,this.transparent=e.transparent,this.blending=e.blending,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.alphaTest=e.alphaTest,this.overdraw=e.overdraw,this.visible=e.visible,this},update:function(){this.dispatchEvent({type:"update"})},dispose:function(){this.dispatchEvent({type:"dispose"})},get wrapAround(){console.warn("THREE."+this.type+": .wrapAround has been removed.")},set wrapAround(e){console.warn("THREE."+this.type+": .wrapAround has been removed.")},get wrapRGB(){return console.warn("THREE."+this.type+": .wrapRGB has been removed."),new i.Color}},i.EventDispatcher.prototype.apply(i.Material.prototype),i.MaterialIdCount=0,i.LineBasicMaterial=function(e){i.Material.call(this),this.type="LineBasicMaterial",this.color=new i.Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.vertexColors=i.NoColors,this.fog=!0,this.setValues(e)},i.LineBasicMaterial.prototype=Object.create(i.Material.prototype),i.LineBasicMaterial.prototype.constructor=i.LineBasicMaterial,i.LineBasicMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.vertexColors=e.vertexColors,this.fog=e.fog,this},i.LineDashedMaterial=function(e){i.Material.call(this),this.type="LineDashedMaterial",this.color=new i.Color(16777215),this.linewidth=1,this.scale=1,this.dashSize=3,this.gapSize=1,this.vertexColors=!1,this.fog=!0,this.setValues(e)},i.LineDashedMaterial.prototype=Object.create(i.Material.prototype),i.LineDashedMaterial.prototype.constructor=i.LineDashedMaterial,i.LineDashedMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this.vertexColors=e.vertexColors,this.fog=e.fog,this},i.MeshBasicMaterial=function(e){i.Material.call(this),this.type="MeshBasicMaterial",this.color=new i.Color(16777215),this.map=null,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=i.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=i.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=i.NoColors,this.skinning=!1,this.morphTargets=!1,this.setValues(e)},i.MeshBasicMaterial.prototype=Object.create(i.Material.prototype),i.MeshBasicMaterial.prototype.constructor=i.MeshBasicMaterial,i.MeshBasicMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.fog=e.fog,this.shading=e.shading,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.vertexColors=e.vertexColors,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},i.MeshLambertMaterial=function(e){i.Material.call(this),this.type="MeshLambertMaterial",this.color=new i.Color(16777215),this.emissive=new i.Color(0),this.map=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=i.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=i.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},i.MeshLambertMaterial.prototype=Object.create(i.Material.prototype),i.MeshLambertMaterial.prototype.constructor=i.MeshLambertMaterial,i.MeshLambertMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.color.copy(e.color),this.emissive.copy(e.emissive),this.map=e.map,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.fog=e.fog,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.vertexColors=e.vertexColors,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},i.MeshPhongMaterial=function(e){i.Material.call(this),this.type="MeshPhongMaterial",this.color=new i.Color(16777215),this.emissive=new i.Color(0),this.specular=new i.Color(1118481),this.shininess=30,this.metal=!1,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,
this.aoMapIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new i.Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=i.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=i.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=i.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},i.MeshPhongMaterial.prototype=Object.create(i.Material.prototype),i.MeshPhongMaterial.prototype.constructor=i.MeshPhongMaterial,i.MeshPhongMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.color.copy(e.color),this.emissive.copy(e.emissive),this.specular.copy(e.specular),this.shininess=e.shininess,this.metal=e.metal,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissiveMap=e.emissiveMap,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.fog=e.fog,this.shading=e.shading,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.vertexColors=e.vertexColors,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},i.MeshDepthMaterial=function(e){i.Material.call(this),this.type="MeshDepthMaterial",this.morphTargets=!1,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)},i.MeshDepthMaterial.prototype=Object.create(i.Material.prototype),i.MeshDepthMaterial.prototype.constructor=i.MeshDepthMaterial,i.MeshDepthMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},i.MeshNormalMaterial=function(e){i.Material.call(this,e),this.type="MeshNormalMaterial",this.wireframe=!1,this.wireframeLinewidth=1,this.morphTargets=!1,this.setValues(e)},i.MeshNormalMaterial.prototype=Object.create(i.Material.prototype),i.MeshNormalMaterial.prototype.constructor=i.MeshNormalMaterial,i.MeshNormalMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},i.MultiMaterial=function(e){this.uuid=i.Math.generateUUID(),this.type="MultiMaterial",this.materials=e instanceof Array?e:[],this.visible=!0},i.MultiMaterial.prototype={constructor:i.MultiMaterial,toJSON:function(){for(var e={metadata:{version:4.2,type:"material",generator:"MaterialExporter"},uuid:this.uuid,type:this.type,materials:[]},t=0,r=this.materials.length;r>t;t++)e.materials.push(this.materials[t].toJSON());return e.visible=this.visible,e},clone:function(){for(var e=new this.constructor,t=0;t<this.materials.length;t++)e.materials.push(this.materials[t].clone());return e.visible=this.visible,e}},i.MeshFaceMaterial=i.MultiMaterial,i.PointsMaterial=function(e){i.Material.call(this),this.type="PointsMaterial",this.color=new i.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.vertexColors=i.NoColors,this.fog=!0,this.setValues(e)},i.PointsMaterial.prototype=Object.create(i.Material.prototype),i.PointsMaterial.prototype.constructor=i.PointsMaterial,i.PointsMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.vertexColors=e.vertexColors,this.fog=e.fog,this},i.PointCloudMaterial=function(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new i.PointsMaterial(e)},i.ParticleBasicMaterial=function(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new i.PointsMaterial(e)},i.ParticleSystemMaterial=function(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new i.PointsMaterial(e)},i.ShaderMaterial=function(e){i.Material.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.shading=i.SmoothShading,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.vertexColors=i.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.derivatives=!1,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))},i.ShaderMaterial.prototype=Object.create(i.Material.prototype),i.ShaderMaterial.prototype.constructor=i.ShaderMaterial,i.ShaderMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=i.UniformsUtils.clone(e.uniforms),this.attributes=e.attributes,this.defines=e.defines,this.shading=e.shading,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.vertexColors=e.vertexColors,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.derivatives=e.derivatives,this},i.ShaderMaterial.prototype.toJSON=function(e){var t=i.Material.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.attributes=this.attributes,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},i.RawShaderMaterial=function(e){i.ShaderMaterial.call(this,e),this.type="RawShaderMaterial"},i.RawShaderMaterial.prototype=Object.create(i.ShaderMaterial.prototype),i.RawShaderMaterial.prototype.constructor=i.RawShaderMaterial,i.SpriteMaterial=function(e){i.Material.call(this),this.type="SpriteMaterial",this.color=new i.Color(16777215),this.map=null,this.rotation=0,this.fog=!1,this.setValues(e)},i.SpriteMaterial.prototype=Object.create(i.Material.prototype),i.SpriteMaterial.prototype.constructor=i.SpriteMaterial,i.SpriteMaterial.prototype.copy=function(e){return i.Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this.fog=e.fog,this},i.Texture=function(e,t,r,n,o,a,s,u,h){Object.defineProperty(this,"id",{value:i.TextureIdCount++}),this.uuid=i.Math.generateUUID(),this.name="",this.sourceFile="",this.image=void 0!==e?e:i.Texture.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:i.Texture.DEFAULT_MAPPING,this.wrapS=void 0!==r?r:i.ClampToEdgeWrapping,this.wrapT=void 0!==n?n:i.ClampToEdgeWrapping,this.magFilter=void 0!==o?o:i.LinearFilter,this.minFilter=void 0!==a?a:i.LinearMipMapLinearFilter,this.anisotropy=void 0!==h?h:1,this.format=void 0!==s?s:i.RGBAFormat,this.type=void 0!==u?u:i.UnsignedByteType,this.offset=new i.Vector2(0,0),this.repeat=new i.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.version=0,this.onUpdate=null},i.Texture.DEFAULT_IMAGE=void 0,i.Texture.DEFAULT_MAPPING=i.UVMapping,i.Texture.prototype={constructor:i.Texture,set needsUpdate(e){e===!0&&this.version++},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this},toJSON:function(e){function t(e){var t;return void 0!==e.toDataURL?t=e:(t=document.createElement("canvas"),t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height)),t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}if(void 0!==e.textures[this.uuid])return e.textures[this.uuid];var r={metadata:{version:4.4,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy};if(void 0!==this.image){var n=this.image;void 0===n.uuid&&(n.uuid=i.Math.generateUUID()),void 0===e.images[n.uuid]&&(e.images[n.uuid]={uuid:n.uuid,url:t(n)}),r.image=n.uuid}return e.textures[this.uuid]=r,r},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(this.mapping===i.UVMapping){if(e.multiply(this.repeat),e.add(this.offset),e.x<0||e.x>1)switch(this.wrapS){case i.RepeatWrapping:e.x=e.x-Math.floor(e.x);break;case i.ClampToEdgeWrapping:e.x=e.x<0?0:1;break;case i.MirroredRepeatWrapping:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case i.RepeatWrapping:e.y=e.y-Math.floor(e.y);break;case i.ClampToEdgeWrapping:e.y=e.y<0?0:1;break;case i.MirroredRepeatWrapping:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}}},i.EventDispatcher.prototype.apply(i.Texture.prototype),i.TextureIdCount=0,i.CanvasTexture=function(e,t,r,n,o,a,s,u,h){i.Texture.call(this,e,t,r,n,o,a,s,u,h),this.needsUpdate=!0},i.CanvasTexture.prototype=Object.create(i.Texture.prototype),i.CanvasTexture.prototype.constructor=i.CanvasTexture,i.CubeTexture=function(e,t,r,n,o,a,s,u,h){t=void 0!==t?t:i.CubeReflectionMapping,i.Texture.call(this,e,t,r,n,o,a,s,u,h),this.images=e,this.flipY=!1},i.CubeTexture.prototype=Object.create(i.Texture.prototype),i.CubeTexture.prototype.constructor=i.CubeTexture,i.CubeTexture.prototype.copy=function(e){return i.Texture.prototype.copy.call(this,e),this.images=e.images,this},i.CompressedTexture=function(e,t,r,n,o,a,s,u,h,c,l){i.Texture.call(this,null,a,s,u,h,c,n,o,l),this.image={width:t,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1},i.CompressedTexture.prototype=Object.create(i.Texture.prototype),i.CompressedTexture.prototype.constructor=i.CompressedTexture,i.DataTexture=function(e,t,r,n,o,a,s,u,h,c,l){i.Texture.call(this,null,a,s,u,h,c,n,o,l),this.image={data:e,width:t,height:r},this.magFilter=void 0!==h?h:i.NearestFilter,this.minFilter=void 0!==c?c:i.NearestFilter,this.flipY=!1,this.generateMipmaps=!1},i.DataTexture.prototype=Object.create(i.Texture.prototype),i.DataTexture.prototype.constructor=i.DataTexture,i.VideoTexture=function(e,t,r,n,o,a,s,u,h){function c(){requestAnimationFrame(c),e.readyState===e.HAVE_ENOUGH_DATA&&(l.needsUpdate=!0)}i.Texture.call(this,e,t,r,n,o,a,s,u,h),this.generateMipmaps=!1;var l=this;c()},i.VideoTexture.prototype=Object.create(i.Texture.prototype),i.VideoTexture.prototype.constructor=i.VideoTexture,i.Group=function(){i.Object3D.call(this),this.type="Group"},i.Group.prototype=Object.create(i.Object3D.prototype),i.Group.prototype.constructor=i.Group,i.Points=function(e,t){i.Object3D.call(this),this.type="Points",this.geometry=void 0!==e?e:new i.Geometry,this.material=void 0!==t?t:new i.PointsMaterial({color:16777215*Math.random()})},i.Points.prototype=Object.create(i.Object3D.prototype),i.Points.prototype.constructor=i.Points,i.Points.prototype.raycast=function(){var e=new i.Matrix4,t=new i.Ray;return function(r,n){function o(e,i){var o=t.distanceSqToPoint(e);if(c>o){var s=t.closestPointToPoint(e);s.applyMatrix4(a.matrixWorld);var u=r.ray.origin.distanceTo(s);if(u<r.near||u>r.far)return;n.push({distance:u,distanceToRay:Math.sqrt(o),point:s.clone(),index:i,face:null,object:a})}}var a=this,s=a.geometry,u=r.params.Points.threshold;if(e.getInverse(this.matrixWorld),t.copy(r.ray).applyMatrix4(e),null===s.boundingBox||t.isIntersectionBox(s.boundingBox)!==!1){var h=u/((this.scale.x+this.scale.y+this.scale.z)/3),c=h*h,l=new i.Vector3;if(s instanceof i.BufferGeometry){var p=s.index,f=s.attributes,d=f.position.array;if(null!==p)for(var m=p.array,g=0,v=m.length;v>g;g++){var x=m[g];l.fromArray(d,3*x),o(l,x)}else for(var g=0,y=d.length/3;y>g;g++)l.fromArray(d,3*g),o(l,g)}else for(var _=s.vertices,g=0,y=_.length;y>g;g++)o(_[g],g)}}}(),i.Points.prototype.clone=function(){return new this.constructor(this.geometry,this.material).copy(this)},i.PointCloud=function(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new i.Points(e,t)},i.ParticleSystem=function(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new i.Points(e,t)},i.Line=function(e,t,r){return 1===r?(console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new i.LineSegments(e,t)):(i.Object3D.call(this),this.type="Line",this.geometry=void 0!==e?e:new i.Geometry,void(this.material=void 0!==t?t:new i.LineBasicMaterial({color:16777215*Math.random()})))},i.Line.prototype=Object.create(i.Object3D.prototype),i.Line.prototype.constructor=i.Line,i.Line.prototype.raycast=function(){var e=new i.Matrix4,t=new i.Ray,r=new i.Sphere;return function(n,o){var a=n.linePrecision,s=a*a,u=this.geometry;if(null===u.boundingSphere&&u.computeBoundingSphere(),r.copy(u.boundingSphere),r.applyMatrix4(this.matrixWorld),n.ray.isIntersectionSphere(r)!==!1){e.getInverse(this.matrixWorld),t.copy(n.ray).applyMatrix4(e);var h=new i.Vector3,c=new i.Vector3,l=new i.Vector3,p=new i.Vector3,f=this instanceof i.LineSegments?2:1;if(u instanceof i.BufferGeometry){var d=u.index,m=u.attributes;if(null!==d)for(var g=d.array,v=m.position.array,x=0,y=g.length-1;y>x;x+=f){var _=g[x],b=g[x+1];h.fromArray(v,3*_),c.fromArray(v,3*b);var w=t.distanceSqToSegment(h,c,p,l);if(!(w>s)){p.applyMatrix4(this.matrixWorld);var T=n.ray.origin.distanceTo(p);T<n.near||T>n.far||o.push({distance:T,point:l.clone().applyMatrix4(this.matrixWorld),index:x,face:null,faceIndex:null,object:this})}}else for(var v=m.position.array,x=0,y=v.length/3-1;y>x;x+=f){h.fromArray(v,3*x),c.fromArray(v,3*x+3);var w=t.distanceSqToSegment(h,c,p,l);if(!(w>s)){p.applyMatrix4(this.matrixWorld);var T=n.ray.origin.distanceTo(p);T<n.near||T>n.far||o.push({distance:T,point:l.clone().applyMatrix4(this.matrixWorld),index:x,face:null,faceIndex:null,object:this})}}}else if(u instanceof i.Geometry)for(var M=u.vertices,S=M.length,x=0;S-1>x;x+=f){var w=t.distanceSqToSegment(M[x],M[x+1],p,l);if(!(w>s)){p.applyMatrix4(this.matrixWorld);var T=n.ray.origin.distanceTo(p);T<n.near||T>n.far||o.push({distance:T,point:l.clone().applyMatrix4(this.matrixWorld),index:x,face:null,faceIndex:null,object:this})}}}}}(),i.Line.prototype.clone=function(){return new this.constructor(this.geometry,this.material).copy(this)},i.LineStrip=0,i.LinePieces=1,i.LineSegments=function(e,t){i.Line.call(this,e,t),this.type="LineSegments"},i.LineSegments.prototype=Object.create(i.Line.prototype),i.LineSegments.prototype.constructor=i.LineSegments,i.Mesh=function(e,t){i.Object3D.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new i.Geometry,this.material=void 0!==t?t:new i.MeshBasicMaterial({color:16777215*Math.random()}),this.updateMorphTargets()},i.Mesh.prototype=Object.create(i.Object3D.prototype),i.Mesh.prototype.constructor=i.Mesh,i.Mesh.prototype.updateMorphTargets=function(){if(void 0!==this.geometry.morphTargets&&this.geometry.morphTargets.length>0){this.morphTargetBase=-1,this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var e=0,t=this.geometry.morphTargets.length;t>e;e++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[e].name]=e}},i.Mesh.prototype.getMorphTargetIndexByName=function(e){return void 0!==this.morphTargetDictionary[e]?this.morphTargetDictionary[e]:(console.warn("THREE.Mesh.getMorphTargetIndexByName: morph target "+e+" does not exist. Returning 0."),0)},i.Mesh.prototype.raycast=function(){function e(e,t,r,n,o,a,s){return i.Triangle.barycoordFromPoint(e,t,r,n,g),o.multiplyScalar(g.x),a.multiplyScalar(g.y),s.multiplyScalar(g.z),o.add(a).add(s),o.clone()}function t(e,t,r,n,o,a,s){var u,h=e.material;if(u=h.side===i.BackSide?r.intersectTriangle(a,o,n,!0,s):r.intersectTriangle(n,o,a,h.side!==i.DoubleSide,s),null===u)return null;x.copy(s),x.applyMatrix4(e.matrixWorld);var c=t.ray.origin.distanceTo(x);return c<t.near||c>t.far?null:{distance:c,point:x.clone(),object:e}}function r(r,n,o,a,c,l,p,g){s.fromArray(a,3*l),u.fromArray(a,3*p),h.fromArray(a,3*g);var x=t(r,n,o,s,u,h,v);return x&&(c&&(f.fromArray(c,2*l),d.fromArray(c,2*p),m.fromArray(c,2*g),x.uv=e(v,s,u,h,f,d,m)),x.face=new i.Face3(l,p,g,i.Triangle.normal(s,u,h)),x.faceIndex=l),x}var n=new i.Matrix4,o=new i.Ray,a=new i.Sphere,s=new i.Vector3,u=new i.Vector3,h=new i.Vector3,c=new i.Vector3,l=new i.Vector3,p=new i.Vector3,f=new i.Vector2,d=new i.Vector2,m=new i.Vector2,g=new i.Vector3,v=new i.Vector3,x=new i.Vector3;return function(g,x){var y=this.geometry,_=this.material;if(void 0!==_){null===y.boundingSphere&&y.computeBoundingSphere();var b=this.matrixWorld;if(a.copy(y.boundingSphere),a.applyMatrix4(b),g.ray.isIntersectionSphere(a)!==!1&&(n.getInverse(b),o.copy(g.ray).applyMatrix4(n),null===y.boundingBox||o.isIntersectionBox(y.boundingBox)!==!1)){var w,T;if(y instanceof i.BufferGeometry){var M,S,E,C=y.index,R=y.attributes,D=R.position.array;if(void 0!==R.uv&&(w=R.uv.array),null!==C)for(var A=C.array,P=0,L=A.length;L>P;P+=3)M=A[P],S=A[P+1],E=A[P+2],T=r(this,g,o,D,w,M,S,E),T&&(T.faceIndex=Math.floor(P/3),x.push(T));else for(var P=0,L=D.length;L>P;P+=9)M=P/3,S=M+1,E=M+2,T=r(this,g,o,D,w,M,S,E),T&&(T.index=M,x.push(T))}else if(y instanceof i.Geometry){var B,F,G,U=_ instanceof i.MeshFaceMaterial,k=U===!0?_.materials:null,V=y.vertices,I=y.faces,O=y.faceVertexUvs[0];O.length>0&&(w=O);for(var z=0,N=I.length;N>z;z++){var j=I[z],H=U===!0?k[j.materialIndex]:_;if(void 0!==H){if(B=V[j.a],F=V[j.b],G=V[j.c],H.morphTargets===!0){var X=y.morphTargets,W=this.morphTargetInfluences;s.set(0,0,0),u.set(0,0,0),h.set(0,0,0);for(var q=0,Y=X.length;Y>q;q++){var K=W[q];if(0!==K){var Z=X[q].vertices;s.addScaledVector(c.subVectors(Z[j.a],B),K),u.addScaledVector(l.subVectors(Z[j.b],F),K),h.addScaledVector(p.subVectors(Z[j.c],G),K)}}s.add(B),u.add(F),h.add(G),B=s,F=u,G=h}if(T=t(this,g,o,B,F,G,v)){if(w){var Q=w[z];f.copy(Q[0]),d.copy(Q[1]),m.copy(Q[2]),T.uv=e(v,B,F,G,f,d,m)}T.face=j,T.faceIndex=z,x.push(T)}}}}}}}}(),i.Mesh.prototype.clone=function(){return new this.constructor(this.geometry,this.material).copy(this)},i.Bone=function(e){i.Object3D.call(this),this.type="Bone",this.skin=e},i.Bone.prototype=Object.create(i.Object3D.prototype),i.Bone.prototype.constructor=i.Bone,i.Bone.prototype.copy=function(e){return i.Object3D.prototype.copy.call(this,e),this.skin=e.skin,this},i.Skeleton=function(e,t,r){if(this.useVertexTexture=void 0!==r?r:!0,this.identityMatrix=new i.Matrix4,e=e||[],this.bones=e.slice(0),this.useVertexTexture){var n=Math.sqrt(4*this.bones.length);n=i.Math.nextPowerOfTwo(Math.ceil(n)),n=Math.max(n,4),this.boneTextureWidth=n,this.boneTextureHeight=n,this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4),this.boneTexture=new i.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,i.RGBAFormat,i.FloatType)}else this.boneMatrices=new Float32Array(16*this.bones.length);if(void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton bonInverses is the wrong length."),this.boneInverses=[];for(var o=0,a=this.bones.length;a>o;o++)this.boneInverses.push(new i.Matrix4)}},i.Skeleton.prototype.calculateInverses=function(){this.boneInverses=[];for(var e=0,t=this.bones.length;t>e;e++){var r=new i.Matrix4;this.bones[e]&&r.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(r)}},i.Skeleton.prototype.pose=function(){for(var e,t=0,r=this.bones.length;r>t;t++)e=this.bones[t],e&&e.matrixWorld.getInverse(this.boneInverses[t]);for(var t=0,r=this.bones.length;r>t;t++)e=this.bones[t],e&&(e.parent?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},i.Skeleton.prototype.update=function(){var e=new i.Matrix4;return function(){for(var t=0,r=this.bones.length;r>t;t++){var n=this.bones[t]?this.bones[t].matrixWorld:this.identityMatrix;e.multiplyMatrices(n,this.boneInverses[t]),e.flattenToArrayOffset(this.boneMatrices,16*t)}this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)}}(),i.Skeleton.prototype.clone=function(){return new i.Skeleton(this.bones,this.boneInverses,this.useVertexTexture)},i.SkinnedMesh=function(e,t,r){i.Mesh.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new i.Matrix4,this.bindMatrixInverse=new i.Matrix4;var n=[];if(this.geometry&&void 0!==this.geometry.bones){for(var o,a,s=0,u=this.geometry.bones.length;u>s;++s)a=this.geometry.bones[s],o=new i.Bone(this),n.push(o),o.name=a.name,o.position.fromArray(a.pos),o.quaternion.fromArray(a.rotq),void 0!==a.scl&&o.scale.fromArray(a.scl);for(var s=0,u=this.geometry.bones.length;u>s;++s)a=this.geometry.bones[s],-1!==a.parent&&null!==a.parent?n[a.parent].add(n[s]):this.add(n[s])}this.normalizeSkinWeights(),this.updateMatrixWorld(!0),this.bind(new i.Skeleton(n,void 0,r),this.matrixWorld)},i.SkinnedMesh.prototype=Object.create(i.Mesh.prototype),i.SkinnedMesh.prototype.constructor=i.SkinnedMesh,i.SkinnedMesh.prototype.bind=function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},i.SkinnedMesh.prototype.pose=function(){this.skeleton.pose()},i.SkinnedMesh.prototype.normalizeSkinWeights=function(){if(this.geometry instanceof i.Geometry)for(var e=0;e<this.geometry.skinIndices.length;e++){var t=this.geometry.skinWeights[e],r=1/t.lengthManhattan();r!==1/0?t.multiplyScalar(r):t.set(1)}},i.SkinnedMesh.prototype.updateMatrixWorld=function(e){i.Mesh.prototype.updateMatrixWorld.call(this,!0),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh unrecognized bindMode: "+this.bindMode)},i.SkinnedMesh.prototype.clone=function(){return new this.constructor(this.geometry,this.material,this.useVertexTexture).copy(this)},i.LOD=function(){i.Object3D.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}})},i.LOD.prototype=Object.create(i.Object3D.prototype),i.LOD.prototype.constructor=i.LOD,i.LOD.prototype.addLevel=function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var r=this.levels,n=0;n<r.length&&!(t<r[n].distance);n++);r.splice(n,0,{distance:t,object:e}),this.add(e)},i.LOD.prototype.getObjectForDistance=function(e){for(var t=this.levels,r=1,n=t.length;n>r&&!(e<t[r].distance);r++);return t[r-1].object},i.LOD.prototype.raycast=function(){var e=new i.Vector3;return function(t,r){e.setFromMatrixPosition(this.matrixWorld);var n=t.ray.origin.distanceTo(e);this.getObjectForDistance(n).raycast(t,r)}}(),i.LOD.prototype.update=function(){var e=new i.Vector3,t=new i.Vector3;return function(r){var n=this.levels;if(n.length>1){e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var i=e.distanceTo(t);n[0].object.visible=!0;for(var o=1,a=n.length;a>o&&i>=n[o].distance;o++)n[o-1].object.visible=!1,n[o].object.visible=!0;for(;a>o;o++)n[o].object.visible=!1}}}(),i.LOD.prototype.copy=function(e){i.Object3D.prototype.copy.call(this,e,!1);for(var t=e.levels,r=0,n=t.length;n>r;r++){var o=t[r];this.addLevel(o.object.clone(),o.distance)}return this},i.LOD.prototype.toJSON=function(e){var t=i.Object3D.prototype.toJSON.call(this,e);t.object.levels=[];for(var r=this.levels,n=0,o=r.length;o>n;n++){var a=r[n];t.object.levels.push({object:a.object.uuid,distance:a.distance})}return t},i.Sprite=function(){var e=new Uint16Array([0,1,2,0,2,3]),t=new Float32Array([-.5,-.5,0,.5,-.5,0,.5,.5,0,-.5,.5,0]),r=new Float32Array([0,0,1,0,1,1,0,1]),n=new i.BufferGeometry;return n.setIndex(new i.BufferAttribute(e,1)),n.addAttribute("position",new i.BufferAttribute(t,3)),n.addAttribute("uv",new i.BufferAttribute(r,2)),function(e){i.Object3D.call(this),this.type="Sprite",this.geometry=n,this.material=void 0!==e?e:new i.SpriteMaterial}}(),i.Sprite.prototype=Object.create(i.Object3D.prototype),i.Sprite.prototype.constructor=i.Sprite,i.Sprite.prototype.raycast=function(){var e=new i.Vector3;return function(t,r){e.setFromMatrixPosition(this.matrixWorld);var n=t.ray.distanceSqToPoint(e),i=this.scale.x*this.scale.y;n>i||r.push({distance:Math.sqrt(n),point:this.position,face:null,object:this})}}(),i.Sprite.prototype.clone=function(){return new this.constructor(this.material).copy(this)},i.Particle=i.Sprite,i.LensFlare=function(e,t,r,n,o){i.Object3D.call(this),this.lensFlares=[],this.positionScreen=new i.Vector3,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,r,n,o)},i.LensFlare.prototype=Object.create(i.Object3D.prototype),i.LensFlare.prototype.constructor=i.LensFlare,i.LensFlare.prototype.add=function(e,t,r,n,o,a){void 0===t&&(t=-1),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=new i.Color(16777215)),void 0===n&&(n=i.NormalBlending),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:e,size:t,distance:r,x:0,y:0,z:0,scale:1,rotation:0,opacity:a,color:o,blending:n})},i.LensFlare.prototype.updateLensFlares=function(){var e,t,r=this.lensFlares.length,n=2*-this.positionScreen.x,i=2*-this.positionScreen.y;for(e=0;r>e;e++)t=this.lensFlares[e],t.x=this.positionScreen.x+n*t.distance,t.y=this.positionScreen.y+i*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)},i.LensFlare.prototype.copy=function(e){i.Object3D.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,r=e.lensFlares.length;r>t;t++)this.lensFlares.push(e.lensFlares[t]);return this},i.Scene=function(){i.Object3D.call(this),this.type="Scene",this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0},i.Scene.prototype=Object.create(i.Object3D.prototype),i.Scene.prototype.constructor=i.Scene,i.Scene.prototype.copy=function(e){return i.Object3D.prototype.copy.call(this,e),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},i.Fog=function(e,t,r){this.name="",this.color=new i.Color(e),this.near=void 0!==t?t:1,this.far=void 0!==r?r:1e3},i.Fog.prototype.clone=function(){return new i.Fog(this.color.getHex(),this.near,this.far)},i.FogExp2=function(e,t){this.name="",this.color=new i.Color(e),this.density=void 0!==t?t:25e-5},i.FogExp2.prototype.clone=function(){return new i.FogExp2(this.color.getHex(),this.density)},i.ShaderChunk={},i.ShaderChunk.alphamap_fragment="#ifdef USE_ALPHAMAP\n\n	diffuseColor.a *= texture2D( alphaMap, vUv ).g;\n\n#endif\n",i.ShaderChunk.alphamap_pars_fragment="#ifdef USE_ALPHAMAP\n\n	uniform sampler2D alphaMap;\n\n#endif\n",i.ShaderChunk.alphatest_fragment="#ifdef ALPHATEST\n\n	if ( diffuseColor.a < ALPHATEST ) discard;\n\n#endif\n",i.ShaderChunk.aomap_fragment="#ifdef USE_AOMAP\n\n	totalAmbientLight *= ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\n#endif\n",i.ShaderChunk.aomap_pars_fragment="#ifdef USE_AOMAP\n\n	uniform sampler2D aoMap;\n	uniform float aoMapIntensity;\n\n#endif",i.ShaderChunk.begin_vertex="\nvec3 transformed = vec3( position );\n",i.ShaderChunk.beginnormal_vertex="\nvec3 objectNormal = vec3( normal );\n",i.ShaderChunk.bumpmap_pars_fragment="#ifdef USE_BUMPMAP\n\n	uniform sampler2D bumpMap;\n	uniform float bumpScale;\n\n\n\n	vec2 dHdxy_fwd() {\n\n		vec2 dSTdx = dFdx( vUv );\n		vec2 dSTdy = dFdy( vUv );\n\n		float Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n		float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n		float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\n		return vec2( dBx, dBy );\n\n	}\n\n	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\n		vec3 vSigmaX = dFdx( surf_pos );\n		vec3 vSigmaY = dFdy( surf_pos );\n		vec3 vN = surf_norm;\n		vec3 R1 = cross( vSigmaY, vN );\n		vec3 R2 = cross( vN, vSigmaX );\n\n		float fDet = dot( vSigmaX, R1 );\n\n		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n		return normalize( abs( fDet ) * surf_norm - vGrad );\n\n	}\n\n#endif\n",i.ShaderChunk.color_fragment="#ifdef USE_COLOR\n\n	diffuseColor.rgb *= vColor;\n\n#endif",i.ShaderChunk.color_pars_fragment="#ifdef USE_COLOR\n\n	varying vec3 vColor;\n\n#endif\n",i.ShaderChunk.color_pars_vertex="#ifdef USE_COLOR\n\n	varying vec3 vColor;\n\n#endif",i.ShaderChunk.color_vertex="#ifdef USE_COLOR\n\n	vColor.xyz = color.xyz;\n\n#endif",i.ShaderChunk.common="#define PI 3.14159\n#define PI2 6.28318\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n\nvec3 transformDirection( in vec3 normal, in mat4 matrix ) {\n\n	return normalize( ( matrix * vec4( normal, 0.0 ) ).xyz );\n\n}\n\nvec3 inverseTransformDirection( in vec3 normal, in mat4 matrix ) {\n\n	return normalize( ( vec4( normal, 0.0 ) * matrix ).xyz );\n\n}\n\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\n	float distance = dot( planeNormal, point - pointOnPlane );\n\n	return - distance * planeNormal + point;\n\n}\n\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\n	return sign( dot( point - pointOnPlane, planeNormal ) );\n\n}\n\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\n	return lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n\n}\n\nfloat calcLightAttenuation( float lightDistance, float cutoffDistance, float decayExponent ) {\n\n	if ( decayExponent > 0.0 ) {\n\n	  return pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\n	}\n\n	return 1.0;\n\n}\n\nvec3 F_Schlick( in vec3 specularColor, in float dotLH ) {\n\n\n	float fresnel = exp2( ( -5.55437 * dotLH - 6.98316 ) * dotLH );\n\n	return ( 1.0 - specularColor ) * fresnel + specularColor;\n\n}\n\nfloat G_BlinnPhong_Implicit( /* in float dotNL, in float dotNV */ ) {\n\n\n	return 0.25;\n\n}\n\nfloat D_BlinnPhong( in float shininess, in float dotNH ) {\n\n\n	return ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n\n}\n\nvec3 BRDF_BlinnPhong( in vec3 specularColor, in float shininess, in vec3 normal, in vec3 lightDir, in vec3 viewDir ) {\n\n	vec3 halfDir = normalize( lightDir + viewDir );\n\n	float dotNH = saturate( dot( normal, halfDir ) );\n	float dotLH = saturate( dot( lightDir, halfDir ) );\n\n	vec3 F = F_Schlick( specularColor, dotLH );\n\n	float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );\n\n	float D = D_BlinnPhong( shininess, dotNH );\n\n	return F * G * D;\n\n}\n\nvec3 inputToLinear( in vec3 a ) {\n\n	#ifdef GAMMA_INPUT\n\n		return pow( a, vec3( float( GAMMA_FACTOR ) ) );\n\n	#else\n\n		return a;\n\n	#endif\n\n}\n\nvec3 linearToOutput( in vec3 a ) {\n\n	#ifdef GAMMA_OUTPUT\n\n		return pow( a, vec3( 1.0 / float( GAMMA_FACTOR ) ) );\n\n	#else\n\n		return a;\n\n	#endif\n\n}\n",
i.ShaderChunk.defaultnormal_vertex="#ifdef FLIP_SIDED\n\n	objectNormal = -objectNormal;\n\n#endif\n\nvec3 transformedNormal = normalMatrix * objectNormal;\n",i.ShaderChunk.displacementmap_vertex="#ifdef USE_DISPLACEMENTMAP\n\n	transformed += normal * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n\n#endif\n",i.ShaderChunk.displacementmap_pars_vertex="#ifdef USE_DISPLACEMENTMAP\n\n	uniform sampler2D displacementMap;\n	uniform float displacementScale;\n	uniform float displacementBias;\n\n#endif\n",i.ShaderChunk.emissivemap_fragment="#ifdef USE_EMISSIVEMAP\n\n	vec4 emissiveColor = texture2D( emissiveMap, vUv );\n\n	emissiveColor.rgb = inputToLinear( emissiveColor.rgb );\n\n	totalEmissiveLight *= emissiveColor.rgb;\n\n#endif\n",i.ShaderChunk.emissivemap_pars_fragment="#ifdef USE_EMISSIVEMAP\n\n	uniform sampler2D emissiveMap;\n\n#endif\n",i.ShaderChunk.envmap_fragment="#ifdef USE_ENVMAP\n\n	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\n		vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\n		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\n		#ifdef ENVMAP_MODE_REFLECTION\n\n			vec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\n		#else\n\n			vec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\n		#endif\n\n	#else\n\n		vec3 reflectVec = vReflect;\n\n	#endif\n\n	#ifdef DOUBLE_SIDED\n		float flipNormal = ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n	#else\n		float flipNormal = 1.0;\n	#endif\n\n	#ifdef ENVMAP_TYPE_CUBE\n		vec4 envColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\n	#elif defined( ENVMAP_TYPE_EQUIREC )\n		vec2 sampleUV;\n		sampleUV.y = saturate( flipNormal * reflectVec.y * 0.5 + 0.5 );\n		sampleUV.x = atan( flipNormal * reflectVec.z, flipNormal * reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n		vec4 envColor = texture2D( envMap, sampleUV );\n\n	#elif defined( ENVMAP_TYPE_SPHERE )\n		vec3 reflectView = flipNormal * normalize((viewMatrix * vec4( reflectVec, 0.0 )).xyz + vec3(0.0,0.0,1.0));\n		vec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n	#endif\n\n	envColor.xyz = inputToLinear( envColor.xyz );\n\n	#ifdef ENVMAP_BLENDING_MULTIPLY\n\n		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\n	#elif defined( ENVMAP_BLENDING_MIX )\n\n		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\n	#elif defined( ENVMAP_BLENDING_ADD )\n\n		outgoingLight += envColor.xyz * specularStrength * reflectivity;\n\n	#endif\n\n#endif\n",i.ShaderChunk.envmap_pars_fragment="#ifdef USE_ENVMAP\n\n	uniform float reflectivity;\n	#ifdef ENVMAP_TYPE_CUBE\n		uniform samplerCube envMap;\n	#else\n		uniform sampler2D envMap;\n	#endif\n	uniform float flipEnvMap;\n\n	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\n		uniform float refractionRatio;\n\n	#else\n\n		varying vec3 vReflect;\n\n	#endif\n\n#endif\n",i.ShaderChunk.envmap_pars_vertex="#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHONG )\n\n	varying vec3 vReflect;\n\n	uniform float refractionRatio;\n\n#endif\n",i.ShaderChunk.envmap_vertex="#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP ) && ! defined( PHONG )\n\n	vec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\n	vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\n	#ifdef ENVMAP_MODE_REFLECTION\n\n		vReflect = reflect( cameraToVertex, worldNormal );\n\n	#else\n\n		vReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\n	#endif\n\n#endif\n",i.ShaderChunk.fog_fragment="#ifdef USE_FOG\n\n	#ifdef USE_LOGDEPTHBUF_EXT\n\n		float depth = gl_FragDepthEXT / gl_FragCoord.w;\n\n	#else\n\n		float depth = gl_FragCoord.z / gl_FragCoord.w;\n\n	#endif\n\n	#ifdef FOG_EXP2\n\n		float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );\n\n	#else\n\n		float fogFactor = smoothstep( fogNear, fogFar, depth );\n\n	#endif\n	\n	outgoingLight = mix( outgoingLight, fogColor, fogFactor );\n\n#endif",i.ShaderChunk.fog_pars_fragment="#ifdef USE_FOG\n\n	uniform vec3 fogColor;\n\n	#ifdef FOG_EXP2\n\n		uniform float fogDensity;\n\n	#else\n\n		uniform float fogNear;\n		uniform float fogFar;\n	#endif\n\n#endif",i.ShaderChunk.hemilight_fragment="#if MAX_HEMI_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\n\n		vec3 lightDir = hemisphereLightDirection[ i ];\n\n		float dotProduct = dot( normal, lightDir );\n\n		float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\n\n		vec3 lightColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\n\n		totalAmbientLight += lightColor;\n\n	}\n\n#endif\n\n",i.ShaderChunk.lightmap_fragment="#ifdef USE_LIGHTMAP\n\n	totalAmbientLight += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\n#endif\n",i.ShaderChunk.lightmap_pars_fragment="#ifdef USE_LIGHTMAP\n\n	uniform sampler2D lightMap;\n	uniform float lightMapIntensity;\n\n#endif",i.ShaderChunk.lights_lambert_pars_vertex="#if MAX_DIR_LIGHTS > 0\n\n	uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\n	uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n\n#endif\n\n#if MAX_HEMI_LIGHTS > 0\n\n	uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\n	uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\n	uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n\n#endif\n\n#if MAX_POINT_LIGHTS > 0\n\n	uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\n	uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\n	uniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n	uniform float pointLightDecay[ MAX_POINT_LIGHTS ];\n\n#endif\n\n#if MAX_SPOT_LIGHTS > 0\n\n	uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\n	uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\n	uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightDecay[ MAX_SPOT_LIGHTS ];\n\n#endif\n",i.ShaderChunk.lights_lambert_vertex="vLightFront = vec3( 0.0 );\n\n#ifdef DOUBLE_SIDED\n\n	vLightBack = vec3( 0.0 );\n\n#endif\n\nvec3 normal = normalize( transformedNormal );\n\n#if MAX_POINT_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\n\n		vec3 lightColor = pointLightColor[ i ];\n\n		vec3 lVector = pointLightPosition[ i ] - mvPosition.xyz;\n		vec3 lightDir = normalize( lVector );\n\n\n		float attenuation = calcLightAttenuation( length( lVector ), pointLightDistance[ i ], pointLightDecay[ i ] );\n\n\n		float dotProduct = dot( normal, lightDir );\n\n		vLightFront += lightColor * attenuation * saturate( dotProduct );\n\n		#ifdef DOUBLE_SIDED\n\n			vLightBack += lightColor * attenuation * saturate( - dotProduct );\n\n		#endif\n\n	}\n\n#endif\n\n#if MAX_SPOT_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\n\n		vec3 lightColor = spotLightColor[ i ];\n\n		vec3 lightPosition = spotLightPosition[ i ];\n		vec3 lVector = lightPosition - mvPosition.xyz;\n		vec3 lightDir = normalize( lVector );\n\n		float spotEffect = dot( spotLightDirection[ i ], lightDir );\n\n		if ( spotEffect > spotLightAngleCos[ i ] ) {\n\n			spotEffect = saturate( pow( saturate( spotEffect ), spotLightExponent[ i ] ) );\n\n\n			float attenuation = calcLightAttenuation( length( lVector ), spotLightDistance[ i ], spotLightDecay[ i ] );\n\n			attenuation *= spotEffect;\n\n\n			float dotProduct = dot( normal, lightDir );\n\n			vLightFront += lightColor * attenuation * saturate( dotProduct );\n\n			#ifdef DOUBLE_SIDED\n\n				vLightBack += lightColor * attenuation * saturate( - dotProduct );\n\n			#endif\n\n		}\n\n	}\n\n#endif\n\n#if MAX_DIR_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\n\n		vec3 lightColor = directionalLightColor[ i ];\n\n		vec3 lightDir = directionalLightDirection[ i ];\n\n\n		float dotProduct = dot( normal, lightDir );\n\n		vLightFront += lightColor * saturate( dotProduct );\n\n		#ifdef DOUBLE_SIDED\n\n			vLightBack += lightColor * saturate( - dotProduct );\n\n		#endif\n\n	}\n\n#endif\n\n#if MAX_HEMI_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\n\n		vec3 lightDir = hemisphereLightDirection[ i ];\n\n\n		float dotProduct = dot( normal, lightDir );\n\n		float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\n\n		vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\n\n		#ifdef DOUBLE_SIDED\n\n			float hemiDiffuseWeightBack = - 0.5 * dotProduct + 0.5;\n\n			vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );\n\n		#endif\n\n	}\n\n#endif\n",i.ShaderChunk.lights_phong_fragment="vec3 viewDir = normalize( vViewPosition );\n\nvec3 totalDiffuseLight = vec3( 0.0 );\nvec3 totalSpecularLight = vec3( 0.0 );\n\n#if MAX_POINT_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\n\n		vec3 lightColor = pointLightColor[ i ];\n\n		vec3 lightPosition = pointLightPosition[ i ];\n		vec3 lVector = lightPosition + vViewPosition.xyz;\n		vec3 lightDir = normalize( lVector );\n\n\n		float attenuation = calcLightAttenuation( length( lVector ), pointLightDistance[ i ], pointLightDecay[ i ] );\n\n\n		float cosineTerm = saturate( dot( normal, lightDir ) );\n\n		totalDiffuseLight += lightColor * attenuation * cosineTerm;\n\n\n		vec3 brdf = BRDF_BlinnPhong( specular, shininess, normal, lightDir, viewDir );\n\n		totalSpecularLight += brdf * specularStrength * lightColor * attenuation * cosineTerm;\n\n\n	}\n\n#endif\n\n#if MAX_SPOT_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\n\n		vec3 lightColor = spotLightColor[ i ];\n\n		vec3 lightPosition = spotLightPosition[ i ];\n		vec3 lVector = lightPosition + vViewPosition.xyz;\n		vec3 lightDir = normalize( lVector );\n\n		float spotEffect = dot( spotLightDirection[ i ], lightDir );\n\n		if ( spotEffect > spotLightAngleCos[ i ] ) {\n\n			spotEffect = saturate( pow( saturate( spotEffect ), spotLightExponent[ i ] ) );\n\n\n			float attenuation = calcLightAttenuation( length( lVector ), spotLightDistance[ i ], spotLightDecay[ i ] );\n\n			attenuation *= spotEffect;\n\n\n			float cosineTerm = saturate( dot( normal, lightDir ) );\n\n			totalDiffuseLight += lightColor * attenuation * cosineTerm;\n\n\n			vec3 brdf = BRDF_BlinnPhong( specular, shininess, normal, lightDir, viewDir );\n\n			totalSpecularLight += brdf * specularStrength * lightColor * attenuation * cosineTerm;\n\n		}\n\n	}\n\n#endif\n\n#if MAX_DIR_LIGHTS > 0\n\n	for ( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\n\n		vec3 lightColor = directionalLightColor[ i ];\n\n		vec3 lightDir = directionalLightDirection[ i ];\n\n\n		float cosineTerm = saturate( dot( normal, lightDir ) );\n\n		totalDiffuseLight += lightColor * cosineTerm;\n\n\n		vec3 brdf = BRDF_BlinnPhong( specular, shininess, normal, lightDir, viewDir );\n\n		totalSpecularLight += brdf * specularStrength * lightColor * cosineTerm;\n\n	}\n\n#endif\n",i.ShaderChunk.lights_phong_pars_fragment="uniform vec3 ambientLightColor;\n\n#if MAX_DIR_LIGHTS > 0\n\n	uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\n	uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n\n#endif\n\n#if MAX_HEMI_LIGHTS > 0\n\n	uniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\n	uniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\n	uniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n\n#endif\n\n#if MAX_POINT_LIGHTS > 0\n\n	uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\n\n	uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\n	uniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n	uniform float pointLightDecay[ MAX_POINT_LIGHTS ];\n\n#endif\n\n#if MAX_SPOT_LIGHTS > 0\n\n	uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\n	uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\n	uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n	uniform float spotLightDecay[ MAX_SPOT_LIGHTS ];\n\n#endif\n\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_ENVMAP )\n\n	varying vec3 vWorldPosition;\n\n#endif\n\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\n	varying vec3 vNormal;\n\n#endif\n",i.ShaderChunk.lights_phong_pars_vertex="#if MAX_SPOT_LIGHTS > 0 || defined( USE_ENVMAP )\n\n	varying vec3 vWorldPosition;\n\n#endif\n\n#if MAX_POINT_LIGHTS > 0\n\n	uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\n\n#endif\n",i.ShaderChunk.lights_phong_vertex="#if MAX_SPOT_LIGHTS > 0 || defined( USE_ENVMAP )\n\n	vWorldPosition = worldPosition.xyz;\n\n#endif\n",i.ShaderChunk.linear_to_gamma_fragment="\n	outgoingLight = linearToOutput( outgoingLight );\n",i.ShaderChunk.logdepthbuf_fragment="#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n\n	gl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n\n#endif",i.ShaderChunk.logdepthbuf_pars_fragment="#ifdef USE_LOGDEPTHBUF\n\n	uniform float logDepthBufFC;\n\n	#ifdef USE_LOGDEPTHBUF_EXT\n\n		varying float vFragDepth;\n\n	#endif\n\n#endif\n",i.ShaderChunk.logdepthbuf_pars_vertex="#ifdef USE_LOGDEPTHBUF\n\n	#ifdef USE_LOGDEPTHBUF_EXT\n\n		varying float vFragDepth;\n\n	#endif\n\n	uniform float logDepthBufFC;\n\n#endif",i.ShaderChunk.logdepthbuf_vertex="#ifdef USE_LOGDEPTHBUF\n\n	gl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\n\n	#ifdef USE_LOGDEPTHBUF_EXT\n\n		vFragDepth = 1.0 + gl_Position.w;\n\n#else\n\n		gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n\n	#endif\n\n#endif",i.ShaderChunk.map_fragment="#ifdef USE_MAP\n\n	vec4 texelColor = texture2D( map, vUv );\n\n	texelColor.xyz = inputToLinear( texelColor.xyz );\n\n	diffuseColor *= texelColor;\n\n#endif\n",i.ShaderChunk.map_pars_fragment="#ifdef USE_MAP\n\n	uniform sampler2D map;\n\n#endif",i.ShaderChunk.map_particle_fragment="#ifdef USE_MAP\n\n	diffuseColor *= texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) * offsetRepeat.zw + offsetRepeat.xy );\n\n#endif\n",i.ShaderChunk.map_particle_pars_fragment="#ifdef USE_MAP\n\n	uniform vec4 offsetRepeat;\n	uniform sampler2D map;\n\n#endif\n",i.ShaderChunk.morphnormal_vertex="#ifdef USE_MORPHNORMALS\n\n	objectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n	objectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n	objectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n	objectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n\n#endif\n",i.ShaderChunk.morphtarget_pars_vertex="#ifdef USE_MORPHTARGETS\n\n	#ifndef USE_MORPHNORMALS\n\n	uniform float morphTargetInfluences[ 8 ];\n\n	#else\n\n	uniform float morphTargetInfluences[ 4 ];\n\n	#endif\n\n#endif",i.ShaderChunk.morphtarget_vertex="#ifdef USE_MORPHTARGETS\n\n	transformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n	transformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n	transformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n	transformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\n	#ifndef USE_MORPHNORMALS\n\n	transformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n	transformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n	transformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n	transformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\n	#endif\n\n#endif\n",i.ShaderChunk.normal_phong_fragment="#ifndef FLAT_SHADED\n\n	vec3 normal = normalize( vNormal );\n\n	#ifdef DOUBLE_SIDED\n\n		normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n\n	#endif\n\n#else\n\n	vec3 fdx = dFdx( vViewPosition );\n	vec3 fdy = dFdy( vViewPosition );\n	vec3 normal = normalize( cross( fdx, fdy ) );\n\n#endif\n\n#ifdef USE_NORMALMAP\n\n	normal = perturbNormal2Arb( -vViewPosition, normal );\n\n#elif defined( USE_BUMPMAP )\n\n	normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n\n#endif\n\n",i.ShaderChunk.normalmap_pars_fragment="#ifdef USE_NORMALMAP\n\n	uniform sampler2D normalMap;\n	uniform vec2 normalScale;\n\n\n	vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\n		vec3 q0 = dFdx( eye_pos.xyz );\n		vec3 q1 = dFdy( eye_pos.xyz );\n		vec2 st0 = dFdx( vUv.st );\n		vec2 st1 = dFdy( vUv.st );\n\n		vec3 S = normalize( q0 * st1.t - q1 * st0.t );\n		vec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n		vec3 N = normalize( surf_norm );\n\n		vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n		mapN.xy = normalScale * mapN.xy;\n		mat3 tsn = mat3( S, T, N );\n		return normalize( tsn * mapN );\n\n	}\n\n#endif\n",i.ShaderChunk.project_vertex="#ifdef USE_SKINNING\n\n	vec4 mvPosition = modelViewMatrix * skinned;\n\n#else\n\n	vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n\n#endif\n\ngl_Position = projectionMatrix * mvPosition;\n",i.ShaderChunk.shadowmap_fragment="#ifdef USE_SHADOWMAP\n\n	for ( int i = 0; i < MAX_SHADOWS; i ++ ) {\n\n		float texelSizeY =  1.0 / shadowMapSize[ i ].y;\n\n		float shadow = 0.0;\n\n#if defined( POINT_LIGHT_SHADOWS )\n\n		bool isPointLight = shadowDarkness[ i ] < 0.0;\n\n		if ( isPointLight ) {\n\n			float realShadowDarkness = abs( shadowDarkness[ i ] );\n\n			vec3 lightToPosition = vShadowCoord[ i ].xyz;\n\n	#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\n			vec3 bd3D = normalize( lightToPosition );\n			float dp = length( lightToPosition );\n\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D, texelSizeY ) ), shadowBias[ i ], shadow );\n\n\n	#if defined( SHADOWMAP_TYPE_PCF )\n			const float Dr = 1.25;\n	#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n			const float Dr = 2.25;\n	#endif\n\n			float os = Dr *  2.0 * texelSizeY;\n\n			const vec3 Gsd = vec3( - 1, 0, 1 );\n\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zzz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zxz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xxz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xzz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zzx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zxx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xxx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xzx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zzy * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zxy * os, texelSizeY ) ), shadowBias[ i ], shadow );\n\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xxy * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xzy * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zyz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xyz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.zyx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.xyx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.yzz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.yxz * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.yxx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D + Gsd.yzx * os, texelSizeY ) ), shadowBias[ i ], shadow );\n\n			shadow *= realShadowDarkness * ( 1.0 / 21.0 );\n\n	#else \n			vec3 bd3D = normalize( lightToPosition );\n			float dp = length( lightToPosition );\n\n			adjustShadowValue1K( dp, texture2D( shadowMap[ i ], cubeToUV( bd3D, texelSizeY ) ), shadowBias[ i ], shadow );\n\n			shadow *= realShadowDarkness;\n\n	#endif\n\n		} else {\n\n#endif \n			float texelSizeX =  1.0 / shadowMapSize[ i ].x;\n\n			vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;\n\n\n			bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n			bool inFrustum = all( inFrustumVec );\n\n			bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n			bool frustumTest = all( frustumTestVec );\n\n			if ( frustumTest ) {\n\n	#if defined( SHADOWMAP_TYPE_PCF )\n\n\n				/*\n					for ( float y = -1.25; y <= 1.25; y += 1.25 )\n						for ( float x = -1.25; x <= 1.25; x += 1.25 ) {\n							vec4 rgbaDepth = texture2D( shadowMap[ i ], vec2( x * xPixelOffset, y * yPixelOffset ) + shadowCoord.xy );\n							float fDepth = unpackDepth( rgbaDepth );\n							if ( fDepth < shadowCoord.z )\n								shadow += 1.0;\n					}\n					shadow /= 9.0;\n				*/\n\n				shadowCoord.z += shadowBias[ i ];\n\n				const float ShadowDelta = 1.0 / 9.0;\n\n				float xPixelOffset = texelSizeX;\n				float yPixelOffset = texelSizeY;\n\n				float dx0 = - 1.25 * xPixelOffset;\n				float dy0 = - 1.25 * yPixelOffset;\n				float dx1 = 1.25 * xPixelOffset;\n				float dy1 = 1.25 * yPixelOffset;\n\n				float fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );\n				if ( fDepth < shadowCoord.z ) shadow += ShadowDelta;\n\n				shadow *= shadowDarkness[ i ];\n\n	#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\n\n				shadowCoord.z += shadowBias[ i ];\n\n				float xPixelOffset = texelSizeX;\n				float yPixelOffset = texelSizeY;\n\n				float dx0 = - 1.0 * xPixelOffset;\n				float dy0 = - 1.0 * yPixelOffset;\n				float dx1 = 1.0 * xPixelOffset;\n				float dy1 = 1.0 * yPixelOffset;\n\n				mat3 shadowKernel;\n				mat3 depthKernel;\n\n				depthKernel[ 0 ][ 0 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );\n				depthKernel[ 0 ][ 1 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );\n				depthKernel[ 0 ][ 2 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );\n				depthKernel[ 1 ][ 0 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );\n				depthKernel[ 1 ][ 1 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );\n				depthKernel[ 1 ][ 2 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );\n				depthKernel[ 2 ][ 0 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );\n				depthKernel[ 2 ][ 1 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );\n				depthKernel[ 2 ][ 2 ] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );\n\n				vec3 shadowZ = vec3( shadowCoord.z );\n				shadowKernel[ 0 ] = vec3( lessThan( depthKernel[ 0 ], shadowZ ) );\n				shadowKernel[ 0 ] *= vec3( 0.25 );\n\n				shadowKernel[ 1 ] = vec3( lessThan( depthKernel[ 1 ], shadowZ ) );\n				shadowKernel[ 1 ] *= vec3( 0.25 );\n\n				shadowKernel[ 2 ] = vec3( lessThan( depthKernel[ 2 ], shadowZ ) );\n				shadowKernel[ 2 ] *= vec3( 0.25 );\n\n				vec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[ i ].xy );\n\n				shadowKernel[ 0 ] = mix( shadowKernel[ 1 ], shadowKernel[ 0 ], fractionalCoord.x );\n				shadowKernel[ 1 ] = mix( shadowKernel[ 2 ], shadowKernel[ 1 ], fractionalCoord.x );\n\n				vec4 shadowValues;\n				shadowValues.x = mix( shadowKernel[ 0 ][ 1 ], shadowKernel[ 0 ][ 0 ], fractionalCoord.y );\n				shadowValues.y = mix( shadowKernel[ 0 ][ 2 ], shadowKernel[ 0 ][ 1 ], fractionalCoord.y );\n				shadowValues.z = mix( shadowKernel[ 1 ][ 1 ], shadowKernel[ 1 ][ 0 ], fractionalCoord.y );\n				shadowValues.w = mix( shadowKernel[ 1 ][ 2 ], shadowKernel[ 1 ][ 1 ], fractionalCoord.y );\n\n				shadow = dot( shadowValues, vec4( 1.0 ) ) * shadowDarkness[ i ];\n\n	#else \n				shadowCoord.z += shadowBias[ i ];\n\n				vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );\n				float fDepth = unpackDepth( rgbaDepth );\n\n				if ( fDepth < shadowCoord.z )\n					shadow = shadowDarkness[ i ];\n\n	#endif\n\n			}\n\n#ifdef SHADOWMAP_DEBUG\n\n			if ( inFrustum ) {\n\n				if ( i == 0 ) {\n\n					outgoingLight *= vec3( 1.0, 0.5, 0.0 );\n\n				} else if ( i == 1 ) {\n\n					outgoingLight *= vec3( 0.0, 1.0, 0.8 );\n\n				} else {\n\n					outgoingLight *= vec3( 0.0, 0.5, 1.0 );\n\n				}\n\n			}\n\n#endif\n\n#if defined( POINT_LIGHT_SHADOWS )\n\n		}\n\n#endif\n\n		shadowMask = shadowMask * vec3( 1.0 - shadow );\n\n	}\n\n#endif\n",i.ShaderChunk.shadowmap_pars_fragment="#ifdef USE_SHADOWMAP\n\n	uniform sampler2D shadowMap[ MAX_SHADOWS ];\n	uniform vec2 shadowMapSize[ MAX_SHADOWS ];\n\n	uniform float shadowDarkness[ MAX_SHADOWS ];\n	uniform float shadowBias[ MAX_SHADOWS ];\n\n	varying vec4 vShadowCoord[ MAX_SHADOWS ];\n\n	float unpackDepth( const in vec4 rgba_depth ) {\n\n		const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\n		float depth = dot( rgba_depth, bit_shift );\n		return depth;\n\n	}\n\n	#if defined(POINT_LIGHT_SHADOWS)\n\n\n		void adjustShadowValue1K( const float testDepth, const vec4 textureData, const float bias, inout float shadowValue ) {\n\n			const vec4 bitSh = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\n			if ( testDepth >= dot( textureData, bitSh ) * 1000.0 + bias )\n				shadowValue += 1.0;\n\n		}\n\n\n		vec2 cubeToUV( vec3 v, float texelSizeY ) {\n\n\n			vec3 absV = abs( v );\n\n\n			float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n			absV *= scaleToCube;\n\n\n			v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\n\n\n			vec2 planar = v.xy;\n\n			float almostATexel = 1.5 * texelSizeY;\n			float almostOne = 1.0 - almostATexel;\n\n			if ( absV.z >= almostOne ) {\n\n				if ( v.z > 0.0 )\n					planar.x = 4.0 - v.x;\n\n			} else if ( absV.x >= almostOne ) {\n\n				float signX = sign( v.x );\n				planar.x = v.z * signX + 2.0 * signX;\n\n			} else if ( absV.y >= almostOne ) {\n\n				float signY = sign( v.y );\n				planar.x = v.x + 2.0 * signY + 2.0;\n				planar.y = v.z * signY - 2.0;\n\n			}\n\n\n			return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\n		}\n\n	#endif\n\n#endif\n",i.ShaderChunk.shadowmap_pars_vertex="#ifdef USE_SHADOWMAP\n\n	uniform float shadowDarkness[ MAX_SHADOWS ];\n	uniform mat4 shadowMatrix[ MAX_SHADOWS ];\n	varying vec4 vShadowCoord[ MAX_SHADOWS ];\n\n#endif",i.ShaderChunk.shadowmap_vertex="#ifdef USE_SHADOWMAP\n\n	for ( int i = 0; i < MAX_SHADOWS; i ++ ) {\n\n			vShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;\n\n	}\n\n#endif",i.ShaderChunk.skinbase_vertex="#ifdef USE_SKINNING\n\n	mat4 boneMatX = getBoneMatrix( skinIndex.x );\n	mat4 boneMatY = getBoneMatrix( skinIndex.y );\n	mat4 boneMatZ = getBoneMatrix( skinIndex.z );\n	mat4 boneMatW = getBoneMatrix( skinIndex.w );\n\n#endif",i.ShaderChunk.skinning_pars_vertex="#ifdef USE_SKINNING\n\n	uniform mat4 bindMatrix;\n	uniform mat4 bindMatrixInverse;\n\n	#ifdef BONE_TEXTURE\n\n		uniform sampler2D boneTexture;\n		uniform int boneTextureWidth;\n		uniform int boneTextureHeight;\n\n		mat4 getBoneMatrix( const in float i ) {\n\n			float j = i * 4.0;\n			float x = mod( j, float( boneTextureWidth ) );\n			float y = floor( j / float( boneTextureWidth ) );\n\n			float dx = 1.0 / float( boneTextureWidth );\n			float dy = 1.0 / float( boneTextureHeight );\n\n			y = dy * ( y + 0.5 );\n\n			vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n			vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n			vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n			vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\n			mat4 bone = mat4( v1, v2, v3, v4 );\n\n			return bone;\n\n		}\n\n	#else\n\n		uniform mat4 boneGlobalMatrices[ MAX_BONES ];\n\n		mat4 getBoneMatrix( const in float i ) {\n\n			mat4 bone = boneGlobalMatrices[ int(i) ];\n			return bone;\n\n		}\n\n	#endif\n\n#endif\n",i.ShaderChunk.skinning_vertex="#ifdef USE_SKINNING\n\n	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\n	vec4 skinned = vec4( 0.0 );\n	skinned += boneMatX * skinVertex * skinWeight.x;\n	skinned += boneMatY * skinVertex * skinWeight.y;\n	skinned += boneMatZ * skinVertex * skinWeight.z;\n	skinned += boneMatW * skinVertex * skinWeight.w;\n	skinned  = bindMatrixInverse * skinned;\n\n#endif\n",i.ShaderChunk.skinnormal_vertex="#ifdef USE_SKINNING\n\n	mat4 skinMatrix = mat4( 0.0 );\n	skinMatrix += skinWeight.x * boneMatX;\n	skinMatrix += skinWeight.y * boneMatY;\n	skinMatrix += skinWeight.z * boneMatZ;\n	skinMatrix += skinWeight.w * boneMatW;\n	skinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\n	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\n#endif\n",i.ShaderChunk.specularmap_fragment="float specularStrength;\n\n#ifdef USE_SPECULARMAP\n\n	vec4 texelSpecular = texture2D( specularMap, vUv );\n	specularStrength = texelSpecular.r;\n\n#else\n\n	specularStrength = 1.0;\n\n#endif",i.ShaderChunk.specularmap_pars_fragment="#ifdef USE_SPECULARMAP\n\n	uniform sampler2D specularMap;\n\n#endif",i.ShaderChunk.uv2_pars_fragment="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n	varying vec2 vUv2;\n\n#endif",i.ShaderChunk.uv2_pars_vertex="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n	attribute vec2 uv2;\n	varying vec2 vUv2;\n\n#endif",i.ShaderChunk.uv2_vertex="#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n	vUv2 = uv2;\n\n#endif",i.ShaderChunk.uv_pars_fragment="#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP )\n\n	varying vec2 vUv;\n\n#endif",i.ShaderChunk.uv_pars_vertex="#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP )\n\n	varying vec2 vUv;\n	uniform vec4 offsetRepeat;\n\n#endif\n",
i.ShaderChunk.uv_vertex="#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP )\n\n	vUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n\n#endif",i.ShaderChunk.worldpos_vertex="#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n\n	#ifdef USE_SKINNING\n\n		vec4 worldPosition = modelMatrix * skinned;\n\n	#else\n\n		vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n\n	#endif\n\n#endif\n",i.UniformsUtils={merge:function(e){for(var t={},r=0;r<e.length;r++){var n=this.clone(e[r]);for(var i in n)t[i]=n[i]}return t},clone:function(e){var t={};for(var r in e){t[r]={};for(var n in e[r]){var o=e[r][n];o instanceof i.Color||o instanceof i.Vector2||o instanceof i.Vector3||o instanceof i.Vector4||o instanceof i.Matrix3||o instanceof i.Matrix4||o instanceof i.Texture?t[r][n]=o.clone():Array.isArray(o)?t[r][n]=o.slice():t[r][n]=o}}return t}},i.UniformsLib={common:{diffuse:{type:"c",value:new i.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new i.Vector4(0,0,1,1)},specularMap:{type:"t",value:null},alphaMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98}},aomap:{aoMap:{type:"t",value:null},aoMapIntensity:{type:"f",value:1}},lightmap:{lightMap:{type:"t",value:null},lightMapIntensity:{type:"f",value:1}},emissivemap:{emissiveMap:{type:"t",value:null}},bumpmap:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new i.Vector2(1,1)}},displacementmap:{displacementMap:{type:"t",value:null},displacementScale:{type:"f",value:1},displacementBias:{type:"f",value:0}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new i.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},pointLightDecay:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]},spotLightDecay:{type:"fv1",value:[]}},points:{psColor:{type:"c",value:new i.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new i.Vector4(0,0,1,1)},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new i.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}},i.ShaderLib={basic:{uniforms:i.UniformsUtils.merge([i.UniformsLib.common,i.UniformsLib.aomap,i.UniformsLib.fog,i.UniformsLib.shadowmap]),vertexShader:[i.ShaderChunk.common,i.ShaderChunk.uv_pars_vertex,i.ShaderChunk.uv2_pars_vertex,i.ShaderChunk.envmap_pars_vertex,i.ShaderChunk.color_pars_vertex,i.ShaderChunk.morphtarget_pars_vertex,i.ShaderChunk.skinning_pars_vertex,i.ShaderChunk.shadowmap_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",i.ShaderChunk.uv_vertex,i.ShaderChunk.uv2_vertex,i.ShaderChunk.color_vertex,i.ShaderChunk.skinbase_vertex,"	#ifdef USE_ENVMAP",i.ShaderChunk.beginnormal_vertex,i.ShaderChunk.morphnormal_vertex,i.ShaderChunk.skinnormal_vertex,i.ShaderChunk.defaultnormal_vertex,"	#endif",i.ShaderChunk.begin_vertex,i.ShaderChunk.morphtarget_vertex,i.ShaderChunk.skinning_vertex,i.ShaderChunk.project_vertex,i.ShaderChunk.logdepthbuf_vertex,i.ShaderChunk.worldpos_vertex,i.ShaderChunk.envmap_vertex,i.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;",i.ShaderChunk.common,i.ShaderChunk.color_pars_fragment,i.ShaderChunk.uv_pars_fragment,i.ShaderChunk.uv2_pars_fragment,i.ShaderChunk.map_pars_fragment,i.ShaderChunk.alphamap_pars_fragment,i.ShaderChunk.aomap_pars_fragment,i.ShaderChunk.envmap_pars_fragment,i.ShaderChunk.fog_pars_fragment,i.ShaderChunk.shadowmap_pars_fragment,i.ShaderChunk.specularmap_pars_fragment,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","	vec3 outgoingLight = vec3( 0.0 );","	vec4 diffuseColor = vec4( diffuse, opacity );","	vec3 totalAmbientLight = vec3( 1.0 );","	vec3 shadowMask = vec3( 1.0 );",i.ShaderChunk.logdepthbuf_fragment,i.ShaderChunk.map_fragment,i.ShaderChunk.color_fragment,i.ShaderChunk.alphamap_fragment,i.ShaderChunk.alphatest_fragment,i.ShaderChunk.specularmap_fragment,i.ShaderChunk.aomap_fragment,i.ShaderChunk.shadowmap_fragment,"	outgoingLight = diffuseColor.rgb * totalAmbientLight * shadowMask;",i.ShaderChunk.envmap_fragment,i.ShaderChunk.linear_to_gamma_fragment,i.ShaderChunk.fog_fragment,"	gl_FragColor = vec4( outgoingLight, diffuseColor.a );","}"].join("\n")},lambert:{uniforms:i.UniformsUtils.merge([i.UniformsLib.common,i.UniformsLib.fog,i.UniformsLib.lights,i.UniformsLib.shadowmap,{emissive:{type:"c",value:new i.Color(0)}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","	varying vec3 vLightBack;","#endif",i.ShaderChunk.common,i.ShaderChunk.uv_pars_vertex,i.ShaderChunk.uv2_pars_vertex,i.ShaderChunk.envmap_pars_vertex,i.ShaderChunk.lights_lambert_pars_vertex,i.ShaderChunk.color_pars_vertex,i.ShaderChunk.morphtarget_pars_vertex,i.ShaderChunk.skinning_pars_vertex,i.ShaderChunk.shadowmap_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",i.ShaderChunk.uv_vertex,i.ShaderChunk.uv2_vertex,i.ShaderChunk.color_vertex,i.ShaderChunk.beginnormal_vertex,i.ShaderChunk.morphnormal_vertex,i.ShaderChunk.skinbase_vertex,i.ShaderChunk.skinnormal_vertex,i.ShaderChunk.defaultnormal_vertex,i.ShaderChunk.begin_vertex,i.ShaderChunk.morphtarget_vertex,i.ShaderChunk.skinning_vertex,i.ShaderChunk.project_vertex,i.ShaderChunk.logdepthbuf_vertex,i.ShaderChunk.worldpos_vertex,i.ShaderChunk.envmap_vertex,i.ShaderChunk.lights_lambert_vertex,i.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform vec3 emissive;","uniform float opacity;","uniform vec3 ambientLightColor;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","	varying vec3 vLightBack;","#endif",i.ShaderChunk.common,i.ShaderChunk.color_pars_fragment,i.ShaderChunk.uv_pars_fragment,i.ShaderChunk.uv2_pars_fragment,i.ShaderChunk.map_pars_fragment,i.ShaderChunk.alphamap_pars_fragment,i.ShaderChunk.envmap_pars_fragment,i.ShaderChunk.fog_pars_fragment,i.ShaderChunk.shadowmap_pars_fragment,i.ShaderChunk.specularmap_pars_fragment,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","	vec3 outgoingLight = vec3( 0.0 );","	vec4 diffuseColor = vec4( diffuse, opacity );","	vec3 totalAmbientLight = ambientLightColor;","	vec3 shadowMask = vec3( 1.0 );",i.ShaderChunk.logdepthbuf_fragment,i.ShaderChunk.map_fragment,i.ShaderChunk.color_fragment,i.ShaderChunk.alphamap_fragment,i.ShaderChunk.alphatest_fragment,i.ShaderChunk.specularmap_fragment,i.ShaderChunk.shadowmap_fragment,"	#ifdef DOUBLE_SIDED","		if ( gl_FrontFacing )","			outgoingLight += diffuseColor.rgb * ( vLightFront * shadowMask + totalAmbientLight ) + emissive;","		else","			outgoingLight += diffuseColor.rgb * ( vLightBack * shadowMask + totalAmbientLight ) + emissive;","	#else","		outgoingLight += diffuseColor.rgb * ( vLightFront * shadowMask + totalAmbientLight ) + emissive;","	#endif",i.ShaderChunk.envmap_fragment,i.ShaderChunk.linear_to_gamma_fragment,i.ShaderChunk.fog_fragment,"	gl_FragColor = vec4( outgoingLight, diffuseColor.a );","}"].join("\n")},phong:{uniforms:i.UniformsUtils.merge([i.UniformsLib.common,i.UniformsLib.aomap,i.UniformsLib.lightmap,i.UniformsLib.emissivemap,i.UniformsLib.bumpmap,i.UniformsLib.normalmap,i.UniformsLib.displacementmap,i.UniformsLib.fog,i.UniformsLib.lights,i.UniformsLib.shadowmap,{emissive:{type:"c",value:new i.Color(0)},specular:{type:"c",value:new i.Color(1118481)},shininess:{type:"f",value:30}}]),vertexShader:["#define PHONG","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","	varying vec3 vNormal;","#endif",i.ShaderChunk.common,i.ShaderChunk.uv_pars_vertex,i.ShaderChunk.uv2_pars_vertex,i.ShaderChunk.displacementmap_pars_vertex,i.ShaderChunk.envmap_pars_vertex,i.ShaderChunk.lights_phong_pars_vertex,i.ShaderChunk.color_pars_vertex,i.ShaderChunk.morphtarget_pars_vertex,i.ShaderChunk.skinning_pars_vertex,i.ShaderChunk.shadowmap_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",i.ShaderChunk.uv_vertex,i.ShaderChunk.uv2_vertex,i.ShaderChunk.color_vertex,i.ShaderChunk.beginnormal_vertex,i.ShaderChunk.morphnormal_vertex,i.ShaderChunk.skinbase_vertex,i.ShaderChunk.skinnormal_vertex,i.ShaderChunk.defaultnormal_vertex,"#ifndef FLAT_SHADED","	vNormal = normalize( transformedNormal );","#endif",i.ShaderChunk.begin_vertex,i.ShaderChunk.displacementmap_vertex,i.ShaderChunk.morphtarget_vertex,i.ShaderChunk.skinning_vertex,i.ShaderChunk.project_vertex,i.ShaderChunk.logdepthbuf_vertex,"	vViewPosition = - mvPosition.xyz;",i.ShaderChunk.worldpos_vertex,i.ShaderChunk.envmap_vertex,i.ShaderChunk.lights_phong_vertex,i.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["#define PHONG","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform float opacity;",i.ShaderChunk.common,i.ShaderChunk.color_pars_fragment,i.ShaderChunk.uv_pars_fragment,i.ShaderChunk.uv2_pars_fragment,i.ShaderChunk.map_pars_fragment,i.ShaderChunk.alphamap_pars_fragment,i.ShaderChunk.aomap_pars_fragment,i.ShaderChunk.lightmap_pars_fragment,i.ShaderChunk.emissivemap_pars_fragment,i.ShaderChunk.envmap_pars_fragment,i.ShaderChunk.fog_pars_fragment,i.ShaderChunk.lights_phong_pars_fragment,i.ShaderChunk.shadowmap_pars_fragment,i.ShaderChunk.bumpmap_pars_fragment,i.ShaderChunk.normalmap_pars_fragment,i.ShaderChunk.specularmap_pars_fragment,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","	vec3 outgoingLight = vec3( 0.0 );","	vec4 diffuseColor = vec4( diffuse, opacity );","	vec3 totalAmbientLight = ambientLightColor;","	vec3 totalEmissiveLight = emissive;","	vec3 shadowMask = vec3( 1.0 );",i.ShaderChunk.logdepthbuf_fragment,i.ShaderChunk.map_fragment,i.ShaderChunk.color_fragment,i.ShaderChunk.alphamap_fragment,i.ShaderChunk.alphatest_fragment,i.ShaderChunk.specularmap_fragment,i.ShaderChunk.normal_phong_fragment,i.ShaderChunk.lightmap_fragment,i.ShaderChunk.hemilight_fragment,i.ShaderChunk.aomap_fragment,i.ShaderChunk.emissivemap_fragment,i.ShaderChunk.lights_phong_fragment,i.ShaderChunk.shadowmap_fragment,"totalDiffuseLight *= shadowMask;","totalSpecularLight *= shadowMask;","#ifdef METAL","	outgoingLight += diffuseColor.rgb * ( totalDiffuseLight + totalAmbientLight ) * specular + totalSpecularLight + totalEmissiveLight;","#else","	outgoingLight += diffuseColor.rgb * ( totalDiffuseLight + totalAmbientLight ) + totalSpecularLight + totalEmissiveLight;","#endif",i.ShaderChunk.envmap_fragment,i.ShaderChunk.linear_to_gamma_fragment,i.ShaderChunk.fog_fragment,"	gl_FragColor = vec4( outgoingLight, diffuseColor.a );","}"].join("\n")},points:{uniforms:i.UniformsUtils.merge([i.UniformsLib.points,i.UniformsLib.shadowmap]),vertexShader:["uniform float size;","uniform float scale;",i.ShaderChunk.common,i.ShaderChunk.color_pars_vertex,i.ShaderChunk.shadowmap_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",i.ShaderChunk.color_vertex,"	vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","	#ifdef USE_SIZEATTENUATION","		gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","	#else","		gl_PointSize = size;","	#endif","	gl_Position = projectionMatrix * mvPosition;",i.ShaderChunk.logdepthbuf_vertex,i.ShaderChunk.worldpos_vertex,i.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;","uniform float opacity;",i.ShaderChunk.common,i.ShaderChunk.color_pars_fragment,i.ShaderChunk.map_particle_pars_fragment,i.ShaderChunk.fog_pars_fragment,i.ShaderChunk.shadowmap_pars_fragment,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","	vec3 outgoingLight = vec3( 0.0 );","	vec4 diffuseColor = vec4( psColor, opacity );","	vec3 shadowMask = vec3( 1.0 );",i.ShaderChunk.logdepthbuf_fragment,i.ShaderChunk.map_particle_fragment,i.ShaderChunk.color_fragment,i.ShaderChunk.alphatest_fragment,i.ShaderChunk.shadowmap_fragment,"	outgoingLight = diffuseColor.rgb * shadowMask;",i.ShaderChunk.fog_fragment,"	gl_FragColor = vec4( outgoingLight, diffuseColor.a );","}"].join("\n")},dashed:{uniforms:i.UniformsUtils.merge([i.UniformsLib.common,i.UniformsLib.fog,{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}}]),vertexShader:["uniform float scale;","attribute float lineDistance;","varying float vLineDistance;",i.ShaderChunk.common,i.ShaderChunk.color_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",i.ShaderChunk.color_vertex,"	vLineDistance = scale * lineDistance;","	vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","	gl_Position = projectionMatrix * mvPosition;",i.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float totalSize;","varying float vLineDistance;",i.ShaderChunk.common,i.ShaderChunk.color_pars_fragment,i.ShaderChunk.fog_pars_fragment,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","	if ( mod( vLineDistance, totalSize ) > dashSize ) {","		discard;","	}","	vec3 outgoingLight = vec3( 0.0 );","	vec4 diffuseColor = vec4( diffuse, opacity );",i.ShaderChunk.logdepthbuf_fragment,i.ShaderChunk.color_fragment,"	outgoingLight = diffuseColor.rgb;",i.ShaderChunk.fog_fragment,"	gl_FragColor = vec4( outgoingLight, diffuseColor.a );","}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:[i.ShaderChunk.common,i.ShaderChunk.morphtarget_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",i.ShaderChunk.begin_vertex,i.ShaderChunk.morphtarget_vertex,i.ShaderChunk.project_vertex,i.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;",i.ShaderChunk.common,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {",i.ShaderChunk.logdepthbuf_fragment,"	#ifdef USE_LOGDEPTHBUF_EXT","		float depth = gl_FragDepthEXT / gl_FragCoord.w;","	#else","		float depth = gl_FragCoord.z / gl_FragCoord.w;","	#endif","	float color = 1.0 - smoothstep( mNear, mFar, depth );","	gl_FragColor = vec4( vec3( color ), opacity );","}"].join("\n")},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;",i.ShaderChunk.common,i.ShaderChunk.morphtarget_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {","	vNormal = normalize( normalMatrix * normal );",i.ShaderChunk.begin_vertex,i.ShaderChunk.morphtarget_vertex,i.ShaderChunk.project_vertex,i.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vNormal;",i.ShaderChunk.common,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","	gl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );",i.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;",i.ShaderChunk.common,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {","	vWorldPosition = transformDirection( position, modelMatrix );","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",i.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vWorldPosition;",i.ShaderChunk.common,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","	gl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );",i.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")},equirect:{uniforms:{tEquirect:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vWorldPosition;",i.ShaderChunk.common,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {","	vWorldPosition = transformDirection( position, modelMatrix );","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",i.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:["uniform sampler2D tEquirect;","uniform float tFlip;","varying vec3 vWorldPosition;",i.ShaderChunk.common,i.ShaderChunk.logdepthbuf_pars_fragment,"void main() {","vec3 direction = normalize( vWorldPosition );","vec2 sampleUV;","sampleUV.y = saturate( tFlip * direction.y * -0.5 + 0.5 );","sampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;","gl_FragColor = texture2D( tEquirect, sampleUV );",i.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[i.ShaderChunk.common,i.ShaderChunk.morphtarget_pars_vertex,i.ShaderChunk.skinning_pars_vertex,i.ShaderChunk.logdepthbuf_pars_vertex,"void main() {",i.ShaderChunk.skinbase_vertex,i.ShaderChunk.begin_vertex,i.ShaderChunk.morphtarget_vertex,i.ShaderChunk.skinning_vertex,i.ShaderChunk.project_vertex,i.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:[i.ShaderChunk.common,i.ShaderChunk.logdepthbuf_pars_fragment,"vec4 pack_depth( const in float depth ) {","	const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","	const vec4 bit_mask = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","	vec4 res = mod( depth * bit_shift * vec4( 255 ), vec4( 256 ) ) / vec4( 255 );","	res -= res.xxyz * bit_mask;","	return res;","}","void main() {",i.ShaderChunk.logdepthbuf_fragment,"	#ifdef USE_LOGDEPTHBUF_EXT","		gl_FragData[ 0 ] = pack_depth( gl_FragDepthEXT );","	#else","		gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","	#endif","}"].join("\n")},distanceRGBA:{uniforms:{lightPos:{type:"v3",value:new i.Vector3(0,0,0)}},vertexShader:["varying vec4 vWorldPosition;",i.ShaderChunk.common,i.ShaderChunk.morphtarget_pars_vertex,i.ShaderChunk.skinning_pars_vertex,"void main() {",i.ShaderChunk.skinbase_vertex,i.ShaderChunk.begin_vertex,i.ShaderChunk.morphtarget_vertex,i.ShaderChunk.skinning_vertex,i.ShaderChunk.project_vertex,i.ShaderChunk.worldpos_vertex,"vWorldPosition = worldPosition;","}"].join("\n"),fragmentShader:["uniform vec3 lightPos;","varying vec4 vWorldPosition;",i.ShaderChunk.common,"vec4 pack1K ( float depth ) {","   depth /= 1000.0;","   const vec4 bitSh = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","	const vec4 bitMsk = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","	vec4 res = fract( depth * bitSh );","	res -= res.xxyz * bitMsk;","	return res; ","}","float unpack1K ( vec4 color ) {","	const vec4 bitSh = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","	return dot( color, bitSh ) * 1000.0;","}","void main () {","	gl_FragColor = pack1K( length( vWorldPosition.xyz - lightPos.xyz ) );","}"].join("\n")}},i.WebGLRenderer=function(e){function t(e,t,r,n){ae===!0&&(e*=n,t*=n,r*=n),Ie.clearColor(e,t,r,n)}function r(){He.init(),Ie.viewport(Se,Ee,Ce,Re),t(ue.r,ue.g,ue.b,he)}function n(){ye=null,Te=null,we="",be=-1,Ge=!0,He.reset()}function o(e){e.preventDefault(),n(),r(),Xe.clear()}function a(e){var t=e.target;t.removeEventListener("dispose",a),h(t),ke.textures--}function s(e){var t=e.target;t.removeEventListener("dispose",s),c(t),ke.textures--}function u(e){var t=e.target;t.removeEventListener("dispose",u),l(t)}function h(e){var t=Xe.get(e);if(e.image&&t.__image__webglTextureCube)Ie.deleteTexture(t.__image__webglTextureCube);else{if(void 0===t.__webglInit)return;Ie.deleteTexture(t.__webglTexture)}Xe["delete"](e)}function c(e){var t=Xe.get(e),r=Xe.get(e.texture);if(e&&void 0!==r.__webglTexture){if(Ie.deleteTexture(r.__webglTexture),e instanceof i.WebGLRenderTargetCube)for(var n=0;6>n;n++)Ie.deleteFramebuffer(t.__webglFramebuffer[n]),Ie.deleteRenderbuffer(t.__webglRenderbuffer[n]);else Ie.deleteFramebuffer(t.__webglFramebuffer),Ie.deleteRenderbuffer(t.__webglRenderbuffer);Xe["delete"](e.texture),Xe["delete"](e)}}function l(e){p(e),Xe["delete"](e)}function p(e){var t=Xe.get(e).program;e.program=void 0,void 0!==t&&qe.releaseProgram(t)}function f(e,t,r,n){var o;if(r instanceof i.InstancedBufferGeometry&&(o=Ne.get("ANGLE_instanced_arrays"),null===o))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===n&&(n=0),He.initAttributes();var a=r.attributes,s=t.getAttributes(),u=e.defaultAttributeValues;for(var h in s){var c=s[h];if(c>=0){var l=a[h];if(void 0!==l){var p=l.itemSize,f=We.getAttributeBuffer(l);if(l instanceof i.InterleavedBufferAttribute){var d=l.data,m=d.stride,g=l.offset;d instanceof i.InstancedInterleavedBuffer?(He.enableAttributeAndDivisor(c,d.meshPerAttribute,o),void 0===r.maxInstancedCount&&(r.maxInstancedCount=d.meshPerAttribute*d.count)):He.enableAttribute(c),Ie.bindBuffer(Ie.ARRAY_BUFFER,f),Ie.vertexAttribPointer(c,p,Ie.FLOAT,!1,m*d.array.BYTES_PER_ELEMENT,(n*m+g)*d.array.BYTES_PER_ELEMENT)}else l instanceof i.InstancedBufferAttribute?(He.enableAttributeAndDivisor(c,l.meshPerAttribute,o),void 0===r.maxInstancedCount&&(r.maxInstancedCount=l.meshPerAttribute*l.count)):He.enableAttribute(c),Ie.bindBuffer(Ie.ARRAY_BUFFER,f),Ie.vertexAttribPointer(c,p,Ie.FLOAT,!1,0,n*p*4)}else if(void 0!==u){var v=u[h];if(void 0!==v)switch(v.length){case 2:Ie.vertexAttrib2fv(c,v);break;case 3:Ie.vertexAttrib3fv(c,v);break;case 4:Ie.vertexAttrib4fv(c,v);break;default:Ie.vertexAttrib1fv(c,v)}}}}He.disableUnusedAttributes()}function d(e,t){return t[0]-e[0]}function m(e,t){return e.object.renderOrder!==t.object.renderOrder?e.object.renderOrder-t.object.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function g(e,t){return e.object.renderOrder!==t.object.renderOrder?e.object.renderOrder-t.object.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function v(e,t,r,n,i){var o,a;r.transparent?(o=fe,a=++de):(o=le,a=++pe);var s=o[a];void 0!==s?(s.id=e.id,s.object=e,s.geometry=t,s.material=r,s.z=Be.z,s.group=i):(s={id:e.id,object:e,geometry:t,material:r,z:Be.z,group:i},o.push(s))}function x(e,t){if(e.visible!==!1){if(0!==(e.channels.mask&t.channels.mask))if(e instanceof i.Light)ce.push(e);else if(e instanceof i.Sprite)ge.push(e);else if(e instanceof i.LensFlare)ve.push(e);else if(e instanceof i.ImmediateRenderObject)xe.sortObjects===!0&&(Be.setFromMatrixPosition(e.matrixWorld),Be.applyProjection(Le)),v(e,null,e.material,Be.z,null);else if((e instanceof i.Mesh||e instanceof i.Line||e instanceof i.Points)&&(e instanceof i.SkinnedMesh&&e.skeleton.update(),e.frustumCulled===!1||Pe.intersectsObject(e)===!0)){var r=e.material;if(r.visible===!0){xe.sortObjects===!0&&(Be.setFromMatrixPosition(e.matrixWorld),Be.applyProjection(Le));var n=We.update(e);if(r instanceof i.MeshFaceMaterial)for(var o=n.groups,a=r.materials,s=0,u=o.length;u>s;s++){var h=o[s],c=a[h.materialIndex];c.visible===!0&&v(e,n,c,Be.z,h)}else v(e,n,r,Be.z,null)}}for(var l=e.children,s=0,u=l.length;u>s;s++)x(l[s],t)}}function y(e,t,r,n,o){for(var a=0,s=e.length;s>a;a++){var u=e[a],h=u.object,c=u.geometry,l=void 0===o?u.material:o,p=u.group;if(h.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,h.matrixWorld),h.normalMatrix.getNormalMatrix(h.modelViewMatrix),h instanceof i.ImmediateRenderObject){b(l);var f=T(t,r,n,l,h);we="",h.render(function(e){xe.renderBufferImmediate(e,f,l)})}else xe.renderBufferDirect(t,r,n,c,l,h,p)}}function _(e,t,r,n){var o=Xe.get(e),a=qe.getParameters(e,t,r,n),s=qe.getProgramCode(e,a),h=o.program,c=!0;if(void 0===h)e.addEventListener("dispose",u);else if(h.code!==s)p(e);else{if(void 0!==a.shaderID)return;c=!1}if(c){if(a.shaderID){var l=i.ShaderLib[a.shaderID];o.__webglShader={name:e.type,uniforms:i.UniformsUtils.clone(l.uniforms),vertexShader:l.vertexShader,fragmentShader:l.fragmentShader}}else o.__webglShader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.__webglShader=o.__webglShader,h=qe.acquireProgram(e,a,s),o.program=h,e.program=h}var f=h.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var d=0;d<xe.maxMorphTargets;d++)f["morphTarget"+d]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals)for(e.numSupportedMorphNormals=0,d=0;d<xe.maxMorphNormals;d++)f["morphNormal"+d]>=0&&e.numSupportedMorphNormals++;o.uniformsList=[];var m=o.program.getUniforms();for(var g in o.__webglShader.uniforms){var v=m[g];v&&o.uniformsList.push([o.__webglShader.uniforms[g],v])}}function b(e){w(e),e.transparent===!0?He.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha):He.setBlending(i.NoBlending),He.setDepthFunc(e.depthFunc),He.setDepthTest(e.depthTest),He.setDepthWrite(e.depthWrite),He.setColorWrite(e.colorWrite),He.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)}function w(e){e.side!==i.DoubleSide?He.enable(Ie.CULL_FACE):He.disable(Ie.CULL_FACE),He.setFlipSided(e.side===i.BackSide)}function T(e,t,r,n,o){Me=0;var a=Xe.get(n);(n.needsUpdate||!a.program)&&(_(n,t,r,o),n.needsUpdate=!1);var s=!1,u=!1,h=!1,c=a.program,l=c.getUniforms(),p=a.__webglShader.uniforms;if(c.id!==ye&&(Ie.useProgram(c.program),ye=c.id,s=!0,u=!0,h=!0),n.id!==be&&(-1===be&&(h=!0),be=n.id,u=!0),(s||e!==Te)&&(Ie.uniformMatrix4fv(l.projectionMatrix,!1,e.projectionMatrix.elements),je.logarithmicDepthBuffer&&Ie.uniform1f(l.logDepthBufFC,2/(Math.log(e.far+1)/Math.LN2)),e!==Te&&(Te=e),(n instanceof i.ShaderMaterial||n instanceof i.MeshPhongMaterial||n.envMap)&&void 0!==l.cameraPosition&&(Be.setFromMatrixPosition(e.matrixWorld),Ie.uniform3f(l.cameraPosition,Be.x,Be.y,Be.z)),(n instanceof i.MeshPhongMaterial||n instanceof i.MeshLambertMaterial||n instanceof i.MeshBasicMaterial||n instanceof i.ShaderMaterial||n.skinning)&&void 0!==l.viewMatrix&&Ie.uniformMatrix4fv(l.viewMatrix,!1,e.matrixWorldInverse.elements)),n.skinning)if(o.bindMatrix&&void 0!==l.bindMatrix&&Ie.uniformMatrix4fv(l.bindMatrix,!1,o.bindMatrix.elements),o.bindMatrixInverse&&void 0!==l.bindMatrixInverse&&Ie.uniformMatrix4fv(l.bindMatrixInverse,!1,o.bindMatrixInverse.elements),je.floatVertexTextures&&o.skeleton&&o.skeleton.useVertexTexture){if(void 0!==l.boneTexture){var f=F();Ie.uniform1i(l.boneTexture,f),xe.setTexture(o.skeleton.boneTexture,f)}void 0!==l.boneTextureWidth&&Ie.uniform1i(l.boneTextureWidth,o.skeleton.boneTextureWidth),void 0!==l.boneTextureHeight&&Ie.uniform1i(l.boneTextureHeight,o.skeleton.boneTextureHeight)}else o.skeleton&&o.skeleton.boneMatrices&&void 0!==l.boneGlobalMatrices&&Ie.uniformMatrix4fv(l.boneGlobalMatrices,!1,o.skeleton.boneMatrices);return u&&(r&&n.fog&&R(p,r),(n instanceof i.MeshPhongMaterial||n instanceof i.MeshLambertMaterial||n.lights)&&(Ge&&(h=!0,k(t,e),Ge=!1),h?(A(p,Ue),P(p,!0)):P(p,!1)),(n instanceof i.MeshBasicMaterial||n instanceof i.MeshLambertMaterial||n instanceof i.MeshPhongMaterial)&&M(p,n),n instanceof i.LineBasicMaterial?S(p,n):n instanceof i.LineDashedMaterial?(S(p,n),E(p,n)):n instanceof i.PointsMaterial?C(p,n):n instanceof i.MeshPhongMaterial?D(p,n):n instanceof i.MeshDepthMaterial?(p.mNear.value=e.near,p.mFar.value=e.far,p.opacity.value=n.opacity):n instanceof i.MeshNormalMaterial&&(p.opacity.value=n.opacity),o.receiveShadow&&!n._shadowPass&&L(p,t,e),G(a.uniformsList)),B(l,o),void 0!==l.modelMatrix&&Ie.uniformMatrix4fv(l.modelMatrix,!1,o.matrixWorld.elements),c}function M(e,t){e.opacity.value=t.opacity,e.diffuse.value=t.color,t.emissive&&(e.emissive.value=t.emissive),e.map.value=t.map,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var r;if(t.map?r=t.map:t.specularMap?r=t.specularMap:t.displacementMap?r=t.displacementMap:t.normalMap?r=t.normalMap:t.bumpMap?r=t.bumpMap:t.alphaMap?r=t.alphaMap:t.emissiveMap&&(r=t.emissiveMap),void 0!==r){r instanceof i.WebGLRenderTarget&&(r=r.texture);var n=r.offset,o=r.repeat;e.offsetRepeat.value.set(n.x,n.y,o.x,o.y)}e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap instanceof i.WebGLRenderTargetCube?1:-1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function S(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function E(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function C(e,t){if(e.psColor.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size,e.scale.value=Q.height/2,e.map.value=t.map,null!==t.map){var r=t.map.offset,n=t.map.repeat;e.offsetRepeat.value.set(r.x,r.y,n.x,n.y)}}function R(e,t){e.fogColor.value=t.color,t instanceof i.Fog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t instanceof i.FogExp2&&(e.fogDensity.value=t.density)}function D(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function A(e,t){e.ambientLightColor.value=t.ambient,e.directionalLightColor.value=t.directional.colors,e.directionalLightDirection.value=t.directional.positions,e.pointLightColor.value=t.point.colors,e.pointLightPosition.value=t.point.positions,e.pointLightDistance.value=t.point.distances,e.pointLightDecay.value=t.point.decays,e.spotLightColor.value=t.spot.colors,e.spotLightPosition.value=t.spot.positions,e.spotLightDistance.value=t.spot.distances,e.spotLightDirection.value=t.spot.directions,e.spotLightAngleCos.value=t.spot.anglesCos,e.spotLightExponent.value=t.spot.exponents,e.spotLightDecay.value=t.spot.decays,e.hemisphereLightSkyColor.value=t.hemi.skyColors,e.hemisphereLightGroundColor.value=t.hemi.groundColors,e.hemisphereLightDirection.value=t.hemi.positions}function P(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLightColor.needsUpdate=t,e.directionalLightDirection.needsUpdate=t,e.pointLightColor.needsUpdate=t,e.pointLightPosition.needsUpdate=t,e.pointLightDistance.needsUpdate=t,e.pointLightDecay.needsUpdate=t,e.spotLightColor.needsUpdate=t,e.spotLightPosition.needsUpdate=t,e.spotLightDistance.needsUpdate=t,e.spotLightDirection.needsUpdate=t,e.spotLightAngleCos.needsUpdate=t,e.spotLightExponent.needsUpdate=t,e.spotLightDecay.needsUpdate=t,e.hemisphereLightSkyColor.needsUpdate=t,e.hemisphereLightGroundColor.needsUpdate=t,e.hemisphereLightDirection.needsUpdate=t}function L(e,t,r){if(e.shadowMatrix)for(var n=0,o=0,a=t.length;a>o;o++){var s=t[o];if(s.castShadow===!0&&(s instanceof i.PointLight||s instanceof i.SpotLight||s instanceof i.DirectionalLight)){var u=s.shadow;s instanceof i.PointLight?(Be.setFromMatrixPosition(s.matrixWorld).negate(),u.matrix.identity().setPosition(Be),e.shadowDarkness.value[n]=-u.darkness):e.shadowDarkness.value[n]=u.darkness,e.shadowMatrix.value[n]=u.matrix,e.shadowMap.value[n]=u.map,e.shadowMapSize.value[n]=u.mapSize,e.shadowBias.value[n]=u.bias,n++}}}function B(e,t){Ie.uniformMatrix4fv(e.modelViewMatrix,!1,t.modelViewMatrix.elements),e.normalMatrix&&Ie.uniformMatrix3fv(e.normalMatrix,!1,t.normalMatrix.elements)}function F(){var e=Me;return e>=je.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+je.maxTextures),
Me+=1,e}function G(e){for(var t,r,n=0,o=e.length;o>n;n++){var a=e[n][0];if(a.needsUpdate!==!1){var s=a.type,u=a.value,h=e[n][1];switch(s){case"1i":Ie.uniform1i(h,u);break;case"1f":Ie.uniform1f(h,u);break;case"2f":Ie.uniform2f(h,u[0],u[1]);break;case"3f":Ie.uniform3f(h,u[0],u[1],u[2]);break;case"4f":Ie.uniform4f(h,u[0],u[1],u[2],u[3]);break;case"1iv":Ie.uniform1iv(h,u);break;case"3iv":Ie.uniform3iv(h,u);break;case"1fv":Ie.uniform1fv(h,u);break;case"2fv":Ie.uniform2fv(h,u);break;case"3fv":Ie.uniform3fv(h,u);break;case"4fv":Ie.uniform4fv(h,u);break;case"Matrix3fv":Ie.uniformMatrix3fv(h,!1,u);break;case"Matrix4fv":Ie.uniformMatrix4fv(h,!1,u);break;case"i":Ie.uniform1i(h,u);break;case"f":Ie.uniform1f(h,u);break;case"v2":Ie.uniform2f(h,u.x,u.y);break;case"v3":Ie.uniform3f(h,u.x,u.y,u.z);break;case"v4":Ie.uniform4f(h,u.x,u.y,u.z,u.w);break;case"c":Ie.uniform3f(h,u.r,u.g,u.b);break;case"iv1":Ie.uniform1iv(h,u);break;case"iv":Ie.uniform3iv(h,u);break;case"fv1":Ie.uniform1fv(h,u);break;case"fv":Ie.uniform3fv(h,u);break;case"v2v":void 0===a._array&&(a._array=new Float32Array(2*u.length));for(var c=0,l=0,p=u.length;p>c;c++,l+=2)a._array[l+0]=u[c].x,a._array[l+1]=u[c].y;Ie.uniform2fv(h,a._array);break;case"v3v":void 0===a._array&&(a._array=new Float32Array(3*u.length));for(var c=0,f=0,p=u.length;p>c;c++,f+=3)a._array[f+0]=u[c].x,a._array[f+1]=u[c].y,a._array[f+2]=u[c].z;Ie.uniform3fv(h,a._array);break;case"v4v":void 0===a._array&&(a._array=new Float32Array(4*u.length));for(var c=0,d=0,p=u.length;p>c;c++,d+=4)a._array[d+0]=u[c].x,a._array[d+1]=u[c].y,a._array[d+2]=u[c].z,a._array[d+3]=u[c].w;Ie.uniform4fv(h,a._array);break;case"m3":Ie.uniformMatrix3fv(h,!1,u.elements);break;case"m3v":void 0===a._array&&(a._array=new Float32Array(9*u.length));for(var c=0,p=u.length;p>c;c++)u[c].flattenToArrayOffset(a._array,9*c);Ie.uniformMatrix3fv(h,!1,a._array);break;case"m4":Ie.uniformMatrix4fv(h,!1,u.elements);break;case"m4v":void 0===a._array&&(a._array=new Float32Array(16*u.length));for(var c=0,p=u.length;p>c;c++)u[c].flattenToArrayOffset(a._array,16*c);Ie.uniformMatrix4fv(h,!1,a._array);break;case"t":if(t=u,r=F(),Ie.uniform1i(h,r),!t)continue;t instanceof i.CubeTexture||Array.isArray(t.image)&&6===t.image.length?H(t,r):t instanceof i.WebGLRenderTargetCube?X(t.texture,r):t instanceof i.WebGLRenderTarget?xe.setTexture(t.texture,r):xe.setTexture(t,r);break;case"tv":void 0===a._array&&(a._array=[]);for(var c=0,p=a.value.length;p>c;c++)a._array[c]=F();Ie.uniform1iv(h,a._array);for(var c=0,p=a.value.length;p>c;c++)t=a.value[c],r=a._array[c],t&&(t instanceof i.CubeTexture||t.image instanceof Array&&6===t.image.length?H(t,r):t instanceof i.WebGLRenderTarget?xe.setTexture(t.texture,r):t instanceof i.WebGLRenderTargetCube?X(t.texture,r):xe.setTexture(t,r));break;default:console.warn("THREE.WebGLRenderer: Unknown uniform type: "+s)}}}}function U(e,t,r,n){e[t+0]=r.r*n,e[t+1]=r.g*n,e[t+2]=r.b*n}function k(e,t){var r,n,o,a,s,u,h,c,l=0,p=0,f=0,d=Ue,m=t.matrixWorldInverse,g=d.directional.colors,v=d.directional.positions,x=d.point.colors,y=d.point.positions,_=d.point.distances,b=d.point.decays,w=d.spot.colors,T=d.spot.positions,M=d.spot.distances,S=d.spot.directions,E=d.spot.anglesCos,C=d.spot.exponents,R=d.spot.decays,D=d.hemi.skyColors,A=d.hemi.groundColors,P=d.hemi.positions,L=0,B=0,F=0,G=0,k=0,V=0,I=0,O=0,z=0,N=0,j=0,H=0;for(r=0,n=e.length;n>r;r++)if(o=e[r],a=o.color,h=o.intensity,c=o.distance,o instanceof i.AmbientLight){if(!o.visible)continue;l+=a.r,p+=a.g,f+=a.b}else if(o instanceof i.DirectionalLight){if(k+=1,!o.visible)continue;Fe.setFromMatrixPosition(o.matrixWorld),Be.setFromMatrixPosition(o.target.matrixWorld),Fe.sub(Be),Fe.transformDirection(m),z=3*L,v[z+0]=Fe.x,v[z+1]=Fe.y,v[z+2]=Fe.z,U(g,z,a,h),L+=1}else if(o instanceof i.PointLight){if(V+=1,!o.visible)continue;N=3*B,U(x,N,a,h),Be.setFromMatrixPosition(o.matrixWorld),Be.applyMatrix4(m),y[N+0]=Be.x,y[N+1]=Be.y,y[N+2]=Be.z,_[B]=c,b[B]=0===o.distance?0:o.decay,B+=1}else if(o instanceof i.SpotLight){if(I+=1,!o.visible)continue;j=3*F,U(w,j,a,h),Fe.setFromMatrixPosition(o.matrixWorld),Be.copy(Fe).applyMatrix4(m),T[j+0]=Be.x,T[j+1]=Be.y,T[j+2]=Be.z,M[F]=c,Be.setFromMatrixPosition(o.target.matrixWorld),Fe.sub(Be),Fe.transformDirection(m),S[j+0]=Fe.x,S[j+1]=Fe.y,S[j+2]=Fe.z,E[F]=Math.cos(o.angle),C[F]=o.exponent,R[F]=0===o.distance?0:o.decay,F+=1}else if(o instanceof i.HemisphereLight){if(O+=1,!o.visible)continue;Fe.setFromMatrixPosition(o.matrixWorld),Fe.transformDirection(m),H=3*G,P[H+0]=Fe.x,P[H+1]=Fe.y,P[H+2]=Fe.z,s=o.color,u=o.groundColor,U(D,H,s,h),U(A,H,u,h),G+=1}for(r=3*L,n=Math.max(g.length,3*k);n>r;r++)g[r]=0;for(r=3*B,n=Math.max(x.length,3*V);n>r;r++)x[r]=0;for(r=3*F,n=Math.max(w.length,3*I);n>r;r++)w[r]=0;for(r=3*G,n=Math.max(D.length,3*O);n>r;r++)D[r]=0;for(r=3*G,n=Math.max(A.length,3*O);n>r;r++)A[r]=0;d.directional.length=L,d.point.length=B,d.spot.length=F,d.hemi.length=G,d.ambient[0]=l,d.ambient[1]=p,d.ambient[2]=f}function V(e,t,r){var n;if(r?(Ie.texParameteri(e,Ie.TEXTURE_WRAP_S,Z(t.wrapS)),Ie.texParameteri(e,Ie.TEXTURE_WRAP_T,Z(t.wrapT)),Ie.texParameteri(e,Ie.TEXTURE_MAG_FILTER,Z(t.magFilter)),Ie.texParameteri(e,Ie.TEXTURE_MIN_FILTER,Z(t.minFilter))):(Ie.texParameteri(e,Ie.TEXTURE_WRAP_S,Ie.CLAMP_TO_EDGE),Ie.texParameteri(e,Ie.TEXTURE_WRAP_T,Ie.CLAMP_TO_EDGE),(t.wrapS!==i.ClampToEdgeWrapping||t.wrapT!==i.ClampToEdgeWrapping)&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",t),Ie.texParameteri(e,Ie.TEXTURE_MAG_FILTER,K(t.magFilter)),Ie.texParameteri(e,Ie.TEXTURE_MIN_FILTER,K(t.minFilter)),t.minFilter!==i.NearestFilter&&t.minFilter!==i.LinearFilter&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",t)),n=Ne.get("EXT_texture_filter_anisotropic")){if(t.type===i.FloatType&&null===Ne.get("OES_texture_float_linear"))return;if(t.type===i.HalfFloatType&&null===Ne.get("OES_texture_half_float_linear"))return;(t.anisotropy>1||Xe.get(t).__currentAnisotropy)&&(Ie.texParameterf(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,xe.getMaxAnisotropy())),Xe.get(t).__currentAnisotropy=t.anisotropy)}}function I(e,t,r){void 0===e.__webglInit&&(e.__webglInit=!0,t.addEventListener("dispose",a),e.__webglTexture=Ie.createTexture(),ke.textures++),He.activeTexture(Ie.TEXTURE0+r),He.bindTexture(Ie.TEXTURE_2D,e.__webglTexture),Ie.pixelStorei(Ie.UNPACK_FLIP_Y_WEBGL,t.flipY),Ie.pixelStorei(Ie.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),Ie.pixelStorei(Ie.UNPACK_ALIGNMENT,t.unpackAlignment),t.image=O(t.image,je.maxTextureSize),N(t)&&z(t.image)===!1&&(t.image=j(t.image));var n=t.image,o=z(n),s=Z(t.format),u=Z(t.type);V(Ie.TEXTURE_2D,t,o);var h,c=t.mipmaps;if(t instanceof i.DataTexture)if(c.length>0&&o){for(var l=0,p=c.length;p>l;l++)h=c[l],He.texImage2D(Ie.TEXTURE_2D,l,s,h.width,h.height,0,s,u,h.data);t.generateMipmaps=!1}else He.texImage2D(Ie.TEXTURE_2D,0,s,n.width,n.height,0,s,u,n.data);else if(t instanceof i.CompressedTexture)for(var l=0,p=c.length;p>l;l++)h=c[l],t.format!==i.RGBAFormat&&t.format!==i.RGBFormat?He.getCompressedTextureFormats().indexOf(s)>-1?He.compressedTexImage2D(Ie.TEXTURE_2D,l,s,h.width,h.height,0,h.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):He.texImage2D(Ie.TEXTURE_2D,l,s,h.width,h.height,0,s,u,h.data);else if(c.length>0&&o){for(var l=0,p=c.length;p>l;l++)h=c[l],He.texImage2D(Ie.TEXTURE_2D,l,s,s,u,h);t.generateMipmaps=!1}else He.texImage2D(Ie.TEXTURE_2D,0,s,s,u,t.image);t.generateMipmaps&&o&&Ie.generateMipmap(Ie.TEXTURE_2D),e.__version=t.version,t.onUpdate&&t.onUpdate(t)}function O(e,t){if(e.width>t||e.height>t){var r=t/Math.max(e.width,e.height),n=document.createElement("canvas");n.width=Math.floor(e.width*r),n.height=Math.floor(e.height*r);var i=n.getContext("2d");return i.drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+n.width+"x"+n.height,e),n}return e}function z(e){return i.Math.isPowerOfTwo(e.width)&&i.Math.isPowerOfTwo(e.height)}function N(e){return e.wrapS!==i.ClampToEdgeWrapping||e.wrapT!==i.ClampToEdgeWrapping?!0:e.minFilter!==i.NearestFilter&&e.minFilter!==i.LinearFilter?!0:!1}function j(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){var t=document.createElement("canvas");t.width=i.Math.nearestPowerOfTwo(e.width),t.height=i.Math.nearestPowerOfTwo(e.height);var r=t.getContext("2d");return r.drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}function H(e,t){var r=Xe.get(e);if(6===e.image.length)if(e.version>0&&r.__version!==e.version){r.__image__webglTextureCube||(e.addEventListener("dispose",a),r.__image__webglTextureCube=Ie.createTexture(),ke.textures++),He.activeTexture(Ie.TEXTURE0+t),He.bindTexture(Ie.TEXTURE_CUBE_MAP,r.__image__webglTextureCube),Ie.pixelStorei(Ie.UNPACK_FLIP_Y_WEBGL,e.flipY);for(var n=e instanceof i.CompressedTexture,o=e.image[0]instanceof i.DataTexture,s=[],u=0;6>u;u++)!xe.autoScaleCubemaps||n||o?s[u]=o?e.image[u].image:e.image[u]:s[u]=O(e.image[u],je.maxCubemapSize);var h=s[0],c=z(h),l=Z(e.format),p=Z(e.type);V(Ie.TEXTURE_CUBE_MAP,e,c);for(var u=0;6>u;u++)if(n)for(var f,d=s[u].mipmaps,m=0,g=d.length;g>m;m++)f=d[m],e.format!==i.RGBAFormat&&e.format!==i.RGBFormat?He.getCompressedTextureFormats().indexOf(l)>-1?He.compressedTexImage2D(Ie.TEXTURE_CUBE_MAP_POSITIVE_X+u,m,l,f.width,f.height,0,f.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setCubeTexture()"):He.texImage2D(Ie.TEXTURE_CUBE_MAP_POSITIVE_X+u,m,l,f.width,f.height,0,l,p,f.data);else o?He.texImage2D(Ie.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,l,s[u].width,s[u].height,0,l,p,s[u].data):He.texImage2D(Ie.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,l,l,p,s[u]);e.generateMipmaps&&c&&Ie.generateMipmap(Ie.TEXTURE_CUBE_MAP),r.__version=e.version,e.onUpdate&&e.onUpdate(e)}else He.activeTexture(Ie.TEXTURE0+t),He.bindTexture(Ie.TEXTURE_CUBE_MAP,r.__image__webglTextureCube)}function X(e,t){He.activeTexture(Ie.TEXTURE0+t),He.bindTexture(Ie.TEXTURE_CUBE_MAP,Xe.get(e).__webglTexture)}function W(e,t,r){Ie.bindFramebuffer(Ie.FRAMEBUFFER,e),Ie.framebufferTexture2D(Ie.FRAMEBUFFER,Ie.COLOR_ATTACHMENT0,r,Xe.get(t.texture).__webglTexture,0)}function q(e,t){Ie.bindRenderbuffer(Ie.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(Ie.renderbufferStorage(Ie.RENDERBUFFER,Ie.DEPTH_COMPONENT16,t.width,t.height),Ie.framebufferRenderbuffer(Ie.FRAMEBUFFER,Ie.DEPTH_ATTACHMENT,Ie.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(Ie.renderbufferStorage(Ie.RENDERBUFFER,Ie.DEPTH_STENCIL,t.width,t.height),Ie.framebufferRenderbuffer(Ie.FRAMEBUFFER,Ie.DEPTH_STENCIL_ATTACHMENT,Ie.RENDERBUFFER,e)):Ie.renderbufferStorage(Ie.RENDERBUFFER,Ie.RGBA4,t.width,t.height)}function Y(e){var t=e instanceof i.WebGLRenderTargetCube?Ie.TEXTURE_CUBE_MAP:Ie.TEXTURE_2D,r=Xe.get(e.texture).__webglTexture;He.bindTexture(t,r),Ie.generateMipmap(t),He.bindTexture(t,null)}function K(e){return e===i.NearestFilter||e===i.NearestMipMapNearestFilter||e===i.NearestMipMapLinearFilter?Ie.NEAREST:Ie.LINEAR}function Z(e){var t;if(e===i.RepeatWrapping)return Ie.REPEAT;if(e===i.ClampToEdgeWrapping)return Ie.CLAMP_TO_EDGE;if(e===i.MirroredRepeatWrapping)return Ie.MIRRORED_REPEAT;if(e===i.NearestFilter)return Ie.NEAREST;if(e===i.NearestMipMapNearestFilter)return Ie.NEAREST_MIPMAP_NEAREST;if(e===i.NearestMipMapLinearFilter)return Ie.NEAREST_MIPMAP_LINEAR;if(e===i.LinearFilter)return Ie.LINEAR;if(e===i.LinearMipMapNearestFilter)return Ie.LINEAR_MIPMAP_NEAREST;if(e===i.LinearMipMapLinearFilter)return Ie.LINEAR_MIPMAP_LINEAR;if(e===i.UnsignedByteType)return Ie.UNSIGNED_BYTE;if(e===i.UnsignedShort4444Type)return Ie.UNSIGNED_SHORT_4_4_4_4;if(e===i.UnsignedShort5551Type)return Ie.UNSIGNED_SHORT_5_5_5_1;if(e===i.UnsignedShort565Type)return Ie.UNSIGNED_SHORT_5_6_5;if(e===i.ByteType)return Ie.BYTE;if(e===i.ShortType)return Ie.SHORT;if(e===i.UnsignedShortType)return Ie.UNSIGNED_SHORT;if(e===i.IntType)return Ie.INT;if(e===i.UnsignedIntType)return Ie.UNSIGNED_INT;if(e===i.FloatType)return Ie.FLOAT;if(t=Ne.get("OES_texture_half_float"),null!==t&&e===i.HalfFloatType)return t.HALF_FLOAT_OES;if(e===i.AlphaFormat)return Ie.ALPHA;if(e===i.RGBFormat)return Ie.RGB;if(e===i.RGBAFormat)return Ie.RGBA;if(e===i.LuminanceFormat)return Ie.LUMINANCE;if(e===i.LuminanceAlphaFormat)return Ie.LUMINANCE_ALPHA;if(e===i.AddEquation)return Ie.FUNC_ADD;if(e===i.SubtractEquation)return Ie.FUNC_SUBTRACT;if(e===i.ReverseSubtractEquation)return Ie.FUNC_REVERSE_SUBTRACT;if(e===i.ZeroFactor)return Ie.ZERO;if(e===i.OneFactor)return Ie.ONE;if(e===i.SrcColorFactor)return Ie.SRC_COLOR;if(e===i.OneMinusSrcColorFactor)return Ie.ONE_MINUS_SRC_COLOR;if(e===i.SrcAlphaFactor)return Ie.SRC_ALPHA;if(e===i.OneMinusSrcAlphaFactor)return Ie.ONE_MINUS_SRC_ALPHA;if(e===i.DstAlphaFactor)return Ie.DST_ALPHA;if(e===i.OneMinusDstAlphaFactor)return Ie.ONE_MINUS_DST_ALPHA;if(e===i.DstColorFactor)return Ie.DST_COLOR;if(e===i.OneMinusDstColorFactor)return Ie.ONE_MINUS_DST_COLOR;if(e===i.SrcAlphaSaturateFactor)return Ie.SRC_ALPHA_SATURATE;if(t=Ne.get("WEBGL_compressed_texture_s3tc"),null!==t){if(e===i.RGB_S3TC_DXT1_Format)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===i.RGBA_S3TC_DXT1_Format)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===i.RGBA_S3TC_DXT3_Format)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===i.RGBA_S3TC_DXT5_Format)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(t=Ne.get("WEBGL_compressed_texture_pvrtc"),null!==t){if(e===i.RGB_PVRTC_4BPPV1_Format)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===i.RGB_PVRTC_2BPPV1_Format)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===i.RGBA_PVRTC_4BPPV1_Format)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===i.RGBA_PVRTC_2BPPV1_Format)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(t=Ne.get("EXT_blend_minmax"),null!==t){if(e===i.MinEquation)return t.MIN_EXT;if(e===i.MaxEquation)return t.MAX_EXT}return 0}console.log("THREE.WebGLRenderer",i.REVISION),e=e||{};var Q=void 0!==e.canvas?e.canvas:document.createElement("canvas"),J=void 0!==e.context?e.context:null,$=Q.width,ee=Q.height,te=1,re=void 0!==e.alpha?e.alpha:!1,ne=void 0!==e.depth?e.depth:!0,ie=void 0!==e.stencil?e.stencil:!0,oe=void 0!==e.antialias?e.antialias:!1,ae=void 0!==e.premultipliedAlpha?e.premultipliedAlpha:!0,se=void 0!==e.preserveDrawingBuffer?e.preserveDrawingBuffer:!1,ue=new i.Color(0),he=0,ce=[],le=[],pe=-1,fe=[],de=-1,me=new Float32Array(8),ge=[],ve=[];this.domElement=Q,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.autoScaleCubemaps=!0;var xe=this,ye=null,_e=null,be=-1,we="",Te=null,Me=0,Se=0,Ee=0,Ce=Q.width,Re=Q.height,De=0,Ae=0,Pe=new i.Frustum,Le=new i.Matrix4,Be=new i.Vector3,Fe=new i.Vector3,Ge=!0,Ue={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[],decays:[]},spot:{length:0,colors:[],positions:[],distances:[],directions:[],anglesCos:[],exponents:[],decays:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]}},ke={geometries:0,textures:0},Ve={calls:0,vertices:0,faces:0,points:0};this.info={render:Ve,memory:ke,programs:null};var Ie;try{var Oe={alpha:re,depth:ne,stencil:ie,antialias:oe,premultipliedAlpha:ae,preserveDrawingBuffer:se};if(Ie=J||Q.getContext("webgl",Oe)||Q.getContext("experimental-webgl",Oe),null===Ie)throw null!==Q.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";Q.addEventListener("webglcontextlost",o,!1)}catch(ze){console.error("THREE.WebGLRenderer: "+ze)}var Ne=new i.WebGLExtensions(Ie);Ne.get("OES_texture_float"),Ne.get("OES_texture_float_linear"),Ne.get("OES_texture_half_float"),Ne.get("OES_texture_half_float_linear"),Ne.get("OES_standard_derivatives"),Ne.get("ANGLE_instanced_arrays"),Ne.get("OES_element_index_uint")&&(i.BufferGeometry.MaxIndex=4294967296);var je=new i.WebGLCapabilities(Ie,Ne,e),He=new i.WebGLState(Ie,Ne,Z),Xe=new i.WebGLProperties,We=new i.WebGLObjects(Ie,Xe,this.info),qe=new i.WebGLPrograms(this,je);this.info.programs=qe.programs;var Ye=new i.WebGLBufferRenderer(Ie,Ne,Ve),Ke=new i.WebGLIndexedBufferRenderer(Ie,Ne,Ve);r(),this.context=Ie,this.capabilities=je,this.extensions=Ne,this.state=He;var Ze=new i.WebGLShadowMap(this,ce,We);this.shadowMap=Ze;var Qe=new i.SpritePlugin(this,ge),Je=new i.LensFlarePlugin(this,ve);this.getContext=function(){return Ie},this.getContextAttributes=function(){return Ie.getContextAttributes()},this.forceContextLoss=function(){Ne.get("WEBGL_lose_context").loseContext()},this.getMaxAnisotropy=function(){var e;return function(){if(void 0!==e)return e;var t=Ne.get("EXT_texture_filter_anisotropic");return e=null!==t?Ie.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}}(),this.getPrecision=function(){return je.precision},this.getPixelRatio=function(){return te},this.setPixelRatio=function(e){void 0!==e&&(te=e)},this.getSize=function(){return{width:$,height:ee}},this.setSize=function(e,t,r){$=e,ee=t,Q.width=e*te,Q.height=t*te,r!==!1&&(Q.style.width=e+"px",Q.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,r,n){Se=e*te,Ee=t*te,Ce=r*te,Re=n*te,Ie.viewport(Se,Ee,Ce,Re)},this.getViewport=function(e){e.x=Se/te,e.y=Ee/te,e.z=Ce/te,e.w=Re/te},this.setScissor=function(e,t,r,n){Ie.scissor(e*te,t*te,r*te,n*te)},this.enableScissorTest=function(e){He.setScissorTest(e)},this.getClearColor=function(){return ue},this.setClearColor=function(e,r){ue.set(e),he=void 0!==r?r:1,t(ue.r,ue.g,ue.b,he)},this.getClearAlpha=function(){return he},this.setClearAlpha=function(e){he=e,t(ue.r,ue.g,ue.b,he)},this.clear=function(e,t,r){var n=0;(void 0===e||e)&&(n|=Ie.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=Ie.DEPTH_BUFFER_BIT),(void 0===r||r)&&(n|=Ie.STENCIL_BUFFER_BIT),Ie.clear(n)},this.clearColor=function(){Ie.clear(Ie.COLOR_BUFFER_BIT)},this.clearDepth=function(){Ie.clear(Ie.DEPTH_BUFFER_BIT)},this.clearStencil=function(){Ie.clear(Ie.STENCIL_BUFFER_BIT)},this.clearTarget=function(e,t,r,n){this.setRenderTarget(e),this.clear(t,r,n)},this.resetGLState=n,this.dispose=function(){Q.removeEventListener("webglcontextlost",o,!1)},this.renderBufferImmediate=function(e,t,r){He.initAttributes();var n=Xe.get(e);e.hasPositions&&!n.position&&(n.position=Ie.createBuffer()),e.hasNormals&&!n.normal&&(n.normal=Ie.createBuffer()),e.hasUvs&&!n.uv&&(n.uv=Ie.createBuffer()),e.hasColors&&!n.color&&(n.color=Ie.createBuffer());var o=t.getAttributes();if(e.hasPositions&&(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.position),Ie.bufferData(Ie.ARRAY_BUFFER,e.positionArray,Ie.DYNAMIC_DRAW),He.enableAttribute(o.position),Ie.vertexAttribPointer(o.position,3,Ie.FLOAT,!1,0,0)),e.hasNormals){if(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.normal),"MeshPhongMaterial"!==r.type&&r.shading===i.FlatShading)for(var a=0,s=3*e.count;s>a;a+=9){var u=e.normalArray,h=(u[a+0]+u[a+3]+u[a+6])/3,c=(u[a+1]+u[a+4]+u[a+7])/3,l=(u[a+2]+u[a+5]+u[a+8])/3;u[a+0]=h,u[a+1]=c,u[a+2]=l,u[a+3]=h,u[a+4]=c,u[a+5]=l,u[a+6]=h,u[a+7]=c,u[a+8]=l}Ie.bufferData(Ie.ARRAY_BUFFER,e.normalArray,Ie.DYNAMIC_DRAW),He.enableAttribute(o.normal),Ie.vertexAttribPointer(o.normal,3,Ie.FLOAT,!1,0,0)}e.hasUvs&&r.map&&(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.uv),Ie.bufferData(Ie.ARRAY_BUFFER,e.uvArray,Ie.DYNAMIC_DRAW),He.enableAttribute(o.uv),Ie.vertexAttribPointer(o.uv,2,Ie.FLOAT,!1,0,0)),e.hasColors&&r.vertexColors!==i.NoColors&&(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.color),Ie.bufferData(Ie.ARRAY_BUFFER,e.colorArray,Ie.DYNAMIC_DRAW),He.enableAttribute(o.color),Ie.vertexAttribPointer(o.color,3,Ie.FLOAT,!1,0,0)),He.disableUnusedAttributes(),Ie.drawArrays(Ie.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,r,n,o,a,s){b(o);var u=T(e,t,r,o,a),h=!1,c=n.id+"_"+u.id+"_"+o.wireframe;c!==we&&(we=c,h=!0);var l=a.morphTargetInfluences;if(void 0!==l){for(var p=[],m=0,g=l.length;g>m;m++){var v=l[m];p.push([v,m])}p.sort(d),p.length>8&&(p.length=8);for(var x=n.morphAttributes,m=0,g=p.length;g>m;m++){var v=p[m];if(me[m]=v[0],0!==v[0]){var y=v[1];o.morphTargets===!0&&x.position&&n.addAttribute("morphTarget"+m,x.position[y]),o.morphNormals===!0&&x.normal&&n.addAttribute("morphNormal"+m,x.normal[y])}else o.morphTargets===!0&&n.removeAttribute("morphTarget"+m),o.morphNormals===!0&&n.removeAttribute("morphNormal"+m)}var _=u.getUniforms();null!==_.morphTargetInfluences&&Ie.uniform1fv(_.morphTargetInfluences,me),h=!0}var y=n.index,w=n.attributes.position;o.wireframe===!0&&(y=We.getWireframeAttribute(n));var M;null!==y?(M=Ke,M.setIndex(y)):M=Ye,h&&(f(o,u,n),null!==y&&Ie.bindBuffer(Ie.ELEMENT_ARRAY_BUFFER,We.getAttributeBuffer(y)));var S=0,E=1/0;null!==y?E=y.count:void 0!==w&&(E=w.count);var C=n.drawRange.start,R=n.drawRange.count,D=null!==s?s.start:0,A=null!==s?s.count:1/0,P=Math.max(S,C,D),L=Math.min(S+E,C+R,D+A)-1,B=Math.max(0,L-P+1);if(a instanceof i.Mesh)o.wireframe===!0?(He.setLineWidth(o.wireframeLinewidth*te),M.setMode(Ie.LINES)):M.setMode(Ie.TRIANGLES),n instanceof i.InstancedBufferGeometry&&n.maxInstancedCount>0?M.renderInstances(n):M.render(P,B);else if(a instanceof i.Line){var F=o.linewidth;void 0===F&&(F=1),He.setLineWidth(F*te),a instanceof i.LineSegments?M.setMode(Ie.LINES):M.setMode(Ie.LINE_STRIP),M.render(P,B)}else a instanceof i.Points&&(M.setMode(Ie.POINTS),M.render(P,B))},this.render=function(e,t,r,n){if(t instanceof i.Camera==!1)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");var o=e.fog;if(we="",be=-1,Te=null,Ge=!0,e.autoUpdate===!0&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),Le.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),Pe.setFromMatrix(Le),ce.length=0,pe=-1,de=-1,ge.length=0,ve.length=0,x(e,t),le.length=pe+1,fe.length=de+1,xe.sortObjects===!0&&(le.sort(m),fe.sort(g)),Ze.render(e),Ve.calls=0,Ve.vertices=0,Ve.faces=0,Ve.points=0,this.setRenderTarget(r),(this.autoClear||n)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),e.overrideMaterial){var a=e.overrideMaterial;y(le,t,ce,o,a),y(fe,t,ce,o,a)}else He.setBlending(i.NoBlending),y(le,t,ce,o),y(fe,t,ce,o);if(Qe.render(e,t),Je.render(e,t,De,Ae),r){var s=r.texture,u=z(r);s.generateMipmaps&&u&&s.minFilter!==i.NearestFilter&&s.minFilter!==i.LinearFilter&&Y(r)}He.setDepthTest(!0),He.setDepthWrite(!0),He.setColorWrite(!0)},this.setFaceCulling=function(e,t){e===i.CullFaceNone?He.disable(Ie.CULL_FACE):(t===i.FrontFaceDirectionCW?Ie.frontFace(Ie.CW):Ie.frontFace(Ie.CCW),e===i.CullFaceBack?Ie.cullFace(Ie.BACK):e===i.CullFaceFront?Ie.cullFace(Ie.FRONT):Ie.cullFace(Ie.FRONT_AND_BACK),He.enable(Ie.CULL_FACE))},this.setTexture=function(e,t){var r=Xe.get(e);if(e.version>0&&r.__version!==e.version){var n=e.image;return void 0===n?void console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",e):n.complete===!1?void console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",e):void I(r,e,t)}He.activeTexture(Ie.TEXTURE0+t),He.bindTexture(Ie.TEXTURE_2D,r.__webglTexture)},this.setRenderTarget=function(e){var t=e instanceof i.WebGLRenderTargetCube;if(e&&void 0===Xe.get(e).__webglFramebuffer){var r=Xe.get(e),n=Xe.get(e.texture);void 0===e.depthBuffer&&(e.depthBuffer=!0),void 0===e.stencilBuffer&&(e.stencilBuffer=!0),e.addEventListener("dispose",s),n.__webglTexture=Ie.createTexture(),ke.textures++;var o=z(e),a=Z(e.texture.format),u=Z(e.texture.type);if(t){r.__webglFramebuffer=[],r.__webglRenderbuffer=[],He.bindTexture(Ie.TEXTURE_CUBE_MAP,n.__webglTexture),V(Ie.TEXTURE_CUBE_MAP,e.texture,o);for(var h=0;6>h;h++)r.__webglFramebuffer[h]=Ie.createFramebuffer(),r.__webglRenderbuffer[h]=Ie.createRenderbuffer(),He.texImage2D(Ie.TEXTURE_CUBE_MAP_POSITIVE_X+h,0,a,e.width,e.height,0,a,u,null),W(r.__webglFramebuffer[h],e,Ie.TEXTURE_CUBE_MAP_POSITIVE_X+h),q(r.__webglRenderbuffer[h],e);e.texture.generateMipmaps&&o&&Ie.generateMipmap(Ie.TEXTURE_CUBE_MAP)}else r.__webglFramebuffer=Ie.createFramebuffer(),e.shareDepthFrom?r.__webglRenderbuffer=e.shareDepthFrom.__webglRenderbuffer:r.__webglRenderbuffer=Ie.createRenderbuffer(),He.bindTexture(Ie.TEXTURE_2D,n.__webglTexture),V(Ie.TEXTURE_2D,e.texture,o),He.texImage2D(Ie.TEXTURE_2D,0,a,e.width,e.height,0,a,u,null),W(r.__webglFramebuffer,e,Ie.TEXTURE_2D),e.shareDepthFrom?e.depthBuffer&&!e.stencilBuffer?Ie.framebufferRenderbuffer(Ie.FRAMEBUFFER,Ie.DEPTH_ATTACHMENT,Ie.RENDERBUFFER,r.__webglRenderbuffer):e.depthBuffer&&e.stencilBuffer&&Ie.framebufferRenderbuffer(Ie.FRAMEBUFFER,Ie.DEPTH_STENCIL_ATTACHMENT,Ie.RENDERBUFFER,r.__webglRenderbuffer):q(r.__webglRenderbuffer,e),e.texture.generateMipmaps&&o&&Ie.generateMipmap(Ie.TEXTURE_2D);t?He.bindTexture(Ie.TEXTURE_CUBE_MAP,null):He.bindTexture(Ie.TEXTURE_2D,null),Ie.bindRenderbuffer(Ie.RENDERBUFFER,null),Ie.bindFramebuffer(Ie.FRAMEBUFFER,null)}var c,l,p,f,d;if(e){var r=Xe.get(e);c=t?r.__webglFramebuffer[e.activeCubeFace]:r.__webglFramebuffer,l=e.width,p=e.height,f=0,d=0}else c=null,l=Ce,p=Re,f=Se,d=Ee;if(c!==_e&&(Ie.bindFramebuffer(Ie.FRAMEBUFFER,c),Ie.viewport(f,d,l,p),_e=c),t){var n=Xe.get(e.texture);Ie.framebufferTexture2D(Ie.FRAMEBUFFER,Ie.COLOR_ATTACHMENT0,Ie.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,n.__webglTexture,0)}De=l,Ae=p},this.readRenderTargetPixels=function(e,t,r,n,o,a){if(e instanceof i.WebGLRenderTarget==!1)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");var s=Xe.get(e).__webglFramebuffer;if(s){var u=!1;s!==_e&&(Ie.bindFramebuffer(Ie.FRAMEBUFFER,s),u=!0);try{var h=e.texture;if(h.format!==i.RGBAFormat&&Z(h.format)!==Ie.getParameter(Ie.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(h.type===i.UnsignedByteType||Z(h.type)===Ie.getParameter(Ie.IMPLEMENTATION_COLOR_READ_TYPE)||h.type===i.FloatType&&Ne.get("WEBGL_color_buffer_float")||h.type===i.HalfFloatType&&Ne.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");Ie.checkFramebufferStatus(Ie.FRAMEBUFFER)===Ie.FRAMEBUFFER_COMPLETE?Ie.readPixels(t,r,n,o,Z(h.format),Z(h.type),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{u&&Ie.bindFramebuffer(Ie.FRAMEBUFFER,_e)}}},this.supportsFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),Ne.get("OES_texture_float")},this.supportsHalfFloatTextures=function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),Ne.get("OES_texture_half_float")},this.supportsStandardDerivatives=function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),Ne.get("OES_standard_derivatives")},this.supportsCompressedTextureS3TC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),Ne.get("WEBGL_compressed_texture_s3tc")},this.supportsCompressedTexturePVRTC=function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),Ne.get("WEBGL_compressed_texture_pvrtc")},this.supportsBlendMinMax=function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),Ne.get("EXT_blend_minmax")},this.supportsVertexTextures=function(){return je.vertexTextures},this.supportsInstancedArrays=function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),Ne.get("ANGLE_instanced_arrays")},this.initMaterial=function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},this.addPrePlugin=function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},this.addPostPlugin=function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},this.updateShadowMap=function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},Object.defineProperties(this,{shadowMapEnabled:{get:function(){return Ze.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),Ze.enabled=e}},shadowMapType:{get:function(){return Ze.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),Ze.type=e}},shadowMapCullFace:{get:function(){return Ze.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),Ze.cullFace=e}},shadowMapDebug:{get:function(){return Ze.debug},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapDebug is now .shadowMap.debug."),Ze.debug=e}}})},i.WebGLRenderTarget=function(e,t,r){this.uuid=i.Math.generateUUID(),this.width=e,this.height=t,r=r||{},void 0===r.minFilter&&(r.minFilter=i.LinearFilter),this.texture=new i.Texture(void 0,void 0,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy),this.depthBuffer=void 0!==r.depthBuffer?r.depthBuffer:!0,this.stencilBuffer=void 0!==r.stencilBuffer?r.stencilBuffer:!0,this.shareDepthFrom=void 0!==r.shareDepthFrom?r.shareDepthFrom:null},i.WebGLRenderTarget.prototype={constructor:i.WebGLRenderTarget,get wrapS(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set wrapS(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e},get wrapT(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set wrapT(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e},get magFilter(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set magFilter(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e},get minFilter(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set minFilter(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e},get anisotropy(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set anisotropy(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e},get offset(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set offset(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e},get repeat(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set repeat(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e},get format(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set format(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e},get type(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set type(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e},get generateMipmaps(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps;
},set generateMipmaps(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e},setSize:function(e,t){(this.width!==e||this.height!==t)&&(this.width=e,this.height=t,this.dispose())},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.shareDepthFrom=e.shareDepthFrom,this},dispose:function(){this.dispatchEvent({type:"dispose"})}},i.EventDispatcher.prototype.apply(i.WebGLRenderTarget.prototype),i.WebGLRenderTargetCube=function(e,t,r){i.WebGLRenderTarget.call(this,e,t,r),this.activeCubeFace=0},i.WebGLRenderTargetCube.prototype=Object.create(i.WebGLRenderTarget.prototype),i.WebGLRenderTargetCube.prototype.constructor=i.WebGLRenderTargetCube,i.WebGLBufferRenderer=function(e,t,r){function n(e){s=e}function o(t,n){e.drawArrays(s,t,n),r.calls++,r.vertices+=n,s===e.TRIANGLES&&(r.faces+=n/3)}function a(e){var r=t.get("ANGLE_instanced_arrays");if(null===r)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");var n=e.attributes.position;n instanceof i.InterleavedBufferAttribute?r.drawArraysInstancedANGLE(s,0,n.data.count,e.maxInstancedCount):r.drawArraysInstancedANGLE(s,0,n.count,e.maxInstancedCount)}var s;this.setMode=n,this.render=o,this.renderInstances=a},i.WebGLIndexedBufferRenderer=function(e,t,r){function n(e){s=e}function i(r){r.array instanceof Uint32Array&&t.get("OES_element_index_uint")?(u=e.UNSIGNED_INT,h=4):(u=e.UNSIGNED_SHORT,h=2)}function o(t,n){e.drawElements(s,n,u,t*h),r.calls++,r.vertices+=n,s===e.TRIANGLES&&(r.faces+=n/3)}function a(e){var r=t.get("ANGLE_instanced_arrays");if(null===r)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");var n=e.index;r.drawElementsInstancedANGLE(s,n.array.length,u,0,e.maxInstancedCount)}var s,u,h;this.setMode=n,this.setIndex=i,this.render=o,this.renderInstances=a},i.WebGLExtensions=function(e){var t={};this.get=function(r){if(void 0!==t[r])return t[r];var n;switch(r){case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(r)}return null===n&&console.warn("THREE.WebGLRenderer: "+r+" extension not supported."),t[r]=n,n}},i.WebGLCapabilities=function(e,t,r){function n(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}this.getMaxPrecision=n,this.precision=void 0!==r.precision?r.precision:"highp",this.logarithmicDepthBuffer=void 0!==r.logarithmicDepthBuffer?r.logarithmicDepthBuffer:!1,this.maxTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubemapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this.maxVertexUniforms=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this.maxVaryings=e.getParameter(e.MAX_VARYING_VECTORS),this.maxFragmentUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this.vertexTextures=this.maxVertexTextures>0,this.floatFragmentTextures=!!t.get("OES_texture_float"),this.floatVertexTextures=this.vertexTextures&&this.floatFragmentTextures;var i=n(this.precision);i!==this.precision&&(console.warn("THREE.WebGLRenderer:",this.precision,"not supported, using",i,"instead."),this.precision=i),this.logarithmicDepthBuffer&&(this.logarithmicDepthBuffer=!!t.get("EXT_frag_depth"))},i.WebGLGeometries=function(e,t,r){function n(e){var t=e.geometry;if(void 0!==c[t.id])return c[t.id];t.addEventListener("dispose",o);var n;return t instanceof i.BufferGeometry?n=t:t instanceof i.Geometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new i.BufferGeometry).setFromObject(e)),n=t._bufferGeometry),c[t.id]=n,r.memory.geometries++,n}function o(e){var n=e.target,i=c[n.id];u(i.attributes),n.removeEventListener("dispose",o),delete c[n.id];var a=t.get(n);a.wireframe&&s(a.wireframe),r.memory.geometries--}function a(e){return e instanceof i.InterleavedBufferAttribute?t.get(e.data).__webglBuffer:t.get(e).__webglBuffer}function s(t){var r=a(t);void 0!==r&&(e.deleteBuffer(r),h(t))}function u(e){for(var t in e)s(e[t])}function h(e){e instanceof i.InterleavedBufferAttribute?t["delete"](e.data):t["delete"](e)}var c={};this.get=n},i.WebGLObjects=function(e,t,r){function n(t){var r=l.get(t);t.geometry instanceof i.Geometry&&r.updateFromObject(t);var n=r.index,a=r.attributes;null!==n&&o(n,e.ELEMENT_ARRAY_BUFFER);for(var s in a)o(a[s],e.ARRAY_BUFFER);var u=r.morphAttributes;for(var s in u)for(var h=u[s],c=0,p=h.length;p>c;c++)o(h[c],e.ARRAY_BUFFER);return r}function o(e,r){var n=e instanceof i.InterleavedBufferAttribute?e.data:e,o=t.get(n);void 0===o.__webglBuffer?a(o,n,r):o.version!==n.version&&s(o,n,r)}function a(t,r,n){t.__webglBuffer=e.createBuffer(),e.bindBuffer(n,t.__webglBuffer);var i=r.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW;e.bufferData(n,r.array,i),t.version=r.version}function s(t,r,n){e.bindBuffer(n,t.__webglBuffer),r.dynamic===!1||-1===r.updateRange.count?e.bufferSubData(n,0,r.array):0===r.updateRange.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(n,r.updateRange.offset*r.array.BYTES_PER_ELEMENT,r.array.subarray(r.updateRange.offset,r.updateRange.offset+r.updateRange.count)),r.updateRange.count=0),t.version=r.version}function u(e){return e instanceof i.InterleavedBufferAttribute?t.get(e.data).__webglBuffer:t.get(e).__webglBuffer}function h(r){var n=t.get(r);if(void 0!==n.wireframe)return n.wireframe;var a=[],s=r.index,u=r.attributes,h=u.position;if(null!==s)for(var l={},p=s.array,f=0,d=p.length;d>f;f+=3){var m=p[f+0],g=p[f+1],v=p[f+2];c(l,m,g)&&a.push(m,g),c(l,g,v)&&a.push(g,v),c(l,v,m)&&a.push(v,m)}else for(var p=u.position.array,f=0,d=p.length/3-1;d>f;f+=3){var m=f+0,g=f+1,v=f+2;a.push(m,g,g,v,v,m)}var x=h.count>65535?Uint32Array:Uint16Array,y=new i.BufferAttribute(new x(a),1);return o(y,e.ELEMENT_ARRAY_BUFFER),n.wireframe=y,y}function c(e,t,r){if(t>r){var n=t;t=r,r=n}var i=e[t];return void 0===i?(e[t]=[r],!0):-1===i.indexOf(r)?(i.push(r),!0):!1}var l=new i.WebGLGeometries(e,t,r);this.getAttributeBuffer=u,this.getWireframeAttribute=h,this.update=n},i.WebGLProgram=function(){function e(e){var t=[];for(var r in e){var n=e[r];n!==!1&&t.push("#define "+r+" "+n)}return t.join("\n")}function t(e,t,r){for(var n={},i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),o=0;i>o;o++){var a=e.getActiveUniform(t,o),s=a.name,u=e.getUniformLocation(t,s),h=s.lastIndexOf("[0]");-1!==h&&h===s.length-3&&(n[s.substr(0,h)]=u),n[s]=u}return n}function r(e,t,r){for(var n={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),o=0;i>o;o++){var a=e.getActiveAttrib(t,o),s=a.name;n[s]=e.getAttribLocation(t,s)}return n}function n(e){return""!==e}var o=0;return function(a,s,u,h){var c=a.context,l=u.defines,p=u.__webglShader.vertexShader,f=u.__webglShader.fragmentShader,d="SHADOWMAP_TYPE_BASIC";h.shadowMapType===i.PCFShadowMap?d="SHADOWMAP_TYPE_PCF":h.shadowMapType===i.PCFSoftShadowMap&&(d="SHADOWMAP_TYPE_PCF_SOFT");var m="ENVMAP_TYPE_CUBE",g="ENVMAP_MODE_REFLECTION",v="ENVMAP_BLENDING_MULTIPLY";if(h.envMap){switch(u.envMap.mapping){case i.CubeReflectionMapping:case i.CubeRefractionMapping:m="ENVMAP_TYPE_CUBE";break;case i.EquirectangularReflectionMapping:case i.EquirectangularRefractionMapping:m="ENVMAP_TYPE_EQUIREC";break;case i.SphericalReflectionMapping:m="ENVMAP_TYPE_SPHERE"}switch(u.envMap.mapping){case i.CubeRefractionMapping:case i.EquirectangularRefractionMapping:g="ENVMAP_MODE_REFRACTION"}switch(u.combine){case i.MultiplyOperation:v="ENVMAP_BLENDING_MULTIPLY";break;case i.MixOperation:v="ENVMAP_BLENDING_MIX";break;case i.AddOperation:v="ENVMAP_BLENDING_ADD"}}var x,y,_=a.gammaFactor>0?a.gammaFactor:1,b=e(l),w=c.createProgram();u instanceof i.RawShaderMaterial?(x="",y=""):(x=["precision "+h.precision+" float;","precision "+h.precision+" int;","#define SHADER_NAME "+u.__webglShader.name,b,h.supportsVertexTextures?"#define VERTEX_TEXTURES":"",a.gammaInput?"#define GAMMA_INPUT":"",a.gammaOutput?"#define GAMMA_OUTPUT":"","#define GAMMA_FACTOR "+_,"#define MAX_DIR_LIGHTS "+h.maxDirLights,"#define MAX_POINT_LIGHTS "+h.maxPointLights,"#define MAX_SPOT_LIGHTS "+h.maxSpotLights,"#define MAX_HEMI_LIGHTS "+h.maxHemiLights,"#define MAX_SHADOWS "+h.maxShadows,"#define MAX_BONES "+h.maxBones,h.map?"#define USE_MAP":"",h.envMap?"#define USE_ENVMAP":"",h.envMap?"#define "+g:"",h.lightMap?"#define USE_LIGHTMAP":"",h.aoMap?"#define USE_AOMAP":"",h.emissiveMap?"#define USE_EMISSIVEMAP":"",h.bumpMap?"#define USE_BUMPMAP":"",h.normalMap?"#define USE_NORMALMAP":"",h.displacementMap&&h.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",h.specularMap?"#define USE_SPECULARMAP":"",h.alphaMap?"#define USE_ALPHAMAP":"",h.vertexColors?"#define USE_COLOR":"",h.flatShading?"#define FLAT_SHADED":"",h.skinning?"#define USE_SKINNING":"",h.useVertexTexture?"#define BONE_TEXTURE":"",h.morphTargets?"#define USE_MORPHTARGETS":"",h.morphNormals&&h.flatShading===!1?"#define USE_MORPHNORMALS":"",h.doubleSided?"#define DOUBLE_SIDED":"",h.flipSided?"#define FLIP_SIDED":"",h.shadowMapEnabled?"#define USE_SHADOWMAP":"",h.shadowMapEnabled?"#define "+d:"",h.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",h.pointLightShadows>0?"#define POINT_LIGHT_SHADOWS":"",h.sizeAttenuation?"#define USE_SIZEATTENUATION":"",h.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",h.logarithmicDepthBuffer&&a.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","	attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","	attribute vec3 morphTarget0;","	attribute vec3 morphTarget1;","	attribute vec3 morphTarget2;","	attribute vec3 morphTarget3;","	#ifdef USE_MORPHNORMALS","		attribute vec3 morphNormal0;","		attribute vec3 morphNormal1;","		attribute vec3 morphNormal2;","		attribute vec3 morphNormal3;","	#else","		attribute vec3 morphTarget4;","		attribute vec3 morphTarget5;","		attribute vec3 morphTarget6;","		attribute vec3 morphTarget7;","	#endif","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif","\n"].filter(n).join("\n"),y=[h.bumpMap||h.normalMap||h.flatShading||u.derivatives?"#extension GL_OES_standard_derivatives : enable":"",h.logarithmicDepthBuffer&&a.extensions.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"","precision "+h.precision+" float;","precision "+h.precision+" int;","#define SHADER_NAME "+u.__webglShader.name,b,"#define MAX_DIR_LIGHTS "+h.maxDirLights,"#define MAX_POINT_LIGHTS "+h.maxPointLights,"#define MAX_SPOT_LIGHTS "+h.maxSpotLights,"#define MAX_HEMI_LIGHTS "+h.maxHemiLights,"#define MAX_SHADOWS "+h.maxShadows,h.alphaTest?"#define ALPHATEST "+h.alphaTest:"",a.gammaInput?"#define GAMMA_INPUT":"",a.gammaOutput?"#define GAMMA_OUTPUT":"","#define GAMMA_FACTOR "+_,h.useFog&&h.fog?"#define USE_FOG":"",h.useFog&&h.fogExp?"#define FOG_EXP2":"",h.map?"#define USE_MAP":"",h.envMap?"#define USE_ENVMAP":"",h.envMap?"#define "+m:"",h.envMap?"#define "+g:"",h.envMap?"#define "+v:"",h.lightMap?"#define USE_LIGHTMAP":"",h.aoMap?"#define USE_AOMAP":"",h.emissiveMap?"#define USE_EMISSIVEMAP":"",h.bumpMap?"#define USE_BUMPMAP":"",h.normalMap?"#define USE_NORMALMAP":"",h.specularMap?"#define USE_SPECULARMAP":"",h.alphaMap?"#define USE_ALPHAMAP":"",h.vertexColors?"#define USE_COLOR":"",h.flatShading?"#define FLAT_SHADED":"",h.metal?"#define METAL":"",h.doubleSided?"#define DOUBLE_SIDED":"",h.flipSided?"#define FLIP_SIDED":"",h.shadowMapEnabled?"#define USE_SHADOWMAP":"",h.shadowMapEnabled?"#define "+d:"",h.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",h.pointLightShadows>0?"#define POINT_LIGHT_SHADOWS":"",h.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",h.logarithmicDepthBuffer&&a.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","\n"].filter(n).join("\n"));var T=x+p,M=y+f,S=i.WebGLShader(c,c.VERTEX_SHADER,T),E=i.WebGLShader(c,c.FRAGMENT_SHADER,M);c.attachShader(w,S),c.attachShader(w,E),void 0!==u.index0AttributeName?c.bindAttribLocation(w,0,u.index0AttributeName):h.morphTargets===!0&&c.bindAttribLocation(w,0,"position"),c.linkProgram(w);var C=c.getProgramInfoLog(w),R=c.getShaderInfoLog(S),D=c.getShaderInfoLog(E),A=!0,P=!0;c.getProgramParameter(w,c.LINK_STATUS)===!1?(A=!1,console.error("THREE.WebGLProgram: shader error: ",c.getError(),"gl.VALIDATE_STATUS",c.getProgramParameter(w,c.VALIDATE_STATUS),"gl.getProgramInfoLog",C,R,D)):""!==C?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",C):(""===R||""===D)&&(P=!1),P&&(this.diagnostics={runnable:A,material:u,programLog:C,vertexShader:{log:R,prefix:x},fragmentShader:{log:D,prefix:y}}),c.deleteShader(S),c.deleteShader(E);var L;this.getUniforms=function(){return void 0===L&&(L=t(c,w)),L};var B;return this.getAttributes=function(){return void 0===B&&(B=r(c,w)),B},this.destroy=function(){c.deleteProgram(w),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=o++,this.code=s,this.usedTimes=1,this.program=w,this.vertexShader=S,this.fragmentShader=E,this}}(),i.WebGLPrograms=function(e,t){function r(e){if(t.floatVertexTextures&&e&&e.skeleton&&e.skeleton.useVertexTexture)return 1024;var r=t.maxVertexUniforms,n=Math.floor((r-20)/4),o=n;return void 0!==e&&e instanceof i.SkinnedMesh&&(o=Math.min(e.skeleton.bones.length,o),o<e.skeleton.bones.length&&console.warn("WebGLRenderer: too many bones - "+e.skeleton.bones.length+", this GPU supports just "+o+" (try OpenGL instead of ANGLE)")),o}function n(e){for(var t=0,r=0,n=0,o=0,a=0,s=e.length;s>a;a++){var u=e[a];u.visible!==!1&&(u instanceof i.DirectionalLight&&t++,u instanceof i.PointLight&&r++,u instanceof i.SpotLight&&n++,u instanceof i.HemisphereLight&&o++)}return{directional:t,point:r,spot:n,hemi:o}}function o(e){for(var t=0,r=0,n=0,o=e.length;o>n;n++){var a=e[n];a.castShadow&&((a instanceof i.SpotLight||a instanceof i.DirectionalLight)&&t++,a instanceof i.PointLight&&(t++,r++))}return{maxShadows:t,pointLightShadows:r}}var a=[],s={MeshDepthMaterial:"depth",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points"},u=["precision","supportsVertexTextures","map","envMap","envMapMode","lightMap","aoMap","emissiveMap","bumpMap","normalMap","displacementMap","specularMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","maxDirLights","maxPointLights","maxSpotLights","maxHemiLights","maxShadows","shadowMapEnabled","pointLightShadows","shadowMapType","shadowMapDebug","alphaTest","metal","doubleSided","flipSided"];this.getParameters=function(a,u,h,c){var l=s[a.type],p=n(u),f=o(u),d=r(c),m=e.getPrecision();null!==a.precision&&(m=t.getMaxPrecision(a.precision),m!==a.precision&&console.warn("THREE.WebGLRenderer.initMaterial:",a.precision,"not supported, using",m,"instead."));var g={shaderID:l,precision:m,supportsVertexTextures:t.vertexTextures,map:!!a.map,envMap:!!a.envMap,envMapMode:a.envMap&&a.envMap.mapping,lightMap:!!a.lightMap,aoMap:!!a.aoMap,emissiveMap:!!a.emissiveMap,bumpMap:!!a.bumpMap,normalMap:!!a.normalMap,displacementMap:!!a.displacementMap,specularMap:!!a.specularMap,alphaMap:!!a.alphaMap,combine:a.combine,vertexColors:a.vertexColors,fog:h,useFog:a.fog,fogExp:h instanceof i.FogExp2,flatShading:a.shading===i.FlatShading,sizeAttenuation:a.sizeAttenuation,logarithmicDepthBuffer:t.logarithmicDepthBuffer,skinning:a.skinning,maxBones:d,useVertexTexture:t.floatVertexTextures&&c&&c.skeleton&&c.skeleton.useVertexTexture,morphTargets:a.morphTargets,morphNormals:a.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,maxDirLights:p.directional,maxPointLights:p.point,maxSpotLights:p.spot,maxHemiLights:p.hemi,maxShadows:f.maxShadows,pointLightShadows:f.pointLightShadows,shadowMapEnabled:e.shadowMap.enabled&&c.receiveShadow&&f.maxShadows>0,shadowMapType:e.shadowMap.type,shadowMapDebug:e.shadowMap.debug,alphaTest:a.alphaTest,metal:a.metal,doubleSided:a.side===i.DoubleSide,flipSided:a.side===i.BackSide};return g},this.getProgramCode=function(e,t){var r=[];if(t.shaderID?r.push(t.shaderID):(r.push(e.fragmentShader),r.push(e.vertexShader)),void 0!==e.defines)for(var n in e.defines)r.push(n),r.push(e.defines[n]);for(var i=0;i<u.length;i++){var o=u[i];r.push(o),r.push(t[o])}return r.join()},this.acquireProgram=function(t,r,n){for(var o,s=0,u=a.length;u>s;s++){var h=a[s];if(h.code===n){o=h,++o.usedTimes;break}}return void 0===o&&(o=new i.WebGLProgram(e,n,t,r),a.push(o)),o},this.releaseProgram=function(e){if(0===--e.usedTimes){var t=a.indexOf(e);a[t]=a[a.length-1],a.pop(),e.destroy()}},this.programs=a},i.WebGLProperties=function(){var e={};this.get=function(t){var r=t.uuid,n=e[r];return void 0===n&&(n={},e[r]=n),n},this["delete"]=function(t){delete e[t.uuid]},this.clear=function(){e={}}},i.WebGLShader=function(){function e(e){for(var t=e.split("\n"),r=0;r<t.length;r++)t[r]=r+1+": "+t[r];return t.join("\n")}return function(t,r,n){var i=t.createShader(r);return t.shaderSource(i,n),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)===!1&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==t.getShaderInfoLog(i)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",r===t.VERTEX_SHADER?"vertex":"fragment",t.getShaderInfoLog(i),e(n)),i}}(),i.WebGLShadowMap=function(e,t,r){function n(e,t,r,n){var o=e.geometry,a=null,s=g,u=e.customDepthMaterial;if(r&&(s=v,u=e.customDistanceMaterial),u)a=u;else{var h=void 0!==o.morphTargets&&o.morphTargets.length>0&&t.morphTargets,c=e instanceof i.SkinnedMesh&&t.skinning,l=0;h&&(l|=f),c&&(l|=d),a=s[l]}return a.visible=t.visible,a.wireframe=t.wireframe,a.wireframeLinewidth=t.wireframeLinewidth,r&&void 0!==a.uniforms.lightPos&&a.uniforms.lightPos.value.copy(n),a}function o(e,t){if(e.visible!==!1){if((e instanceof i.Mesh||e instanceof i.Line||e instanceof i.Points)&&e.castShadow&&(e.frustumCulled===!1||u.intersectsObject(e)===!0)){var r=e.material;r.visible===!0&&(e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld),p.push(e))}for(var n=e.children,a=0,s=n.length;s>a;a++)o(n[a],t)}}for(var a=e.context,s=e.state,u=new i.Frustum,h=new i.Matrix4,c=(new i.Vector3,new i.Vector3,new i.Vector3),l=new i.Vector3,p=[],f=1,d=2,m=(f|d)+1,g=new Array(m),v=new Array(m),x=[new i.Vector3(1,0,0),new i.Vector3(-1,0,0),new i.Vector3(0,0,1),new i.Vector3(0,0,-1),new i.Vector3(0,1,0),new i.Vector3(0,-1,0)],y=[new i.Vector3(0,1,0),new i.Vector3(0,1,0),new i.Vector3(0,1,0),new i.Vector3(0,1,0),new i.Vector3(0,0,1),new i.Vector3(0,0,-1)],_=[new i.Vector4,new i.Vector4,new i.Vector4,new i.Vector4,new i.Vector4,new i.Vector4],b=new i.Vector4,w=i.ShaderLib.depthRGBA,T=i.UniformsUtils.clone(w.uniforms),M=i.ShaderLib.distanceRGBA,S=i.UniformsUtils.clone(M.uniforms),E=0;E!==m;++E){var C=0!==(E&f),R=0!==(E&d),D=new i.ShaderMaterial({uniforms:T,vertexShader:w.vertexShader,fragmentShader:w.fragmentShader,morphTargets:C,skinning:R});D._shadowPass=!0,g[E]=D;var A=new i.ShaderMaterial({uniforms:S,vertexShader:M.vertexShader,fragmentShader:M.fragmentShader,morphTargets:C,skinning:R});A._shadowPass=!0,v[E]=A}var P=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=i.PCFShadowMap,this.cullFace=i.CullFaceFront,this.render=function(f){var d,m;if(P.enabled!==!1&&(P.autoUpdate!==!1||P.needsUpdate!==!1)){a.clearColor(1,1,1,1),s.disable(a.BLEND),s.enable(a.CULL_FACE),a.frontFace(a.CCW),a.cullFace(P.cullFace===i.CullFaceFront?a.FRONT:a.BACK),s.setDepthTest(!0),e.getViewport(b);for(var g=0,v=t.length;v>g;g++){var w=t[g];if(w.castShadow===!0){var T=w.shadow,M=T.camera,S=T.mapSize;if(w instanceof i.PointLight){d=6,m=!0;var E=S.x/4,C=S.y/2;_[0].set(2*E,C,E,C),_[1].set(0,C,E,C),_[2].set(3*E,C,E,C),_[3].set(E,C,E,C),_[4].set(3*E,0,E,C),_[5].set(E,0,E,C)}else d=1,m=!1;if(null===T.map){var R=i.LinearFilter;P.type===i.PCFSoftShadowMap&&(R=i.NearestFilter);var D={minFilter:R,magFilter:R,format:i.RGBAFormat};T.map=new i.WebGLRenderTarget(S.x,S.y,D),T.matrix=new i.Matrix4,w instanceof i.SpotLight&&(M.aspect=S.x/S.y),M.updateProjectionMatrix()}var A=T.map,L=T.matrix;l.setFromMatrixPosition(w.matrixWorld),M.position.copy(l),e.setRenderTarget(A),e.clear();for(var B=0;d>B;B++){if(m){c.copy(M.position),c.add(x[B]),M.up.copy(y[B]),M.lookAt(c);var F=_[B];e.setViewport(F.x,F.y,F.z,F.w)}else c.setFromMatrixPosition(w.target.matrixWorld),M.lookAt(c);M.updateMatrixWorld(),M.matrixWorldInverse.getInverse(M.matrixWorld),L.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),L.multiply(M.projectionMatrix),L.multiply(M.matrixWorldInverse),h.multiplyMatrices(M.projectionMatrix,M.matrixWorldInverse),u.setFromMatrix(h),p.length=0,o(f,M);for(var G=0,U=p.length;U>G;G++){var k=p[G],V=r.update(k),I=k.material;if(I instanceof i.MeshFaceMaterial)for(var O=V.groups,z=I.materials,N=0,j=O.length;j>N;N++){var H=O[N],X=z[H.materialIndex];if(X.visible===!0){var W=n(k,X,m,l);e.renderBufferDirect(M,t,null,V,W,k,H)}}else{var W=n(k,I,m,l);e.renderBufferDirect(M,t,null,V,W,k,null)}}}e.resetGLState()}}e.setViewport(b.x,b.y,b.z,b.w);var q=e.getClearColor(),Y=e.getClearAlpha();e.setClearColor(q,Y),s.enable(a.BLEND),P.cullFace===i.CullFaceFront&&a.cullFace(a.BACK),e.resetGLState(),P.needsUpdate=!1}}},i.WebGLState=function(e,t,r){var n=this,o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),u={},h=null,c=null,l=null,p=null,f=null,d=null,m=null,g=null,v=null,x=null,y=null,_=null,b=null,w=null,T=null,M=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),S=void 0,E={};this.init=function(){e.clearColor(0,0,0,1),e.clearDepth(1),e.clearStencil(0),this.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.frontFace(e.CCW),e.cullFace(e.BACK),this.enable(e.CULL_FACE),this.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)},this.initAttributes=function(){for(var e=0,t=o.length;t>e;e++)o[e]=0},this.enableAttribute=function(r){if(o[r]=1,0===a[r]&&(e.enableVertexAttribArray(r),a[r]=1),0!==s[r]){var n=t.get("ANGLE_instanced_arrays");n.vertexAttribDivisorANGLE(r,0),s[r]=0}},this.enableAttributeAndDivisor=function(t,r,n){o[t]=1,0===a[t]&&(e.enableVertexAttribArray(t),a[t]=1),s[t]!==r&&(n.vertexAttribDivisorANGLE(t,r),s[t]=r)},this.disableUnusedAttributes=function(){for(var t=0,r=a.length;r>t;t++)a[t]!==o[t]&&(e.disableVertexAttribArray(t),a[t]=0)},this.enable=function(t){u[t]!==!0&&(e.enable(t),u[t]=!0)},this.disable=function(t){u[t]!==!1&&(e.disable(t),u[t]=!1)},this.getCompressedTextureFormats=function(){if(null===h&&(h=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")))for(var r=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),n=0;n<r.length;n++)h.push(r[n]);return h},this.setBlending=function(t,n,o,a,s,u,h){t!==c&&(t===i.NoBlending?this.disable(e.BLEND):t===i.AdditiveBlending?(this.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE)):t===i.SubtractiveBlending?(this.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR)):t===i.MultiplyBlending?(this.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.SRC_COLOR)):t===i.CustomBlending?this.enable(e.BLEND):(this.enable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)),c=t),t===i.CustomBlending?(s=s||n,u=u||o,h=h||a,(n!==l||s!==d)&&(e.blendEquationSeparate(r(n),r(s)),l=n,d=s),(o!==p||a!==f||u!==m||h!==g)&&(e.blendFuncSeparate(r(o),r(a),r(u),r(h)),p=o,f=a,m=u,g=h)):(l=null,p=null,f=null,d=null,m=null,g=null)},this.setDepthFunc=function(t){if(v!==t){if(t)switch(t){case i.NeverDepth:e.depthFunc(e.NEVER);break;case i.AlwaysDepth:e.depthFunc(e.ALWAYS);break;case i.LessDepth:e.depthFunc(e.LESS);break;case i.LessEqualDepth:e.depthFunc(e.LEQUAL);break;case i.EqualDepth:e.depthFunc(e.EQUAL);break;case i.GreaterEqualDepth:e.depthFunc(e.GEQUAL);break;case i.GreaterDepth:e.depthFunc(e.GREATER);break;case i.NotEqualDepth:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);v=t}},this.setDepthTest=function(t){t?this.enable(e.DEPTH_TEST):this.disable(e.DEPTH_TEST)},this.setDepthWrite=function(t){x!==t&&(e.depthMask(t),x=t)},this.setColorWrite=function(t){y!==t&&(e.colorMask(t,t,t,t),y=t)},this.setFlipSided=function(t){_!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),_=t)},this.setLineWidth=function(t){t!==b&&(e.lineWidth(t),b=t)},this.setPolygonOffset=function(t,r,n){t?this.enable(e.POLYGON_OFFSET_FILL):this.disable(e.POLYGON_OFFSET_FILL),!t||w===r&&T===n||(e.polygonOffset(r,n),w=r,T=n)},this.setScissorTest=function(t){t?this.enable(e.SCISSOR_TEST):this.disable(e.SCISSOR_TEST)},this.activeTexture=function(t){void 0===t&&(t=e.TEXTURE0+M-1),S!==t&&(e.activeTexture(t),S=t)},this.bindTexture=function(t,r){void 0===S&&n.activeTexture();var i=E[S];void 0===i&&(i={type:void 0,texture:void 0},E[S]=i),(i.type!==t||i.texture!==r)&&(e.bindTexture(t,r),i.type=t,i.texture=r)},this.compressedTexImage2D=function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(t){console.error(t)}},this.texImage2D=function(){try{e.texImage2D.apply(e,arguments)}catch(t){console.error(t)}},this.reset=function(){for(var t=0;t<a.length;t++)1===a[t]&&(e.disableVertexAttribArray(t),a[t]=0);u={},h=null,c=null,x=null,y=null,_=null}},i.LensFlarePlugin=function(e,t){function r(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),t=new Uint16Array([0,1,2,0,2,3]);o=f.createBuffer(),a=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,o),f.bufferData(f.ARRAY_BUFFER,e,f.STATIC_DRAW),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a),f.bufferData(f.ELEMENT_ARRAY_BUFFER,t,f.STATIC_DRAW),l=f.createTexture(),p=f.createTexture(),d.bindTexture(f.TEXTURE_2D,l),f.texImage2D(f.TEXTURE_2D,0,f.RGB,16,16,0,f.RGB,f.UNSIGNED_BYTE,null),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),d.bindTexture(f.TEXTURE_2D,p),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,16,16,0,f.RGBA,f.UNSIGNED_BYTE,null),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),c=f.getParameter(f.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;var r;r=c?{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}:{vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform lowp int renderType;","uniform sampler2D map;","uniform sampler2D occlusionMap;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","float visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a;","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a;","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a;","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;","visibility = ( 1.0 - visibility / 4.0 );","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},s=n(r),u={vertex:f.getAttribLocation(s,"position"),uv:f.getAttribLocation(s,"uv")},h={renderType:f.getUniformLocation(s,"renderType"),map:f.getUniformLocation(s,"map"),occlusionMap:f.getUniformLocation(s,"occlusionMap"),opacity:f.getUniformLocation(s,"opacity"),color:f.getUniformLocation(s,"color"),scale:f.getUniformLocation(s,"scale"),rotation:f.getUniformLocation(s,"rotation"),screenPosition:f.getUniformLocation(s,"screenPosition")}}function n(t){var r=f.createProgram(),n=f.createShader(f.FRAGMENT_SHADER),i=f.createShader(f.VERTEX_SHADER),o="precision "+e.getPrecision()+" float;\n";return f.shaderSource(n,o+t.fragmentShader),
f.shaderSource(i,o+t.vertexShader),f.compileShader(n),f.compileShader(i),f.attachShader(r,n),f.attachShader(r,i),f.linkProgram(r),r}var o,a,s,u,h,c,l,p,f=e.context,d=e.state;this.render=function(n,m,g,v){if(0!==t.length){var x=new i.Vector3,y=v/g,_=.5*g,b=.5*v,w=16/v,T=new i.Vector2(w*y,w),M=new i.Vector3(1,1,0),S=new i.Vector2(1,1);void 0===s&&r(),f.useProgram(s),d.initAttributes(),d.enableAttribute(u.vertex),d.enableAttribute(u.uv),d.disableUnusedAttributes(),f.uniform1i(h.occlusionMap,0),f.uniform1i(h.map,1),f.bindBuffer(f.ARRAY_BUFFER,o),f.vertexAttribPointer(u.vertex,2,f.FLOAT,!1,16,0),f.vertexAttribPointer(u.uv,2,f.FLOAT,!1,16,8),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a),d.disable(f.CULL_FACE),f.depthMask(!1);for(var E=0,C=t.length;C>E;E++){w=16/v,T.set(w*y,w);var R=t[E];if(x.set(R.matrixWorld.elements[12],R.matrixWorld.elements[13],R.matrixWorld.elements[14]),x.applyMatrix4(m.matrixWorldInverse),x.applyProjection(m.projectionMatrix),M.copy(x),S.x=M.x*_+_,S.y=M.y*b+b,c||S.x>0&&S.x<g&&S.y>0&&S.y<v){d.activeTexture(f.TEXTURE0),d.bindTexture(f.TEXTURE_2D,null),d.activeTexture(f.TEXTURE1),d.bindTexture(f.TEXTURE_2D,l),f.copyTexImage2D(f.TEXTURE_2D,0,f.RGB,S.x-8,S.y-8,16,16,0),f.uniform1i(h.renderType,0),f.uniform2f(h.scale,T.x,T.y),f.uniform3f(h.screenPosition,M.x,M.y,M.z),d.disable(f.BLEND),d.enable(f.DEPTH_TEST),f.drawElements(f.TRIANGLES,6,f.UNSIGNED_SHORT,0),d.activeTexture(f.TEXTURE0),d.bindTexture(f.TEXTURE_2D,p),f.copyTexImage2D(f.TEXTURE_2D,0,f.RGBA,S.x-8,S.y-8,16,16,0),f.uniform1i(h.renderType,1),d.disable(f.DEPTH_TEST),d.activeTexture(f.TEXTURE1),d.bindTexture(f.TEXTURE_2D,l),f.drawElements(f.TRIANGLES,6,f.UNSIGNED_SHORT,0),R.positionScreen.copy(M),R.customUpdateCallback?R.customUpdateCallback(R):R.updateLensFlares(),f.uniform1i(h.renderType,2),d.enable(f.BLEND);for(var D=0,A=R.lensFlares.length;A>D;D++){var P=R.lensFlares[D];P.opacity>.001&&P.scale>.001&&(M.x=P.x,M.y=P.y,M.z=P.z,w=P.size*P.scale/v,T.x=w*y,T.y=w,f.uniform3f(h.screenPosition,M.x,M.y,M.z),f.uniform2f(h.scale,T.x,T.y),f.uniform1f(h.rotation,P.rotation),f.uniform1f(h.opacity,P.opacity),f.uniform3f(h.color,P.color.r,P.color.g,P.color.b),d.setBlending(P.blending,P.blendEquation,P.blendSrc,P.blendDst),e.setTexture(P.texture,1),f.drawElements(f.TRIANGLES,6,f.UNSIGNED_SHORT,0))}}}d.enable(f.CULL_FACE),d.enable(f.DEPTH_TEST),f.depthMask(!0),e.resetGLState()}}},i.SpritePlugin=function(e,t){function r(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),t=new Uint16Array([0,1,2,0,2,3]);a=p.createBuffer(),s=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,a),p.bufferData(p.ARRAY_BUFFER,e,p.STATIC_DRAW),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,s),p.bufferData(p.ELEMENT_ARRAY_BUFFER,t,p.STATIC_DRAW),u=n(),h={position:p.getAttribLocation(u,"position"),uv:p.getAttribLocation(u,"uv")},c={uvOffset:p.getUniformLocation(u,"uvOffset"),uvScale:p.getUniformLocation(u,"uvScale"),rotation:p.getUniformLocation(u,"rotation"),scale:p.getUniformLocation(u,"scale"),color:p.getUniformLocation(u,"color"),map:p.getUniformLocation(u,"map"),opacity:p.getUniformLocation(u,"opacity"),modelViewMatrix:p.getUniformLocation(u,"modelViewMatrix"),projectionMatrix:p.getUniformLocation(u,"projectionMatrix"),fogType:p.getUniformLocation(u,"fogType"),fogDensity:p.getUniformLocation(u,"fogDensity"),fogNear:p.getUniformLocation(u,"fogNear"),fogFar:p.getUniformLocation(u,"fogFar"),fogColor:p.getUniformLocation(u,"fogColor"),alphaTest:p.getUniformLocation(u,"alphaTest")};var r=document.createElement("canvas");r.width=8,r.height=8;var o=r.getContext("2d");o.fillStyle="white",o.fillRect(0,0,8,8),l=new i.Texture(r),l.needsUpdate=!0}function n(){var t=p.createProgram(),r=p.createShader(p.VERTEX_SHADER),n=p.createShader(p.FRAGMENT_SHADER);return p.shaderSource(r,["precision "+e.getPrecision()+" float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition;","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n")),p.shaderSource(n,["precision "+e.getPrecision()+" float;","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")),p.compileShader(r),p.compileShader(n),p.attachShader(t,r),p.attachShader(t,n),p.linkProgram(t),t}function o(e,t){return e.z!==t.z?t.z-e.z:t.id-e.id}var a,s,u,h,c,l,p=e.context,f=e.state,d=new i.Vector3,m=new i.Quaternion,g=new i.Vector3;this.render=function(n,v){if(0!==t.length){void 0===u&&r(),p.useProgram(u),f.initAttributes(),f.enableAttribute(h.position),f.enableAttribute(h.uv),f.disableUnusedAttributes(),f.disable(p.CULL_FACE),f.enable(p.BLEND),p.bindBuffer(p.ARRAY_BUFFER,a),p.vertexAttribPointer(h.position,2,p.FLOAT,!1,16,0),p.vertexAttribPointer(h.uv,2,p.FLOAT,!1,16,8),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,s),p.uniformMatrix4fv(c.projectionMatrix,!1,v.projectionMatrix.elements),f.activeTexture(p.TEXTURE0),p.uniform1i(c.map,0);var x=0,y=0,_=n.fog;_?(p.uniform3f(c.fogColor,_.color.r,_.color.g,_.color.b),_ instanceof i.Fog?(p.uniform1f(c.fogNear,_.near),p.uniform1f(c.fogFar,_.far),p.uniform1i(c.fogType,1),x=1,y=1):_ instanceof i.FogExp2&&(p.uniform1f(c.fogDensity,_.density),p.uniform1i(c.fogType,2),x=2,y=2)):(p.uniform1i(c.fogType,0),x=0,y=0);for(var b=0,w=t.length;w>b;b++){var T=t[b];T.modelViewMatrix.multiplyMatrices(v.matrixWorldInverse,T.matrixWorld),T.z=-T.modelViewMatrix.elements[14]}t.sort(o);for(var M=[],b=0,w=t.length;w>b;b++){var T=t[b],S=T.material;p.uniform1f(c.alphaTest,S.alphaTest),p.uniformMatrix4fv(c.modelViewMatrix,!1,T.modelViewMatrix.elements),T.matrixWorld.decompose(d,m,g),M[0]=g.x,M[1]=g.y;var E=0;n.fog&&S.fog&&(E=y),x!==E&&(p.uniform1i(c.fogType,E),x=E),null!==S.map?(p.uniform2f(c.uvOffset,S.map.offset.x,S.map.offset.y),p.uniform2f(c.uvScale,S.map.repeat.x,S.map.repeat.y)):(p.uniform2f(c.uvOffset,0,0),p.uniform2f(c.uvScale,1,1)),p.uniform1f(c.opacity,S.opacity),p.uniform3f(c.color,S.color.r,S.color.g,S.color.b),p.uniform1f(c.rotation,S.rotation),p.uniform2fv(c.scale,M),f.setBlending(S.blending,S.blendEquation,S.blendSrc,S.blendDst),f.setDepthTest(S.depthTest),f.setDepthWrite(S.depthWrite),S.map&&S.map.image&&S.map.image.width?e.setTexture(S.map,0):e.setTexture(l,0),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0)}f.enable(p.CULL_FACE),e.resetGLState()}}},i.CurveUtils={tangentQuadraticBezier:function(e,t,r,n){return 2*(1-e)*(r-t)+2*e*(n-r)},tangentCubicBezier:function(e,t,r,n,i){return-3*t*(1-e)*(1-e)+3*r*(1-e)*(1-e)-6*e*r*(1-e)+6*e*n*(1-e)-3*e*e*n+3*e*e*i},tangentSpline:function(e,t,r,n,i){var o=6*e*e-6*e,a=3*e*e-4*e+1,s=-6*e*e+6*e,u=3*e*e-2*e;return o+a+s+u},interpolate:function(e,t,r,n,i){var o=.5*(r-e),a=.5*(n-t),s=i*i,u=i*s;return(2*t-2*r+o+a)*u+(-3*t+3*r-2*o-a)*s+o*i+t}},i.GeometryUtils={merge:function(e,t,r){console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead.");var n;t instanceof i.Mesh&&(t.matrixAutoUpdate&&t.updateMatrix(),n=t.matrix,t=t.geometry),e.merge(t,n,r)},center:function(e){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),e.center()}},i.ImageUtils={crossOrigin:void 0,loadTexture:function(e,t,r,n){console.warn("THREE.ImageUtils.loadTexture is being deprecated. Use THREE.TextureLoader() instead.");var o=new i.TextureLoader;o.setCrossOrigin(this.crossOrigin);var a=o.load(e,r,void 0,n);return t&&(a.mapping=t),a},loadTextureCube:function(e,t,r,n){console.warn("THREE.ImageUtils.loadTextureCube is being deprecated. Use THREE.CubeTextureLoader() instead.");var o=new i.CubeTextureLoader;o.setCrossOrigin(this.crossOrigin);var a=o.load(e,r,void 0,n);return t&&(a.mapping=t),a},loadCompressedTexture:function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},loadCompressedTextureCube:function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")}},i.SceneUtils={createMultiMaterialObject:function(e,t){for(var r=new i.Group,n=0,o=t.length;o>n;n++)r.add(new i.Mesh(e,t[n]));return r},detach:function(e,t,r){e.applyMatrix(t.matrixWorld),t.remove(e),r.add(e)},attach:function(e,t,r){var n=new i.Matrix4;n.getInverse(r.matrixWorld),e.applyMatrix(n),t.remove(e),r.add(e)}},i.ShapeUtils={area:function(e){for(var t=e.length,r=0,n=t-1,i=0;t>i;n=i++)r+=e[n].x*e[i].y-e[i].x*e[n].y;return.5*r},triangulate:function(){function e(e,t,r,n,i,o){var a,s,u,h,c,l,p,f,d;if(s=e[o[t]].x,u=e[o[t]].y,h=e[o[r]].x,c=e[o[r]].y,l=e[o[n]].x,p=e[o[n]].y,Number.EPSILON>(h-s)*(p-u)-(c-u)*(l-s))return!1;var m,g,v,x,y,_,b,w,T,M,S,E,C,R,D;for(m=l-h,g=p-c,v=s-l,x=u-p,y=h-s,_=c-u,a=0;i>a;a++)if(f=e[o[a]].x,d=e[o[a]].y,!(f===s&&d===u||f===h&&d===c||f===l&&d===p)&&(b=f-s,w=d-u,T=f-h,M=d-c,S=f-l,E=d-p,D=m*M-g*T,C=y*w-_*b,R=v*E-x*S,D>=-Number.EPSILON&&R>=-Number.EPSILON&&C>=-Number.EPSILON))return!1;return!0}return function(t,r){var n=t.length;if(3>n)return null;var o,a,s,u=[],h=[],c=[];if(i.ShapeUtils.area(t)>0)for(a=0;n>a;a++)h[a]=a;else for(a=0;n>a;a++)h[a]=n-1-a;var l=n,p=2*l;for(a=l-1;l>2;){if(p--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),r?c:u;if(o=a,o>=l&&(o=0),a=o+1,a>=l&&(a=0),s=a+1,s>=l&&(s=0),e(t,o,a,s,l,h)){var f,d,m,g,v;for(f=h[o],d=h[a],m=h[s],u.push([t[f],t[d],t[m]]),c.push([h[o],h[a],h[s]]),g=a,v=a+1;l>v;g++,v++)h[g]=h[v];l--,p=2*l}}return r?c:u}}(),triangulateShape:function(e,t){function r(e,t,r){return e.x!==t.x?e.x<t.x?e.x<=r.x&&r.x<=t.x:t.x<=r.x&&r.x<=e.x:e.y<t.y?e.y<=r.y&&r.y<=t.y:t.y<=r.y&&r.y<=e.y}function n(e,t,n,i,o){var a=t.x-e.x,s=t.y-e.y,u=i.x-n.x,h=i.y-n.y,c=e.x-n.x,l=e.y-n.y,p=s*u-a*h,f=s*c-a*l;if(Math.abs(p)>Number.EPSILON){var d;if(p>0){if(0>f||f>p)return[];if(d=h*c-u*l,0>d||d>p)return[]}else{if(f>0||p>f)return[];if(d=h*c-u*l,d>0||p>d)return[]}if(0===d)return!o||0!==f&&f!==p?[e]:[];if(d===p)return!o||0!==f&&f!==p?[t]:[];if(0===f)return[n];if(f===p)return[i];var m=d/p;return[{x:e.x+m*a,y:e.y+m*s}]}if(0!==f||h*c!==u*l)return[];var g=0===a&&0===s,v=0===u&&0===h;if(g&&v)return e.x!==n.x||e.y!==n.y?[]:[e];if(g)return r(n,i,e)?[e]:[];if(v)return r(e,t,n)?[n]:[];var x,y,_,b,w,T,M,S;return 0!==a?(e.x<t.x?(x=e,_=e.x,y=t,b=t.x):(x=t,_=t.x,y=e,b=e.x),n.x<i.x?(w=n,M=n.x,T=i,S=i.x):(w=i,M=i.x,T=n,S=n.x)):(e.y<t.y?(x=e,_=e.y,y=t,b=t.y):(x=t,_=t.y,y=e,b=e.y),n.y<i.y?(w=n,M=n.y,T=i,S=i.y):(w=i,M=i.y,T=n,S=n.y)),M>=_?M>b?[]:b===M?o?[]:[w]:S>=b?[w,y]:[w,T]:_>S?[]:_===S?o?[]:[x]:S>=b?[x,y]:[x,T]}function o(e,t,r,n){var i=t.x-e.x,o=t.y-e.y,a=r.x-e.x,s=r.y-e.y,u=n.x-e.x,h=n.y-e.y,c=i*s-o*a,l=i*h-o*u;if(Math.abs(c)>Number.EPSILON){var p=u*s-h*a;return c>0?l>=0&&p>=0:l>=0||p>=0}return l>0}function a(e,t){function r(e,t){var r=x.length-1,n=e-1;0>n&&(n=r);var i=e+1;i>r&&(i=0);var a=o(x[e],x[n],x[i],s[t]);if(!a)return!1;var u=s.length-1,h=t-1;0>h&&(h=u);var c=t+1;return c>u&&(c=0),a=o(s[t],s[h],s[c],x[e]),a?!0:!1}function i(e,t){var r,i,o;for(r=0;r<x.length;r++)if(i=r+1,i%=x.length,o=n(e,t,x[r],x[i],!0),o.length>0)return!0;return!1}function a(e,r){var i,o,a,s,u;for(i=0;i<y.length;i++)for(o=t[y[i]],a=0;a<o.length;a++)if(s=a+1,s%=o.length,u=n(e,r,o[a],o[s],!0),u.length>0)return!0;return!1}for(var s,u,h,c,l,p,f,d,m,g,v,x=e.concat(),y=[],_=[],b=0,w=t.length;w>b;b++)y.push(b);for(var T=0,M=2*y.length;y.length>0;){if(M--,0>M){console.log("Infinite Loop! Holes left:"+y.length+", Probably Hole outside Shape!");break}for(h=T;h<x.length;h++){c=x[h],u=-1;for(var b=0;b<y.length;b++)if(p=y[b],f=c.x+":"+c.y+":"+p,void 0===_[f]){s=t[p];for(var S=0;S<s.length;S++)if(l=s[S],r(h,S)&&!i(c,l)&&!a(c,l)){u=S,y.splice(b,1),d=x.slice(0,h+1),m=x.slice(h),g=s.slice(u),v=s.slice(0,u+1),x=d.concat(g).concat(v).concat(m),T=h;break}if(u>=0)break;_[f]=!0}if(u>=0)break}}return x}for(var s,u,h,c,l,p,f={},d=e.concat(),m=0,g=t.length;g>m;m++)Array.prototype.push.apply(d,t[m]);for(s=0,u=d.length;u>s;s++)l=d[s].x+":"+d[s].y,void 0!==f[l]&&console.warn("THREE.Shape: Duplicate point",l),f[l]=s;var v=a(e,t),x=i.ShapeUtils.triangulate(v,!1);for(s=0,u=x.length;u>s;s++)for(c=x[s],h=0;3>h;h++)l=c[h].x+":"+c[h].y,p=f[l],void 0!==p&&(c[h]=p);return x.concat()},isClockWise:function(e){return i.ShapeUtils.area(e)<0},b2:function(){function e(e,t){var r=1-e;return r*r*t}function t(e,t){return 2*(1-e)*e*t}function r(e,t){return e*e*t}return function(n,i,o,a){return e(n,i)+t(n,o)+r(n,a)}}(),b3:function(){function e(e,t){var r=1-e;return r*r*r*t}function t(e,t){var r=1-e;return 3*r*r*e*t}function r(e,t){var r=1-e;return 3*r*e*e*t}function n(e,t){return e*e*e*t}return function(i,o,a,s,u){return e(i,o)+t(i,a)+r(i,s)+n(i,u)}}()},i.Audio=function(e){i.Object3D.call(this),this.type="Audio",this.context=e.context,this.source=this.context.createBufferSource(),this.source.onended=this.onEnded.bind(this),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.panner=this.context.createPanner(),this.panner.connect(this.gain),this.autoplay=!1,this.startTime=0,this.playbackRate=1,this.isPlaying=!1},i.Audio.prototype=Object.create(i.Object3D.prototype),i.Audio.prototype.constructor=i.Audio,i.Audio.prototype.load=function(e){var t=this,r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(e){t.context.decodeAudioData(this.response,function(e){t.source.buffer=e,t.autoplay&&t.play()})},r.send(),this},i.Audio.prototype.play=function(){if(this.isPlaying===!0)return void console.warn("THREE.Audio: Audio is already playing.");var e=this.context.createBufferSource();e.buffer=this.source.buffer,e.loop=this.source.loop,e.onended=this.source.onended,e.start(0,this.startTime),e.playbackRate.value=this.playbackRate,this.isPlaying=!0,this.source=e,this.connect()},i.Audio.prototype.pause=function(){this.source.stop(),this.startTime=this.context.currentTime},i.Audio.prototype.stop=function(){this.source.stop(),this.startTime=0},i.Audio.prototype.connect=function(){void 0!==this.filter?(this.source.connect(this.filter),this.filter.connect(this.panner)):this.source.connect(this.panner)},i.Audio.prototype.disconnect=function(){void 0!==this.filter?(this.source.disconnect(this.filter),this.filter.disconnect(this.panner)):this.source.disconnect(this.panner)},i.Audio.prototype.setFilter=function(e){this.isPlaying===!0?(this.disconnect(),this.filter=e,this.connect()):this.filter=e},i.Audio.prototype.getFilter=function(){return this.filter},i.Audio.prototype.setPlaybackRate=function(e){this.playbackRate=e,this.isPlaying===!0&&(this.source.playbackRate.value=this.playbackRate)},i.Audio.prototype.getPlaybackRate=function(){return this.playbackRate},i.Audio.prototype.onEnded=function(){this.isPlaying=!1},i.Audio.prototype.setLoop=function(e){this.source.loop=e},i.Audio.prototype.getLoop=function(){return this.source.loop},i.Audio.prototype.setRefDistance=function(e){this.panner.refDistance=e},i.Audio.prototype.getRefDistance=function(){return this.panner.refDistance},i.Audio.prototype.setRolloffFactor=function(e){this.panner.rolloffFactor=e},i.Audio.prototype.getRolloffFactor=function(){return this.panner.rolloffFactor},i.Audio.prototype.setVolume=function(e){this.gain.gain.value=e},i.Audio.prototype.getVolume=function(){return this.gain.gain.value},i.Audio.prototype.updateMatrixWorld=function(){var e=new i.Vector3;return function(t){i.Object3D.prototype.updateMatrixWorld.call(this,t),e.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(e.x,e.y,e.z)}}(),i.AudioListener=function(){i.Object3D.call(this),this.type="AudioListener",this.context=new(window.AudioContext||window.webkitAudioContext)},i.AudioListener.prototype=Object.create(i.Object3D.prototype),i.AudioListener.prototype.constructor=i.AudioListener,i.AudioListener.prototype.updateMatrixWorld=function(){var e=new i.Vector3,t=new i.Quaternion,r=new i.Vector3,n=new i.Vector3;return function(o){i.Object3D.prototype.updateMatrixWorld.call(this,o);var a=this.context.listener,s=this.up;this.matrixWorld.decompose(e,t,r),n.set(0,0,-1).applyQuaternion(t),a.setPosition(e.x,e.y,e.z),a.setOrientation(n.x,n.y,n.z,s.x,s.y,s.z)}}(),i.Curve=function(){},i.Curve.prototype={constructor:i.Curve,getPoint:function(e){return console.warn("THREE.Curve: Warning, getPoint() not implemented!"),null},getPointAt:function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},getPoints:function(e){e||(e=5);var t,r=[];for(t=0;e>=t;t++)r.push(this.getPoint(t/e));return r},getSpacedPoints:function(e){e||(e=5);var t,r=[];for(t=0;e>=t;t++)r.push(this.getPointAt(t/e));return r},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,r,n=[],i=this.getPoint(0),o=0;for(n.push(0),r=1;e>=r;r++)t=this.getPoint(r/e),o+=t.distanceTo(i),n.push(o),i=t;return this.cacheArcLengths=n,n},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var r,n=this.getLengths(),i=0,o=n.length;r=t?t:e*n[o-1];for(var a,s=0,u=o-1;u>=s;)if(i=Math.floor(s+(u-s)/2),a=n[i]-r,0>a)s=i+1;else{if(!(a>0)){u=i;break}u=i-1}if(i=u,n[i]===r){var h=i/(o-1);return h}var c=n[i],l=n[i+1],p=l-c,f=(r-c)/p,h=(i+f)/(o-1);return h},getTangent:function(e){var t=1e-4,r=e-t,n=e+t;0>r&&(r=0),n>1&&(n=1);var i=this.getPoint(r),o=this.getPoint(n),a=o.clone().sub(i);return a.normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)}},i.Curve.Utils=i.CurveUtils,i.Curve.create=function(e,t){return e.prototype=Object.create(i.Curve.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},i.CurvePath=function(){this.curves=[],this.autoClose=!1},i.CurvePath.prototype=Object.create(i.Curve.prototype),i.CurvePath.prototype.constructor=i.CurvePath,i.CurvePath.prototype.add=function(e){this.curves.push(e)},i.CurvePath.prototype.closePath=function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new i.LineCurve(t,e))},i.CurvePath.prototype.getPoint=function(e){for(var t=e*this.getLength(),r=this.getCurveLengths(),n=0;n<r.length;){if(r[n]>=t){var i=r[n]-t,o=this.curves[n],a=1-i/o.getLength();return o.getPointAt(a)}n++}return null},i.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},i.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,r=0,n=this.curves.length;n>r;r++)t+=this.curves[r].getLength(),e.push(t);return this.cacheLengths=e,e},i.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},i.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},i.CurvePath.prototype.createGeometry=function(e){for(var t=new i.Geometry,r=0,n=e.length;n>r;r++){var o=e[r];t.vertices.push(new i.Vector3(o.x,o.y,o.z||0))}return t},i.Path=function(e){i.CurvePath.call(this),this.actions=[],e&&this.fromPoints(e)},i.Path.prototype=Object.create(i.CurvePath.prototype),i.Path.prototype.constructor=i.Path,i.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,r=e.length;r>t;t++)this.lineTo(e[t].x,e[t].y)},i.Path.prototype.moveTo=function(e,t){this.actions.push({action:"moveTo",args:[e,t]})},i.Path.prototype.lineTo=function(e,t){var r=this.actions[this.actions.length-1].args,n=r[r.length-2],o=r[r.length-1],a=new i.LineCurve(new i.Vector2(n,o),new i.Vector2(e,t));this.curves.push(a),this.actions.push({action:"lineTo",args:[e,t]})},i.Path.prototype.quadraticCurveTo=function(e,t,r,n){var o=this.actions[this.actions.length-1].args,a=o[o.length-2],s=o[o.length-1],u=new i.QuadraticBezierCurve(new i.Vector2(a,s),new i.Vector2(e,t),new i.Vector2(r,n));this.curves.push(u),this.actions.push({action:"quadraticCurveTo",args:[e,t,r,n]})},i.Path.prototype.bezierCurveTo=function(e,t,r,n,o,a){var s=this.actions[this.actions.length-1].args,u=s[s.length-2],h=s[s.length-1],c=new i.CubicBezierCurve(new i.Vector2(u,h),new i.Vector2(e,t),new i.Vector2(r,n),new i.Vector2(o,a));this.curves.push(c),this.actions.push({action:"bezierCurveTo",args:[e,t,r,n,o,a]})},i.Path.prototype.splineThru=function(e){var t=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,n=r[r.length-2],o=r[r.length-1],a=[new i.Vector2(n,o)];Array.prototype.push.apply(a,e);var s=new i.SplineCurve(a);this.curves.push(s),this.actions.push({action:"splineThru",args:t})},i.Path.prototype.arc=function(e,t,r,n,i,o){var a=this.actions[this.actions.length-1].args,s=a[a.length-2],u=a[a.length-1];this.absarc(e+s,t+u,r,n,i,o)},i.Path.prototype.absarc=function(e,t,r,n,i,o){this.absellipse(e,t,r,r,n,i,o)},i.Path.prototype.ellipse=function(e,t,r,n,i,o,a,s){var u=this.actions[this.actions.length-1].args,h=u[u.length-2],c=u[u.length-1];this.absellipse(e+h,t+c,r,n,i,o,a,s)},i.Path.prototype.absellipse=function(e,t,r,n,o,a,s,u){var h=[e,t,r,n,o,a,s,u||0],c=new i.EllipseCurve(e,t,r,n,o,a,s,u);this.curves.push(c);var l=c.getPoint(1);h.push(l.x),h.push(l.y),this.actions.push({action:"ellipse",args:h})},i.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);for(var r=[],n=0;e>n;n++)r.push(this.getPoint(n/e));return r},i.Path.prototype.getPoints=function(e,t){e=e||12;for(var r,n,o,a,s,u,h,c,l,p,f,d=i.ShapeUtils.b2,m=i.ShapeUtils.b3,g=[],v=0,x=this.actions.length;x>v;v++){var y=this.actions[v],_=y.action,b=y.args;switch(_){case"moveTo":g.push(new i.Vector2(b[0],b[1]));break;case"lineTo":g.push(new i.Vector2(b[0],b[1]));break;case"quadraticCurveTo":r=b[2],n=b[3],s=b[0],u=b[1],g.length>0?(l=g[g.length-1],h=l.x,c=l.y):(l=this.actions[v-1].args,h=l[l.length-2],c=l[l.length-1]);for(var w=1;e>=w;w++){var T=w/e;p=d(T,h,s,r),f=d(T,c,u,n),g.push(new i.Vector2(p,f))}break;case"bezierCurveTo":r=b[4],n=b[5],s=b[0],u=b[1],o=b[2],a=b[3],g.length>0?(l=g[g.length-1],h=l.x,c=l.y):(l=this.actions[v-1].args,h=l[l.length-2],c=l[l.length-1]);for(var w=1;e>=w;w++){var T=w/e;p=m(T,h,s,o,r),f=m(T,c,u,a,n),g.push(new i.Vector2(p,f))}break;case"splineThru":l=this.actions[v-1].args;var M=new i.Vector2(l[l.length-2],l[l.length-1]),S=[M],E=e*b[0].length;S=S.concat(b[0]);for(var C=new i.SplineCurve(S),w=1;E>=w;w++)g.push(C.getPointAt(w/E));break;case"arc":for(var R,D=b[0],A=b[1],P=b[2],L=b[3],B=b[4],F=!!b[5],G=B-L,U=2*e,w=1;U>=w;w++){var T=w/U;F||(T=1-T),R=L+T*G,p=D+P*Math.cos(R),f=A+P*Math.sin(R),g.push(new i.Vector2(p,f))}break;case"ellipse":var R,k,V,D=b[0],A=b[1],I=b[2],O=b[3],L=b[4],B=b[5],F=!!b[6],z=b[7],G=B-L,U=2*e;0!==z&&(k=Math.cos(z),V=Math.sin(z));for(var w=1;U>=w;w++){var T=w/U;if(F||(T=1-T),R=L+T*G,p=D+I*Math.cos(R),f=A+O*Math.sin(R),0!==z){var N=p,j=f;p=(N-D)*k-(j-A)*V+D,f=(N-D)*V+(j-A)*k+A}g.push(new i.Vector2(p,f))}}}var H=g[g.length-1];return Math.abs(H.x-g[0].x)<Number.EPSILON&&Math.abs(H.y-g[0].y)<Number.EPSILON&&g.splice(g.length-1,1),t&&g.push(g[0]),g},i.Path.prototype.toShapes=function(e,t){function r(e){for(var t=[],r=new i.Path,n=0,o=e.length;o>n;n++){var a=e[n],s=a.args,u=a.action;"moveTo"===u&&0!==r.actions.length&&(t.push(r),r=new i.Path),r[u].apply(r,s)}return 0!==r.actions.length&&t.push(r),t}function n(e){for(var t=[],r=0,n=e.length;n>r;r++){var o=e[r],a=new i.Shape;a.actions=o.actions,a.curves=o.curves,t.push(a)}return t}function o(e,t){for(var r=t.length,n=!1,i=r-1,o=0;r>o;i=o++){var a=t[i],s=t[o],u=s.x-a.x,h=s.y-a.y;if(Math.abs(h)>Number.EPSILON){if(0>h&&(a=t[o],u=-u,s=t[i],h=-h),e.y<a.y||e.y>s.y)continue;if(e.y===a.y){if(e.x===a.x)return!0}else{var c=h*(e.x-a.x)-u*(e.y-a.y);if(0===c)return!0;if(0>c)continue;n=!n}}else{if(e.y!==a.y)continue;if(s.x<=e.x&&e.x<=a.x||a.x<=e.x&&e.x<=s.x)return!0}}return n}var a=i.ShapeUtils.isClockWise,s=r(this.actions);if(0===s.length)return[];if(t===!0)return n(s);var u,h,c,l=[];if(1===s.length)return h=s[0],c=new i.Shape,c.actions=h.actions,c.curves=h.curves,l.push(c),l;var p=!a(s[0].getPoints());p=e?!p:p;var f,d=[],m=[],g=[],v=0;m[v]=void 0,g[v]=[];for(var x=0,y=s.length;y>x;x++)h=s[x],f=h.getPoints(),u=a(f),u=e?!u:u,u?(!p&&m[v]&&v++,m[v]={s:new i.Shape,p:f},m[v].s.actions=h.actions,m[v].s.curves=h.curves,p&&v++,g[v]=[]):g[v].push({h:h,p:f[0]});if(!m[0])return n(s);if(m.length>1){for(var _=!1,b=[],w=0,T=m.length;T>w;w++)d[w]=[];for(var w=0,T=m.length;T>w;w++)for(var M=g[w],S=0;S<M.length;S++){for(var E=M[S],C=!0,R=0;R<m.length;R++)o(E.p,m[R].p)&&(w!==R&&b.push({froms:w,tos:R,hole:S}),C?(C=!1,d[R].push(E)):_=!0);C&&d[w].push(E)}b.length>0&&(_||(g=d))}for(var D,x=0,A=m.length;A>x;x++){c=m[x].s,l.push(c),D=g[x];for(var P=0,L=D.length;L>P;P++)c.holes.push(D[P].h)}return l},i.Shape=function(){i.Path.apply(this,arguments),this.holes=[]},i.Shape.prototype=Object.create(i.Path.prototype),i.Shape.prototype.constructor=i.Shape,i.Shape.prototype.extrude=function(e){return new i.ExtrudeGeometry(this,e)},i.Shape.prototype.makeGeometry=function(e){return new i.ShapeGeometry(this,e)},i.Shape.prototype.getPointsHoles=function(e){for(var t=[],r=0,n=this.holes.length;n>r;r++)t[r]=this.holes[r].getPoints(e);return t},i.Shape.prototype.extractAllPoints=function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},i.Shape.prototype.extractPoints=function(e){return this.extractAllPoints(e)},i.Shape.Utils=i.ShapeUtils,i.LineCurve=function(e,t){this.v1=e,this.v2=t},i.LineCurve.prototype=Object.create(i.Curve.prototype),i.LineCurve.prototype.constructor=i.LineCurve,i.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},i.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},i.LineCurve.prototype.getTangent=function(e){var t=this.v2.clone().sub(this.v1);return t.normalize()},i.QuadraticBezierCurve=function(e,t,r){this.v0=e,this.v1=t,this.v2=r},i.QuadraticBezierCurve.prototype=Object.create(i.Curve.prototype),i.QuadraticBezierCurve.prototype.constructor=i.QuadraticBezierCurve,i.QuadraticBezierCurve.prototype.getPoint=function(e){var t=i.ShapeUtils.b2;return new i.Vector2(t(e,this.v0.x,this.v1.x,this.v2.x),t(e,this.v0.y,this.v1.y,this.v2.y))},i.QuadraticBezierCurve.prototype.getTangent=function(e){var t=i.CurveUtils.tangentQuadraticBezier;return new i.Vector2(t(e,this.v0.x,this.v1.x,this.v2.x),t(e,this.v0.y,this.v1.y,this.v2.y)).normalize()},i.CubicBezierCurve=function(e,t,r,n){this.v0=e,this.v1=t,this.v2=r,this.v3=n},i.CubicBezierCurve.prototype=Object.create(i.Curve.prototype),i.CubicBezierCurve.prototype.constructor=i.CubicBezierCurve,i.CubicBezierCurve.prototype.getPoint=function(e){var t=i.ShapeUtils.b3;return new i.Vector2(t(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y))},i.CubicBezierCurve.prototype.getTangent=function(e){var t=i.CurveUtils.tangentCubicBezier;return new i.Vector2(t(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y)).normalize()},i.SplineCurve=function(e){this.points=void 0==e?[]:e},i.SplineCurve.prototype=Object.create(i.Curve.prototype),i.SplineCurve.prototype.constructor=i.SplineCurve,i.SplineCurve.prototype.getPoint=function(e){var t=this.points,r=(t.length-1)*e,n=Math.floor(r),o=r-n,a=t[0===n?n:n-1],s=t[n],u=t[n>t.length-2?t.length-1:n+1],h=t[n>t.length-3?t.length-1:n+2],c=i.CurveUtils.interpolate;return new i.Vector2(c(a.x,s.x,u.x,h.x,o),c(a.y,s.y,u.y,h.y,o))},i.EllipseCurve=function(e,t,r,n,i,o,a,s){this.aX=e,this.aY=t,this.xRadius=r,this.yRadius=n,this.aStartAngle=i,this.aEndAngle=o,this.aClockwise=a,this.aRotation=s||0},i.EllipseCurve.prototype=Object.create(i.Curve.prototype),i.EllipseCurve.prototype.constructor=i.EllipseCurve,i.EllipseCurve.prototype.getPoint=function(e){var t=this.aEndAngle-this.aStartAngle;0>t&&(t+=2*Math.PI),t>2*Math.PI&&(t-=2*Math.PI);var r;r=this.aClockwise===!0?this.aEndAngle+(1-e)*(2*Math.PI-t):this.aStartAngle+e*t;var n=this.aX+this.xRadius*Math.cos(r),o=this.aY+this.yRadius*Math.sin(r);if(0!==this.aRotation){var a=Math.cos(this.aRotation),s=Math.sin(this.aRotation),u=n,h=o;n=(u-this.aX)*a-(h-this.aY)*s+this.aX,o=(u-this.aX)*s+(h-this.aY)*a+this.aY}return new i.Vector2(n,o)},i.ArcCurve=function(e,t,r,n,o,a){i.EllipseCurve.call(this,e,t,r,r,n,o,a)},i.ArcCurve.prototype=Object.create(i.EllipseCurve.prototype),i.ArcCurve.prototype.constructor=i.ArcCurve,i.LineCurve3=i.Curve.create(function(e,t){this.v1=e,this.v2=t},function(e){var t=new i.Vector3;return t.subVectors(this.v2,this.v1),t.multiplyScalar(e),t.add(this.v1),t}),i.QuadraticBezierCurve3=i.Curve.create(function(e,t,r){this.v0=e,this.v1=t,this.v2=r},function(e){var t=i.ShapeUtils.b2;return new i.Vector3(t(e,this.v0.x,this.v1.x,this.v2.x),t(e,this.v0.y,this.v1.y,this.v2.y),t(e,this.v0.z,this.v1.z,this.v2.z))}),i.CubicBezierCurve3=i.Curve.create(function(e,t,r,n){this.v0=e,this.v1=t,this.v2=r,this.v3=n},function(e){var t=i.ShapeUtils.b3;return new i.Vector3(t(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),t(e,this.v0.z,this.v1.z,this.v2.z,this.v3.z))}),i.SplineCurve3=i.Curve.create(function(e){console.warn("THREE.SplineCurve3 will be deprecated. Please use THREE.CatmullRomCurve3"),this.points=void 0==e?[]:e},function(e){var t=this.points,r=(t.length-1)*e,n=Math.floor(r),o=r-n,a=t[0==n?n:n-1],s=t[n],u=t[n>t.length-2?t.length-1:n+1],h=t[n>t.length-3?t.length-1:n+2],c=i.CurveUtils.interpolate;return new i.Vector3(c(a.x,s.x,u.x,h.x,o),c(a.y,s.y,u.y,h.y,o),c(a.z,s.z,u.z,h.z,o))}),i.CatmullRomCurve3=function(){function e(){}var t=new i.Vector3,r=new e,n=new e,o=new e;return e.prototype.init=function(e,t,r,n){this.c0=e,this.c1=r,this.c2=-3*e+3*t-2*r-n,this.c3=2*e-2*t+r+n},e.prototype.initNonuniformCatmullRom=function(e,t,r,n,i,o,a){var s=(t-e)/i-(r-e)/(i+o)+(r-t)/o,u=(r-t)/o-(n-t)/(o+a)+(n-r)/a;s*=o,u*=o,this.init(t,r,s,u)},e.prototype.initCatmullRom=function(e,t,r,n,i){this.init(t,r,i*(r-e),i*(n-t))},e.prototype.calc=function(e){var t=e*e,r=t*e;return this.c0+this.c1*e+this.c2*t+this.c3*r},i.Curve.create(function(e){this.points=e||[]},function(e){var a,s,u,h,c=this.points;h=c.length,2>h&&console.log("duh, you need at least 2 points"),a=(h-1)*e,s=Math.floor(a),u=a-s,0===u&&s===h-1&&(s=h-2,u=1);var l,p,f,d;if(0===s?(t.subVectors(c[0],c[1]).add(c[0]),l=t):l=c[s-1],p=c[s],f=c[s+1],h>s+2?d=c[s+2]:(t.subVectors(c[h-1],c[h-2]).add(c[h-2]),d=t),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var m="chordal"===this.type?.5:.25,g=Math.pow(l.distanceToSquared(p),m),v=Math.pow(p.distanceToSquared(f),m),x=Math.pow(f.distanceToSquared(d),m);1e-4>v&&(v=1),1e-4>g&&(g=v),1e-4>x&&(x=v),r.initNonuniformCatmullRom(l.x,p.x,f.x,d.x,g,v,x),n.initNonuniformCatmullRom(l.y,p.y,f.y,d.y,g,v,x),
o.initNonuniformCatmullRom(l.z,p.z,f.z,d.z,g,v,x)}else if("catmullrom"===this.type){var y=void 0!==this.tension?this.tension:.5;r.initCatmullRom(l.x,p.x,f.x,d.x,y),n.initCatmullRom(l.y,p.y,f.y,d.y,y),o.initCatmullRom(l.z,p.z,f.z,d.z,y)}var _=new i.Vector3(r.calc(u),n.calc(u),o.calc(u));return _})}(),i.ClosedSplineCurve3=i.Curve.create(function(e){this.points=void 0==e?[]:e},function(e){var t=this.points,r=(t.length-0)*e,n=Math.floor(r),o=r-n;n+=n>0?0:(Math.floor(Math.abs(n)/t.length)+1)*t.length;var a=t[(n-1)%t.length],s=t[n%t.length],u=t[(n+1)%t.length],h=t[(n+2)%t.length],c=i.CurveUtils.interpolate;return new i.Vector3(c(a.x,s.x,u.x,h.x,o),c(a.y,s.y,u.y,h.y,o),c(a.z,s.z,u.z,h.z,o))}),i.BoxGeometry=function(e,t,r,n,o,a){function s(e,t,r,n,o,a,s,h){var c,l,p,f=u.widthSegments,d=u.heightSegments,m=o/2,g=a/2,v=u.vertices.length;"x"===e&&"y"===t||"y"===e&&"x"===t?c="z":"x"===e&&"z"===t||"z"===e&&"x"===t?(c="y",d=u.depthSegments):("z"===e&&"y"===t||"y"===e&&"z"===t)&&(c="x",f=u.depthSegments);var x=f+1,y=d+1,_=o/f,b=a/d,w=new i.Vector3;for(w[c]=s>0?1:-1,p=0;y>p;p++)for(l=0;x>l;l++){var T=new i.Vector3;T[e]=(l*_-m)*r,T[t]=(p*b-g)*n,T[c]=s,u.vertices.push(T)}for(p=0;d>p;p++)for(l=0;f>l;l++){var M=l+x*p,S=l+x*(p+1),E=l+1+x*(p+1),C=l+1+x*p,R=new i.Vector2(l/f,1-p/d),D=new i.Vector2(l/f,1-(p+1)/d),A=new i.Vector2((l+1)/f,1-(p+1)/d),P=new i.Vector2((l+1)/f,1-p/d),L=new i.Face3(M+v,S+v,C+v);L.normal.copy(w),L.vertexNormals.push(w.clone(),w.clone(),w.clone()),L.materialIndex=h,u.faces.push(L),u.faceVertexUvs[0].push([R,D,P]),L=new i.Face3(S+v,E+v,C+v),L.normal.copy(w),L.vertexNormals.push(w.clone(),w.clone(),w.clone()),L.materialIndex=h,u.faces.push(L),u.faceVertexUvs[0].push([D.clone(),A,P.clone()])}}i.Geometry.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:n,heightSegments:o,depthSegments:a},this.widthSegments=n||1,this.heightSegments=o||1,this.depthSegments=a||1;var u=this,h=e/2,c=t/2,l=r/2;s("z","y",-1,-1,r,t,h,0),s("z","y",1,-1,r,t,-h,1),s("x","z",1,1,e,r,c,2),s("x","z",1,-1,e,r,-c,3),s("x","y",1,-1,e,t,l,4),s("x","y",-1,-1,e,t,-l,5),this.mergeVertices()},i.BoxGeometry.prototype=Object.create(i.Geometry.prototype),i.BoxGeometry.prototype.constructor=i.BoxGeometry,i.BoxGeometry.prototype.clone=function(){var e=this.parameters;return new i.BoxGeometry(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)},i.CubeGeometry=i.BoxGeometry,i.CircleGeometry=function(e,t,r,n){i.Geometry.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:n},this.fromBufferGeometry(new i.CircleBufferGeometry(e,t,r,n))},i.CircleGeometry.prototype=Object.create(i.Geometry.prototype),i.CircleGeometry.prototype.constructor=i.CircleGeometry,i.CircleGeometry.prototype.clone=function(){var e=this.parameters;return new i.CircleGeometry(e.radius,e.segments,e.thetaStart,e.thetaLength)},i.CircleBufferGeometry=function(e,t,r,n){i.BufferGeometry.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:n},e=e||50,t=void 0!==t?Math.max(3,t):8,r=void 0!==r?r:0,n=void 0!==n?n:2*Math.PI;var o=t+2,a=new Float32Array(3*o),s=new Float32Array(3*o),u=new Float32Array(2*o);s[2]=1,u[0]=.5,u[1]=.5;for(var h=0,c=3,l=2;t>=h;h++,c+=3,l+=2){var p=r+h/t*n;a[c]=e*Math.cos(p),a[c+1]=e*Math.sin(p),s[c+2]=1,u[l]=(a[c]/e+1)/2,u[l+1]=(a[c+1]/e+1)/2}for(var f=[],c=1;t>=c;c++)f.push(c,c+1,0);this.setIndex(new i.BufferAttribute(new Uint16Array(f),1)),this.addAttribute("position",new i.BufferAttribute(a,3)),this.addAttribute("normal",new i.BufferAttribute(s,3)),this.addAttribute("uv",new i.BufferAttribute(u,2)),this.boundingSphere=new i.Sphere(new i.Vector3,e)},i.CircleBufferGeometry.prototype=Object.create(i.BufferGeometry.prototype),i.CircleBufferGeometry.prototype.constructor=i.CircleBufferGeometry,i.CircleBufferGeometry.prototype.clone=function(){var e=this.parameters;return new i.CircleBufferGeometry(e.radius,e.segments,e.thetaStart,e.thetaLength)},i.CylinderGeometry=function(e,t,r,n,o,a,s,u){i.Geometry.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:n,heightSegments:o,openEnded:a,thetaStart:s,thetaLength:u},e=void 0!==e?e:20,t=void 0!==t?t:20,r=void 0!==r?r:100,n=n||8,o=o||1,a=void 0!==a?a:!1,s=void 0!==s?s:0,u=void 0!==u?u:2*Math.PI;var h,c,l=r/2,p=[],f=[];for(c=0;o>=c;c++){var d=[],m=[],g=c/o,v=g*(t-e)+e;for(h=0;n>=h;h++){var x=h/n,y=new i.Vector3;y.x=v*Math.sin(x*u+s),y.y=-g*r+l,y.z=v*Math.cos(x*u+s),this.vertices.push(y),d.push(this.vertices.length-1),m.push(new i.Vector2(x,1-g))}p.push(d),f.push(m)}var _,b,w=(t-e)/r;for(h=0;n>h;h++)for(0!==e?(_=this.vertices[p[0][h]].clone(),b=this.vertices[p[0][h+1]].clone()):(_=this.vertices[p[1][h]].clone(),b=this.vertices[p[1][h+1]].clone()),_.setY(Math.sqrt(_.x*_.x+_.z*_.z)*w).normalize(),b.setY(Math.sqrt(b.x*b.x+b.z*b.z)*w).normalize(),c=0;o>c;c++){var T=p[c][h],M=p[c+1][h],S=p[c+1][h+1],E=p[c][h+1],C=_.clone(),R=_.clone(),D=b.clone(),A=b.clone(),P=f[c][h].clone(),L=f[c+1][h].clone(),B=f[c+1][h+1].clone(),F=f[c][h+1].clone();this.faces.push(new i.Face3(T,M,E,[C,R,A])),this.faceVertexUvs[0].push([P,L,F]),this.faces.push(new i.Face3(M,S,E,[R.clone(),D,A.clone()])),this.faceVertexUvs[0].push([L.clone(),B,F.clone()])}if(a===!1&&e>0)for(this.vertices.push(new i.Vector3(0,l,0)),h=0;n>h;h++){var T=p[0][h],M=p[0][h+1],S=this.vertices.length-1,C=new i.Vector3(0,1,0),R=new i.Vector3(0,1,0),D=new i.Vector3(0,1,0),P=f[0][h].clone(),L=f[0][h+1].clone(),B=new i.Vector2(L.x,0);this.faces.push(new i.Face3(T,M,S,[C,R,D],void 0,1)),this.faceVertexUvs[0].push([P,L,B])}if(a===!1&&t>0)for(this.vertices.push(new i.Vector3(0,-l,0)),h=0;n>h;h++){var T=p[o][h+1],M=p[o][h],S=this.vertices.length-1,C=new i.Vector3(0,-1,0),R=new i.Vector3(0,-1,0),D=new i.Vector3(0,-1,0),P=f[o][h+1].clone(),L=f[o][h].clone(),B=new i.Vector2(L.x,1);this.faces.push(new i.Face3(T,M,S,[C,R,D],void 0,2)),this.faceVertexUvs[0].push([P,L,B])}this.computeFaceNormals()},i.CylinderGeometry.prototype=Object.create(i.Geometry.prototype),i.CylinderGeometry.prototype.constructor=i.CylinderGeometry,i.CylinderGeometry.prototype.clone=function(){var e=this.parameters;return new i.CylinderGeometry(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)},i.EdgesGeometry=function(e,t){function r(e,t){return e-t}i.BufferGeometry.call(this),t=void 0!==t?t:1;var n,o=Math.cos(i.Math.degToRad(t)),a=[0,0],s={},u=["a","b","c"];e instanceof i.BufferGeometry?(n=new i.Geometry,n.fromBufferGeometry(e)):n=e.clone(),n.mergeVertices(),n.computeFaceNormals();for(var h=n.vertices,c=n.faces,l=0,p=c.length;p>l;l++)for(var f=c[l],d=0;3>d;d++){a[0]=f[u[d]],a[1]=f[u[(d+1)%3]],a.sort(r);var m=a.toString();void 0===s[m]?s[m]={vert1:a[0],vert2:a[1],face1:l,face2:void 0}:s[m].face2=l}var g=[];for(var m in s){var v=s[m];if(void 0===v.face2||c[v.face1].normal.dot(c[v.face2].normal)<=o){var x=h[v.vert1];g.push(x.x),g.push(x.y),g.push(x.z),x=h[v.vert2],g.push(x.x),g.push(x.y),g.push(x.z)}}this.addAttribute("position",new i.BufferAttribute(new Float32Array(g),3))},i.EdgesGeometry.prototype=Object.create(i.BufferGeometry.prototype),i.EdgesGeometry.prototype.constructor=i.EdgesGeometry,i.ExtrudeGeometry=function(e,t){return"undefined"==typeof e?void(e=[]):(i.Geometry.call(this),this.type="ExtrudeGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),void this.computeFaceNormals())},i.ExtrudeGeometry.prototype=Object.create(i.Geometry.prototype),i.ExtrudeGeometry.prototype.constructor=i.ExtrudeGeometry,i.ExtrudeGeometry.prototype.addShapeList=function(e,t){for(var r=e.length,n=0;r>n;n++){var i=e[n];this.addShape(i,t)}},i.ExtrudeGeometry.prototype.addShape=function(e,t){function r(e,t,r){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(r).add(e)}function n(e,t,r){var n,o,a=1,s=e.x-t.x,u=e.y-t.y,h=r.x-e.x,c=r.y-e.y,l=s*s+u*u,p=s*c-u*h;if(Math.abs(p)>Number.EPSILON){var f=Math.sqrt(l),d=Math.sqrt(h*h+c*c),m=t.x-u/f,g=t.y+s/f,v=r.x-c/d,x=r.y+h/d,y=((v-m)*c-(x-g)*h)/(s*c-u*h);n=m+s*y-e.x,o=g+u*y-e.y;var _=n*n+o*o;if(2>=_)return new i.Vector2(n,o);a=Math.sqrt(_/2)}else{var b=!1;s>Number.EPSILON?h>Number.EPSILON&&(b=!0):s<-Number.EPSILON?h<-Number.EPSILON&&(b=!0):Math.sign(u)===Math.sign(c)&&(b=!0),b?(n=-u,o=s,a=Math.sqrt(l)):(n=s,o=u,a=Math.sqrt(l/2))}return new i.Vector2(n/a,o/a)}function o(){if(_){var e=0,t=j*e;for(W=0;H>W;W++)N=G[W],h(N[2]+t,N[1]+t,N[0]+t);for(e=w+2*y,t=j*e,W=0;H>W;W++)N=G[W],h(N[0]+t,N[1]+t,N[2]+t)}else{for(W=0;H>W;W++)N=G[W],h(N[2],N[1],N[0]);for(W=0;H>W;W++)N=G[W],h(N[0]+j*w,N[1]+j*w,N[2]+j*w)}}function a(){var e=0;for(s(U,e),e+=U.length,C=0,R=B.length;R>C;C++)E=B[C],s(E,e),e+=E.length}function s(e,t){var r,n;for(W=e.length;--W>=0;){r=W,n=W-1,0>n&&(n=e.length-1);var i=0,o=w+2*y;for(i=0;o>i;i++){var a=j*i,s=j*(i+1),u=t+r+a,h=t+n+a,l=t+n+s,p=t+r+s;c(u,h,l,p,e,i,o,r,n)}}}function u(e,t,r){D.vertices.push(new i.Vector3(e,t,r))}function h(e,t,r){e+=A,t+=A,r+=A,D.faces.push(new i.Face3(e,t,r,null,null,0));var n=S.generateTopUV(D,e,t,r);D.faceVertexUvs[0].push(n)}function c(e,t,r,n,o,a,s,u,h){e+=A,t+=A,r+=A,n+=A,D.faces.push(new i.Face3(e,t,n,null,null,1)),D.faces.push(new i.Face3(t,r,n,null,null,1));var c=S.generateSideWallUV(D,e,t,r,n);D.faceVertexUvs[0].push([c[0],c[1],c[3]]),D.faceVertexUvs[0].push([c[1],c[2],c[3]])}var l,p,f,d,m,g=void 0!==t.amount?t.amount:100,v=void 0!==t.bevelThickness?t.bevelThickness:6,x=void 0!==t.bevelSize?t.bevelSize:v-2,y=void 0!==t.bevelSegments?t.bevelSegments:3,_=void 0!==t.bevelEnabled?t.bevelEnabled:!0,b=void 0!==t.curveSegments?t.curveSegments:12,w=void 0!==t.steps?t.steps:1,T=t.extrudePath,M=!1,S=void 0!==t.UVGenerator?t.UVGenerator:i.ExtrudeGeometry.WorldUVGenerator;T&&(l=T.getSpacedPoints(w),M=!0,_=!1,p=void 0!==t.frames?t.frames:new i.TubeGeometry.FrenetFrames(T,w,!1),f=new i.Vector3,d=new i.Vector3,m=new i.Vector3),_||(y=0,v=0,x=0);var E,C,R,D=this,A=this.vertices.length,P=e.extractPoints(b),L=P.shape,B=P.holes,F=!i.ShapeUtils.isClockWise(L);if(F){for(L=L.reverse(),C=0,R=B.length;R>C;C++)E=B[C],i.ShapeUtils.isClockWise(E)&&(B[C]=E.reverse());F=!1}var G=i.ShapeUtils.triangulateShape(L,B),U=L;for(C=0,R=B.length;R>C;C++)E=B[C],L=L.concat(E);for(var k,V,I,O,z,N,j=L.length,H=G.length,X=[],W=0,q=U.length,Y=q-1,K=W+1;q>W;W++,Y++,K++)Y===q&&(Y=0),K===q&&(K=0),X[W]=n(U[W],U[Y],U[K]);var Z,Q=[],J=X.concat();for(C=0,R=B.length;R>C;C++){for(E=B[C],Z=[],W=0,q=E.length,Y=q-1,K=W+1;q>W;W++,Y++,K++)Y===q&&(Y=0),K===q&&(K=0),Z[W]=n(E[W],E[Y],E[K]);Q.push(Z),J=J.concat(Z)}for(k=0;y>k;k++){for(I=k/y,O=v*(1-I),V=x*Math.sin(I*Math.PI/2),W=0,q=U.length;q>W;W++)z=r(U[W],X[W],V),u(z.x,z.y,-O);for(C=0,R=B.length;R>C;C++)for(E=B[C],Z=Q[C],W=0,q=E.length;q>W;W++)z=r(E[W],Z[W],V),u(z.x,z.y,-O)}for(V=x,W=0;j>W;W++)z=_?r(L[W],J[W],V):L[W],M?(d.copy(p.normals[0]).multiplyScalar(z.x),f.copy(p.binormals[0]).multiplyScalar(z.y),m.copy(l[0]).add(d).add(f),u(m.x,m.y,m.z)):u(z.x,z.y,0);var $;for($=1;w>=$;$++)for(W=0;j>W;W++)z=_?r(L[W],J[W],V):L[W],M?(d.copy(p.normals[$]).multiplyScalar(z.x),f.copy(p.binormals[$]).multiplyScalar(z.y),m.copy(l[$]).add(d).add(f),u(m.x,m.y,m.z)):u(z.x,z.y,g/w*$);for(k=y-1;k>=0;k--){for(I=k/y,O=v*(1-I),V=x*Math.sin(I*Math.PI/2),W=0,q=U.length;q>W;W++)z=r(U[W],X[W],V),u(z.x,z.y,g+O);for(C=0,R=B.length;R>C;C++)for(E=B[C],Z=Q[C],W=0,q=E.length;q>W;W++)z=r(E[W],Z[W],V),M?u(z.x,z.y+l[w-1].y,l[w-1].x+O):u(z.x,z.y,g+O)}o(),a()},i.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(e,t,r,n){var o=e.vertices,a=o[t],s=o[r],u=o[n];return[new i.Vector2(a.x,a.y),new i.Vector2(s.x,s.y),new i.Vector2(u.x,u.y)]},generateSideWallUV:function(e,t,r,n,o){var a=e.vertices,s=a[t],u=a[r],h=a[n],c=a[o];return Math.abs(s.y-u.y)<.01?[new i.Vector2(s.x,1-s.z),new i.Vector2(u.x,1-u.z),new i.Vector2(h.x,1-h.z),new i.Vector2(c.x,1-c.z)]:[new i.Vector2(s.y,1-s.z),new i.Vector2(u.y,1-u.z),new i.Vector2(h.y,1-h.z),new i.Vector2(c.y,1-c.z)]}},i.ShapeGeometry=function(e,t){i.Geometry.call(this),this.type="ShapeGeometry",Array.isArray(e)===!1&&(e=[e]),this.addShapeList(e,t),this.computeFaceNormals()},i.ShapeGeometry.prototype=Object.create(i.Geometry.prototype),i.ShapeGeometry.prototype.constructor=i.ShapeGeometry,i.ShapeGeometry.prototype.addShapeList=function(e,t){for(var r=0,n=e.length;n>r;r++)this.addShape(e[r],t);return this},i.ShapeGeometry.prototype.addShape=function(e,t){void 0===t&&(t={});var r,n,o,a=void 0!==t.curveSegments?t.curveSegments:12,s=t.material,u=void 0===t.UVGenerator?i.ExtrudeGeometry.WorldUVGenerator:t.UVGenerator,h=this.vertices.length,c=e.extractPoints(a),l=c.shape,p=c.holes,f=!i.ShapeUtils.isClockWise(l);if(f){for(l=l.reverse(),r=0,n=p.length;n>r;r++)o=p[r],i.ShapeUtils.isClockWise(o)&&(p[r]=o.reverse());f=!1}var d=i.ShapeUtils.triangulateShape(l,p);for(r=0,n=p.length;n>r;r++)o=p[r],l=l.concat(o);var m,g,v=l.length,x=d.length;for(r=0;v>r;r++)m=l[r],this.vertices.push(new i.Vector3(m.x,m.y,0));for(r=0;x>r;r++){g=d[r];var y=g[0]+h,_=g[1]+h,b=g[2]+h;this.faces.push(new i.Face3(y,_,b,null,null,s)),this.faceVertexUvs[0].push(u.generateTopUV(this,y,_,b))}},i.LatheGeometry=function(e,t,r,n){i.Geometry.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:n},t=t||12,r=r||0,n=n||2*Math.PI;for(var o=1/(e.length-1),a=1/t,s=0,u=t;u>=s;s++)for(var h=r+s*a*n,c=Math.cos(h),l=Math.sin(h),p=0,f=e.length;f>p;p++){var d=e[p],m=new i.Vector3;m.x=c*d.x-l*d.y,m.y=l*d.x+c*d.y,m.z=d.z,this.vertices.push(m)}for(var g=e.length,s=0,u=t;u>s;s++)for(var p=0,f=e.length-1;f>p;p++){var v=p+g*s,x=v,y=v+g,c=v+1+g,_=v+1,b=s*a,w=p*o,T=b+a,M=w+o;this.faces.push(new i.Face3(x,y,_)),this.faceVertexUvs[0].push([new i.Vector2(b,w),new i.Vector2(T,w),new i.Vector2(b,M)]),this.faces.push(new i.Face3(y,c,_)),this.faceVertexUvs[0].push([new i.Vector2(T,w),new i.Vector2(T,M),new i.Vector2(b,M)])}this.mergeVertices(),this.computeFaceNormals(),this.computeVertexNormals()},i.LatheGeometry.prototype=Object.create(i.Geometry.prototype),i.LatheGeometry.prototype.constructor=i.LatheGeometry,i.PlaneGeometry=function(e,t,r,n){i.Geometry.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:n},this.fromBufferGeometry(new i.PlaneBufferGeometry(e,t,r,n))},i.PlaneGeometry.prototype=Object.create(i.Geometry.prototype),i.PlaneGeometry.prototype.constructor=i.PlaneGeometry,i.PlaneGeometry.prototype.clone=function(){var e=this.parameters;return new i.PlaneGeometry(e.width,e.height,e.widthSegments,e.heightSegments)},i.PlaneBufferGeometry=function(e,t,r,n){i.BufferGeometry.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:n};for(var o=e/2,a=t/2,s=Math.floor(r)||1,u=Math.floor(n)||1,h=s+1,c=u+1,l=e/s,p=t/u,f=new Float32Array(h*c*3),d=new Float32Array(h*c*3),m=new Float32Array(h*c*2),g=0,v=0,x=0;c>x;x++)for(var y=x*p-a,_=0;h>_;_++){var b=_*l-o;f[g]=b,f[g+1]=-y,d[g+2]=1,m[v]=_/s,m[v+1]=1-x/u,g+=3,v+=2}g=0;for(var w=new(f.length/3>65535?Uint32Array:Uint16Array)(s*u*6),x=0;u>x;x++)for(var _=0;s>_;_++){var T=_+h*x,M=_+h*(x+1),S=_+1+h*(x+1),E=_+1+h*x;w[g]=T,w[g+1]=M,w[g+2]=E,w[g+3]=M,w[g+4]=S,w[g+5]=E,g+=6}this.setIndex(new i.BufferAttribute(w,1)),this.addAttribute("position",new i.BufferAttribute(f,3)),this.addAttribute("normal",new i.BufferAttribute(d,3)),this.addAttribute("uv",new i.BufferAttribute(m,2))},i.PlaneBufferGeometry.prototype=Object.create(i.BufferGeometry.prototype),i.PlaneBufferGeometry.prototype.constructor=i.PlaneBufferGeometry,i.PlaneBufferGeometry.prototype.clone=function(){var e=this.parameters;return new i.PlaneBufferGeometry(e.width,e.height,e.widthSegments,e.heightSegments)},i.RingGeometry=function(e,t,r,n,o,a){i.Geometry.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:n,thetaStart:o,thetaLength:a},e=e||0,t=t||50,o=void 0!==o?o:0,a=void 0!==a?a:2*Math.PI,r=void 0!==r?Math.max(3,r):8,n=void 0!==n?Math.max(1,n):8;var s,u,h=[],c=e,l=(t-e)/n;for(s=0;n+1>s;s++){for(u=0;r+1>u;u++){var p=new i.Vector3,f=o+u/r*a;p.x=c*Math.cos(f),p.y=c*Math.sin(f),this.vertices.push(p),h.push(new i.Vector2((p.x/t+1)/2,(p.y/t+1)/2))}c+=l}var d=new i.Vector3(0,0,1);for(s=0;n>s;s++){var m=s*(r+1);for(u=0;r>u;u++){var f=u+m,g=f,v=f+r+1,x=f+r+2;this.faces.push(new i.Face3(g,v,x,[d.clone(),d.clone(),d.clone()])),this.faceVertexUvs[0].push([h[g].clone(),h[v].clone(),h[x].clone()]),g=f,v=f+r+2,x=f+1,this.faces.push(new i.Face3(g,v,x,[d.clone(),d.clone(),d.clone()])),this.faceVertexUvs[0].push([h[g].clone(),h[v].clone(),h[x].clone()])}}this.computeFaceNormals(),this.boundingSphere=new i.Sphere(new i.Vector3,c)},i.RingGeometry.prototype=Object.create(i.Geometry.prototype),i.RingGeometry.prototype.constructor=i.RingGeometry,i.RingGeometry.prototype.clone=function(){var e=this.parameters;return new i.RingGeometry(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength)},i.SphereGeometry=function(e,t,r,n,o,a,s){i.Geometry.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:n,phiLength:o,thetaStart:a,thetaLength:s},this.fromBufferGeometry(new i.SphereBufferGeometry(e,t,r,n,o,a,s))},i.SphereGeometry.prototype=Object.create(i.Geometry.prototype),i.SphereGeometry.prototype.constructor=i.SphereGeometry,i.SphereGeometry.prototype.clone=function(){var e=this.parameters;return new i.SphereGeometry(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)},i.SphereBufferGeometry=function(e,t,r,n,o,a,s){i.BufferGeometry.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:n,phiLength:o,thetaStart:a,thetaLength:s},e=e||50,t=Math.max(3,Math.floor(t)||8),r=Math.max(2,Math.floor(r)||6),n=void 0!==n?n:0,o=void 0!==o?o:2*Math.PI,a=void 0!==a?a:0,s=void 0!==s?s:Math.PI;for(var u=a+s,h=(t+1)*(r+1),c=new i.BufferAttribute(new Float32Array(3*h),3),l=new i.BufferAttribute(new Float32Array(3*h),3),p=new i.BufferAttribute(new Float32Array(2*h),2),f=0,d=[],m=new i.Vector3,g=0;r>=g;g++){for(var v=[],x=g/r,y=0;t>=y;y++){var _=y/t,b=-e*Math.cos(n+_*o)*Math.sin(a+x*s),w=e*Math.cos(a+x*s),T=e*Math.sin(n+_*o)*Math.sin(a+x*s);m.set(b,w,T).normalize(),c.setXYZ(f,b,w,T),l.setXYZ(f,m.x,m.y,m.z),p.setXY(f,_,1-x),v.push(f),f++}d.push(v)}for(var M=[],g=0;r>g;g++)for(var y=0;t>y;y++){var S=d[g][y+1],E=d[g][y],C=d[g+1][y],R=d[g+1][y+1];(0!==g||a>0)&&M.push(S,E,R),(g!==r-1||u<Math.PI)&&M.push(E,C,R)}this.setIndex(new(c.count>65535?i.Uint32Attribute:i.Uint16Attribute)(M,1)),this.addAttribute("position",c),this.addAttribute("normal",l),this.addAttribute("uv",p),this.boundingSphere=new i.Sphere(new i.Vector3,e)},i.SphereBufferGeometry.prototype=Object.create(i.BufferGeometry.prototype),i.SphereBufferGeometry.prototype.constructor=i.SphereBufferGeometry,i.SphereBufferGeometry.prototype.clone=function(){var e=this.parameters;return new i.SphereBufferGeometry(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)},i.TorusGeometry=function(e,t,r,n,o){i.Geometry.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:n,arc:o},e=e||100,t=t||40,r=r||8,n=n||6,o=o||2*Math.PI;for(var a=new i.Vector3,s=[],u=[],h=0;r>=h;h++)for(var c=0;n>=c;c++){var l=c/n*o,p=h/r*Math.PI*2;a.x=e*Math.cos(l),a.y=e*Math.sin(l);var f=new i.Vector3;f.x=(e+t*Math.cos(p))*Math.cos(l),f.y=(e+t*Math.cos(p))*Math.sin(l),f.z=t*Math.sin(p),this.vertices.push(f),s.push(new i.Vector2(c/n,h/r)),u.push(f.clone().sub(a).normalize())}for(var h=1;r>=h;h++)for(var c=1;n>=c;c++){var d=(n+1)*h+c-1,m=(n+1)*(h-1)+c-1,g=(n+1)*(h-1)+c,v=(n+1)*h+c,x=new i.Face3(d,m,v,[u[d].clone(),u[m].clone(),u[v].clone()]);this.faces.push(x),this.faceVertexUvs[0].push([s[d].clone(),s[m].clone(),s[v].clone()]),x=new i.Face3(m,g,v,[u[m].clone(),u[g].clone(),u[v].clone()]),this.faces.push(x),this.faceVertexUvs[0].push([s[m].clone(),s[g].clone(),s[v].clone()])}this.computeFaceNormals()},i.TorusGeometry.prototype=Object.create(i.Geometry.prototype),i.TorusGeometry.prototype.constructor=i.TorusGeometry,i.TorusGeometry.prototype.clone=function(){var e=this.parameters;return new i.TorusGeometry(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)},i.TorusKnotGeometry=function(e,t,r,n,o,a,s){function u(e,t,r,n,o){var a=Math.cos(e),s=Math.sin(e),u=t/r*e,h=Math.cos(u),c=n*(2+h)*.5*a,l=n*(2+h)*s*.5,p=o*n*Math.sin(u)*.5;return new i.Vector3(c,l,p)}i.Geometry.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:n,p:o,q:a,heightScale:s},e=e||100,t=t||40,r=r||64,n=n||8,o=o||2,a=a||3,s=s||1;for(var h=new Array(r),c=new i.Vector3,l=new i.Vector3,p=new i.Vector3,f=0;r>f;++f){h[f]=new Array(n);var d=f/r*2*o*Math.PI,m=u(d,a,o,e,s),g=u(d+.01,a,o,e,s);c.subVectors(g,m),l.addVectors(g,m),p.crossVectors(c,l),l.crossVectors(p,c),p.normalize(),l.normalize();for(var v=0;n>v;++v){var x=v/n*2*Math.PI,y=-t*Math.cos(x),_=t*Math.sin(x),b=new i.Vector3;b.x=m.x+y*l.x+_*p.x,b.y=m.y+y*l.y+_*p.y,b.z=m.z+y*l.z+_*p.z,h[f][v]=this.vertices.push(b)-1}}for(var f=0;r>f;++f)for(var v=0;n>v;++v){var w=(f+1)%r,T=(v+1)%n,M=h[f][v],S=h[w][v],E=h[w][T],C=h[f][T],R=new i.Vector2(f/r,v/n),D=new i.Vector2((f+1)/r,v/n),A=new i.Vector2((f+1)/r,(v+1)/n),P=new i.Vector2(f/r,(v+1)/n);this.faces.push(new i.Face3(M,S,C)),this.faceVertexUvs[0].push([R,D,P]),this.faces.push(new i.Face3(S,E,C)),this.faceVertexUvs[0].push([D.clone(),A,P.clone()])}this.computeFaceNormals(),this.computeVertexNormals()},i.TorusKnotGeometry.prototype=Object.create(i.Geometry.prototype),i.TorusKnotGeometry.prototype.constructor=i.TorusKnotGeometry,i.TorusKnotGeometry.prototype.clone=function(){var e=this.parameters;return new i.TorusKnotGeometry(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.p,e.q,e.heightScale)},i.TubeGeometry=function(e,t,r,n,o,a){function s(e,t,r){return A.vertices.push(new i.Vector3(e,t,r))-1}i.Geometry.call(this),this.type="TubeGeometry",this.parameters={path:e,segments:t,radius:r,radialSegments:n,closed:o,taper:a},t=t||64,r=r||1,n=n||8,o=o||!1,a=a||i.TubeGeometry.NoTaper;var u,h,c,l,p,f,d,m,g,v,x,y,_,b,w,T,M,S,E,C,R,D=[],A=this,P=t+1,L=new i.Vector3,B=new i.TubeGeometry.FrenetFrames(e,t,o),F=B.tangents,G=B.normals,U=B.binormals;for(this.tangents=F,this.normals=G,this.binormals=U,v=0;P>v;v++)for(D[v]=[],l=v/(P-1),g=e.getPointAt(l),u=F[v],h=G[v],c=U[v],f=r*a(l),x=0;n>x;x++)p=x/n*2*Math.PI,d=-f*Math.cos(p),m=f*Math.sin(p),L.copy(g),L.x+=d*h.x+m*c.x,L.y+=d*h.y+m*c.y,L.z+=d*h.z+m*c.z,D[v][x]=s(L.x,L.y,L.z);for(v=0;t>v;v++)for(x=0;n>x;x++)y=o?(v+1)%t:v+1,_=(x+1)%n,b=D[v][x],w=D[y][x],T=D[y][_],M=D[v][_],S=new i.Vector2(v/t,x/n),E=new i.Vector2((v+1)/t,x/n),C=new i.Vector2((v+1)/t,(x+1)/n),R=new i.Vector2(v/t,(x+1)/n),this.faces.push(new i.Face3(b,w,M)),this.faceVertexUvs[0].push([S,E,R]),this.faces.push(new i.Face3(w,T,M)),this.faceVertexUvs[0].push([E.clone(),C,R.clone()]);this.computeFaceNormals(),this.computeVertexNormals()},i.TubeGeometry.prototype=Object.create(i.Geometry.prototype),i.TubeGeometry.prototype.constructor=i.TubeGeometry,i.TubeGeometry.prototype.clone=function(){return new this.constructor(this.parameters.path,this.parameters.segments,this.parameters.radius,this.parameters.radialSegments,this.parameters.closed,this.parameters.taper)},i.TubeGeometry.NoTaper=function(e){return 1},i.TubeGeometry.SinusoidalTaper=function(e){return Math.sin(Math.PI*e)},i.TubeGeometry.FrenetFrames=function(e,t,r){function n(){d[0]=new i.Vector3,m[0]=new i.Vector3,a=Number.MAX_VALUE,s=Math.abs(f[0].x),u=Math.abs(f[0].y),h=Math.abs(f[0].z),a>=s&&(a=s,p.set(1,0,0)),a>=u&&(a=u,p.set(0,1,0)),a>=h&&p.set(0,0,1),g.crossVectors(f[0],p).normalize(),d[0].crossVectors(f[0],g),m[0].crossVectors(f[0],d[0])}var o,a,s,u,h,c,l,p=new i.Vector3,f=[],d=[],m=[],g=new i.Vector3,v=new i.Matrix4,x=t+1;for(this.tangents=f,this.normals=d,this.binormals=m,c=0;x>c;c++)l=c/(x-1),f[c]=e.getTangentAt(l),f[c].normalize();for(n(),c=1;x>c;c++)d[c]=d[c-1].clone(),m[c]=m[c-1].clone(),g.crossVectors(f[c-1],f[c]),g.length()>Number.EPSILON&&(g.normalize(),o=Math.acos(i.Math.clamp(f[c-1].dot(f[c]),-1,1)),d[c].applyMatrix4(v.makeRotationAxis(g,o))),m[c].crossVectors(f[c],d[c]);if(r)for(o=Math.acos(i.Math.clamp(d[0].dot(d[x-1]),-1,1)),o/=x-1,f[0].dot(g.crossVectors(d[0],d[x-1]))>0&&(o=-o),c=1;x>c;c++)d[c].applyMatrix4(v.makeRotationAxis(f[c],o*c)),m[c].crossVectors(f[c],d[c])},i.PolyhedronGeometry=function(e,t,r,n){function o(e){var t=e.normalize().clone();t.index=l.vertices.push(t)-1;var r=u(e)/2/Math.PI+.5,n=h(e)/Math.PI+.5;return t.uv=new i.Vector2(r,1-n),t}function a(e,t,r,n){var o=new i.Face3(e.index,t.index,r.index,[e.clone(),t.clone(),r.clone()],void 0,n);l.faces.push(o),_.copy(e).add(t).add(r).divideScalar(3);var a=u(_);l.faceVertexUvs[0].push([c(e.uv,e,a),c(t.uv,t,a),c(r.uv,r,a)])}function s(e,t){for(var r=Math.pow(2,t),n=o(l.vertices[e.a]),i=o(l.vertices[e.b]),s=o(l.vertices[e.c]),u=[],h=e.materialIndex,c=0;r>=c;c++){u[c]=[];for(var p=o(n.clone().lerp(s,c/r)),f=o(i.clone().lerp(s,c/r)),d=r-c,m=0;d>=m;m++)0===m&&c===r?u[c][m]=p:u[c][m]=o(p.clone().lerp(f,m/d))}for(var c=0;r>c;c++)for(var m=0;2*(r-c)-1>m;m++){var g=Math.floor(m/2);m%2===0?a(u[c][g+1],u[c+1][g],u[c][g],h):a(u[c][g+1],u[c+1][g+1],u[c+1][g],h)}}function u(e){return Math.atan2(e.z,-e.x)}function h(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}function c(e,t,r){return 0>r&&1===e.x&&(e=new i.Vector2(e.x-1,e.y)),0===t.x&&0===t.z&&(e=new i.Vector2(r/2/Math.PI+.5,e.y)),e.clone()}i.Geometry.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:n},r=r||1,n=n||0;for(var l=this,p=0,f=e.length;f>p;p+=3)o(new i.Vector3(e[p],e[p+1],e[p+2]));for(var d=this.vertices,m=[],p=0,g=0,f=t.length;f>p;p+=3,g++){var v=d[t[p]],x=d[t[p+1]],y=d[t[p+2]];m[g]=new i.Face3(v.index,x.index,y.index,[v.clone(),x.clone(),y.clone()],void 0,g)}for(var _=new i.Vector3,p=0,f=m.length;f>p;p++)s(m[p],n);for(var p=0,f=this.faceVertexUvs[0].length;f>p;p++){var b=this.faceVertexUvs[0][p],w=b[0].x,T=b[1].x,M=b[2].x,S=Math.max(w,T,M),E=Math.min(w,T,M);S>.9&&.1>E&&(.2>w&&(b[0].x+=1),.2>T&&(b[1].x+=1),.2>M&&(b[2].x+=1))}for(var p=0,f=this.vertices.length;f>p;p++)this.vertices[p].multiplyScalar(r);this.mergeVertices(),this.computeFaceNormals(),this.boundingSphere=new i.Sphere(new i.Vector3,r)},i.PolyhedronGeometry.prototype=Object.create(i.Geometry.prototype),i.PolyhedronGeometry.prototype.constructor=i.PolyhedronGeometry,i.PolyhedronGeometry.prototype.clone=function(){var e=this.parameters;return new i.PolyhedronGeometry(e.vertices,e.indices,e.radius,e.detail)},i.DodecahedronGeometry=function(e,t){var r=(1+Math.sqrt(5))/2,n=1/r,o=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-r,0,-n,r,0,n,-r,0,n,r,-n,-r,0,-n,r,0,n,-r,0,n,r,0,-r,0,-n,r,0,-n,-r,0,n,r,0,n],a=[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9];i.PolyhedronGeometry.call(this,o,a,e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}},i.DodecahedronGeometry.prototype=Object.create(i.PolyhedronGeometry.prototype),i.DodecahedronGeometry.prototype.constructor=i.DodecahedronGeometry,i.DodecahedronGeometry.prototype.clone=function(){var e=this.parameters;return new i.DodecahedronGeometry(e.radius,e.detail)},i.IcosahedronGeometry=function(e,t){var r=(1+Math.sqrt(5))/2,n=[-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1],o=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];i.PolyhedronGeometry.call(this,n,o,e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}},i.IcosahedronGeometry.prototype=Object.create(i.PolyhedronGeometry.prototype),i.IcosahedronGeometry.prototype.constructor=i.IcosahedronGeometry,i.IcosahedronGeometry.prototype.clone=function(){var e=this.parameters;return new i.IcosahedronGeometry(e.radius,e.detail)},i.OctahedronGeometry=function(e,t){var r=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],n=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2];i.PolyhedronGeometry.call(this,r,n,e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}},i.OctahedronGeometry.prototype=Object.create(i.PolyhedronGeometry.prototype),i.OctahedronGeometry.prototype.constructor=i.OctahedronGeometry,i.OctahedronGeometry.prototype.clone=function(){var e=this.parameters;return new i.OctahedronGeometry(e.radius,e.detail)},i.TetrahedronGeometry=function(e,t){var r=[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],n=[2,1,0,0,3,2,1,3,0,2,3,1];i.PolyhedronGeometry.call(this,r,n,e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}},i.TetrahedronGeometry.prototype=Object.create(i.PolyhedronGeometry.prototype),i.TetrahedronGeometry.prototype.constructor=i.TetrahedronGeometry,i.TetrahedronGeometry.prototype.clone=function(){var e=this.parameters;return new i.TetrahedronGeometry(e.radius,e.detail)},i.ParametricGeometry=function(e,t,r){i.Geometry.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:r};var n,o,a,s,u,h=this.vertices,c=this.faces,l=this.faceVertexUvs[0],p=t+1;for(n=0;r>=n;n++)for(u=n/r,o=0;t>=o;o++)s=o/t,a=e(s,u),h.push(a);var f,d,m,g,v,x,y,_;for(n=0;r>n;n++)for(o=0;t>o;o++)f=n*p+o,d=n*p+o+1,m=(n+1)*p+o+1,g=(n+1)*p+o,v=new i.Vector2(o/t,n/r),x=new i.Vector2((o+1)/t,n/r),y=new i.Vector2((o+1)/t,(n+1)/r),_=new i.Vector2(o/t,(n+1)/r),c.push(new i.Face3(f,d,g)),l.push([v,x,_]),c.push(new i.Face3(d,m,g)),l.push([x.clone(),y,_.clone()]);this.computeFaceNormals(),this.computeVertexNormals()},i.ParametricGeometry.prototype=Object.create(i.Geometry.prototype),i.ParametricGeometry.prototype.constructor=i.ParametricGeometry,i.WireframeGeometry=function(e){function t(e,t){return e-t}i.BufferGeometry.call(this);var r=[0,0],n={},o=["a","b","c"];if(e instanceof i.Geometry){for(var a=e.vertices,s=e.faces,u=0,h=new Uint32Array(6*s.length),c=0,l=s.length;l>c;c++)for(var p=s[c],f=0;3>f;f++){r[0]=p[o[f]],r[1]=p[o[(f+1)%3]],r.sort(t);var d=r.toString();void 0===n[d]&&(h[2*u]=r[0],h[2*u+1]=r[1],n[d]=!0,u++)}for(var m=new Float32Array(2*u*3),c=0,l=u;l>c;c++)for(var f=0;2>f;f++){var g=a[h[2*c+f]],v=6*c+3*f;m[v+0]=g.x,m[v+1]=g.y,m[v+2]=g.z}this.addAttribute("position",new i.BufferAttribute(m,3))}else if(e instanceof i.BufferGeometry)if(null!==e.index){var x=e.index.array,a=e.attributes.position,y=e.drawcalls,u=0;0===y.length&&e.addGroup(0,x.length);for(var h=new Uint32Array(2*x.length),_=0,b=y.length;b>_;++_)for(var w=y[_],T=w.start,M=w.count,c=T,S=T+M;S>c;c+=3)for(var f=0;3>f;f++){r[0]=x[c+f],r[1]=x[c+(f+1)%3],r.sort(t);var d=r.toString();void 0===n[d]&&(h[2*u]=r[0],h[2*u+1]=r[1],n[d]=!0,u++)}for(var m=new Float32Array(2*u*3),c=0,l=u;l>c;c++)for(var f=0;2>f;f++){var v=6*c+3*f,E=h[2*c+f];m[v+0]=a.getX(E),m[v+1]=a.getY(E),m[v+2]=a.getZ(E)}this.addAttribute("position",new i.BufferAttribute(m,3))}else{for(var a=e.attributes.position.array,u=a.length/3,C=u/3,m=new Float32Array(2*u*3),c=0,l=C;l>c;c++)for(var f=0;3>f;f++){var v=18*c+6*f,R=9*c+3*f;m[v+0]=a[R],m[v+1]=a[R+1],m[v+2]=a[R+2];var E=9*c+3*((f+1)%3);m[v+3]=a[E],m[v+4]=a[E+1],m[v+5]=a[E+2]}this.addAttribute("position",new i.BufferAttribute(m,3))}},i.WireframeGeometry.prototype=Object.create(i.BufferGeometry.prototype),i.WireframeGeometry.prototype.constructor=i.WireframeGeometry,i.AxisHelper=function(e){e=e||1;var t=new Float32Array([0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e]),r=new Float32Array([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1]),n=new i.BufferGeometry;n.addAttribute("position",new i.BufferAttribute(t,3)),n.addAttribute("color",new i.BufferAttribute(r,3));var o=new i.LineBasicMaterial({vertexColors:i.VertexColors});i.LineSegments.call(this,n,o)},i.AxisHelper.prototype=Object.create(i.LineSegments.prototype),
i.AxisHelper.prototype.constructor=i.AxisHelper,i.ArrowHelper=function(){var e=new i.Geometry;e.vertices.push(new i.Vector3(0,0,0),new i.Vector3(0,1,0));var t=new i.CylinderGeometry(0,.5,1,5,1);return t.translate(0,-.5,0),function(r,n,o,a,s,u){i.Object3D.call(this),void 0===a&&(a=16776960),void 0===o&&(o=1),void 0===s&&(s=.2*o),void 0===u&&(u=.2*s),this.position.copy(n),o>s&&(this.line=new i.Line(e,new i.LineBasicMaterial({color:a})),this.line.matrixAutoUpdate=!1,this.add(this.line)),this.cone=new i.Mesh(t,new i.MeshBasicMaterial({color:a})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(r),this.setLength(o,s,u)}}(),i.ArrowHelper.prototype=Object.create(i.Object3D.prototype),i.ArrowHelper.prototype.constructor=i.ArrowHelper,i.ArrowHelper.prototype.setDirection=function(){var e,t=new i.Vector3;return function(r){r.y>.99999?this.quaternion.set(0,0,0,1):r.y<-.99999?this.quaternion.set(1,0,0,0):(t.set(r.z,0,-r.x).normalize(),e=Math.acos(r.y),this.quaternion.setFromAxisAngle(t,e))}}(),i.ArrowHelper.prototype.setLength=function(e,t,r){void 0===t&&(t=.2*e),void 0===r&&(r=.2*t),e>t&&(this.line.scale.set(1,e-t,1),this.line.updateMatrix()),this.cone.scale.set(r,t,r),this.cone.position.y=e,this.cone.updateMatrix()},i.ArrowHelper.prototype.setColor=function(e){void 0!==this.line&&this.line.material.color.set(e),this.cone.material.color.set(e)},i.BoxHelper=function(e){var t=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new Float32Array(24),n=new i.BufferGeometry;n.setIndex(new i.BufferAttribute(t,1)),n.addAttribute("position",new i.BufferAttribute(r,3)),i.LineSegments.call(this,n,new i.LineBasicMaterial({color:16776960})),void 0!==e&&this.update(e)},i.BoxHelper.prototype=Object.create(i.LineSegments.prototype),i.BoxHelper.prototype.constructor=i.BoxHelper,i.BoxHelper.prototype.update=function(){var e=new i.Box3;return function(t){if(e.setFromObject(t),!e.empty()){var r=e.min,n=e.max,i=this.geometry.attributes.position,o=i.array;o[0]=n.x,o[1]=n.y,o[2]=n.z,o[3]=r.x,o[4]=n.y,o[5]=n.z,o[6]=r.x,o[7]=r.y,o[8]=n.z,o[9]=n.x,o[10]=r.y,o[11]=n.z,o[12]=n.x,o[13]=n.y,o[14]=r.z,o[15]=r.x,o[16]=n.y,o[17]=r.z,o[18]=r.x,o[19]=r.y,o[20]=r.z,o[21]=n.x,o[22]=r.y,o[23]=r.z,i.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),i.BoundingBoxHelper=function(e,t){var r=void 0!==t?t:8947848;this.object=e,this.box=new i.Box3,i.Mesh.call(this,new i.BoxGeometry(1,1,1),new i.MeshBasicMaterial({color:r,wireframe:!0}))},i.BoundingBoxHelper.prototype=Object.create(i.Mesh.prototype),i.BoundingBoxHelper.prototype.constructor=i.BoundingBoxHelper,i.BoundingBoxHelper.prototype.update=function(){this.box.setFromObject(this.object),this.box.size(this.scale),this.box.center(this.position)},i.CameraHelper=function(e){function t(e,t,n){r(e,n),r(t,n)}function r(e,t){n.vertices.push(new i.Vector3),n.colors.push(new i.Color(t)),void 0===a[e]&&(a[e]=[]),a[e].push(n.vertices.length-1)}var n=new i.Geometry,o=new i.LineBasicMaterial({color:16777215,vertexColors:i.FaceColors}),a={},s=16755200,u=16711680,h=43775,c=16777215,l=3355443;t("n1","n2",s),t("n2","n4",s),t("n4","n3",s),t("n3","n1",s),t("f1","f2",s),t("f2","f4",s),t("f4","f3",s),t("f3","f1",s),t("n1","f1",s),t("n2","f2",s),t("n3","f3",s),t("n4","f4",s),t("p","n1",u),t("p","n2",u),t("p","n3",u),t("p","n4",u),t("u1","u2",h),t("u2","u3",h),t("u3","u1",h),t("c","t",c),t("p","c",l),t("cn1","cn2",l),t("cn3","cn4",l),t("cf1","cf2",l),t("cf3","cf4",l),i.LineSegments.call(this,n,o),this.camera=e,this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=a,this.update()},i.CameraHelper.prototype=Object.create(i.LineSegments.prototype),i.CameraHelper.prototype.constructor=i.CameraHelper,i.CameraHelper.prototype.update=function(){function e(e,i,a,s){n.set(i,a,s).unproject(o);var u=r[e];if(void 0!==u)for(var h=0,c=u.length;c>h;h++)t.vertices[u[h]].copy(n)}var t,r,n=new i.Vector3,o=new i.Camera;return function(){t=this.geometry,r=this.pointMap;var n=1,i=1;o.projectionMatrix.copy(this.camera.projectionMatrix),e("c",0,0,-1),e("t",0,0,1),e("n1",-n,-i,-1),e("n2",n,-i,-1),e("n3",-n,i,-1),e("n4",n,i,-1),e("f1",-n,-i,1),e("f2",n,-i,1),e("f3",-n,i,1),e("f4",n,i,1),e("u1",.7*n,1.1*i,-1),e("u2",.7*-n,1.1*i,-1),e("u3",0,2*i,-1),e("cf1",-n,0,1),e("cf2",n,0,1),e("cf3",0,-i,1),e("cf4",0,i,1),e("cn1",-n,0,-1),e("cn2",n,0,-1),e("cn3",0,-i,-1),e("cn4",0,i,-1),t.verticesNeedUpdate=!0}}(),i.DirectionalLightHelper=function(e,t){i.Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,t=t||1;var r=new i.Geometry;r.vertices.push(new i.Vector3(-t,t,0),new i.Vector3(t,t,0),new i.Vector3(t,-t,0),new i.Vector3(-t,-t,0),new i.Vector3(-t,t,0));var n=new i.LineBasicMaterial({fog:!1});n.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.lightPlane=new i.Line(r,n),this.add(this.lightPlane),r=new i.Geometry,r.vertices.push(new i.Vector3,new i.Vector3),n=new i.LineBasicMaterial({fog:!1}),n.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.targetLine=new i.Line(r,n),this.add(this.targetLine),this.update()},i.DirectionalLightHelper.prototype=Object.create(i.Object3D.prototype),i.DirectionalLightHelper.prototype.constructor=i.DirectionalLightHelper,i.DirectionalLightHelper.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},i.DirectionalLightHelper.prototype.update=function(){var e=new i.Vector3,t=new i.Vector3,r=new i.Vector3;return function(){e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),r.subVectors(t,e),this.lightPlane.lookAt(r),this.lightPlane.material.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.targetLine.geometry.vertices[1].copy(r),this.targetLine.geometry.verticesNeedUpdate=!0,this.targetLine.material.color.copy(this.lightPlane.material.color)}}(),i.EdgesHelper=function(e,t,r){var n=void 0!==t?t:16777215;i.LineSegments.call(this,new i.EdgesGeometry(e.geometry,r),new i.LineBasicMaterial({color:n})),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1},i.EdgesHelper.prototype=Object.create(i.LineSegments.prototype),i.EdgesHelper.prototype.constructor=i.EdgesHelper,i.FaceNormalsHelper=function(e,t,r,n){this.object=e,this.size=void 0!==t?t:1;var o=void 0!==r?r:16776960,a=void 0!==n?n:1,s=0,u=this.object.geometry;u instanceof i.Geometry?s=u.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var h=new i.BufferGeometry,c=new i.Float32Attribute(2*s*3,3);h.addAttribute("position",c),i.LineSegments.call(this,h,new i.LineBasicMaterial({color:o,linewidth:a})),this.matrixAutoUpdate=!1,this.update()},i.FaceNormalsHelper.prototype=Object.create(i.LineSegments.prototype),i.FaceNormalsHelper.prototype.constructor=i.FaceNormalsHelper,i.FaceNormalsHelper.prototype.update=function(){var e=new i.Vector3,t=new i.Vector3,r=new i.Matrix3;return function(){this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);for(var n=this.object.matrixWorld,i=this.geometry.attributes.position,o=this.object.geometry,a=o.vertices,s=o.faces,u=0,h=0,c=s.length;c>h;h++){var l=s[h],p=l.normal;e.copy(a[l.a]).add(a[l.b]).add(a[l.c]).divideScalar(3).applyMatrix4(n),t.copy(p).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),i.setXYZ(u,e.x,e.y,e.z),u+=1,i.setXYZ(u,t.x,t.y,t.z),u+=1}return i.needsUpdate=!0,this}}(),i.GridHelper=function(e,t){var r=new i.Geometry,n=new i.LineBasicMaterial({vertexColors:i.VertexColors});this.color1=new i.Color(4473924),this.color2=new i.Color(8947848);for(var o=-e;e>=o;o+=t){r.vertices.push(new i.Vector3(-e,0,o),new i.Vector3(e,0,o),new i.Vector3(o,0,-e),new i.Vector3(o,0,e));var a=0===o?this.color1:this.color2;r.colors.push(a,a,a,a)}i.LineSegments.call(this,r,n)},i.GridHelper.prototype=Object.create(i.LineSegments.prototype),i.GridHelper.prototype.constructor=i.GridHelper,i.GridHelper.prototype.setColors=function(e,t){this.color1.set(e),this.color2.set(t),this.geometry.colorsNeedUpdate=!0},i.HemisphereLightHelper=function(e,t){i.Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.colors=[new i.Color,new i.Color];var r=new i.SphereGeometry(t,4,2);r.rotateX(-Math.PI/2);for(var n=0,o=8;o>n;n++)r.faces[n].color=this.colors[4>n?0:1];var a=new i.MeshBasicMaterial({vertexColors:i.FaceColors,wireframe:!0});this.lightSphere=new i.Mesh(r,a),this.add(this.lightSphere),this.update()},i.HemisphereLightHelper.prototype=Object.create(i.Object3D.prototype),i.HemisphereLightHelper.prototype.constructor=i.HemisphereLightHelper,i.HemisphereLightHelper.prototype.dispose=function(){this.lightSphere.geometry.dispose(),this.lightSphere.material.dispose()},i.HemisphereLightHelper.prototype.update=function(){var e=new i.Vector3;return function(){this.colors[0].copy(this.light.color).multiplyScalar(this.light.intensity),this.colors[1].copy(this.light.groundColor).multiplyScalar(this.light.intensity),this.lightSphere.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate()),this.lightSphere.geometry.colorsNeedUpdate=!0}}(),i.PointLightHelper=function(e,t){this.light=e,this.light.updateMatrixWorld();var r=new i.SphereGeometry(t,4,2),n=new i.MeshBasicMaterial({wireframe:!0,fog:!1});n.color.copy(this.light.color).multiplyScalar(this.light.intensity),i.Mesh.call(this,r,n),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1},i.PointLightHelper.prototype=Object.create(i.Mesh.prototype),i.PointLightHelper.prototype.constructor=i.PointLightHelper,i.PointLightHelper.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},i.PointLightHelper.prototype.update=function(){this.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)},i.SkeletonHelper=function(e){this.bones=this.getBoneList(e);for(var t=new i.Geometry,r=0;r<this.bones.length;r++){var n=this.bones[r];n.parent instanceof i.Bone&&(t.vertices.push(new i.Vector3),t.vertices.push(new i.Vector3),t.colors.push(new i.Color(0,0,1)),t.colors.push(new i.Color(0,1,0)))}t.dynamic=!0;var o=new i.LineBasicMaterial({vertexColors:i.VertexColors,depthTest:!1,depthWrite:!1,transparent:!0});i.LineSegments.call(this,t,o),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.update()},i.SkeletonHelper.prototype=Object.create(i.LineSegments.prototype),i.SkeletonHelper.prototype.constructor=i.SkeletonHelper,i.SkeletonHelper.prototype.getBoneList=function(e){var t=[];e instanceof i.Bone&&t.push(e);for(var r=0;r<e.children.length;r++)t.push.apply(t,this.getBoneList(e.children[r]));return t},i.SkeletonHelper.prototype.update=function(){for(var e=this.geometry,t=(new i.Matrix4).getInverse(this.root.matrixWorld),r=new i.Matrix4,n=0,o=0;o<this.bones.length;o++){var a=this.bones[o];a.parent instanceof i.Bone&&(r.multiplyMatrices(t,a.matrixWorld),e.vertices[n].setFromMatrixPosition(r),r.multiplyMatrices(t,a.parent.matrixWorld),e.vertices[n+1].setFromMatrixPosition(r),n+=2)}e.verticesNeedUpdate=!0,e.computeBoundingSphere()},i.SpotLightHelper=function(e){i.Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;var t=new i.CylinderGeometry(0,1,1,8,1,!0);t.translate(0,-.5,0),t.rotateX(-Math.PI/2);var r=new i.MeshBasicMaterial({wireframe:!0,fog:!1});this.cone=new i.Mesh(t,r),this.add(this.cone),this.update()},i.SpotLightHelper.prototype=Object.create(i.Object3D.prototype),i.SpotLightHelper.prototype.constructor=i.SpotLightHelper,i.SpotLightHelper.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},i.SpotLightHelper.prototype.update=function(){var e=new i.Vector3,t=new i.Vector3;return function(){var r=this.light.distance?this.light.distance:1e4,n=r*Math.tan(this.light.angle);this.cone.scale.set(n,n,r),e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(t.sub(e)),this.cone.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)}}(),i.VertexNormalsHelper=function(e,t,r,n){this.object=e,this.size=void 0!==t?t:1;var o=void 0!==r?r:16711680,a=void 0!==n?n:1,s=0,u=this.object.geometry;u instanceof i.Geometry?s=3*u.faces.length:u instanceof i.BufferGeometry&&(s=u.attributes.normal.count);var h=new i.BufferGeometry,c=new i.Float32Attribute(2*s*3,3);h.addAttribute("position",c),i.LineSegments.call(this,h,new i.LineBasicMaterial({color:o,linewidth:a})),this.matrixAutoUpdate=!1,this.update()},i.VertexNormalsHelper.prototype=Object.create(i.LineSegments.prototype),i.VertexNormalsHelper.prototype.constructor=i.VertexNormalsHelper,i.VertexNormalsHelper.prototype.update=function(){var e=new i.Vector3,t=new i.Vector3,r=new i.Matrix3;return function(){var n=["a","b","c"];this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);var o=this.object.matrixWorld,a=this.geometry.attributes.position,s=this.object.geometry;if(s instanceof i.Geometry)for(var u=s.vertices,h=s.faces,c=0,l=0,p=h.length;p>l;l++)for(var f=h[l],d=0,m=f.vertexNormals.length;m>d;d++){var g=u[f[n[d]]],v=f.vertexNormals[d];e.copy(g).applyMatrix4(o),t.copy(v).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),a.setXYZ(c,e.x,e.y,e.z),c+=1,a.setXYZ(c,t.x,t.y,t.z),c+=1}else if(s instanceof i.BufferGeometry)for(var x=s.attributes.position,y=s.attributes.normal,c=0,d=0,m=x.count;m>d;d++)e.set(x.getX(d),x.getY(d),x.getZ(d)).applyMatrix4(o),t.set(y.getX(d),y.getY(d),y.getZ(d)),t.applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),a.setXYZ(c,e.x,e.y,e.z),c+=1,a.setXYZ(c,t.x,t.y,t.z),c+=1;return a.needsUpdate=!0,this}}(),i.WireframeHelper=function(e,t){var r=void 0!==t?t:16777215;i.LineSegments.call(this,new i.WireframeGeometry(e.geometry),new i.LineBasicMaterial({color:r})),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1},i.WireframeHelper.prototype=Object.create(i.LineSegments.prototype),i.WireframeHelper.prototype.constructor=i.WireframeHelper,i.ImmediateRenderObject=function(e){i.Object3D.call(this),this.material=e,this.render=function(e){}},i.ImmediateRenderObject.prototype=Object.create(i.Object3D.prototype),i.ImmediateRenderObject.prototype.constructor=i.ImmediateRenderObject,i.MorphBlendMesh=function(e,t){i.Mesh.call(this,e,t),this.animationsMap={},this.animationsList=[];var r=this.geometry.morphTargets.length,n="__default",o=0,a=r-1,s=r/1;this.createAnimation(n,o,a,s),this.setAnimationWeight(n,1)},i.MorphBlendMesh.prototype=Object.create(i.Mesh.prototype),i.MorphBlendMesh.prototype.constructor=i.MorphBlendMesh,i.MorphBlendMesh.prototype.createAnimation=function(e,t,r,n){var i={start:t,end:r,length:r-t+1,fps:n,duration:(r-t)/n,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=i,this.animationsList.push(i)},i.MorphBlendMesh.prototype.autoCreateAnimations=function(e){for(var t,r=/([a-z]+)_?(\d+)/,n={},i=this.geometry,o=0,a=i.morphTargets.length;a>o;o++){var s=i.morphTargets[o],u=s.name.match(r);if(u&&u.length>1){var h=u[1];n[h]||(n[h]={start:1/0,end:-(1/0)});var c=n[h];o<c.start&&(c.start=o),o>c.end&&(c.end=o),t||(t=h)}}for(var h in n){var c=n[h];this.createAnimation(h,c.start,c.end,e)}this.firstAnimation=t},i.MorphBlendMesh.prototype.setAnimationDirectionForward=function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},i.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},i.MorphBlendMesh.prototype.setAnimationFPS=function(e,t){var r=this.animationsMap[e];r&&(r.fps=t,r.duration=(r.end-r.start)/r.fps)},i.MorphBlendMesh.prototype.setAnimationDuration=function(e,t){var r=this.animationsMap[e];r&&(r.duration=t,r.fps=(r.end-r.start)/r.duration)},i.MorphBlendMesh.prototype.setAnimationWeight=function(e,t){var r=this.animationsMap[e];r&&(r.weight=t)},i.MorphBlendMesh.prototype.setAnimationTime=function(e,t){var r=this.animationsMap[e];r&&(r.time=t)},i.MorphBlendMesh.prototype.getAnimationTime=function(e){var t=0,r=this.animationsMap[e];return r&&(t=r.time),t},i.MorphBlendMesh.prototype.getAnimationDuration=function(e){var t=-1,r=this.animationsMap[e];return r&&(t=r.duration),t},i.MorphBlendMesh.prototype.playAnimation=function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("THREE.MorphBlendMesh: animation["+e+"] undefined in .playAnimation()")},i.MorphBlendMesh.prototype.stopAnimation=function(e){var t=this.animationsMap[e];t&&(t.active=!1)},i.MorphBlendMesh.prototype.update=function(e){for(var t=0,r=this.animationsList.length;r>t;t++){var n=this.animationsList[t];if(n.active){var o=n.duration/n.length;n.time+=n.direction*e,n.mirroredLoop?(n.time>n.duration||n.time<0)&&(n.direction*=-1,n.time>n.duration&&(n.time=n.duration,n.directionBackwards=!0),n.time<0&&(n.time=0,n.directionBackwards=!1)):(n.time=n.time%n.duration,n.time<0&&(n.time+=n.duration));var a=n.start+i.Math.clamp(Math.floor(n.time/o),0,n.length-1),s=n.weight;a!==n.currentFrame&&(this.morphTargetInfluences[n.lastFrame]=0,this.morphTargetInfluences[n.currentFrame]=1*s,this.morphTargetInfluences[a]=0,n.lastFrame=n.currentFrame,n.currentFrame=a);var u=n.time%o/o;n.directionBackwards&&(u=1-u),n.currentFrame!==n.lastFrame?(this.morphTargetInfluences[n.currentFrame]=u*s,this.morphTargetInfluences[n.lastFrame]=(1-u)*s):this.morphTargetInfluences[n.currentFrame]=s}}},"undefined"!=typeof r?("undefined"!=typeof t&&t.exports&&(r=t.exports=i),r.THREE=i):this.THREE=i},{}]},{},[]);